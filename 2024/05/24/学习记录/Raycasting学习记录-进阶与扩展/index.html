<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"><title>Raycasting学习记录_进阶与扩展 | WinkySpeed's Blog</title><meta name="author" content="WinkySpeed"><meta name="copyright" content="WinkySpeed"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Raycasting学习记录_进阶与扩展 这篇博客是Raycasting学习记录的进阶与扩展部分，会在原来实现的基础上新添加一些内容 因此请先阅读Raycasting学习记录的内容，对“Raycasting”过程有了大致了解后再来阅读本博客 源代码和可执行程序已经部署到github上：Raycasting 纹理地板天花板 visual studio的Release模式 注意：实现此功">
<meta property="og:type" content="article">
<meta property="og:title" content="Raycasting学习记录_进阶与扩展">
<meta property="og:url" content="http://example.com/2024/05/24/%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/Raycasting%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95-%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%89%A9%E5%B1%95/index.html">
<meta property="og:site_name" content="WinkySpeed&#39;s Blog">
<meta property="og:description" content="Raycasting学习记录_进阶与扩展 这篇博客是Raycasting学习记录的进阶与扩展部分，会在原来实现的基础上新添加一些内容 因此请先阅读Raycasting学习记录的内容，对“Raycasting”过程有了大致了解后再来阅读本博客 源代码和可执行程序已经部署到github上：Raycasting 纹理地板天花板 visual studio的Release模式 注意：实现此功">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/img/WinkySpeed%20SP%20-%20Repaired.jpg">
<meta property="article:published_time" content="2024-05-24T07:00:00.000Z">
<meta property="article:modified_time" content="2024-05-31T07:28:36.186Z">
<meta property="article:author" content="WinkySpeed">
<meta property="article:tag" content="计算机图形学">
<meta property="article:tag" content="Raycasting">
<meta property="article:tag" content="伪3D">
<meta property="article:tag" content="SFML">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/img/WinkySpeed%20SP%20-%20Repaired.jpg"><link rel="shortcut icon" href="/img/WinkySpeed%20SP%20-%20Repaired.jpg"><link rel="canonical" href="http://example.com/2024/05/24/%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/Raycasting%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95-%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%89%A9%E5%B1%95/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  }
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Raycasting学习记录_进阶与扩展',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-05-31 15:28:36'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = url => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      link.onload = () => resolve()
      link.onerror = () => reject()
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/WinkySpeed%20SP%20-%20Repaired.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">50</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">60</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><hr/></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/33703665_p0.jpg')"><nav id="nav"><span id="blog-info"><a href="/" title="WinkySpeed's Blog"><span class="site-name">WinkySpeed's Blog</span></a></span><div id="menus"><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Raycasting学习记录_进阶与扩展</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-05-24T07:00:00.000Z" title="发表于 2024-05-24 15:00:00">2024-05-24</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-05-31T07:28:36.186Z" title="更新于 2024-05-31 15:28:36">2024-05-31</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Raycasting学习记录_进阶与扩展"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="raycasting学习记录_进阶与扩展">Raycasting学习记录_进阶与扩展</h1>
<p>这篇博客是<a target="_blank" rel="noopener" href="https://winkyspeed.github.io/2023/11/09/学习记录/Raycasting学习记录/">Raycasting学习记录</a>的进阶与扩展部分，会在原来实现的基础上新添加一些内容</p>
<p>因此请先阅读<a target="_blank" rel="noopener" href="https://winkyspeed.github.io/2023/11/09/学习记录/Raycasting学习记录/">Raycasting学习记录</a>的内容，对“Raycasting”过程有了大致了解后再来阅读本博客</p>
<p>源代码和可执行程序已经部署到github上：<a target="_blank" rel="noopener" href="https://github.com/WinkySpeed/Raycasting">Raycasting</a></p>
<h1 id="纹理地板天花板">纹理地板天花板</h1>
<h2 id="visual-studio的release模式">visual
studio的<strong>Release模式</strong></h2>
<p><strong>注意</strong>：实现此功能时，务必使用visual
studio的<strong>Release模式</strong>，因为Debug模式非常卡</p>
<blockquote>
<p>这是因为Debug模式和Release模式在编译选项上有所不同：</p>
<ul>
<li><strong>Debug模式</strong>：在Debug模式下，编译器会保留调试信息和不进行优化，以便开发者可以跟踪代码的执行情况，找出和修复错误。由于保留了更多的信息并且没有进行优化，所以Debug模式下的程序运行速度通常会比Release模式慢。</li>
<li><strong>Release模式</strong>：在Release模式下，编译器会进行各种优化，比如消除冗余代码，进行代码重排，内联函数等，以提高程序的运行速度。同时，编译器不会保留调试信息，因此Release模式下的程序文件通常会比Debug模式小。</li>
</ul>
<p>所以，在开发和调试程序时，通常会使用Debug模式。而当程序开发完成，准备发布时，通常会切换到Release模式，以提高程序的运行效率。</p>
</blockquote>
<p><br></p>
<p>原<a target="_blank" rel="noopener" href="https://lodev.org/cgtutor/raycasting2.html">博客</a>里面介绍了这种方法，但是不能像之前画墙一样取巧了，这里只能<strong>逐像素操作</strong></p>
<p>画墙的时候，可以直接使用一条完整的竖线来截取纹理上对应一个像素宽度的部分，每一条竖线都对应纹理上的一个像素宽度，从而实现了墙壁的纹理映射</p>
<p>但是地板很不一样，因为同一条横线上可能会跨越好几块不同的地板，因此此处采用逐像素操作</p>
<h2 id="sfml逐像素操作">SFML逐像素操作</h2>
<p><a id="SFML-pixel_by_pixel"></a></p>
<p>SFML的逐像素操作逻辑有些奇怪，如果要对宽<code>screenWidth</code>高<code>screenHeight</code>的窗口进行逐像素操作，步骤如下：</p>
<ol type="1">
<li>首先需要创建宽<code>screenWidth</code>高<code>screenHeight</code>的一张图像<code>Image</code>对象（因为只有<code>Image</code>能逐像素设置颜色，<code>Texture</code>和<code>Sprite</code>不行）</li>
<li>对这个<code>Image</code>调用<code>setPixel</code>函数逐像素设置颜色</li>
<li>在<code>Image</code>每个像素设置好颜色后，用这张<code>Image</code>创建一个新的纹理<code>Texture</code>对象（因为<code>Image</code>不能直接设置<code>Sprite</code>的纹理）</li>
<li>最后创建一个<code>Sprite</code>，用刚刚的纹理对象设置这个<code>Sprite</code>的纹理</li>
<li>最后在窗口上画出这个<code>Sprite</code>（因为<code>draw</code>函数只能画<code>Sprite</code>和一系列图形，不能画<code>Image</code>和<code>Texture</code>，所以需要这么麻烦才能逐像素操作，<del>闹麻了</del>）</li>
</ol>
<p>因此，地板天花板的实现就会按照这个逻辑执行</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">Floor_Ceiling_Casting</span><span class="params">(RenderWindow &amp;window)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 创建一个新的Image</span></span><br><span class="line">    Image Floor_Ceiling_image;</span><br><span class="line">    Floor_Ceiling_image.<span class="built_in">create</span>(screenWidth, screenHeight);</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// 遍历填充这个Image</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> y = <span class="number">0</span>; y &lt; screenHeight; y++)</span><br><span class="line">    &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> x = <span class="number">0</span>; x &lt; screenWidth; x++)</span><br><span class="line">        &#123;</span><br><span class="line">            ...</span><br><span class="line">            <span class="comment">// 计算像素颜色，逐像素赋值</span></span><br><span class="line">            Color Floorcolor = Floor_image.<span class="built_in">getPixel</span>(tx, ty);</span><br><span class="line">            Color Ceilingcolor = Ceiling_image.<span class="built_in">getPixel</span>(tx, ty);</span><br><span class="line">            Floor_Ceiling_image.<span class="built_in">setPixel</span>(x, y, Floorcolor);</span><br><span class="line">            Floor_Ceiling_image.<span class="built_in">setPixel</span>(x, screenHeight - y - <span class="number">1</span>, Ceilingcolor);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 创建一个新的Texture</span></span><br><span class="line">    Texture Floor_Ceiling_texture;</span><br><span class="line">    Floor_Ceiling_texture.<span class="built_in">loadFromImage</span>(Floor_Ceiling_image);</span><br><span class="line">    <span class="comment">// 创建一个新的Sprite并设置其纹理</span></span><br><span class="line">    Sprite sprite;</span><br><span class="line">    sprite.<span class="built_in">setTexture</span>(Floor_Ceiling_texture);</span><br><span class="line">    <span class="comment">// 把这个Sprite画在屏幕上</span></span><br><span class="line">    window.<span class="built_in">draw</span>(sprite);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>绘制天花板的方式与绘制地板的方式相同，所以这里只解释地板，坐标几乎可以复用</p>
<p>画天花板和地板是在画墙之前的，简单来说，地板的投射工作如下：<strong>逐行扫描</strong></p>
<p>对于当前的扫描线，计算匹配扫描线左像素的地板位置，以及匹配右像素的位置</p>
<p>这可以计算为从相机发出，通过相机平面的那个像素的射线击中地板的位置</p>
<h2 id="具体逻辑">具体逻辑</h2>
<p>令人意想不到的是，地板的绘制比纹理墙面简单一些，只是不能像墙面绘制一样取巧</p>
<p>大致思路是一样的，并且不用考虑镜面翻转</p>
<h3 id="计算fov起点终点">计算FOV起点终点</h3>
<p>在开始遍历之前，需要计算一些必要变量</p>
<p>首先是人物FOV的起点和终点，可以通过方向向量<span class="math inline">\(\overrightarrow{dir}\)</span>和相机平面向量<span class="math inline">\(\overrightarrow{plane}\)</span>加减法计算出来</p>
<img src="/2024/05/24/%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/Raycasting%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95-%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%89%A9%E5%B1%95/image-20240527161950710.png" class title="image-20240527161950710">
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// rayDir for leftmost ray (x = 0) and rightmost ray (x = w)</span></span><br><span class="line"><span class="type">float</span> FOV_StartX = dirX - planeX;</span><br><span class="line"><span class="type">float</span> FOV_StartY = dirY - planeY;</span><br><span class="line"><span class="type">float</span> FOV_EndX = dirX + planeX;</span><br><span class="line"><span class="type">float</span> FOV_EndY = dirY + planeY;</span><br></pre></td></tr></table></figure>
<h3 id="遍历y并计算rowdistance">遍历<code>y</code>并计算<code>rowDistance</code></h3>
<p>所谓<code>rowDistance</code>，就是沿人物<span class="math inline">\(\overrightarrow{dir}\)</span>方向的距离，我们需要根据这个距离计算地板与天花板对应坐标</p>
<p>一个具体的<code>y</code>会对应一个<code>rowDistance</code>，进而对应一条横线</p>
<p><code>y</code>的取值可以从<code>screenHeight / 2</code>开始（因为天花板坐标可以复用地板的），这样可以减少一半计算量</p>
<p><br></p>
<p>比起<a target="_blank" rel="noopener" href="https://lodev.org/cgtutor/raycasting2.html">原教程</a>，我认为这个<a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=OpIS1zoz6fU">视频</a>的图像更直观<del>（毕竟我为了画出下面这个图还是画了一段时间的）</del></p>
<p>假设人物面前1个单位的距离有一个垂直平面，从摄像机发出的光线经过这个平面，交点就是<code>y</code>点</p>
<p>如图所示，红色三角形和紫色三角形相似</p>
<img src="/2024/05/24/%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/Raycasting%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95-%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%89%A9%E5%B1%95/image-20240527105548396.png" class title="image-20240527105548396">
<p>在代码中，我们指定图中<code>cam_z</code>这个变量为<code>posZ</code>，大小为屏幕高度的一半，即<code>posZ = 0.5 * screenHeight</code></p>
<p>指定图中<code>x</code>为<code>rowDistance</code>，根据三角形相似得出<code>rowDistance = posZ / row_y</code></p>
<p><br></p>
<p>可以通过这个动图了解所谓<code>rowDistance</code>有什么作用，左边是俯视图，右边是屏幕：</p>
<img src="/2024/05/24/%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/Raycasting%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95-%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%89%A9%E5%B1%95/Raycasting_rowDistance.gif" class title="Raycasting_rowDistance">
<p>一个<code>rowDistance</code>就对应一条横线，画出全部横线就完成了画地板</p>
<img src="/2024/05/24/%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/Raycasting%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95-%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%89%A9%E5%B1%95/rowDistance.jpg" class title="rowDistance">
<p>代码如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Vertical position of the camera.</span></span><br><span class="line"><span class="type">float</span> posZ = <span class="number">0.5</span> * screenHeight;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 遍历全部y</span></span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> y = <span class="number">0</span>; y &lt; screenHeight; y++)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Current y position compared to the center of the screen (the horizon)</span></span><br><span class="line">    <span class="type">int</span> row_y = y - screenHeight / <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Horizontal distance from the camera to the floor for the current row.</span></span><br><span class="line">    <span class="comment">// 0.5 is the z position exactly in the middle between floor and ceiling.</span></span><br><span class="line">    <span class="type">float</span> rowDistance = posZ / row_y;</span><br><span class="line">......</span><br></pre></td></tr></table></figure>
<h3 id="计算遍历变量">计算遍历变量</h3>
<p>根据相似三角形，可以计算出<code>floor</code>遍历的起点，通过FOV的起点计算</p>
<img src="/2024/05/24/%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/Raycasting%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95-%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%89%A9%E5%B1%95/image-20240527161259535.png" class title="image-20240527161259535">
<p>代码如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// real world coordinates of the leftmost column. This will be updated as we step to the right.</span></span><br><span class="line"><span class="type">float</span> floorX = posX + rowDistance * FOV_StartX;</span><br><span class="line"><span class="type">float</span> floorY = posY + rowDistance * FOV_StartY;</span><br></pre></td></tr></table></figure>
<p>还是根据相似三角形，求出<code>stepX</code>与<code>stepY</code></p>
<img src="/2024/05/24/%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/Raycasting%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95-%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%89%A9%E5%B1%95/image-20240527161448694.png" class title="image-20240527161448694">
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// calculate the real world step vector we have to add for each x (parallel to camera plane)</span></span><br><span class="line"><span class="comment">// adding step by step avoids multiplications with a weight in the inner loop</span></span><br><span class="line"><span class="type">float</span> floorStepX = rowDistance * (FOV_EndX - FOV_StartX) / screenWidth;</span><br><span class="line"><span class="type">float</span> floorStepY = rowDistance * (FOV_EndY - FOV_StartY) / screenWidth;</span><br></pre></td></tr></table></figure>
<h3 id="遍历x">遍历<code>x</code></h3>
<p>跟纹理墙壁逻辑差不多</p>
<p>计算出<code>tx, ty</code>，找到纹理图片对应位置，把对应颜色画在屏幕<code>(x, y)</code>处</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="type">int</span> x = <span class="number">0</span>; x &lt; screenWidth; ++x)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// the cell coord is simply got from the integer parts of floorX and floorY</span></span><br><span class="line">    <span class="type">int</span> cellX = (<span class="type">int</span>)(floorX);</span><br><span class="line">    <span class="type">int</span> cellY = (<span class="type">int</span>)(floorY);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// get the texture coordinate from the fractional part</span></span><br><span class="line">    <span class="type">int</span> tx = (<span class="type">int</span>)(texWidth * (floorX - cellX)) &amp; (texWidth - <span class="number">1</span>);</span><br><span class="line">    <span class="type">int</span> ty = (<span class="type">int</span>)(texHeight * (floorY - cellY)) &amp; (texHeight - <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    floorX += floorStepX;</span><br><span class="line">    floorY += floorStepY;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 计算像素颜色，逐像素赋值</span></span><br><span class="line">    Color Floorcolor = Floor_image.<span class="built_in">getPixel</span>(tx, ty);</span><br><span class="line">    Color Ceilingcolor = Ceiling_image.<span class="built_in">getPixel</span>(tx, ty);</span><br><span class="line">    Floor_Ceiling_image.<span class="built_in">setPixel</span>(x, y, Floorcolor);</span><br><span class="line">    Floor_Ceiling_image.<span class="built_in">setPixel</span>(x, screenHeight - y - <span class="number">1</span>, Ceilingcolor);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="效果">效果</h2>
<p>把画墙壁的函数注释掉，仅保留画地板天花板函数，效果如下，非常好</p>
<img src="/2024/05/24/%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/Raycasting%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95-%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%89%A9%E5%B1%95/image-20240527162903287.png" class title="image-20240527162903287">
<h2 id="对应代码">对应代码</h2>
<p>代码如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">Floor_Ceiling_Casting</span><span class="params">(RenderWindow &amp;window)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 创建一个新的Image</span></span><br><span class="line">    Image Floor_Ceiling_image;</span><br><span class="line">    Floor_Ceiling_image.<span class="built_in">create</span>(screenWidth, screenHeight);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// rayDir for leftmost ray (x = 0) and rightmost ray (x = w)</span></span><br><span class="line">    <span class="type">float</span> FOV_StartX = dirX - planeX;</span><br><span class="line">    <span class="type">float</span> FOV_StartY = dirY - planeY;</span><br><span class="line">    <span class="type">float</span> FOV_EndX = dirX + planeX;</span><br><span class="line">    <span class="type">float</span> FOV_EndY = dirY + planeY;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Vertical position of the camera.</span></span><br><span class="line">    <span class="type">float</span> posZ = <span class="number">0.5</span> * screenHeight;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// FLOOR AND CEILING CASTING</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> y = screenHeight / <span class="number">2</span>; y &lt; screenHeight; y++) <span class="comment">//其实可以直接从screenHeight / 2处开始遍历</span></span><br><span class="line">        <span class="comment">//for (int y = 0; y &lt; screenHeight; y++)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// Current y position compared to the center of the screen (the horizon)</span></span><br><span class="line">        <span class="type">int</span> row_y = y - screenHeight / <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Horizontal distance from the camera to the floor for the current row.</span></span><br><span class="line">        <span class="comment">// 0.5 is the z position exactly in the middle between floor and ceiling.</span></span><br><span class="line">        <span class="type">float</span> rowDistance = posZ / row_y;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// real world coordinates of the leftmost column. This will be updated as we step to the right.</span></span><br><span class="line">        <span class="type">float</span> floorX = posX + rowDistance * FOV_StartX;</span><br><span class="line">        <span class="type">float</span> floorY = posY + rowDistance * FOV_StartY;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// calculate the real world step vector we have to add for each x (parallel to camera plane)</span></span><br><span class="line">        <span class="comment">// adding step by step avoids multiplications with a weight in the inner loop</span></span><br><span class="line">        <span class="type">float</span> floorStepX = rowDistance * (FOV_EndX - FOV_StartX) / screenWidth;</span><br><span class="line">        <span class="type">float</span> floorStepY = rowDistance * (FOV_EndY - FOV_StartY) / screenWidth;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> x = <span class="number">0</span>; x &lt; screenWidth; ++x)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// the cell coord is simply got from the integer parts of floorX and floorY</span></span><br><span class="line">            <span class="type">int</span> cellX = (<span class="type">int</span>)(floorX);</span><br><span class="line">            <span class="type">int</span> cellY = (<span class="type">int</span>)(floorY);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// get the texture coordinate from the fractional part</span></span><br><span class="line">            <span class="type">int</span> tx = (<span class="type">int</span>)(texWidth * (floorX - cellX)) &amp; (texWidth - <span class="number">1</span>);</span><br><span class="line">            <span class="type">int</span> ty = (<span class="type">int</span>)(texHeight * (floorY - cellY)) &amp; (texHeight - <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">            floorX += floorStepX;</span><br><span class="line">            floorY += floorStepY;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 计算像素颜色，逐像素赋值</span></span><br><span class="line">            Color Floorcolor = Floor_image.<span class="built_in">getPixel</span>(tx, ty);</span><br><span class="line">            Color Ceilingcolor = Ceiling_image.<span class="built_in">getPixel</span>(tx, ty);</span><br><span class="line">            Floor_Ceiling_image.<span class="built_in">setPixel</span>(x, y, Floorcolor);</span><br><span class="line">            Floor_Ceiling_image.<span class="built_in">setPixel</span>(x, screenHeight - y - <span class="number">1</span>, Ceilingcolor);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 创建一个新的Texture</span></span><br><span class="line">    Texture Floor_Ceiling_texture;</span><br><span class="line">    Floor_Ceiling_texture.<span class="built_in">loadFromImage</span>(Floor_Ceiling_image);</span><br><span class="line">    <span class="comment">// 创建一个新的Sprite并设置其纹理</span></span><br><span class="line">    Sprite sprite;</span><br><span class="line">    sprite.<span class="built_in">setTexture</span>(Floor_Ceiling_texture);</span><br><span class="line">    <span class="comment">// 把这个Sprite画在屏幕上</span></span><br><span class="line">    window.<span class="built_in">draw</span>(sprite);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="鼠标控制视角旋转">鼠标控制视角旋转</h1>
<p>之前控制旋转是用键盘的左右键实现的，转起来跟坦克一样</p>
<p>这次加入鼠标逻辑，并且跟正常游戏差不多，鼠标移动的快慢会影响视角转动的速度</p>
<p><br></p>
<p>鼠标转向的大致思路很容易，大一做绘图软件的时候实现过类似的操作：拖拽图形移动</p>
<p>通过判断这一帧和上一帧鼠标位置之间的差值，计算出图形对应位移的向量；对应到这里，就是计算出对应视角旋转的度数</p>
<p>但是鼠标在移动的过程中容易移动出窗口；这个旋转角度具体怎么计算？我参考这个<a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=OpIS1zoz6fU">视频</a>以及对应的<a target="_blank" rel="noopener" href="https://github.com/Kofybrek/New-Raycasting">代码</a>得出了一个很不错的解法：</p>
<ol type="1">
<li>固定鼠标在窗口中心，这样就不会移动出窗口</li>
<li>固定鼠标这个操作是在计算完旋转角度后做的，所以“这一帧和上一帧鼠标位置之间的差值”就直接转换为“这一帧鼠标位置和窗口中心位置的差值”，就不用保存上一帧的位置了</li>
<li>这一帧鼠标位置和窗口中心位置的差值只考虑水平分量，将这个差值除以<strong>窗口的宽度</strong>，得到一个介于<code>-0.5</code>和<code>0.5</code>之间的值，最后乘以水平FOV就得到理想的旋转角度</li>
</ol>
<p>大致思路有了，下面开始实现</p>
<p><br></p>
<h2 id="设置鼠标指针">设置鼠标指针</h2>
<p>因为涉及到鼠标操作，就需要把鼠标指针可视化关闭，并且让鼠标总是居中在窗口中央</p>
<p>可以在<code>main</code>函数开始主循环之前设置鼠标，代码如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Mouse::<span class="built_in">setPosition</span>(<span class="built_in">Vector2i</span>(screenWidth * <span class="number">0.5f</span>, screenHeight * <span class="number">0.5f</span>), window);</span><br><span class="line">window.<span class="built_in">setMouseCursorVisible</span>(<span class="number">0</span>);</span><br></pre></td></tr></table></figure>
<p>因为鼠标不能正常控制关闭了，需要添加按<code>ESC</code>退出，故在<code>main</code>函数主循环的事件处理循环中添加：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (window.<span class="built_in">pollEvent</span>(event))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (event.type == sf::Event::Closed || sf::Keyboard::<span class="built_in">isKeyPressed</span>(sf::Keyboard::Escape))</span><br><span class="line">        window.<span class="built_in">close</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><br></p>
<h2 id="fovfield-of-vision">FOV（Field Of Vision）</h2>
<p>需要写一个计算FOV的函数</p>
<p>不过令我意外的是，我在之前的<a target="_blank" rel="noopener" href="https://winkyspeed.github.io/2023/11/09/学习记录/Raycasting学习记录/">博客</a>中并没有提到FOV（Field
Of Vision）的计算，那就在这里补上吧</p>
<img src="/2024/05/24/%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/Raycasting%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95-%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%89%A9%E5%B1%95/raycastingcamera.gif" class title="raycastingcamera">
<p>如图所示，最外面两条红线之间的夹角就是FOV，这个角度可以通过方向向量<span class="math inline">\(\overrightarrow{dir}\)</span>和相机平面向量<span class="math inline">\(\overrightarrow{plane}\)</span>的长度求出</p>
<p>而且可以看出，在方向向量<span class="math inline">\(\overrightarrow{dir}\)</span>不变的前提下，相机平面向量<span class="math inline">\(\overrightarrow{plane}\)</span>的长度越短，FOV越小</p>
<p>具体公式如下： <span class="math display">\[
\begin{align*}
\tan(\frac{FOV}{2})&amp;=\frac{|\overrightarrow{plane}|}{|\overrightarrow{dir}|}\\
FOV&amp;=\arctan(\frac{|\overrightarrow{plane}|}{|\overrightarrow{dir}|})\times
2
\end{align*}
\]</span> 计算FOV的函数如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 计算FOV大小</span></span><br><span class="line"><span class="function"><span class="type">double</span> <span class="title">calculate_FOV</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">double</span> length_dir = <span class="built_in">sqrt</span>(dirX * dirX + dirY * dirY);</span><br><span class="line">    <span class="type">double</span> length_plane = <span class="built_in">sqrt</span>(planeX * planeX + planeY * planeY);</span><br><span class="line">    <span class="comment">// 弧度制</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">atan</span>(length_plane / length_dir) * <span class="number">2</span>;</span><br><span class="line">    <span class="comment">// 角度制</span></span><br><span class="line">    <span class="comment">//// return atan(length_plane / length_dir) * 2 * 180 / acos(-1);</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意：C++里面数学函数角度计算是弧度制，因此要得到具体的角度需要处理一下：
<span class="math display">\[
\begin{align*}
\text{radian}=\frac{\text{degree}}{180}\times\pi
\end{align*}
\]</span>
但是，我们后面的计算全部都需要用到三角函数，所以在这里还是统一采用弧度制的运算<del>（不然鼠标一转就上天了，真的要注意统一）</del></p>
<p>可以在<code>main</code>函数开始循环之前就申明<code>FOV</code>这个变量，并且计算出具体的弧度制，然后就可以代入运算了</p>
<h2 id="具体逻辑-1">具体逻辑</h2>
<p>计算好了FOV，就可以在<code>Move</code>函数中添加鼠标移动旋转方向向量和相机平面向量的逻辑了，具体逻辑如下：</p>
<ol type="1">
<li>获取窗口的中心位置</li>
<li>获取鼠标当前位置</li>
<li>计算鼠标的旋转角度</li>
<li>旋转方向向量<span class="math inline">\(\overrightarrow{dir}\)</span>和相机平面向量<span class="math inline">\(\overrightarrow{plane}\)</span></li>
<li>将鼠标位置重置到窗口中心</li>
</ol>
<h2 id="对应代码-1">对应代码</h2>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这些是计算鼠标移动逻辑</span></span><br><span class="line"><span class="comment">// 获取窗口的中心位置</span></span><br><span class="line"><span class="function">Vector2i <span class="title">center</span><span class="params">(screenWidth * <span class="number">0.5f</span>, screenHeight * <span class="number">0.5f</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取鼠标当前位置</span></span><br><span class="line">Vector2i position_now = Mouse::<span class="built_in">getPosition</span>(window);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 计算鼠标的旋转角度</span></span><br><span class="line"><span class="comment">// 水平方向旋转角度</span></span><br><span class="line"><span class="type">double</span> rotation_degree_horizontal = (center.x - position_now.x) * FOV / screenWidth;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 更新方向</span></span><br><span class="line"><span class="comment">// dir和plane一起更新</span></span><br><span class="line"><span class="type">double</span> oldDirX = dirX;</span><br><span class="line">dirX = dirX * <span class="built_in">cos</span>(rotation_degree_horizontal) - dirY * <span class="built_in">sin</span>(rotation_degree_horizontal);</span><br><span class="line">dirY = oldDirX * <span class="built_in">sin</span>(rotation_degree_horizontal) + dirY * <span class="built_in">cos</span>(rotation_degree_horizontal);</span><br><span class="line"><span class="type">double</span> oldPlaneX = planeX;</span><br><span class="line">planeX = planeX * <span class="built_in">cos</span>(rotation_degree_horizontal) - planeY * <span class="built_in">sin</span>(rotation_degree_horizontal);</span><br><span class="line">planeY = oldPlaneX * <span class="built_in">sin</span>(rotation_degree_horizontal) + planeY * <span class="built_in">cos</span>(rotation_degree_horizontal);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将鼠标位置重置到窗口中心</span></span><br><span class="line">Mouse::<span class="built_in">setPosition</span>(center, window);</span><br></pre></td></tr></table></figure>
<p>这段逻辑是独立于键盘操作的逻辑，因此放在最开始或者最后面都可以，只要不影响键盘逻辑就好</p>
<p><br></p>
<p>由于实现绘制decoration和illustration时需要截图，因此添加一个全局变量布尔值，用于控制是否允许鼠标逻辑：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//debug用，每次手动注释掉鼠标的逻辑烦死我了</span></span><br><span class="line"><span class="type">bool</span> ifMouse = <span class="number">1</span>;</span><br></pre></td></tr></table></figure>
<p>在<code>main</code>函数中修改：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (ifMouse)</span><br><span class="line">&#123;</span><br><span class="line">    Mouse::<span class="built_in">setPosition</span>(<span class="built_in">Vector2i</span>(screenWidth * <span class="number">0.5f</span>, screenHeight * <span class="number">0.5f</span>), window);</span><br><span class="line">    window.<span class="built_in">setMouseCursorVisible</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在<code>Move</code>函数中修改：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (ifMouse)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 更新方向</span></span><br><span class="line">    <span class="comment">// dir和plane一起更新</span></span><br><span class="line">    <span class="type">double</span> oldDirX = dirX;</span><br><span class="line">    dirX = dirX * <span class="built_in">cos</span>(rotation_degree_horizontal) - dirY * <span class="built_in">sin</span>(rotation_degree_horizontal);</span><br><span class="line">    dirY = oldDirX * <span class="built_in">sin</span>(rotation_degree_horizontal) + dirY * <span class="built_in">cos</span>(rotation_degree_horizontal);</span><br><span class="line">    <span class="type">double</span> oldPlaneX = planeX;</span><br><span class="line">    planeX = planeX * <span class="built_in">cos</span>(rotation_degree_horizontal) - planeY * <span class="built_in">sin</span>(rotation_degree_horizontal);</span><br><span class="line">    planeY = oldPlaneX * <span class="built_in">sin</span>(rotation_degree_horizontal) + planeY * <span class="built_in">cos</span>(rotation_degree_horizontal);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将鼠标位置重置到窗口中心</span></span><br><span class="line">    Mouse::<span class="built_in">setPosition</span>(center, window);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="增加decoration-sprite">增加<code>Decoration Sprite</code></h1>
<h2 id="必要变量">必要变量</h2>
<p>首先定义一系列变量：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// decoration纹理总数</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> textureNum_Decoration 3</span></span><br><span class="line"><span class="comment">// decoration总数</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> decorationNum 19</span></span><br></pre></td></tr></table></figure>
<p>画出一个decoration，需要记录<code>x, y, texture_index</code>，因此增加一个<code>Decoration</code>类：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/************************************************************/</span></span><br><span class="line"><span class="comment">/* Decoration</span></span><br><span class="line"><span class="comment">/************************************************************/</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Decoration</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">    <span class="type">double</span> x;</span><br><span class="line">    <span class="type">double</span> y;</span><br><span class="line">    <span class="type">int</span> texture_index;</span><br><span class="line">    <span class="type">int</span> type; <span class="comment">// 用于指明是decoration还是illustration</span></span><br><span class="line">    		 <span class="comment">// 0为decoration，1为illustration</span></span><br><span class="line">    <span class="built_in">Decoration</span>(<span class="type">double</span> x = <span class="number">0</span>, <span class="type">double</span> y = <span class="number">0</span>, <span class="type">int</span> texindex = <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">this</span>-&gt;x = x;</span><br><span class="line">        <span class="keyword">this</span>-&gt;y = y;</span><br><span class="line">        <span class="keyword">this</span>-&gt;texture_index = texindex;</span><br><span class="line">        <span class="keyword">this</span>-&gt;type = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>除此之外，decoration还需要读取新的纹理，新建一个纹理数组存储：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// decoration纹理数组</span></span><br><span class="line">Texture decoration_texture[textureNum_Decoration];</span><br></pre></td></tr></table></figure>
<p>还需要存储所有decoration的信息，建立<code>decoration_lst</code>数组存储<code>x, y, texture_index</code>：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// decoration数组，用于记录全部decoration的位置和对应纹理下标</span></span><br><span class="line">Decoration decoration_lst[decorationNum] =</span><br><span class="line">&#123;</span><br><span class="line">    &#123;<span class="number">20.5</span>, <span class="number">11.5</span>, <span class="number">0</span>&#125;, <span class="comment">// green light in front of playerstart</span></span><br><span class="line">    <span class="comment">// green lights in every room</span></span><br><span class="line">    &#123;<span class="number">18.5</span>, <span class="number">4.5</span>, <span class="number">0</span>&#125;,</span><br><span class="line">    &#123;<span class="number">10.0</span>, <span class="number">4.5</span>, <span class="number">0</span>&#125;,</span><br><span class="line">    &#123;<span class="number">10.0</span>, <span class="number">12.5</span>, <span class="number">0</span>&#125;,</span><br><span class="line">    &#123;<span class="number">3.5</span>, <span class="number">6.5</span>, <span class="number">0</span>&#125;,</span><br><span class="line">    &#123;<span class="number">3.5</span>, <span class="number">20.5</span>, <span class="number">0</span>&#125;,</span><br><span class="line">    &#123;<span class="number">3.5</span>, <span class="number">14.5</span>, <span class="number">0</span>&#125;,</span><br><span class="line">    &#123;<span class="number">14.5</span>, <span class="number">20.5</span>, <span class="number">0</span>&#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// row of pillars in front of wall: fisheye test</span></span><br><span class="line">    &#123;<span class="number">18.5</span>, <span class="number">10.5</span>, <span class="number">1</span>&#125;,</span><br><span class="line">    &#123;<span class="number">18.5</span>, <span class="number">11.5</span>, <span class="number">1</span>&#125;,</span><br><span class="line">    &#123;<span class="number">18.5</span>, <span class="number">12.5</span>, <span class="number">1</span>&#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// some barrels around the map</span></span><br><span class="line">    &#123;<span class="number">21.5</span>, <span class="number">1.5</span>, <span class="number">2</span>&#125;,</span><br><span class="line">    &#123;<span class="number">15.5</span>, <span class="number">1.5</span>, <span class="number">2</span>&#125;,</span><br><span class="line">    &#123;<span class="number">16.0</span>, <span class="number">1.8</span>, <span class="number">2</span>&#125;,</span><br><span class="line">    &#123;<span class="number">16.2</span>, <span class="number">1.2</span>, <span class="number">2</span>&#125;,</span><br><span class="line">    &#123;<span class="number">3.5</span>, <span class="number">2.5</span>, <span class="number">2</span>&#125;,</span><br><span class="line">    &#123;<span class="number">9.5</span>, <span class="number">15.5</span>, <span class="number">2</span>&#125;,</span><br><span class="line">    &#123;<span class="number">10.0</span>, <span class="number">15.1</span>, <span class="number">2</span>&#125;,</span><br><span class="line">    &#123;<span class="number">10.5</span>, <span class="number">15.8</span>, <span class="number">2</span>&#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>考虑到墙面的遮挡，需要建立一个<code>ZBuffer</code>数组，用于表示深度，即屏幕上每个<code>x</code>对应的<code>perpWallDist</code></p>
<p>人视角只能发出<code>screenWidth</code>束光线，于是就建立大小为<code>screenWidth</code>的<code>ZBuffer</code>：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ZBuffer数组，记录屏幕上每个x对应的perpWallDist</span></span><br><span class="line"><span class="type">double</span> ZBuffer[screenWidth] = &#123;<span class="number">0</span>&#125;;</span><br></pre></td></tr></table></figure>
<p>然后在<code>Wall_Casting</code>函数中对应位置更新<code>ZBuffer</code>：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="type">int</span> x = <span class="number">0</span>; x &lt; screenWidth; x++)</span><br><span class="line">&#123;</span><br><span class="line">	...</span><br><span class="line">    <span class="comment">// 此处求出perpWallDist</span></span><br><span class="line">    <span class="keyword">if</span> (side == <span class="number">0</span>)</span><br><span class="line">        perpWallDist = (sideDistX - deltaDistX);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        perpWallDist = (sideDistY - deltaDistY);</span><br><span class="line">    <span class="comment">// 紧接着更新ZBuffer</span></span><br><span class="line">    ZBuffer[x] = perpWallDist;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="读取纹理时透明处理">读取纹理时透明处理</h2>
<p>这是一张灯的贴图：</p>
<img src="/2024/05/24/%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/Raycasting%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95-%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%89%A9%E5%B1%95/greenlight.png" class title="greenlight">
<p>可以看到，只有顶部有图，剩下都是纯黑色部分</p>
<p>这些纯黑色部分在绘制的时候，应该画成“完全透明”的颜色，即<code>alpha</code>值改为<code>0</code></p>
<p>这一步操作可以在读取纹理的时候进行，我们先写一个<code>SetTexture_Alpha</code>函数，功能是遍历读取的纹理图像，将纯黑色的地方改为透明</p>
<p>SFML中对纹理图片的操作方法在上文<a href="#SFML-pixel_by_pixel">这里</a>提及，此处差不多</p>
<p>用读取的<code>texture</code>建立一个<code>image</code>，再对这个<code>image</code>进行逐像素操作，黑色改为完全透明，最后再把<code>texture</code>改写即可</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">SetTexture_Alpha</span><span class="params">(Texture *texture, <span class="type">int</span> start_index, <span class="type">int</span> end_index)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = start_index; i &lt;= end_index; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        Image tmp = texture[i].<span class="built_in">copyToImage</span>();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> y = <span class="number">0</span>; y &lt; tmp.<span class="built_in">getSize</span>().y; y++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> x = <span class="number">0</span>; x &lt; tmp.<span class="built_in">getSize</span>().x; x++)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (tmp.<span class="built_in">getPixel</span>(x, y) == Color::Black)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// 设置为完全透明</span></span><br><span class="line">                    tmp.<span class="built_in">setPixel</span>(x, y, sf::<span class="built_in">Color</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        texture[i].<span class="built_in">loadFromImage</span>(tmp); <span class="comment">// 用修改后的图像覆盖原数组的纹理</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后就能在读取纹理的时候调用这个函数，具体代码如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">LoadTexture</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 读取墙壁、地板天花板纹理</span></span><br><span class="line">    texture[<span class="number">0</span>].<span class="built_in">loadFromFile</span>(<span class="string">&quot;pics/eagle.png&quot;</span>);</span><br><span class="line">    texture[<span class="number">1</span>].<span class="built_in">loadFromFile</span>(<span class="string">&quot;pics/redbrick.png&quot;</span>);</span><br><span class="line">    texture[<span class="number">2</span>].<span class="built_in">loadFromFile</span>(<span class="string">&quot;pics/purplestone.png&quot;</span>);</span><br><span class="line">    texture[<span class="number">3</span>].<span class="built_in">loadFromFile</span>(<span class="string">&quot;pics/greystone.png&quot;</span>);</span><br><span class="line">    texture[<span class="number">4</span>].<span class="built_in">loadFromFile</span>(<span class="string">&quot;pics/bluestone.png&quot;</span>);</span><br><span class="line">    texture[<span class="number">5</span>].<span class="built_in">loadFromFile</span>(<span class="string">&quot;pics/mossy.png&quot;</span>);</span><br><span class="line">    texture[<span class="number">6</span>].<span class="built_in">loadFromFile</span>(<span class="string">&quot;pics/wood.png&quot;</span>);</span><br><span class="line">    texture[<span class="number">7</span>].<span class="built_in">loadFromFile</span>(<span class="string">&quot;pics/colorstone.png&quot;</span>);</span><br><span class="line">    <span class="comment">// 地板天花板渲染用的image</span></span><br><span class="line">    Ceiling_image = texture[<span class="number">6</span>].<span class="built_in">copyToImage</span>(); <span class="comment">// 天花板为木头</span></span><br><span class="line">    Floor_image = texture[<span class="number">3</span>].<span class="built_in">copyToImage</span>();   <span class="comment">// 地板为石头</span></span><br><span class="line">    <span class="comment">// 读取decoration纹理</span></span><br><span class="line">    decoration_texture[<span class="number">0</span>].<span class="built_in">loadFromFile</span>(<span class="string">&quot;pics/greenlight.png&quot;</span>);</span><br><span class="line">    decoration_texture[<span class="number">1</span>].<span class="built_in">loadFromFile</span>(<span class="string">&quot;pics/pillar.png&quot;</span>);</span><br><span class="line">    decoration_texture[<span class="number">2</span>].<span class="built_in">loadFromFile</span>(<span class="string">&quot;pics/barrel.png&quot;</span>);</span><br><span class="line">    <span class="comment">// 纯黑部分改透明</span></span><br><span class="line">    <span class="built_in">SetTexture_Alpha</span>(decoration_texture, <span class="number">0</span>, <span class="number">2</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="具体逻辑-2">具体逻辑</h2>
<p><a id="draw_Sprites"></a></p>
<p>理解这段逻辑，得对线性代数里面“基变换”的内容有所了解，不然可能就不知道我在说什么<del>（也可能是我讲解的方式不清楚）</del></p>
<p><a target="_blank" rel="noopener" href="https://lodev.org/cgtutor/raycasting3.html">原教程</a>里完全没有提到坐标变换的解释，因此我在这里会说的详细一点</p>
<ol type="1">
<li>将decoration从远到近排序，这样能实现先画远的，再画近的</li>
<li>得到decoration和玩家的相对位置，可以用decoration的坐标减去玩家坐标，得到一个从玩家指向decoration的向量<span class="math inline">\(\overrightarrow{a}\)</span>，这个是真实世界坐标轴下的向量（即以<span class="math inline">\((1,0),(0,1)\)</span>作为基的坐标系）</li>
<li>在以<span class="math inline">\(\overrightarrow{plane},\overrightarrow{dir}\)</span>为基的向量坐标系（这个坐标系貌似叫“相机坐标系”）下，指示玩家到decoration的向量为<span class="math inline">\(\overrightarrow{b}\)</span>，我们就需要求出这个<span class="math inline">\(\overrightarrow{b}\)</span>，从而正确画在屏幕上</li>
<li>根据<strong>基变换</strong>（如果对线性代数的基变换理解不是很清楚，墙裂推荐观看<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1ys411472E?p=13">《线性代数的本质：基变换》</a>这个章节，把<span class="math inline">\(\overrightarrow{b}\)</span>理解为真实世界坐标系下的“误解”就可以）：<span class="math inline">\(\overrightarrow{a}=Mat\cdot\overrightarrow{b}\)</span>，因此可以两遍同时左乘<span class="math inline">\(Mat^{-1}\)</span>得到<span class="math inline">\(\overrightarrow{b}\)</span>；也就是说，想得到<span class="math inline">\(\overrightarrow{a}\)</span>在以<span class="math inline">\(\overrightarrow{plane},\overrightarrow{dir}\)</span>为基向量的坐标系下怎么表示，左乘<span class="math inline">\(Mat^{-1}\)</span>就能得到答案</li>
<li>求出decoration Sprite在屏幕上的坐标</li>
<li>求出decoration
Sprite在屏幕上的范围，即<code>drawStartX, drawEndX, drawStartY</code>，可以不用求出<code>drawEndY</code>，因为这里和画墙一样取了个巧，纹理图案上一个<code>x</code>直接对应了宽度为1像素的一条纹理</li>
<li>绘制！这里跟画纹理墙的思路一模一样</li>
</ol>
<h3 id="排序">排序</h3>
<p>想在对应位置画出正确的decoration
Sprite，需要<strong>先画远处的，再画近处的</strong>，因为后画的近处Sprite会直接覆盖远处的图层，可以正确画出层叠关系</p>
<p>因此，我们需要在每一帧计算每个decoration与玩家的距离，存储在数组中，再排序就可以得到</p>
<p>为了防止下标混乱，这里把下标和距离绑定成一个<code>pair&lt;double, int&gt;</code>进行排序</p>
<p>同时为了获得这个<code>pair</code>，建立下标数组和距离数组：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// arrays used to sort the sprites</span></span><br><span class="line"><span class="comment">// Order数组和Distance数组，分别存储下标和离玩家的距离</span></span><br><span class="line"><span class="type">int</span> decoration_Order[decorationNum];</span><br><span class="line"><span class="type">double</span> decoration_Distance[decorationNum];</span><br></pre></td></tr></table></figure>
<p>排序函数调用C++的<code>sort</code>函数，针对<code>pair</code>默认就用第一个变量按升序排列</p>
<p>最后<strong>再按降序赋值到原数组</strong>中，就实现距离从远到近排列，并且下标数组元素和距离一一对应</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// sort algorithm</span></span><br><span class="line"><span class="comment">// sort the sprites based on distance</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">sortSprites</span><span class="params">(<span class="type">int</span> *order, <span class="type">double</span> *dist, <span class="type">int</span> amount)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    std::vector&lt;std::pair&lt;<span class="type">double</span>, <span class="type">int</span>&gt;&gt; <span class="built_in">sprites</span>(amount);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; amount; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        sprites[i].first = dist[i];</span><br><span class="line">        sprites[i].second = order[i];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 针对pair默认就用第一个变量按升序排列</span></span><br><span class="line">    std::<span class="built_in">sort</span>(sprites.<span class="built_in">begin</span>(), sprites.<span class="built_in">end</span>());</span><br><span class="line">    <span class="comment">// restore in reverse order to go from farthest to nearest</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; amount; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        dist[i] = sprites[amount - i - <span class="number">1</span>].first;</span><br><span class="line">        order[i] = sprites[amount - i - <span class="number">1</span>].second;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后遍历<code>decoration_Order</code>数组，就能拿到从远到近每一个decoration
Sprite的下标</p>
<h3 id="基变换">基变换</h3>
<p>具体逻辑那里可能讲的不是很清楚（？）那这里就根据代码讲解吧</p>
<p>首先，得到decoration和玩家的相对位置，可以用decoration的坐标减去玩家坐标，得到一个从玩家指向decoration的向量<span class="math inline">\(\overrightarrow{a}\)</span></p>
<p>这个向量<span class="math inline">\(\overrightarrow{a}\)</span>是真实世界坐标轴下的向量（即以<span class="math inline">\((1,0),(0,1)\)</span>作为基的坐标系）</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// translate sprite position to relative to camera</span></span><br><span class="line"><span class="type">double</span> spriteX = decoration_lst[decoration_Order[i]].x - posX;</span><br><span class="line"><span class="type">double</span> spriteY = decoration_lst[decoration_Order[i]].y - posY;</span><br></pre></td></tr></table></figure>
<p>如代码所示，向量<span class="math inline">\(\overrightarrow{a}\)</span>就可以表示为： <span class="math display">\[
\overrightarrow{a}=
\begin{bmatrix}
\text{spriteX}\\
\text{spriteY}
\end{bmatrix}
\]</span> <br></p>
<p>在以<span class="math inline">\(\overrightarrow{plane},\overrightarrow{dir}\)</span>为基的向量坐标系（这个坐标系貌似叫“相机坐标系”）下，指示玩家到decoration的向量为<span class="math inline">\(\overrightarrow{b}\)</span></p>
<p>我们就需要求出这个<span class="math inline">\(\overrightarrow{b}\)</span>，从而正确画在屏幕上</p>
<p>定义<span class="math inline">\(\overrightarrow{b}\)</span>向量为：
<span class="math display">\[
\overrightarrow{b}=
\begin{bmatrix}
\text{transformX} \\
\text{transformY}
\end{bmatrix}
\]</span> <br></p>
<p>根据<strong>基变换</strong>（再次墙裂推荐观看<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1ys411472E?p=13">《线性代数的本质：基变换》</a>这个章节），<span class="math inline">\(\overrightarrow{a}=Mat\cdot\overrightarrow{b}\)</span>，因此可以两遍同时左乘<span class="math inline">\(Mat^{-1}\)</span>求解<span class="math inline">\(\overrightarrow{b}\)</span>向量</p>
<p>其中，<span class="math inline">\(Mat\)</span>矩阵是以<span class="math inline">\(\overrightarrow{plane}\)</span>为第一列，<span class="math inline">\(\overrightarrow{dir}\)</span>为第二列的矩阵，定义为：
<span class="math display">\[
Mat=
\begin{bmatrix}
\text{planeX} &amp; \text{dirX} \\
\text{planeY} &amp; \text{dirY}
\end{bmatrix}
\]</span> 也就是说，想得到<span class="math inline">\(\overrightarrow{a}\)</span>在以<span class="math inline">\(\overrightarrow{plane},\overrightarrow{dir}\)</span>为基的向量坐标系下怎么表示，左乘<span class="math inline">\(Mat^{-1}\)</span>就能得到答案</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// transform sprite with the inverse camera matrix</span></span><br><span class="line"><span class="comment">//  [ planeX   dirX ] -1                                       [ dirY      -dirX ]</span></span><br><span class="line"><span class="comment">//  [               ]       =  1/(planeX*dirY-dirX*planeY) *   [                 ]</span></span><br><span class="line"><span class="comment">//  [ planeY   dirY ]                                          [ -planeY  planeX ]</span></span><br><span class="line"></span><br><span class="line"><span class="type">double</span> invDet = <span class="number">1.0</span> / (planeX * dirY - dirX * planeY); <span class="comment">// required for correct matrix multiplication</span></span><br><span class="line"></span><br><span class="line"><span class="type">double</span> transformX = invDet * (dirY * spriteX - dirX * spriteY);</span><br><span class="line"><span class="type">double</span> transformY = invDet * (-planeY * spriteX + planeX * spriteY); <span class="comment">// this is actually the depth inside the screen, that what Z is in 3D</span></span><br></pre></td></tr></table></figure>
<p>由于没有引入Eigen库，用不了线性代数运算，因此只能把逆矩阵的求法写成代码里的这样</p>
<p>这段代码的意思就是： <span class="math display">\[
\begin{align*}
\overrightarrow{b}&amp;=Mat^{-1}\cdot\overrightarrow{a}\\\\
\begin{bmatrix}
\text{transformX} \\
\text{transformY}
\end{bmatrix}&amp;=
\begin{bmatrix}
\text{planeX} &amp; \text{dirX} \\
\text{planeY} &amp; \text{dirY}
\end{bmatrix}^{-1}\cdot
\begin{bmatrix}
\text{spriteX}\\
\text{spriteY}
\end{bmatrix}
\end{align*}
\]</span> 故求出<span class="math inline">\(\overrightarrow{b}\)</span>向量： <span class="math display">\[
\overrightarrow{b}=
\begin{bmatrix}
\text{transformX} \\
\text{transformY}
\end{bmatrix}
\]</span></p>
<h3 id="计算decoration-sprite在屏幕上的范围">计算decoration
Sprite在屏幕上的范围</h3>
<p>首先计算sprite在屏幕上的<code>x</code>坐标</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// sprite在屏幕上的x坐标</span></span><br><span class="line"><span class="type">int</span> spriteScreenX = <span class="built_in">int</span>((screenWidth / <span class="number">2</span>) * (<span class="number">1</span> + transformX / transformY));</span><br></pre></td></tr></table></figure>
<p>理解这个可以采取一些极端情况，比如人物立绘就在视角正前方时，<code>transformX = 0, transformY != 0</code>（<span class="math inline">\(\overrightarrow{b}\)</span>向量是以<span class="math inline">\(\overrightarrow{plane},\overrightarrow{dir}\)</span>为基，<code>transformX = 0</code>表示没有左右偏移，即在正前方）</p>
<p>又比如有两个decoration Sprite:
A和B，对应的<code>transformX</code>完全一样，但是<code>transformY_B &gt; transformY_A</code>，画在图上就是：</p>
<img src="/2024/05/24/%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/Raycasting%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95-%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%89%A9%E5%B1%95/image-20240529163631237.png" class title="image-20240529163631237">
<p>C为A在屏幕上的点，D为B在屏幕上的点，明显看出D比C更靠近屏幕中心</p>
<p><br></p>
<p>计算<code>spriteHeight</code>与<code>spriteWidth</code>：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// calculate height of the sprite on screen</span></span><br><span class="line"><span class="type">int</span> spriteHeight = <span class="built_in">abs</span>(<span class="built_in">int</span>(screenHeight / (transformY))); <span class="comment">// using &#x27;transformY&#x27; instead of the real distance prevents fisheye</span></span><br><span class="line"><span class="comment">// calculate width of the sprite</span></span><br><span class="line"><span class="type">int</span> spriteWidth = <span class="built_in">abs</span>(<span class="built_in">int</span>(screenHeight / (transformY)));</span><br></pre></td></tr></table></figure>
<p>用屏幕的宽度和高度做比例就行</p>
<p><br></p>
<p>计算<code>drawStartX, drawEndX, drawStartY</code>，这部分很好理解</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// calculate lowest and highest pixel to fill in current stripe</span></span><br><span class="line"><span class="comment">// 计算y上的起点，不需要计算终点，因为竖线直接指定了Sprite的高度</span></span><br><span class="line"><span class="type">int</span> drawStartY = -spriteHeight / <span class="number">2</span> + screenHeight / <span class="number">2</span>;</span><br><span class="line"><span class="comment">// if (drawStartY &lt; 0) drawStartY = 0;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 计算x上的起点和终点</span></span><br><span class="line"><span class="type">int</span> drawStartX = -spriteWidth / <span class="number">2</span> + spriteScreenX;</span><br><span class="line"><span class="keyword">if</span> (drawStartX &lt; <span class="number">0</span>)</span><br><span class="line">    drawStartX = <span class="number">0</span>;</span><br><span class="line"><span class="type">int</span> drawEndX = spriteWidth / <span class="number">2</span> + spriteScreenX;</span><br><span class="line"><span class="keyword">if</span> (drawEndX &gt;= screenWidth)</span><br><span class="line">    drawEndX = screenWidth - <span class="number">1</span>;</span><br></pre></td></tr></table></figure>
<p><code>drawStartY</code>还是以屏幕中心<code>screenHeight/ 2</code>为基准做减法</p>
<p><code>drawStartX</code>和<code>drawEndX</code>：以纹理坐标中心<code>spriteScreenX</code>为基准，加减<code>spriteWidth / 2</code></p>
<h3 id="绘制">绘制</h3>
<p>然后就可以从<code>drawStartX</code>遍历到<code>drawEndX</code>进行绘制</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// loop through every vertical stripe of the sprite on screen</span></span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> stripe = drawStartX; stripe &lt; drawEndX; stripe++)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> texX = <span class="built_in">int</span>(<span class="number">256</span> * (stripe - (-spriteWidth / <span class="number">2</span> + spriteScreenX)) * texWidth / spriteWidth) / <span class="number">256</span>;</span><br><span class="line">    <span class="comment">// the conditions in the if are:</span></span><br><span class="line">    <span class="comment">// 1) it&#x27;s in front of camera plane so you don&#x27;t see things behind you</span></span><br><span class="line">    <span class="comment">// 2) it&#x27;s on the screen (left)</span></span><br><span class="line">    <span class="comment">// 3) it&#x27;s on the screen (right)</span></span><br><span class="line">    <span class="comment">// 4) ZBuffer, with perpendicular distance</span></span><br><span class="line">    <span class="keyword">if</span> (transformY &gt; <span class="number">0</span> &amp;&amp; stripe &gt; <span class="number">0</span> &amp;&amp; stripe &lt; screenWidth &amp;&amp; transformY &lt; ZBuffer[stripe])</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// decoration一条线的Sprite</span></span><br><span class="line">        Sprite decoration_sprite;</span><br><span class="line">        <span class="comment">// 设置对应纹理</span></span><br><span class="line">        decoration_sprite.<span class="built_in">setTexture</span>(decoration_texture[decoration_lst[decoration_Order[i]].texture_index]);</span><br><span class="line">        <span class="comment">// 设置sprite的纹理矩形，定义了在纹理中的哪个部分应用到decoration_sprite上</span></span><br><span class="line">        <span class="comment">// 宽度为1个像素，相当于原来的画线</span></span><br><span class="line">        decoration_sprite.<span class="built_in">setTextureRect</span>(sf::<span class="built_in">IntRect</span>(texX, <span class="number">0</span>, <span class="number">1</span>, texHeight));</span><br><span class="line">        <span class="comment">// 设置sprite的位置，坐标指定了左上角的位置</span></span><br><span class="line">        decoration_sprite.<span class="built_in">setPosition</span>(stripe, drawStartY);</span><br><span class="line">        <span class="comment">// 设置sprite的缩放因子</span></span><br><span class="line">        decoration_sprite.<span class="built_in">setScale</span>(<span class="number">1</span>, spriteHeight / (<span class="type">float</span>)texHeight);</span><br><span class="line">        <span class="comment">// 绘制sprite</span></span><br><span class="line">        window.<span class="built_in">draw</span>(decoration_sprite);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>绘制步骤还是和画纹理墙一样：</p>
<ol type="1">
<li>利用<code>texX</code>求出纹理图像上对应到当前像素列的位置</li>
<li>建立一个新的<code>Sprite</code>，对其设置相应纹理</li>
<li>设置这个<code>Sprite</code>为宽1个像素，高<code>texHeight</code>，相当于原来的画线</li>
<li>设置<code>Sprite</code>的位置，坐标指定了左上角的位置</li>
<li>设置<code>Sprite</code>的缩放因子，具体缩放<code>y</code>方向上的，缩放大小为<code>spriteHeight / (float)texHeight</code></li>
<li>调用<code>draw</code>函数绘制</li>
</ol>
<p>首先是求出<code>texX</code>：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> texX = <span class="built_in">int</span>(<span class="number">256</span> * (stripe - (-spriteWidth / <span class="number">2</span> + spriteScreenX)) * texWidth / spriteWidth) / <span class="number">256</span>;</span><br></pre></td></tr></table></figure>
<p>其中，<code>stripe - (-spriteWidth / 2 + spriteScreenX)</code>是计算出当前遍历的<code>x</code>坐标与<code>Sprite</code>在屏幕上的中心位置的偏移量</p>
<p>这个偏移量乘以<code>256</code>和<code>texWidth / spriteWidth</code>，这里的<code>256</code>是一个放大因子，用来增加精度；<code>texWidth / spriteWidth</code>是纹理图像宽度和<code>Sprite</code>宽度的比例，用来将偏移量从Sprite的宽度转换到纹理的宽度</p>
<p>这个放大因子有没有好像都不是很影响</p>
<p><br></p>
<p>紧接着就是绘制部分，绘制条件有几点：</p>
<ol type="1">
<li>当前深度<code>transformY</code>与<code>ZBuffer[stripe]</code>做比较，如果当前深度小于远处墙的<code>perpWallDist</code>，就能画，不然就应该被墙挡住</li>
<li><code>stripe &gt; 0 &amp;&amp; stripe &lt; screenWidth</code>，即在屏幕范围内，如果<code>drawStartX</code>到<code>drawEndX</code>在屏幕之外，就不用画了</li>
<li><code>transformY &gt; 0</code>，即在面前的才能画，如果在身后就不能画</li>
</ol>
<p>然后就正常绘制</p>
<p>结果如下：</p>
<img src="/2024/05/24/%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/Raycasting%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95-%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%89%A9%E5%B1%95/image-20240529170646853.png" class title="image-20240529170646853">
<p>还是很不错的</p>
<h2 id="源代码">源代码</h2>
<p><code>Decoration_Casting</code>函数代码如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 画出Decoration Sprite</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Decoration_Casting</span><span class="params">(RenderWindow &amp;window)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; decorationNum; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        decoration_Order[i] = i;</span><br><span class="line">        decoration_Distance[i] = ((posX - decoration_lst[i].x) * (posX - decoration_lst[i].x) + (posY - decoration_lst[i].y) * (posY - decoration_lst[i].y)); <span class="comment">// sqrt not taken, unneeded</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 排序</span></span><br><span class="line">    <span class="comment">// 先画远的再画近的不会导致透明遮挡问题</span></span><br><span class="line">    <span class="comment">// 因为近的Sprite透明地方可以直接显示出远的Sprite</span></span><br><span class="line">    <span class="built_in">sortSprites</span>(decoration_Order, decoration_Distance, decorationNum);</span><br><span class="line">    <span class="comment">// after sorting the sprites, do the projection and draw them</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; decorationNum; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// translate sprite position to relative to camera</span></span><br><span class="line">        <span class="type">double</span> spriteX = decoration_lst[decoration_Order[i]].x - posX;</span><br><span class="line">        <span class="type">double</span> spriteY = decoration_lst[decoration_Order[i]].y - posY;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// transform sprite with the inverse camera matrix</span></span><br><span class="line">        <span class="comment">//  [ planeX   dirX ] -1                                       [ dirY      -dirX ]</span></span><br><span class="line">        <span class="comment">//  [               ]       =  1/(planeX*dirY-dirX*planeY) *   [                 ]</span></span><br><span class="line">        <span class="comment">//  [ planeY   dirY ]                                          [ -planeY  planeX ]</span></span><br><span class="line"></span><br><span class="line">        <span class="type">double</span> invDet = <span class="number">1.0</span> / (planeX * dirY - dirX * planeY); <span class="comment">// required for correct matrix multiplication</span></span><br><span class="line"></span><br><span class="line">        <span class="type">double</span> transformX = invDet * (dirY * spriteX - dirX * spriteY);</span><br><span class="line">        <span class="type">double</span> transformY = invDet * (-planeY * spriteX + planeX * spriteY); <span class="comment">// this is actually the depth inside the screen, that what Z is in 3D</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// sprite在屏幕上的x坐标</span></span><br><span class="line">        <span class="type">int</span> spriteScreenX = <span class="built_in">int</span>((screenWidth / <span class="number">2</span>) * (<span class="number">1</span> + transformX / transformY));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// calculate height of the sprite on screen</span></span><br><span class="line">        <span class="type">int</span> spriteHeight = <span class="built_in">abs</span>(<span class="built_in">int</span>(screenHeight / (transformY))); <span class="comment">// using &#x27;transformY&#x27; instead of the real distance prevents fisheye</span></span><br><span class="line">        <span class="comment">// calculate width of the sprite</span></span><br><span class="line">        <span class="type">int</span> spriteWidth = <span class="built_in">abs</span>(<span class="built_in">int</span>(screenHeight / (transformY)));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// calculate lowest and highest pixel to fill in current stripe</span></span><br><span class="line">        <span class="comment">// 计算y上的起点，不需要计算终点，因为竖线直接指定了Sprite的高度</span></span><br><span class="line">        <span class="type">int</span> drawStartY = -spriteHeight / <span class="number">2</span> + screenHeight / <span class="number">2</span>;</span><br><span class="line">        <span class="comment">// if (drawStartY &lt; 0) drawStartY = 0;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 计算x上的起点和终点</span></span><br><span class="line">        <span class="type">int</span> drawStartX = -spriteWidth / <span class="number">2</span> + spriteScreenX;</span><br><span class="line">        <span class="keyword">if</span> (drawStartX &lt; <span class="number">0</span>)</span><br><span class="line">            drawStartX = <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> drawEndX = spriteWidth / <span class="number">2</span> + spriteScreenX;</span><br><span class="line">        <span class="keyword">if</span> (drawEndX &gt;= screenWidth)</span><br><span class="line">            drawEndX = screenWidth - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// loop through every vertical stripe of the sprite on screen</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> stripe = drawStartX; stripe &lt; drawEndX; stripe++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="type">int</span> texX = <span class="built_in">int</span>(<span class="number">256</span> * (stripe - (-spriteWidth / <span class="number">2</span> + spriteScreenX)) * texWidth / spriteWidth) / <span class="number">256</span>;</span><br><span class="line">            <span class="comment">// the conditions in the if are:</span></span><br><span class="line">            <span class="comment">// 1) it&#x27;s in front of camera plane so you don&#x27;t see things behind you</span></span><br><span class="line">            <span class="comment">// 2) it&#x27;s on the screen (left)</span></span><br><span class="line">            <span class="comment">// 3) it&#x27;s on the screen (right)</span></span><br><span class="line">            <span class="comment">// 4) ZBuffer, with perpendicular distance</span></span><br><span class="line">            <span class="keyword">if</span> (transformY &gt; <span class="number">0</span> &amp;&amp; stripe &gt; <span class="number">0</span> &amp;&amp; stripe &lt; screenWidth &amp;&amp; transformY &lt; ZBuffer[stripe])</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// decoration一条线的Sprite</span></span><br><span class="line">                Sprite decoration_sprite;</span><br><span class="line">                <span class="comment">// 设置对应纹理</span></span><br><span class="line">                decoration_sprite.<span class="built_in">setTexture</span>(decoration_texture[decoration_lst[decoration_Order[i]].texture_index]);</span><br><span class="line">                <span class="comment">// 设置sprite的纹理矩形，定义了在纹理中的哪个部分应用到decoration_sprite上</span></span><br><span class="line">                <span class="comment">// 宽度为1个像素，相当于原来的画线</span></span><br><span class="line">                decoration_sprite.<span class="built_in">setTextureRect</span>(sf::<span class="built_in">IntRect</span>(texX, <span class="number">0</span>, <span class="number">1</span>, texHeight));</span><br><span class="line">                <span class="comment">// 设置sprite的位置，坐标指定了左上角的位置</span></span><br><span class="line">                decoration_sprite.<span class="built_in">setPosition</span>(stripe, drawStartY);</span><br><span class="line">                <span class="comment">// 设置sprite的缩放因子</span></span><br><span class="line">                decoration_sprite.<span class="built_in">setScale</span>(<span class="number">1</span>, spriteHeight / (<span class="type">float</span>)texHeight);</span><br><span class="line">                <span class="comment">// 绘制sprite</span></span><br><span class="line">                window.<span class="built_in">draw</span>(decoration_sprite);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1 id="增加illustration-sprite">增加<code>Illustration Sprite</code></h1>
<p>这是我的私货，我是一个WA2粉丝，于是就想着能不能在我的<code>raycaster</code>里面把小木曾雪菜的立绘显示出来</p>
<h2 id="wa2立绘解包">《WA2》立绘解包</h2>
<p>解包WA2立绘工程参考<a target="_blank" rel="noopener" href="https://www.bilibili.com/read/cv30532434/">《白色相簿2》中的PAK文件解包</a></p>
<p>下载对应的<a target="_blank" rel="noopener" href="https://allenheartcore.github.io/assets/bili/reveng_wa2_unpak.zip">素材包</a>，然后把游戏立绘<code>char.pak</code>复制到同一路径</p>
<p>cmd中运行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python wa2_unpak.py char.pak</span><br></pre></td></tr></table></figure>
<p>就能把立绘文件解压出来了</p>
<h2 id="必要变量-1">必要变量</h2>
<p>跟刚刚的decoration几乎一样，声明如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// illustration纹理总数</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> textureNum_Illustration 12</span></span><br><span class="line"><span class="comment">// illustration总数</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> illustrationNum 12</span></span><br><span class="line"><span class="comment">// 人物立绘宽高</span></span><br><span class="line"><span class="comment">// 由于人物立绘各个尺寸不一样，因此需要把所有图片缩放到370x690</span></span><br><span class="line"><span class="comment">// 缩放已经通过python实现，此处代码不考虑</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> illustrationWidth 370</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> illustrationHeight 690</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//更新了一下posX</span></span><br><span class="line"><span class="type">double</span> posX = <span class="number">22.5</span>, posY = <span class="number">11.5</span>;  <span class="comment">// x and y start position</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/************************************************************/</span></span><br><span class="line"><span class="comment">/* illustration</span></span><br><span class="line"><span class="comment">/************************************************************/</span></span><br><span class="line"><span class="comment">// illustration纹理数组</span></span><br><span class="line">Texture illustration_texture[textureNum_Illustration];</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Illustration</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">    <span class="type">double</span> x;</span><br><span class="line">    <span class="type">double</span> y;</span><br><span class="line">    <span class="type">int</span> texture_index;</span><br><span class="line">    <span class="type">int</span> type; <span class="comment">// 用于指明是decoration还是illustration</span></span><br><span class="line">    <span class="comment">// 0为decoration，1为illustration</span></span><br><span class="line">    <span class="built_in">Illustration</span>(<span class="type">double</span> x = <span class="number">0</span>, <span class="type">double</span> y = <span class="number">0</span>, <span class="type">int</span> texindex = <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">this</span>-&gt;x = x;</span><br><span class="line">        <span class="keyword">this</span>-&gt;y = y;</span><br><span class="line">        <span class="keyword">this</span>-&gt;texture_index = texindex;</span><br><span class="line">        <span class="keyword">this</span>-&gt;type = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// illustration数组，用于记录全部illustration的位置和对应纹理下标</span></span><br><span class="line">Illustration illustration_lst[illustrationNum] =</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 北原春希立绘，刚进游戏就能看见</span></span><br><span class="line">    &#123;<span class="number">20.6</span>, <span class="number">11.5</span>, <span class="number">0</span>&#125;,</span><br><span class="line">    <span class="comment">// 小木曾雪菜流汗黄豆立绘</span></span><br><span class="line">    &#123;<span class="number">18</span>, <span class="number">3.25</span>, <span class="number">1</span>&#125;,</span><br><span class="line">    <span class="comment">// 小木曾雪菜怒立绘</span></span><br><span class="line">    &#123;<span class="number">8.0</span>, <span class="number">4.5</span>, <span class="number">2</span>&#125;,</span><br><span class="line">    <span class="comment">// 小木曾雪菜哭1</span></span><br><span class="line">    &#123;<span class="number">21</span>,<span class="number">8</span>,<span class="number">3</span>&#125;,</span><br><span class="line">    <span class="comment">// 小木曾雪菜哭2</span></span><br><span class="line">    &#123;<span class="number">22.5</span>,<span class="number">3.5</span>,<span class="number">4</span>&#125;,</span><br><span class="line">    <span class="comment">// 冬马和纱斗鸡眼</span></span><br><span class="line">    &#123;<span class="number">17.1</span>,<span class="number">14.7</span>,<span class="number">5</span>&#125;,</span><br><span class="line">    <span class="comment">// 冬马和纱怒</span></span><br><span class="line">    &#123;<span class="number">22.5</span>,<span class="number">18.5</span>,<span class="number">6</span>&#125;,</span><br><span class="line">    <span class="comment">// 冬马和纱闭眼</span></span><br><span class="line">    &#123;<span class="number">16.8</span>,<span class="number">21.5</span>,<span class="number">7</span>&#125;,</span><br><span class="line">    <span class="comment">// 冬马和纱笑</span></span><br><span class="line">    &#123;<span class="number">3</span>,<span class="number">12</span>,<span class="number">8</span>&#125;,</span><br><span class="line">    <span class="comment">// 杉浦小春</span></span><br><span class="line">    &#123;<span class="number">10.1</span>,<span class="number">18.3</span>,<span class="number">9</span>&#125;,</span><br><span class="line">    <span class="comment">// 和泉千晶</span></span><br><span class="line">    &#123;<span class="number">2.5</span>,<span class="number">21.2</span>,<span class="number">10</span>&#125;,</span><br><span class="line">    <span class="comment">// 风冈麻理</span></span><br><span class="line">    &#123;<span class="number">6.4</span>,<span class="number">19.2</span>,<span class="number">11</span>&#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// arrays used to sort the sprites</span></span><br><span class="line"><span class="comment">// Order数组和Distance数组，分别存储下标和离玩家的距离</span></span><br><span class="line"><span class="type">int</span> illustration_Order[illustrationNum];</span><br><span class="line"><span class="type">double</span> illustration_Distance[illustrationNum];</span><br></pre></td></tr></table></figure>
<p><strong>注意</strong>，立绘解包出来的长宽各不一样，我用python把用到的立绘全部<code>resize</code>到了<code>370 x 690</code>像素，对应python代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义输入和输出文件夹路径</span></span><br><span class="line">input_folder = <span class="string">&#x27;./&#x27;</span></span><br><span class="line">output_folder = <span class="string">&#x27;./resized&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建输出文件夹（如果不存在）</span></span><br><span class="line">os.makedirs(output_folder, exist_ok=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义新的尺寸</span></span><br><span class="line">new_size = (<span class="number">370</span>, <span class="number">690</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 遍历输入文件夹中的所有文件</span></span><br><span class="line"><span class="keyword">for</span> filename <span class="keyword">in</span> os.listdir(input_folder):</span><br><span class="line">    <span class="keyword">if</span> filename.endswith((<span class="string">&#x27;.png&#x27;</span>, <span class="string">&#x27;.jpg&#x27;</span>, <span class="string">&#x27;.jpeg&#x27;</span>, <span class="string">&#x27;.bmp&#x27;</span>, <span class="string">&#x27;.tiff&#x27;</span>)):</span><br><span class="line">        <span class="comment"># 构建完整的文件路径</span></span><br><span class="line">        file_path = os.path.join(input_folder, filename)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 读取图像文件</span></span><br><span class="line">        image = cv2.imread(file_path)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> image <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="comment"># 调整图像大小</span></span><br><span class="line">            resized_image = cv2.resize(image, new_size, interpolation=cv2.INTER_AREA)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 构建输出文件路径</span></span><br><span class="line">            output_path = os.path.join(output_folder, filename)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 保存调整大小后的图像</span></span><br><span class="line">            cv2.imwrite(output_path, resized_image)</span><br><span class="line"></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&#x27;Resized and saved <span class="subst">&#123;filename&#125;</span> to <span class="subst">&#123;output_path&#125;</span>&#x27;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&#x27;Failed to read <span class="subst">&#123;file_path&#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;All images have been resized.&#x27;</span>)</span><br></pre></td></tr></table></figure>
<h2 id="读取纹理透明处理">读取纹理透明处理</h2>
<p>逻辑还是一样的，首先读取纹理，然后调用修改<code>alpha</code>函数</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">LoadTexture</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 读取墙壁、地板天花板纹理</span></span><br><span class="line">    texture[<span class="number">0</span>].<span class="built_in">loadFromFile</span>(<span class="string">&quot;pics/eagle.png&quot;</span>);</span><br><span class="line">    texture[<span class="number">1</span>].<span class="built_in">loadFromFile</span>(<span class="string">&quot;pics/redbrick.png&quot;</span>);</span><br><span class="line">    texture[<span class="number">2</span>].<span class="built_in">loadFromFile</span>(<span class="string">&quot;pics/purplestone.png&quot;</span>);</span><br><span class="line">    texture[<span class="number">3</span>].<span class="built_in">loadFromFile</span>(<span class="string">&quot;pics/greystone.png&quot;</span>);</span><br><span class="line">    texture[<span class="number">4</span>].<span class="built_in">loadFromFile</span>(<span class="string">&quot;pics/bluestone.png&quot;</span>);</span><br><span class="line">    texture[<span class="number">5</span>].<span class="built_in">loadFromFile</span>(<span class="string">&quot;pics/mossy.png&quot;</span>);</span><br><span class="line">    texture[<span class="number">6</span>].<span class="built_in">loadFromFile</span>(<span class="string">&quot;pics/wood.png&quot;</span>);</span><br><span class="line">    texture[<span class="number">7</span>].<span class="built_in">loadFromFile</span>(<span class="string">&quot;pics/colorstone.png&quot;</span>);</span><br><span class="line">    <span class="comment">// 地板天花板渲染用的image</span></span><br><span class="line">    Ceiling_image = texture[<span class="number">6</span>].<span class="built_in">copyToImage</span>(); <span class="comment">// 天花板为木头</span></span><br><span class="line">    Floor_image = texture[<span class="number">3</span>].<span class="built_in">copyToImage</span>();   <span class="comment">// 地板为石头</span></span><br><span class="line">    <span class="comment">// 读取decoration纹理</span></span><br><span class="line">    decoration_texture[<span class="number">0</span>].<span class="built_in">loadFromFile</span>(<span class="string">&quot;pics/greenlight.png&quot;</span>);</span><br><span class="line">    decoration_texture[<span class="number">1</span>].<span class="built_in">loadFromFile</span>(<span class="string">&quot;pics/pillar.png&quot;</span>);</span><br><span class="line">    decoration_texture[<span class="number">2</span>].<span class="built_in">loadFromFile</span>(<span class="string">&quot;pics/barrel.png&quot;</span>);</span><br><span class="line">    <span class="comment">// 纯黑部分改透明</span></span><br><span class="line">    <span class="built_in">SetTexture_Alpha</span>(decoration_texture, <span class="number">0</span>, <span class="number">2</span>);</span><br><span class="line">    <span class="comment">// 读取illustration纹理</span></span><br><span class="line">    illustration_texture[<span class="number">0</span>].<span class="built_in">loadFromFile</span>(<span class="string">&quot;illustration/haruki.png&quot;</span>);</span><br><span class="line">    illustration_texture[<span class="number">1</span>].<span class="built_in">loadFromFile</span>(<span class="string">&quot;illustration/setsuna0.png&quot;</span>);</span><br><span class="line">    illustration_texture[<span class="number">2</span>].<span class="built_in">loadFromFile</span>(<span class="string">&quot;illustration/setsuna1.png&quot;</span>);</span><br><span class="line">    illustration_texture[<span class="number">3</span>].<span class="built_in">loadFromFile</span>(<span class="string">&quot;illustration/setsuna2.png&quot;</span>);</span><br><span class="line">    illustration_texture[<span class="number">4</span>].<span class="built_in">loadFromFile</span>(<span class="string">&quot;illustration/setsuna3.png&quot;</span>);</span><br><span class="line">    illustration_texture[<span class="number">5</span>].<span class="built_in">loadFromFile</span>(<span class="string">&quot;illustration/kazusa0.png&quot;</span>);</span><br><span class="line">    illustration_texture[<span class="number">6</span>].<span class="built_in">loadFromFile</span>(<span class="string">&quot;illustration/kazusa1.png&quot;</span>);</span><br><span class="line">    illustration_texture[<span class="number">7</span>].<span class="built_in">loadFromFile</span>(<span class="string">&quot;illustration/kazusa2.png&quot;</span>);</span><br><span class="line">    illustration_texture[<span class="number">8</span>].<span class="built_in">loadFromFile</span>(<span class="string">&quot;illustration/kazusa3.png&quot;</span>);</span><br><span class="line">    illustration_texture[<span class="number">9</span>].<span class="built_in">loadFromFile</span>(<span class="string">&quot;illustration/koharu.png&quot;</span>);</span><br><span class="line">    illustration_texture[<span class="number">10</span>].<span class="built_in">loadFromFile</span>(<span class="string">&quot;illustration/chiaki.png&quot;</span>);</span><br><span class="line">    illustration_texture[<span class="number">11</span>].<span class="built_in">loadFromFile</span>(<span class="string">&quot;illustration/mari.png&quot;</span>);</span><br><span class="line">    <span class="comment">// 纯黑部分改透明</span></span><br><span class="line">    <span class="built_in">SetTexture_Alpha</span>(illustration_texture, <span class="number">0</span>, <span class="number">11</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="源代码-1">源代码</h2>
<p><a href="#draw_Sprites">逻辑</a>也是一样的，代码如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 画出illustration Sprite</span></span><br><span class="line"><span class="comment">// 如果illustration与decoration分开画，会导致透明遮挡问题</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Illustration_Casting</span><span class="params">(RenderWindow &amp;window)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; illustrationNum; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        illustration_Order[i] = i;</span><br><span class="line">        illustration_Distance[i] = ((posX - illustration_lst[i].x) * (posX - illustration_lst[i].x) + (posY - illustration_lst[i].y) * (posY - illustration_lst[i].y)); <span class="comment">// sqrt not taken, unneeded</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 排序</span></span><br><span class="line">    <span class="comment">// 先画远的再画近的不会导致透明遮挡问题</span></span><br><span class="line">    <span class="comment">// 因为近的Sprite透明地方可以直接显示出远的Sprite</span></span><br><span class="line">    <span class="built_in">sortSprites</span>(illustration_Order, illustration_Distance, illustrationNum);</span><br><span class="line">    <span class="comment">// after sorting the sprites, do the projection and draw them</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; illustrationNum; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// translate sprite position to relative to camera</span></span><br><span class="line">        <span class="type">double</span> spriteX = illustration_lst[illustration_Order[i]].x - posX;</span><br><span class="line">        <span class="type">double</span> spriteY = illustration_lst[illustration_Order[i]].y - posY;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// transform sprite with the inverse camera matrix</span></span><br><span class="line">        <span class="comment">//  [ planeX   dirX ] -1                                       [ dirY      -dirX ]</span></span><br><span class="line">        <span class="comment">//  [               ]       =  1/(planeX*dirY-dirX*planeY) *   [                 ]</span></span><br><span class="line">        <span class="comment">//  [ planeY   dirY ]                                          [ -planeY  planeX ]</span></span><br><span class="line"></span><br><span class="line">        <span class="type">double</span> invDet = <span class="number">1.0</span> / (planeX * dirY - dirX * planeY); <span class="comment">// required for correct matrix multiplication</span></span><br><span class="line"></span><br><span class="line">        <span class="type">double</span> transformX = invDet * (dirY * spriteX - dirX * spriteY);</span><br><span class="line">        <span class="type">double</span> transformY = invDet * (-planeY * spriteX + planeX * spriteY); <span class="comment">// this is actually the depth inside the screen, that what Z is in 3D</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// sprite在屏幕上的x坐标</span></span><br><span class="line">        <span class="type">int</span> spriteScreenX = <span class="built_in">int</span>((screenWidth / <span class="number">2</span>) * (<span class="number">1</span> + transformX / transformY));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// calculate height of the sprite on screen</span></span><br><span class="line">        <span class="comment">// 注意illustration这里需要给高度乘一个illustrationHeight / illustrationWidth</span></span><br><span class="line">        <span class="comment">// 用于保持长宽比，不然不好看，北原春希都被压成正方形了</span></span><br><span class="line">        <span class="type">int</span> spriteHeight = <span class="built_in">abs</span>(<span class="built_in">int</span>(screenHeight / (transformY))) * illustrationHeight / illustrationWidth; <span class="comment">// using &#x27;transformY&#x27; instead of the real distance prevents fisheye</span></span><br><span class="line">        <span class="comment">// calculate width of the sprite</span></span><br><span class="line">        <span class="type">int</span> spriteWidth = <span class="built_in">abs</span>(<span class="built_in">int</span>(screenHeight / (transformY)));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// calculate lowest and highest pixel to fill in current stripe</span></span><br><span class="line">        <span class="comment">// 计算y上的起点，不需要计算终点，因为竖线直接指定了Sprite的高度</span></span><br><span class="line">        <span class="type">int</span> drawStartY = -spriteHeight / <span class="number">2</span> + screenHeight / <span class="number">2</span>;</span><br><span class="line">        <span class="comment">// if (drawStartY &lt; 0) drawStartY = 0;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 计算x上的起点和终点</span></span><br><span class="line">        <span class="type">int</span> drawStartX = -spriteWidth / <span class="number">2</span> + spriteScreenX;</span><br><span class="line">        <span class="keyword">if</span> (drawStartX &lt; <span class="number">0</span>)</span><br><span class="line">            drawStartX = <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> drawEndX = spriteWidth / <span class="number">2</span> + spriteScreenX;</span><br><span class="line">        <span class="keyword">if</span> (drawEndX &gt;= screenWidth)</span><br><span class="line">            drawEndX = screenWidth - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// loop through every vertical stripe of the sprite on screen</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> stripe = drawStartX; stripe &lt; drawEndX; stripe++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="type">int</span> texX = <span class="built_in">int</span>(<span class="number">256</span> * (stripe - (-spriteWidth / <span class="number">2</span> + spriteScreenX)) * illustrationWidth / spriteWidth) / <span class="number">256</span>;</span><br><span class="line">            <span class="comment">// the conditions in the if are:</span></span><br><span class="line">            <span class="comment">// 1) it&#x27;s in front of camera plane so you don&#x27;t see things behind you</span></span><br><span class="line">            <span class="comment">// 2) it&#x27;s on the screen (left)</span></span><br><span class="line">            <span class="comment">// 3) it&#x27;s on the screen (right)</span></span><br><span class="line">            <span class="comment">// 4) ZBuffer, with perpendicular distance</span></span><br><span class="line">            <span class="keyword">if</span> (transformY &gt; <span class="number">0</span> &amp;&amp; stripe &gt; <span class="number">0</span> &amp;&amp; stripe &lt; screenWidth &amp;&amp; transformY &lt; ZBuffer[stripe])</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// illustration一条线的Sprite</span></span><br><span class="line">                Sprite illustration_sprite;</span><br><span class="line">                <span class="comment">// 设置对应纹理</span></span><br><span class="line">                illustration_sprite.<span class="built_in">setTexture</span>(illustration_texture[illustration_lst[illustration_Order[i]].texture_index]);</span><br><span class="line">                <span class="comment">// 设置sprite的纹理矩形，定义了在纹理中的哪个部分应用到illustration_sprite上</span></span><br><span class="line">                <span class="comment">// 宽度为1个像素，相当于原来的画线</span></span><br><span class="line">                illustration_sprite.<span class="built_in">setTextureRect</span>(sf::<span class="built_in">IntRect</span>(texX, <span class="number">0</span>, <span class="number">1</span>, illustrationHeight));</span><br><span class="line">                <span class="comment">// 设置sprite的位置，坐标指定了左上角的位置</span></span><br><span class="line">                illustration_sprite.<span class="built_in">setPosition</span>(stripe, drawStartY);</span><br><span class="line">                <span class="comment">// 设置sprite的缩放因子</span></span><br><span class="line">                illustration_sprite.<span class="built_in">setScale</span>(<span class="number">1</span>, spriteHeight / (<span class="type">float</span>)illustrationHeight);</span><br><span class="line">                <span class="comment">// 绘制sprite</span></span><br><span class="line">                window.<span class="built_in">draw</span>(illustration_sprite);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>不过需要注意一点：计算<code>spriteHeight</code>时，需要乘长宽比，不然立绘画出来就被压成正方形，如图：</p>
<img src="/2024/05/24/%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/Raycasting%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95-%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%89%A9%E5%B1%95/image-20240529171950235.png" class title="image-20240529171950235">
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// calculate height of the sprite on screen</span></span><br><span class="line"><span class="comment">// 注意illustration这里需要给高度乘一个illustrationHeight / illustrationWidth</span></span><br><span class="line"><span class="comment">// 用于保持长宽比，不然不好看，北原春希都被压成正方形了</span></span><br><span class="line"><span class="type">int</span> spriteHeight = <span class="built_in">abs</span>(<span class="built_in">int</span>(screenHeight / (transformY))) * illustrationHeight / illustrationWidth;  <span class="comment">// using &#x27;transformY&#x27; instead of the real distance prevents fisheye</span></span><br></pre></td></tr></table></figure>
<p>结果如下<del>（你说得对，但是我就喜欢看雪菜哭哭）</del>：</p>
<img src="/2024/05/24/%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/Raycasting%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95-%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%89%A9%E5%B1%95/image-20240529172115864.png" class title="image-20240529172115864">
<h1 id="两种sprite一起绘制出现遮挡问题">两种<code>Sprite</code>一起绘制出现遮挡问题</h1>
<h2 id="问题阐述">问题阐述</h2>
<p>此时<code>main</code>函数的调用如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// 主循环</span></span><br><span class="line">    <span class="keyword">while</span> (window.<span class="built_in">isOpen</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        ...</span><br><span class="line">        window.<span class="built_in">clear</span>();</span><br><span class="line">        <span class="built_in">Floor_Ceiling_Casting</span>(window);</span><br><span class="line">        <span class="built_in">Wall_Casting</span>(window);</span><br><span class="line">        <span class="comment">// 此处先画立绘</span></span><br><span class="line">        <span class="built_in">Illustration_Casting</span>(window);</span><br><span class="line">        <span class="comment">// 再画decoration</span></span><br><span class="line">        <span class="built_in">Decoration_Casting</span>(window);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">Move</span>(window);</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如图所示，decoration的绘制在illustration之后，因此出现图层覆盖的情况</p>
<img src="/2024/05/24/%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/Raycasting%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95-%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%89%A9%E5%B1%95/image-20240529172549648.png" class title="image-20240529172549648">
<p>我尝试在画Sprite的同时更新<code>ZBuffer</code>，希望能够解决问题，但引入了一个新问题，先看代码</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// loop through every vertical stripe of the sprite on screen</span></span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> stripe = drawStartX; stripe &lt; drawEndX; stripe++)</span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// 绘制sprite</span></span><br><span class="line">    window.<span class="built_in">draw</span>(illustration_sprite);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//此处更新ZBUFFER</span></span><br><span class="line">    ZBuffer[stripe] = transformY;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>引入的新问题就是：透明部分更新的<code>ZBuffer</code>阻止了本该正常画的新Sprite，如下图中，近处的雪菜透明部分挡住了远处本应该正常显示的灯的Sprite</p>
<img src="/2024/05/24/%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/Raycasting%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95-%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%89%A9%E5%B1%95/image-20240529195305571.png" class title="image-20240529195305571">
<p>如果这样看不太明显，我换一下调用顺序就能很清楚了，即先画decoration再画illustration：</p>
<img src="/2024/05/24/%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/Raycasting%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95-%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%89%A9%E5%B1%95/image-20240529195921818.png" class title="image-20240529195921818">
<p>这时就很明显了，近处灯纹理的<strong>透明部分更新了<code>ZBuffer</code></strong>，导致应该正常绘制远处的雪菜在左半边绘制时被<code>if</code>判断跳过了：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (... &amp;&amp; transformY &lt; ZBuffer[stripe])</span><br></pre></td></tr></table></figure>
<p>灯的整个纹理都算在近处，所以透明部分更新<code>ZBuffer</code>的值，远处雪菜立绘的<code>transformY</code>确实是比<code>ZBuffer</code>大</p>
<p>那么怎么解决呢？</p>
<p>我第一时间想的是修改<code>ZBuffer</code>，让它记录每一个像素的深度值，如果是透明的就不修改</p>
<p>如果这样修改，画两种Sprite的时候就需要对<code>y</code>值进行判断，对应的<code>drawStartY</code>也需要改变，太麻烦了</p>
<p>那么有没有一种简单的方法解决这个问题呢？</p>
<h2 id="解决方案">解决方案</h2>
<p>通过观察，发现单独绘制decoration和illustration时都没出现这种问题</p>
<p>如下图所示，冬马和纱这张立绘的包围盒应该是红框，但是和泉千晶的立绘能够正常出现，没有被透明部分遮挡</p>
<img src="/2024/05/24/%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/Raycasting%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95-%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%89%A9%E5%B1%95/image-20240529201500394.png" class title="image-20240529201500394">
<p>因此得出结论：需要把decoration和illustration<strong>同时画</strong>，即一起排序，一起执行一遍上面的逻辑</p>
<p>于是，就需要新建一个类，除了需要存储<code>x, y, texture_index</code>以外，还需要存储这个变量是decoration还是illustration</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/************************************************************/</span></span><br><span class="line"><span class="comment">/* 为了防止decoration和illustration互相的透明遮挡问题</span></span><br><span class="line"><span class="comment">/* 采用两种Sprite一起画的方法，反正这两种单独画的逻辑也是完全一样</span></span><br><span class="line"><span class="comment">/* 为此，需要声明MySprite类，和之前两种Sprite成员变量一样</span></span><br><span class="line"><span class="comment">/* 不需要声明新的纹理数组，可以直接复用decoration和illustration的纹理数组</span></span><br><span class="line"><span class="comment">/* 声明Order和Distance数组，并且初始化数目为Sprite总数</span></span><br><span class="line"><span class="comment">/* 已知Sprite总数为 decorationNum + illustrationNum</span></span><br><span class="line"><span class="comment">/* 需要一个能存下全部Sprite的数组Allsprites_lst，记录位置和下标</span></span><br><span class="line"><span class="comment">/* 还需要对应的排序函数sortAllSprites</span></span><br><span class="line"><span class="comment">/************************************************************/</span></span><br><span class="line"><span class="comment">/************************************************************/</span></span><br><span class="line"><span class="comment">/* MySprite，用于创建数组</span></span><br><span class="line"><span class="comment">/************************************************************/</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MySprite</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">    <span class="type">double</span> x;</span><br><span class="line">    <span class="type">double</span> y;</span><br><span class="line">    <span class="type">int</span> texture_index;</span><br><span class="line">    <span class="type">int</span> type; <span class="comment">// 用于指明是decoration还是illustration</span></span><br><span class="line">    		 <span class="comment">// 0为decoration，1为illustration</span></span><br><span class="line">    <span class="function"><span class="keyword">class</span> <span class="title">MySprite</span><span class="params">(<span class="type">double</span> x = <span class="number">0</span>, <span class="type">double</span> y = <span class="number">0</span>, <span class="type">int</span> texindex = <span class="number">0</span>, <span class="type">int</span> type = <span class="number">-1</span>)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>-&gt;x = x;</span><br><span class="line">        <span class="keyword">this</span>-&gt;y = y;</span><br><span class="line">        <span class="keyword">this</span>-&gt;texture_index = texindex;</span><br><span class="line">        <span class="keyword">this</span>-&gt;type = type;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><br></p>
<p>然后还需要跟<a href="#draw_Sprites">上文逻辑</a>一样的一系列数组，存储具体位置和纹理下标、<code>Order</code>数组，<code>Distance</code>数组：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 全部Sprite的数组，记录位置和下标</span></span><br><span class="line">MySprite Allsprites_lst[decorationNum + illustrationNum] =</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/************************************************************/</span></span><br><span class="line">    <span class="comment">/* Decoration</span></span><br><span class="line"><span class="comment">    /************************************************************/</span></span><br><span class="line">    <span class="comment">// green light in front of playerstart</span></span><br><span class="line">    &#123;<span class="number">20.5</span>, <span class="number">11.5</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">    <span class="comment">// green lights in every room</span></span><br><span class="line">    &#123;<span class="number">18.5</span>, <span class="number">4.5</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">    &#123;<span class="number">10.0</span>, <span class="number">4.5</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">    &#123;<span class="number">10.0</span>, <span class="number">12.5</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">    &#123;<span class="number">3.5</span>, <span class="number">6.5</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">    &#123;<span class="number">3.5</span>, <span class="number">20.5</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">    &#123;<span class="number">3.5</span>, <span class="number">14.5</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">    &#123;<span class="number">14.5</span>, <span class="number">20.5</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// row of pillars in front of wall: fisheye test</span></span><br><span class="line">    &#123;<span class="number">18.5</span>, <span class="number">10.5</span>, <span class="number">1</span>, <span class="number">0</span>&#125;,</span><br><span class="line">    &#123;<span class="number">18.5</span>, <span class="number">11.5</span>, <span class="number">1</span>, <span class="number">0</span>&#125;,</span><br><span class="line">    &#123;<span class="number">18.5</span>, <span class="number">12.5</span>, <span class="number">1</span>, <span class="number">0</span>&#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// some barrels around the map</span></span><br><span class="line">    &#123;<span class="number">21.5</span>, <span class="number">1.5</span>, <span class="number">2</span>, <span class="number">0</span>&#125;,</span><br><span class="line">    &#123;<span class="number">15.5</span>, <span class="number">1.5</span>, <span class="number">2</span>, <span class="number">0</span>&#125;,</span><br><span class="line">    &#123;<span class="number">16.0</span>, <span class="number">1.8</span>, <span class="number">2</span>, <span class="number">0</span>&#125;,</span><br><span class="line">    &#123;<span class="number">16.2</span>, <span class="number">1.2</span>, <span class="number">2</span>, <span class="number">0</span>&#125;,</span><br><span class="line">    &#123;<span class="number">3.5</span>, <span class="number">2.5</span>, <span class="number">2</span>, <span class="number">0</span>&#125;,</span><br><span class="line">    &#123;<span class="number">9.5</span>, <span class="number">15.5</span>, <span class="number">2</span>, <span class="number">0</span>&#125;,</span><br><span class="line">    &#123;<span class="number">10.0</span>, <span class="number">15.1</span>, <span class="number">2</span>, <span class="number">0</span>&#125;,</span><br><span class="line">    &#123;<span class="number">10.5</span>, <span class="number">15.8</span>, <span class="number">2</span>, <span class="number">0</span>&#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/************************************************************/</span></span><br><span class="line">    <span class="comment">/* illustration</span></span><br><span class="line"><span class="comment">    /************************************************************/</span></span><br><span class="line">    <span class="comment">// 北原春希立绘，刚进游戏就能看见</span></span><br><span class="line">    &#123;<span class="number">20.6</span>, <span class="number">11.5</span>, <span class="number">0</span>, <span class="number">1</span>&#125;,</span><br><span class="line">    <span class="comment">// 小木曾雪菜流汗黄豆立绘</span></span><br><span class="line">    &#123;<span class="number">18</span>, <span class="number">3.25</span>, <span class="number">1</span>, <span class="number">1</span>&#125;,</span><br><span class="line">    <span class="comment">// 小木曾雪菜怒立绘</span></span><br><span class="line">    &#123;<span class="number">8.0</span>, <span class="number">4.5</span>, <span class="number">2</span>, <span class="number">1</span>&#125;,</span><br><span class="line">    <span class="comment">// 小木曾雪菜哭1</span></span><br><span class="line">    &#123;<span class="number">21</span>,<span class="number">8</span>,<span class="number">3</span>,<span class="number">1</span>&#125;,</span><br><span class="line">    <span class="comment">// 小木曾雪菜哭2</span></span><br><span class="line">    &#123;<span class="number">22.5</span>,<span class="number">3.5</span>,<span class="number">4</span>,<span class="number">1</span>&#125;,</span><br><span class="line">    <span class="comment">// 冬马和纱斗鸡眼</span></span><br><span class="line">    &#123;<span class="number">17.1</span>,<span class="number">14.7</span>,<span class="number">5</span>,<span class="number">1</span>&#125;,</span><br><span class="line">    <span class="comment">// 冬马和纱怒</span></span><br><span class="line">    &#123;<span class="number">22.5</span>,<span class="number">18.5</span>,<span class="number">6</span>,<span class="number">1</span>&#125;,</span><br><span class="line">    <span class="comment">// 冬马和纱闭眼</span></span><br><span class="line">    &#123;<span class="number">16.8</span>,<span class="number">21.5</span>,<span class="number">7</span>,<span class="number">1</span>&#125;,</span><br><span class="line">    <span class="comment">// 冬马和纱笑</span></span><br><span class="line">    &#123;<span class="number">3</span>,<span class="number">12</span>,<span class="number">8</span>,<span class="number">1</span>&#125;,</span><br><span class="line">    <span class="comment">// 小春</span></span><br><span class="line">    &#123;<span class="number">10.1</span>,<span class="number">18.3</span>,<span class="number">9</span>,<span class="number">1</span>&#125;,</span><br><span class="line">    <span class="comment">// 千晶</span></span><br><span class="line">    &#123;<span class="number">2.5</span>,<span class="number">21.2</span>,<span class="number">10</span>,<span class="number">1</span>&#125;,</span><br><span class="line">    <span class="comment">// 麻理</span></span><br><span class="line">    &#123;<span class="number">6.4</span>,<span class="number">19.2</span>,<span class="number">11</span>,<span class="number">1</span>&#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// Order数组，并且初始化数目为decorationNum + illustrationNum</span></span><br><span class="line"><span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">Allsprites_Order</span><span class="params">(decorationNum + illustrationNum)</span></span>;</span><br><span class="line"><span class="comment">// Distance数组，并且初始化数目为decorationNum + illustrationNum</span></span><br><span class="line"><span class="function">vector&lt;<span class="type">double</span>&gt; <span class="title">Allsprites_Distance</span><span class="params">(decorationNum + illustrationNum)</span></span>;</span><br></pre></td></tr></table></figure>
<p>最后需要一个逻辑完全一样的排序函数：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 全部Sprite的排序函数，用于画出全部Sprite</span></span><br><span class="line"><span class="comment">// 注意传递vector的引用</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">sortAllSprites</span><span class="params">(vector&lt;<span class="type">int</span>&gt; &amp;Allsprites_Order, vector&lt;<span class="type">double</span>&gt; &amp;Allsprites_Distance, <span class="type">int</span> amount)</span></span>;</span><br></pre></td></tr></table></figure>
<p>值得注意的是，排序函数传递参数要传递<code>vector</code>的<strong>引用</strong><del>（多弱质的错误，就因为太久没用了，难绷）</del></p>
<p>排序函数具体如下，逻辑完全没变：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">sortAllSprites</span><span class="params">(vector&lt;<span class="type">int</span>&gt; &amp;Allsprites_Order, vector&lt;<span class="type">double</span>&gt; &amp;Allsprites_Distance, <span class="type">int</span> amount)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    std::vector&lt;std::pair&lt;<span class="type">double</span>, <span class="type">int</span>&gt;&gt; <span class="built_in">sprites</span>(amount);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; amount; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        sprites[i].first = Allsprites_Distance[i];</span><br><span class="line">        sprites[i].second = Allsprites_Order[i];</span><br><span class="line">    &#125;</span><br><span class="line">    std::<span class="built_in">sort</span>(sprites.<span class="built_in">begin</span>(), sprites.<span class="built_in">end</span>());</span><br><span class="line">    <span class="comment">// restore in reverse order to go from farthest to nearest</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; amount; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        Allsprites_Distance[i] = sprites[amount - i - <span class="number">1</span>].first;</span><br><span class="line">        Allsprites_Order[i] = sprites[amount - i - <span class="number">1</span>].second;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后就是绘制函数，只需要注意判断类型是decoration还是illustration，两者<code>spriteHeight</code>计算方法不同，绘制方法也不太相同</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 成功解决遮挡问题，原因：sortAllSprites排序没传递vector的引用，导致没有正常排序</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Allsprites_Casting</span><span class="params">(RenderWindow &amp;window)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; decorationNum + illustrationNum; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        Allsprites_Order[i] = i;</span><br><span class="line">        Allsprites_Distance[i] = ((posX - Allsprites_lst[i].x) * (posX - Allsprites_lst[i].x) + (posY - Allsprites_lst[i].y) * (posY - Allsprites_lst[i].y)); <span class="comment">// sqrt not taken, unneeded</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 排序</span></span><br><span class="line">    <span class="comment">// 先画远的再画近的不会导致透明遮挡问题</span></span><br><span class="line">    <span class="comment">// 因为近的Sprite透明地方可以直接显示出远的Sprite</span></span><br><span class="line">    <span class="built_in">sortAllSprites</span>(Allsprites_Order, Allsprites_Distance, decorationNum + illustrationNum);</span><br><span class="line">    <span class="comment">// after sorting the sprites, do the projection and draw them</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; decorationNum + illustrationNum; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// translate sprite position to relative to camera</span></span><br><span class="line">        <span class="type">double</span> spriteX = Allsprites_lst[Allsprites_Order[i]].x - posX;</span><br><span class="line">        <span class="type">double</span> spriteY = Allsprites_lst[Allsprites_Order[i]].y - posY;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// transform sprite with the inverse camera matrix</span></span><br><span class="line">        <span class="comment">//  [ planeX   dirX ] -1                                       [ dirY      -dirX ]</span></span><br><span class="line">        <span class="comment">//  [               ]       =  1/(planeX*dirY-dirX*planeY) *   [                 ]</span></span><br><span class="line">        <span class="comment">//  [ planeY   dirY ]                                          [ -planeY  planeX ]</span></span><br><span class="line"></span><br><span class="line">        <span class="type">double</span> invDet = <span class="number">1.0</span> / (planeX * dirY - dirX * planeY); <span class="comment">// required for correct matrix multiplication</span></span><br><span class="line"></span><br><span class="line">        <span class="type">double</span> transformX = invDet * (dirY * spriteX - dirX * spriteY);</span><br><span class="line">        <span class="type">double</span> transformY = invDet * (-planeY * spriteX + planeX * spriteY); <span class="comment">// this is actually the depth inside the screen, that what Z is in 3D</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// sprite在屏幕上的x坐标</span></span><br><span class="line">        <span class="type">int</span> spriteScreenX = <span class="built_in">int</span>((screenWidth / <span class="number">2</span>) * (<span class="number">1</span> + transformX / transformY));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// calculate height of the sprite on screen</span></span><br><span class="line">        <span class="type">int</span> spriteHeight = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">// decoration的height不用乘比例</span></span><br><span class="line">        <span class="keyword">if</span> (Allsprites_lst[Allsprites_Order[i]].type == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            spriteHeight = <span class="built_in">abs</span>(<span class="built_in">int</span>(screenHeight / (transformY))); <span class="comment">// using &#x27;transformY&#x27; instead of the real distance prevents fisheye</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// illustration的height需要乘比例</span></span><br><span class="line">        <span class="comment">// 用于保持长宽比，不然立绘被压成正方形</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (Allsprites_lst[Allsprites_Order[i]].type == <span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            spriteHeight = <span class="built_in">abs</span>(<span class="built_in">int</span>(screenHeight / (transformY))) * illustrationHeight / illustrationWidth; <span class="comment">// using &#x27;transformY&#x27; instead of the real distance prevents fisheye</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// calculate width of the sprite</span></span><br><span class="line">        <span class="type">int</span> spriteWidth = <span class="built_in">abs</span>(<span class="built_in">int</span>(screenHeight / (transformY)));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// calculate lowest and highest pixel to fill in current stripe</span></span><br><span class="line">        <span class="comment">// 计算y上的起点，不需要计算终点，因为竖线直接指定了Sprite的高度</span></span><br><span class="line">        <span class="type">int</span> drawStartY = -spriteHeight / <span class="number">2</span> + screenHeight / <span class="number">2</span>;</span><br><span class="line">        <span class="comment">// if (drawStartY &lt; 0) drawStartY = 0;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 计算x上的起点和终点</span></span><br><span class="line">        <span class="type">int</span> drawStartX = -spriteWidth / <span class="number">2</span> + spriteScreenX;</span><br><span class="line">        <span class="keyword">if</span> (drawStartX &lt; <span class="number">0</span>)</span><br><span class="line">            drawStartX = <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> drawEndX = spriteWidth / <span class="number">2</span> + spriteScreenX;</span><br><span class="line">        <span class="keyword">if</span> (drawEndX &gt;= screenWidth)</span><br><span class="line">            drawEndX = screenWidth - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// loop through every vertical stripe of the sprite on screen</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> stripe = drawStartX; stripe &lt; drawEndX; stripe++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// the conditions in the if are:</span></span><br><span class="line">            <span class="comment">// 1) it&#x27;s in front of camera plane so you don&#x27;t see things behind you</span></span><br><span class="line">            <span class="comment">// 2) it&#x27;s on the screen (left)</span></span><br><span class="line">            <span class="comment">// 3) it&#x27;s on the screen (right)</span></span><br><span class="line">            <span class="comment">// 4) ZBuffer, with perpendicular distance</span></span><br><span class="line">            <span class="keyword">if</span> (transformY &gt; <span class="number">0</span> &amp;&amp; stripe &gt; <span class="number">0</span> &amp;&amp; stripe &lt; screenWidth &amp;&amp; transformY &lt; ZBuffer[stripe])</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 画decoration</span></span><br><span class="line">                <span class="keyword">if</span> (Allsprites_lst[Allsprites_Order[i]].type == <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// 计算texX</span></span><br><span class="line">                    <span class="type">int</span> texX = <span class="built_in">int</span>(<span class="number">256</span> * (stripe - (-spriteWidth / <span class="number">2</span> + spriteScreenX)) * texWidth / spriteWidth) / <span class="number">256</span>;</span><br><span class="line">                    <span class="comment">// decoration一条线的Sprite</span></span><br><span class="line">                    Sprite decoration_sprite;</span><br><span class="line">                    <span class="comment">// 设置对应纹理</span></span><br><span class="line">                    decoration_sprite.<span class="built_in">setTexture</span>(decoration_texture[Allsprites_lst[Allsprites_Order[i]].texture_index]);</span><br><span class="line">                    <span class="comment">// 设置sprite的纹理矩形，定义了在纹理中的哪个部分应用到decoration_sprite上</span></span><br><span class="line">                    <span class="comment">// 宽度为1个像素，相当于原来的画线</span></span><br><span class="line">                    decoration_sprite.<span class="built_in">setTextureRect</span>(sf::<span class="built_in">IntRect</span>(texX, <span class="number">0</span>, <span class="number">1</span>, texHeight));</span><br><span class="line">                    <span class="comment">// 设置sprite的位置，坐标指定了左上角的位置</span></span><br><span class="line">                    decoration_sprite.<span class="built_in">setPosition</span>(stripe, drawStartY);</span><br><span class="line">                    <span class="comment">// 设置sprite的缩放因子</span></span><br><span class="line">                    decoration_sprite.<span class="built_in">setScale</span>(<span class="number">1</span>, spriteHeight / (<span class="type">float</span>)texHeight);</span><br><span class="line">                    <span class="comment">// 绘制sprite</span></span><br><span class="line">                    window.<span class="built_in">draw</span>(decoration_sprite);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 画illustration</span></span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (Allsprites_lst[Allsprites_Order[i]].type == <span class="number">1</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// 计算texX</span></span><br><span class="line">                    <span class="type">int</span> texX = <span class="built_in">int</span>(<span class="number">256</span> * (stripe - (-spriteWidth / <span class="number">2</span> + spriteScreenX)) * illustrationWidth / spriteWidth) / <span class="number">256</span>;</span><br><span class="line">                    <span class="comment">// illustration一条线的Sprite</span></span><br><span class="line">                    Sprite illustration_sprite;</span><br><span class="line">                    <span class="comment">// 设置对应纹理</span></span><br><span class="line">                    illustration_sprite.<span class="built_in">setTexture</span>(illustration_texture[Allsprites_lst[Allsprites_Order[i]].texture_index]);</span><br><span class="line">                    <span class="comment">// 设置sprite的纹理矩形，定义了在纹理中的哪个部分应用到illustration_sprite上</span></span><br><span class="line">                    <span class="comment">// 宽度为1个像素，相当于原来的画线</span></span><br><span class="line">                    illustration_sprite.<span class="built_in">setTextureRect</span>(sf::<span class="built_in">IntRect</span>(texX, <span class="number">0</span>, <span class="number">1</span>, illustrationHeight));</span><br><span class="line">                    <span class="comment">// 设置sprite的位置，坐标指定了左上角的位置</span></span><br><span class="line">                    illustration_sprite.<span class="built_in">setPosition</span>(stripe, drawStartY);</span><br><span class="line">                    <span class="comment">// 设置sprite的缩放因子</span></span><br><span class="line">                    illustration_sprite.<span class="built_in">setScale</span>(<span class="number">1</span>, spriteHeight / (<span class="type">float</span>)illustrationHeight);</span><br><span class="line">                    <span class="comment">// 绘制sprite</span></span><br><span class="line">                    window.<span class="built_in">draw</span>(illustration_sprite);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>至此，完美解决<strong>透明遮挡</strong>问题，再把之前做的小地图功能拿出来，就是下图结果</p>
<img src="/2024/05/24/%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/Raycasting%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95-%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%89%A9%E5%B1%95/image-20240529203716858.png" class title="image-20240529203716858">
<h1 id="最终源代码">最终源代码</h1>
<p>代码如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br><span class="line">819</span><br><span class="line">820</span><br><span class="line">821</span><br><span class="line">822</span><br><span class="line">823</span><br><span class="line">824</span><br><span class="line">825</span><br><span class="line">826</span><br><span class="line">827</span><br><span class="line">828</span><br><span class="line">829</span><br><span class="line">830</span><br><span class="line">831</span><br><span class="line">832</span><br><span class="line">833</span><br><span class="line">834</span><br><span class="line">835</span><br><span class="line">836</span><br><span class="line">837</span><br><span class="line">838</span><br><span class="line">839</span><br><span class="line">840</span><br><span class="line">841</span><br><span class="line">842</span><br><span class="line">843</span><br><span class="line">844</span><br><span class="line">845</span><br><span class="line">846</span><br><span class="line">847</span><br><span class="line">848</span><br><span class="line">849</span><br><span class="line">850</span><br><span class="line">851</span><br><span class="line">852</span><br><span class="line">853</span><br><span class="line">854</span><br><span class="line">855</span><br><span class="line">856</span><br><span class="line">857</span><br><span class="line">858</span><br><span class="line">859</span><br><span class="line">860</span><br><span class="line">861</span><br><span class="line">862</span><br><span class="line">863</span><br><span class="line">864</span><br><span class="line">865</span><br><span class="line">866</span><br><span class="line">867</span><br><span class="line">868</span><br><span class="line">869</span><br><span class="line">870</span><br><span class="line">871</span><br><span class="line">872</span><br><span class="line">873</span><br><span class="line">874</span><br><span class="line">875</span><br><span class="line">876</span><br><span class="line">877</span><br><span class="line">878</span><br><span class="line">879</span><br><span class="line">880</span><br><span class="line">881</span><br><span class="line">882</span><br><span class="line">883</span><br><span class="line">884</span><br><span class="line">885</span><br><span class="line">886</span><br><span class="line">887</span><br><span class="line">888</span><br><span class="line">889</span><br><span class="line">890</span><br><span class="line">891</span><br><span class="line">892</span><br><span class="line">893</span><br><span class="line">894</span><br><span class="line">895</span><br><span class="line">896</span><br><span class="line">897</span><br><span class="line">898</span><br><span class="line">899</span><br><span class="line">900</span><br><span class="line">901</span><br><span class="line">902</span><br><span class="line">903</span><br><span class="line">904</span><br><span class="line">905</span><br><span class="line">906</span><br><span class="line">907</span><br><span class="line">908</span><br><span class="line">909</span><br><span class="line">910</span><br><span class="line">911</span><br><span class="line">912</span><br><span class="line">913</span><br><span class="line">914</span><br><span class="line">915</span><br><span class="line">916</span><br><span class="line">917</span><br><span class="line">918</span><br><span class="line">919</span><br><span class="line">920</span><br><span class="line">921</span><br><span class="line">922</span><br><span class="line">923</span><br><span class="line">924</span><br><span class="line">925</span><br><span class="line">926</span><br><span class="line">927</span><br><span class="line">928</span><br><span class="line">929</span><br><span class="line">930</span><br><span class="line">931</span><br><span class="line">932</span><br><span class="line">933</span><br><span class="line">934</span><br><span class="line">935</span><br><span class="line">936</span><br><span class="line">937</span><br><span class="line">938</span><br><span class="line">939</span><br><span class="line">940</span><br><span class="line">941</span><br><span class="line">942</span><br><span class="line">943</span><br><span class="line">944</span><br><span class="line">945</span><br><span class="line">946</span><br><span class="line">947</span><br><span class="line">948</span><br><span class="line">949</span><br><span class="line">950</span><br><span class="line">951</span><br><span class="line">952</span><br><span class="line">953</span><br><span class="line">954</span><br><span class="line">955</span><br><span class="line">956</span><br><span class="line">957</span><br><span class="line">958</span><br><span class="line">959</span><br><span class="line">960</span><br><span class="line">961</span><br><span class="line">962</span><br><span class="line">963</span><br><span class="line">964</span><br><span class="line">965</span><br><span class="line">966</span><br><span class="line">967</span><br><span class="line">968</span><br><span class="line">969</span><br><span class="line">970</span><br><span class="line">971</span><br><span class="line">972</span><br><span class="line">973</span><br><span class="line">974</span><br><span class="line">975</span><br><span class="line">976</span><br><span class="line">977</span><br><span class="line">978</span><br><span class="line">979</span><br><span class="line">980</span><br><span class="line">981</span><br><span class="line">982</span><br><span class="line">983</span><br><span class="line">984</span><br><span class="line">985</span><br><span class="line">986</span><br><span class="line">987</span><br><span class="line">988</span><br><span class="line">989</span><br><span class="line">990</span><br><span class="line">991</span><br><span class="line">992</span><br><span class="line">993</span><br><span class="line">994</span><br><span class="line">995</span><br><span class="line">996</span><br><span class="line">997</span><br><span class="line">998</span><br><span class="line">999</span><br><span class="line">1000</span><br><span class="line">1001</span><br><span class="line">1002</span><br><span class="line">1003</span><br><span class="line">1004</span><br><span class="line">1005</span><br><span class="line">1006</span><br><span class="line">1007</span><br><span class="line">1008</span><br><span class="line">1009</span><br><span class="line">1010</span><br><span class="line">1011</span><br><span class="line">1012</span><br><span class="line">1013</span><br><span class="line">1014</span><br><span class="line">1015</span><br><span class="line">1016</span><br><span class="line">1017</span><br><span class="line">1018</span><br><span class="line">1019</span><br><span class="line">1020</span><br><span class="line">1021</span><br><span class="line">1022</span><br><span class="line">1023</span><br><span class="line">1024</span><br><span class="line">1025</span><br><span class="line">1026</span><br><span class="line">1027</span><br><span class="line">1028</span><br><span class="line">1029</span><br><span class="line">1030</span><br><span class="line">1031</span><br><span class="line">1032</span><br><span class="line">1033</span><br><span class="line">1034</span><br><span class="line">1035</span><br><span class="line">1036</span><br><span class="line">1037</span><br><span class="line">1038</span><br><span class="line">1039</span><br><span class="line">1040</span><br><span class="line">1041</span><br><span class="line">1042</span><br><span class="line">1043</span><br><span class="line">1044</span><br><span class="line">1045</span><br><span class="line">1046</span><br><span class="line">1047</span><br><span class="line">1048</span><br><span class="line">1049</span><br><span class="line">1050</span><br><span class="line">1051</span><br><span class="line">1052</span><br><span class="line">1053</span><br><span class="line">1054</span><br><span class="line">1055</span><br><span class="line">1056</span><br><span class="line">1057</span><br><span class="line">1058</span><br><span class="line">1059</span><br><span class="line">1060</span><br><span class="line">1061</span><br><span class="line">1062</span><br><span class="line">1063</span><br><span class="line">1064</span><br><span class="line">1065</span><br><span class="line">1066</span><br><span class="line">1067</span><br><span class="line">1068</span><br><span class="line">1069</span><br><span class="line">1070</span><br><span class="line">1071</span><br><span class="line">1072</span><br><span class="line">1073</span><br><span class="line">1074</span><br><span class="line">1075</span><br><span class="line">1076</span><br><span class="line">1077</span><br><span class="line">1078</span><br><span class="line">1079</span><br><span class="line">1080</span><br><span class="line">1081</span><br><span class="line">1082</span><br><span class="line">1083</span><br><span class="line">1084</span><br><span class="line">1085</span><br><span class="line">1086</span><br><span class="line">1087</span><br><span class="line">1088</span><br><span class="line">1089</span><br><span class="line">1090</span><br><span class="line">1091</span><br><span class="line">1092</span><br><span class="line">1093</span><br><span class="line">1094</span><br><span class="line">1095</span><br><span class="line">1096</span><br><span class="line">1097</span><br><span class="line">1098</span><br><span class="line">1099</span><br><span class="line">1100</span><br><span class="line">1101</span><br><span class="line">1102</span><br><span class="line">1103</span><br><span class="line">1104</span><br><span class="line">1105</span><br><span class="line">1106</span><br><span class="line">1107</span><br><span class="line">1108</span><br><span class="line">1109</span><br><span class="line">1110</span><br><span class="line">1111</span><br><span class="line">1112</span><br><span class="line">1113</span><br><span class="line">1114</span><br><span class="line">1115</span><br><span class="line">1116</span><br><span class="line">1117</span><br><span class="line">1118</span><br><span class="line">1119</span><br><span class="line">1120</span><br><span class="line">1121</span><br><span class="line">1122</span><br><span class="line">1123</span><br><span class="line">1124</span><br><span class="line">1125</span><br><span class="line">1126</span><br><span class="line">1127</span><br><span class="line">1128</span><br><span class="line">1129</span><br><span class="line">1130</span><br><span class="line">1131</span><br><span class="line">1132</span><br><span class="line">1133</span><br><span class="line">1134</span><br><span class="line">1135</span><br><span class="line">1136</span><br><span class="line">1137</span><br><span class="line">1138</span><br><span class="line">1139</span><br><span class="line">1140</span><br><span class="line">1141</span><br><span class="line">1142</span><br><span class="line">1143</span><br><span class="line">1144</span><br><span class="line">1145</span><br><span class="line">1146</span><br><span class="line">1147</span><br><span class="line">1148</span><br><span class="line">1149</span><br><span class="line">1150</span><br><span class="line">1151</span><br><span class="line">1152</span><br><span class="line">1153</span><br><span class="line">1154</span><br><span class="line">1155</span><br><span class="line">1156</span><br><span class="line">1157</span><br><span class="line">1158</span><br><span class="line">1159</span><br><span class="line">1160</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;SFML/Graphics.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;algorithm&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cmath&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> sf;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> screenWidth 1440</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> screenHeight 900</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> mapWidth 24</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> mapHeight 24</span></span><br><span class="line"><span class="comment">// 地板天花板、墙壁、decoration纹理宽高</span></span><br><span class="line"><span class="comment">// 纹理图片都来自《德军总部3D》，因此宽高一样</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> texWidth 64</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> texHeight 64</span></span><br><span class="line"><span class="comment">// 地板天花板墙壁纹理总数</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> textureNum_Wall 8</span></span><br><span class="line"><span class="comment">// decoration纹理总数</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> textureNum_Decoration 3</span></span><br><span class="line"><span class="comment">// illustration纹理总数</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> textureNum_Illustration 12</span></span><br><span class="line"><span class="comment">// decoration总数</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> decorationNum 19</span></span><br><span class="line"><span class="comment">// illustration总数</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> illustrationNum 12</span></span><br><span class="line"><span class="comment">// 人物立绘宽高</span></span><br><span class="line"><span class="comment">// 由于人物立绘各个尺寸不一样，因此需要把所有图片缩放到370x690</span></span><br><span class="line"><span class="comment">// 缩放已经通过python实现，此处代码不考虑</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> illustrationWidth 370</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> illustrationHeight 690</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> worldMap[mapWidth][mapHeight] =</span><br><span class="line">    &#123;</span><br><span class="line">        &#123;<span class="number">4</span>, <span class="number">4</span>, <span class="number">4</span>, <span class="number">4</span>, <span class="number">4</span>, <span class="number">4</span>, <span class="number">4</span>, <span class="number">4</span>, <span class="number">4</span>, <span class="number">4</span>, <span class="number">4</span>, <span class="number">4</span>, <span class="number">4</span>, <span class="number">4</span>, <span class="number">4</span>, <span class="number">4</span>, <span class="number">7</span>, <span class="number">7</span>, <span class="number">7</span>, <span class="number">7</span>, <span class="number">7</span>, <span class="number">7</span>, <span class="number">7</span>, <span class="number">7</span>&#125;,</span><br><span class="line">        &#123;<span class="number">4</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">7</span>&#125;,</span><br><span class="line">        &#123;<span class="number">4</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">7</span>&#125;,</span><br><span class="line">        &#123;<span class="number">4</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">7</span>&#125;,</span><br><span class="line">        &#123;<span class="number">4</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">7</span>&#125;,</span><br><span class="line">        &#123;<span class="number">4</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">5</span>, <span class="number">5</span>, <span class="number">5</span>, <span class="number">5</span>, <span class="number">5</span>, <span class="number">5</span>, <span class="number">5</span>, <span class="number">5</span>, <span class="number">5</span>, <span class="number">7</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">7</span>, <span class="number">7</span>, <span class="number">7</span>, <span class="number">7</span>, <span class="number">7</span>&#125;,</span><br><span class="line">        &#123;<span class="number">4</span>, <span class="number">0</span>, <span class="number">5</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">5</span>, <span class="number">0</span>, <span class="number">5</span>, <span class="number">0</span>, <span class="number">5</span>, <span class="number">0</span>, <span class="number">5</span>, <span class="number">0</span>, <span class="number">5</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">7</span>, <span class="number">7</span>, <span class="number">7</span>, <span class="number">1</span>&#125;,</span><br><span class="line">        &#123;<span class="number">4</span>, <span class="number">0</span>, <span class="number">6</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">5</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">5</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">8</span>&#125;,</span><br><span class="line">        &#123;<span class="number">4</span>, <span class="number">0</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">7</span>, <span class="number">7</span>, <span class="number">7</span>, <span class="number">1</span>&#125;,</span><br><span class="line">        &#123;<span class="number">4</span>, <span class="number">0</span>, <span class="number">8</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">5</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">5</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">8</span>&#125;,</span><br><span class="line">        &#123;<span class="number">4</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">5</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">5</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">7</span>, <span class="number">7</span>, <span class="number">7</span>, <span class="number">1</span>&#125;,</span><br><span class="line">        &#123;<span class="number">4</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">5</span>, <span class="number">5</span>, <span class="number">5</span>, <span class="number">5</span>, <span class="number">0</span>, <span class="number">5</span>, <span class="number">5</span>, <span class="number">5</span>, <span class="number">5</span>, <span class="number">7</span>, <span class="number">7</span>, <span class="number">7</span>, <span class="number">7</span>, <span class="number">7</span>, <span class="number">7</span>, <span class="number">7</span>, <span class="number">1</span>&#125;,</span><br><span class="line">        &#123;<span class="number">6</span>, <span class="number">6</span>, <span class="number">6</span>, <span class="number">6</span>, <span class="number">6</span>, <span class="number">6</span>, <span class="number">6</span>, <span class="number">6</span>, <span class="number">6</span>, <span class="number">6</span>, <span class="number">6</span>, <span class="number">0</span>, <span class="number">6</span>, <span class="number">6</span>, <span class="number">6</span>, <span class="number">6</span>, <span class="number">6</span>, <span class="number">6</span>, <span class="number">6</span>, <span class="number">6</span>, <span class="number">6</span>, <span class="number">6</span>, <span class="number">6</span>, <span class="number">6</span>&#125;,</span><br><span class="line">        &#123;<span class="number">8</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">4</span>&#125;,</span><br><span class="line">        &#123;<span class="number">6</span>, <span class="number">6</span>, <span class="number">6</span>, <span class="number">6</span>, <span class="number">6</span>, <span class="number">6</span>, <span class="number">0</span>, <span class="number">6</span>, <span class="number">6</span>, <span class="number">6</span>, <span class="number">6</span>, <span class="number">0</span>, <span class="number">6</span>, <span class="number">6</span>, <span class="number">6</span>, <span class="number">6</span>, <span class="number">6</span>, <span class="number">6</span>, <span class="number">6</span>, <span class="number">6</span>, <span class="number">6</span>, <span class="number">6</span>, <span class="number">6</span>, <span class="number">6</span>&#125;,</span><br><span class="line">        &#123;<span class="number">4</span>, <span class="number">4</span>, <span class="number">4</span>, <span class="number">4</span>, <span class="number">4</span>, <span class="number">4</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">4</span>, <span class="number">4</span>, <span class="number">6</span>, <span class="number">0</span>, <span class="number">6</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">3</span>&#125;,</span><br><span class="line">        &#123;<span class="number">4</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">6</span>, <span class="number">0</span>, <span class="number">6</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">2</span>&#125;,</span><br><span class="line">        &#123;<span class="number">4</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">6</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">5</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">2</span>&#125;,</span><br><span class="line">        &#123;<span class="number">4</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">6</span>, <span class="number">0</span>, <span class="number">6</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">2</span>&#125;,</span><br><span class="line">        &#123;<span class="number">4</span>, <span class="number">0</span>, <span class="number">6</span>, <span class="number">0</span>, <span class="number">6</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">6</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">5</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">2</span>&#125;,</span><br><span class="line">        &#123;<span class="number">4</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">5</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">6</span>, <span class="number">0</span>, <span class="number">6</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">2</span>&#125;,</span><br><span class="line">        &#123;<span class="number">4</span>, <span class="number">0</span>, <span class="number">6</span>, <span class="number">0</span>, <span class="number">6</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">6</span>, <span class="number">0</span>, <span class="number">6</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">5</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">2</span>&#125;,</span><br><span class="line">        &#123;<span class="number">4</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">6</span>, <span class="number">0</span>, <span class="number">6</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">2</span>&#125;,</span><br><span class="line">        &#123;<span class="number">4</span>, <span class="number">4</span>, <span class="number">4</span>, <span class="number">4</span>, <span class="number">4</span>, <span class="number">4</span>, <span class="number">4</span>, <span class="number">4</span>, <span class="number">4</span>, <span class="number">4</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">3</span>&#125;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">double</span> posX = <span class="number">22.5</span>, posY = <span class="number">11.5</span>;  <span class="comment">// x and y start position</span></span><br><span class="line"><span class="type">double</span> dirX = <span class="number">-1</span>, dirY = <span class="number">0</span>;       <span class="comment">// initial direction vector</span></span><br><span class="line"><span class="type">double</span> planeX = <span class="number">0</span>, planeY = <span class="number">0.66</span>; <span class="comment">// the 2d raycaster version of camera plane</span></span><br><span class="line"><span class="type">double</span> FOV;                       <span class="comment">// FOV视角大小，采用弧度制</span></span><br><span class="line"></span><br><span class="line"><span class="type">double</span> new_Time = <span class="number">0</span>; <span class="comment">// time of current frame</span></span><br><span class="line"><span class="type">double</span> old_Time = <span class="number">0</span>; <span class="comment">// time of previous frame</span></span><br><span class="line"></span><br><span class="line">Texture texture[textureNum_Wall]; <span class="comment">// 墙面、地板天花板纹理数组</span></span><br><span class="line">                                  <span class="comment">// decoration和illustration纹理数组单独开</span></span><br><span class="line">Clock Myclock;                    <span class="comment">// 用于计时，计算这一帧和上一帧的时间</span></span><br><span class="line"></span><br><span class="line">Image Ceiling_image; <span class="comment">// 天花板纹理图像，用于(tx, ty)获取颜色</span></span><br><span class="line">Image Floor_image;   <span class="comment">// 地板纹理图像，用于(tx, ty)获取颜色</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// debug用，每次手动注释掉鼠标的逻辑烦死我了</span></span><br><span class="line"><span class="type">bool</span> ifMouse = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ZBuffer数组，记录屏幕上每个x对应的perpWallDist</span></span><br><span class="line"><span class="type">double</span> ZBuffer[screenWidth] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/************************************************************/</span></span><br><span class="line"><span class="comment">/* Decoration</span></span><br><span class="line"><span class="comment">/************************************************************/</span></span><br><span class="line"><span class="comment">// decoration纹理数组</span></span><br><span class="line">Texture decoration_texture[textureNum_Decoration];</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Decoration</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="type">double</span> x;</span><br><span class="line">    <span class="type">double</span> y;</span><br><span class="line">    <span class="type">int</span> texture_index;</span><br><span class="line">    <span class="type">int</span> type; <span class="comment">// 用于指明是decoration还是illustration</span></span><br><span class="line">              <span class="comment">// 0为decoration，1为illustration</span></span><br><span class="line">    <span class="built_in">Decoration</span>(<span class="type">double</span> x = <span class="number">0</span>, <span class="type">double</span> y = <span class="number">0</span>, <span class="type">int</span> texindex = <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">this</span>-&gt;x = x;</span><br><span class="line">        <span class="keyword">this</span>-&gt;y = y;</span><br><span class="line">        <span class="keyword">this</span>-&gt;texture_index = texindex;</span><br><span class="line">        <span class="keyword">this</span>-&gt;type = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// decoration数组，用于记录全部decoration的位置和对应纹理下标</span></span><br><span class="line">Decoration decoration_lst[decorationNum] =</span><br><span class="line">    &#123;</span><br><span class="line">        &#123;<span class="number">20.5</span>, <span class="number">11.5</span>, <span class="number">0</span>&#125;, <span class="comment">// green light in front of playerstart</span></span><br><span class="line">        <span class="comment">// green lights in every room</span></span><br><span class="line">        &#123;<span class="number">18.5</span>, <span class="number">4.5</span>, <span class="number">0</span>&#125;,</span><br><span class="line">        &#123;<span class="number">10.0</span>, <span class="number">4.5</span>, <span class="number">0</span>&#125;,</span><br><span class="line">        &#123;<span class="number">10.0</span>, <span class="number">12.5</span>, <span class="number">0</span>&#125;,</span><br><span class="line">        &#123;<span class="number">3.5</span>, <span class="number">6.5</span>, <span class="number">0</span>&#125;,</span><br><span class="line">        &#123;<span class="number">3.5</span>, <span class="number">20.5</span>, <span class="number">0</span>&#125;,</span><br><span class="line">        &#123;<span class="number">3.5</span>, <span class="number">14.5</span>, <span class="number">0</span>&#125;,</span><br><span class="line">        &#123;<span class="number">14.5</span>, <span class="number">20.5</span>, <span class="number">0</span>&#125;,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// row of pillars in front of wall: fisheye test</span></span><br><span class="line">        &#123;<span class="number">18.5</span>, <span class="number">10.5</span>, <span class="number">1</span>&#125;,</span><br><span class="line">        &#123;<span class="number">18.5</span>, <span class="number">11.5</span>, <span class="number">1</span>&#125;,</span><br><span class="line">        &#123;<span class="number">18.5</span>, <span class="number">12.5</span>, <span class="number">1</span>&#125;,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// some barrels around the map</span></span><br><span class="line">        &#123;<span class="number">21.5</span>, <span class="number">1.5</span>, <span class="number">2</span>&#125;,</span><br><span class="line">        &#123;<span class="number">15.5</span>, <span class="number">1.5</span>, <span class="number">2</span>&#125;,</span><br><span class="line">        &#123;<span class="number">16.0</span>, <span class="number">1.8</span>, <span class="number">2</span>&#125;,</span><br><span class="line">        &#123;<span class="number">16.2</span>, <span class="number">1.2</span>, <span class="number">2</span>&#125;,</span><br><span class="line">        &#123;<span class="number">3.5</span>, <span class="number">2.5</span>, <span class="number">2</span>&#125;,</span><br><span class="line">        &#123;<span class="number">9.5</span>, <span class="number">15.5</span>, <span class="number">2</span>&#125;,</span><br><span class="line">        &#123;<span class="number">10.0</span>, <span class="number">15.1</span>, <span class="number">2</span>&#125;,</span><br><span class="line">        &#123;<span class="number">10.5</span>, <span class="number">15.8</span>, <span class="number">2</span>&#125;,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// arrays used to sort the sprites</span></span><br><span class="line"><span class="comment">// Order数组和Distance数组，分别存储下标和离玩家的距离</span></span><br><span class="line"><span class="type">int</span> decoration_Order[decorationNum];</span><br><span class="line"><span class="type">double</span> decoration_Distance[decorationNum];</span><br><span class="line"></span><br><span class="line"><span class="comment">/************************************************************/</span></span><br><span class="line"><span class="comment">/* illustration</span></span><br><span class="line"><span class="comment">/************************************************************/</span></span><br><span class="line"><span class="comment">// illustration纹理数组</span></span><br><span class="line">Texture illustration_texture[textureNum_Illustration];</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Illustration</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="type">double</span> x;</span><br><span class="line">    <span class="type">double</span> y;</span><br><span class="line">    <span class="type">int</span> texture_index;</span><br><span class="line">    <span class="type">int</span> type; <span class="comment">// 用于指明是decoration还是illustration</span></span><br><span class="line">              <span class="comment">// 0为decoration，1为illustration</span></span><br><span class="line">    <span class="built_in">Illustration</span>(<span class="type">double</span> x = <span class="number">0</span>, <span class="type">double</span> y = <span class="number">0</span>, <span class="type">int</span> texindex = <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">this</span>-&gt;x = x;</span><br><span class="line">        <span class="keyword">this</span>-&gt;y = y;</span><br><span class="line">        <span class="keyword">this</span>-&gt;texture_index = texindex;</span><br><span class="line">        <span class="keyword">this</span>-&gt;type = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// illustration数组，用于记录全部illustration的位置和对应纹理下标</span></span><br><span class="line">Illustration illustration_lst[illustrationNum] =</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 北原春希立绘，刚进游戏就能看见</span></span><br><span class="line">        &#123;<span class="number">20.6</span>, <span class="number">11.5</span>, <span class="number">0</span>&#125;,</span><br><span class="line">        <span class="comment">// 小木曾雪菜流汗黄豆立绘</span></span><br><span class="line">        &#123;<span class="number">18</span>, <span class="number">3.25</span>, <span class="number">1</span>&#125;,</span><br><span class="line">        <span class="comment">// 小木曾雪菜怒立绘</span></span><br><span class="line">        &#123;<span class="number">8.0</span>, <span class="number">4.5</span>, <span class="number">2</span>&#125;,</span><br><span class="line">        <span class="comment">// 小木曾雪菜哭1</span></span><br><span class="line">        &#123;<span class="number">21</span>, <span class="number">8</span>, <span class="number">3</span>&#125;,</span><br><span class="line">        <span class="comment">// 小木曾雪菜哭2</span></span><br><span class="line">        &#123;<span class="number">22.5</span>, <span class="number">3.5</span>, <span class="number">4</span>&#125;,</span><br><span class="line">        <span class="comment">// 冬马和纱斗鸡眼</span></span><br><span class="line">        &#123;<span class="number">17.1</span>, <span class="number">14.7</span>, <span class="number">5</span>&#125;,</span><br><span class="line">        <span class="comment">// 冬马和纱怒</span></span><br><span class="line">        &#123;<span class="number">22.5</span>, <span class="number">18.5</span>, <span class="number">6</span>&#125;,</span><br><span class="line">        <span class="comment">// 冬马和纱闭眼</span></span><br><span class="line">        &#123;<span class="number">16.8</span>, <span class="number">21.5</span>, <span class="number">7</span>&#125;,</span><br><span class="line">        <span class="comment">// 冬马和纱笑</span></span><br><span class="line">        &#123;<span class="number">3</span>, <span class="number">12</span>, <span class="number">8</span>&#125;,</span><br><span class="line">        <span class="comment">// 杉浦小春</span></span><br><span class="line">        &#123;<span class="number">10.1</span>, <span class="number">18.3</span>, <span class="number">9</span>&#125;,</span><br><span class="line">        <span class="comment">// 和泉千晶</span></span><br><span class="line">        &#123;<span class="number">2.5</span>, <span class="number">21.2</span>, <span class="number">10</span>&#125;,</span><br><span class="line">        <span class="comment">// 风冈麻理</span></span><br><span class="line">        &#123;<span class="number">6.4</span>, <span class="number">19.2</span>, <span class="number">11</span>&#125;&#125;;</span><br><span class="line"><span class="comment">// arrays used to sort the sprites</span></span><br><span class="line"><span class="comment">// Order数组和Distance数组，分别存储下标和离玩家的距离</span></span><br><span class="line"><span class="type">int</span> illustration_Order[illustrationNum];</span><br><span class="line"><span class="type">double</span> illustration_Distance[illustrationNum];</span><br><span class="line"></span><br><span class="line"><span class="comment">// function used to sort the sprites</span></span><br><span class="line"><span class="comment">// 此函数用于单独画decoration或单独画illustration</span></span><br><span class="line"><span class="comment">// 如果一起画，则用sortAllSprites函数</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">sortSprites</span><span class="params">(<span class="type">int</span> *order, <span class="type">double</span> *dist, <span class="type">int</span> amount)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/************************************************************/</span></span><br><span class="line"><span class="comment">/* 为了防止decoration和illustration互相的透明遮挡问题</span></span><br><span class="line"><span class="comment">/* 采用两种Sprite一起画的方法，反正这两种单独画的逻辑也是完全一样</span></span><br><span class="line"><span class="comment">/* 为此，需要声明MySprite类，和之前两种Sprite成员变量一样</span></span><br><span class="line"><span class="comment">/* 不需要声明新的纹理数组，可以直接复用decoration和illustration的纹理数组</span></span><br><span class="line"><span class="comment">/* 声明Order和Distance数组，并且初始化数目为Sprite总数</span></span><br><span class="line"><span class="comment">/* 已知Sprite总数为 decorationNum + illustrationNum</span></span><br><span class="line"><span class="comment">/* 需要一个能存下全部Sprite的数组Allsprites_lst，记录位置和下标</span></span><br><span class="line"><span class="comment">/* 还需要对应的排序函数sortAllSprites</span></span><br><span class="line"><span class="comment">/************************************************************/</span></span><br><span class="line"><span class="comment">/************************************************************/</span></span><br><span class="line"><span class="comment">/* MySprite，用于创建数组</span></span><br><span class="line"><span class="comment">/************************************************************/</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MySprite</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="type">double</span> x;</span><br><span class="line">    <span class="type">double</span> y;</span><br><span class="line">    <span class="type">int</span> texture_index;</span><br><span class="line">    <span class="type">int</span> type; <span class="comment">// 用于指明是decoration还是illustration</span></span><br><span class="line">              <span class="comment">// 0为decoration，1为illustration</span></span><br><span class="line">    <span class="function"><span class="keyword">class</span> <span class="title">MySprite</span><span class="params">(<span class="type">double</span> x = <span class="number">0</span>, <span class="type">double</span> y = <span class="number">0</span>, <span class="type">int</span> texindex = <span class="number">0</span>, <span class="type">int</span> type = <span class="number">-1</span>)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>-&gt;x = x;</span><br><span class="line">        <span class="keyword">this</span>-&gt;y = y;</span><br><span class="line">        <span class="keyword">this</span>-&gt;texture_index = texindex;</span><br><span class="line">        <span class="keyword">this</span>-&gt;type = type;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// 全部Sprite的数组，记录位置和下标</span></span><br><span class="line">MySprite Allsprites_lst[decorationNum + illustrationNum] =</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">/************************************************************/</span></span><br><span class="line">        <span class="comment">/* Decoration</span></span><br><span class="line"><span class="comment">        /************************************************************/</span></span><br><span class="line">        <span class="comment">// green light in front of playerstart</span></span><br><span class="line">        &#123;<span class="number">20.5</span>, <span class="number">11.5</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">        <span class="comment">// green lights in every room</span></span><br><span class="line">        &#123;<span class="number">18.5</span>, <span class="number">4.5</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">        &#123;<span class="number">10.0</span>, <span class="number">4.5</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">        &#123;<span class="number">10.0</span>, <span class="number">12.5</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">        &#123;<span class="number">3.5</span>, <span class="number">6.5</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">        &#123;<span class="number">3.5</span>, <span class="number">20.5</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">        &#123;<span class="number">3.5</span>, <span class="number">14.5</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">        &#123;<span class="number">14.5</span>, <span class="number">20.5</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// row of pillars in front of wall: fisheye test</span></span><br><span class="line">        &#123;<span class="number">18.5</span>, <span class="number">10.5</span>, <span class="number">1</span>, <span class="number">0</span>&#125;,</span><br><span class="line">        &#123;<span class="number">18.5</span>, <span class="number">11.5</span>, <span class="number">1</span>, <span class="number">0</span>&#125;,</span><br><span class="line">        &#123;<span class="number">18.5</span>, <span class="number">12.5</span>, <span class="number">1</span>, <span class="number">0</span>&#125;,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// some barrels around the map</span></span><br><span class="line">        &#123;<span class="number">21.5</span>, <span class="number">1.5</span>, <span class="number">2</span>, <span class="number">0</span>&#125;,</span><br><span class="line">        &#123;<span class="number">15.5</span>, <span class="number">1.5</span>, <span class="number">2</span>, <span class="number">0</span>&#125;,</span><br><span class="line">        &#123;<span class="number">16.0</span>, <span class="number">1.8</span>, <span class="number">2</span>, <span class="number">0</span>&#125;,</span><br><span class="line">        &#123;<span class="number">16.2</span>, <span class="number">1.2</span>, <span class="number">2</span>, <span class="number">0</span>&#125;,</span><br><span class="line">        &#123;<span class="number">3.5</span>, <span class="number">2.5</span>, <span class="number">2</span>, <span class="number">0</span>&#125;,</span><br><span class="line">        &#123;<span class="number">9.5</span>, <span class="number">15.5</span>, <span class="number">2</span>, <span class="number">0</span>&#125;,</span><br><span class="line">        &#123;<span class="number">10.0</span>, <span class="number">15.1</span>, <span class="number">2</span>, <span class="number">0</span>&#125;,</span><br><span class="line">        &#123;<span class="number">10.5</span>, <span class="number">15.8</span>, <span class="number">2</span>, <span class="number">0</span>&#125;,</span><br><span class="line"></span><br><span class="line">        <span class="comment">/************************************************************/</span></span><br><span class="line">        <span class="comment">/* illustration</span></span><br><span class="line"><span class="comment">        /************************************************************/</span></span><br><span class="line">        <span class="comment">// 北原春希立绘，刚进游戏就能看见</span></span><br><span class="line">        &#123;<span class="number">20.6</span>, <span class="number">11.5</span>, <span class="number">0</span>, <span class="number">1</span>&#125;,</span><br><span class="line">        <span class="comment">// 小木曾雪菜流汗黄豆立绘</span></span><br><span class="line">        &#123;<span class="number">18</span>, <span class="number">3.25</span>, <span class="number">1</span>, <span class="number">1</span>&#125;,</span><br><span class="line">        <span class="comment">// 小木曾雪菜怒立绘</span></span><br><span class="line">        &#123;<span class="number">8.0</span>, <span class="number">4.5</span>, <span class="number">2</span>, <span class="number">1</span>&#125;,</span><br><span class="line">        <span class="comment">// 小木曾雪菜哭1</span></span><br><span class="line">        &#123;<span class="number">21</span>, <span class="number">8</span>, <span class="number">3</span>, <span class="number">1</span>&#125;,</span><br><span class="line">        <span class="comment">// 小木曾雪菜哭2</span></span><br><span class="line">        &#123;<span class="number">22.5</span>, <span class="number">3.5</span>, <span class="number">4</span>, <span class="number">1</span>&#125;,</span><br><span class="line">        <span class="comment">// 冬马和纱斗鸡眼</span></span><br><span class="line">        &#123;<span class="number">17.1</span>, <span class="number">14.7</span>, <span class="number">5</span>, <span class="number">1</span>&#125;,</span><br><span class="line">        <span class="comment">// 冬马和纱怒</span></span><br><span class="line">        &#123;<span class="number">22.5</span>, <span class="number">18.5</span>, <span class="number">6</span>, <span class="number">1</span>&#125;,</span><br><span class="line">        <span class="comment">// 冬马和纱闭眼</span></span><br><span class="line">        &#123;<span class="number">16.8</span>, <span class="number">21.5</span>, <span class="number">7</span>, <span class="number">1</span>&#125;,</span><br><span class="line">        <span class="comment">// 冬马和纱笑</span></span><br><span class="line">        &#123;<span class="number">3</span>, <span class="number">12</span>, <span class="number">8</span>, <span class="number">1</span>&#125;,</span><br><span class="line">        <span class="comment">// 小春</span></span><br><span class="line">        &#123;<span class="number">10.1</span>, <span class="number">18.3</span>, <span class="number">9</span>, <span class="number">1</span>&#125;,</span><br><span class="line">        <span class="comment">// 千晶</span></span><br><span class="line">        &#123;<span class="number">2.5</span>, <span class="number">21.2</span>, <span class="number">10</span>, <span class="number">1</span>&#125;,</span><br><span class="line">        <span class="comment">// 麻理</span></span><br><span class="line">        &#123;<span class="number">6.4</span>, <span class="number">19.2</span>, <span class="number">11</span>, <span class="number">1</span>&#125;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// Order数组，并且初始化数目为decorationNum + illustrationNum</span></span><br><span class="line"><span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">Allsprites_Order</span><span class="params">(decorationNum + illustrationNum)</span></span>;</span><br><span class="line"><span class="comment">// Distance数组，并且初始化数目为decorationNum + illustrationNum</span></span><br><span class="line"><span class="function">vector&lt;<span class="type">double</span>&gt; <span class="title">Allsprites_Distance</span><span class="params">(decorationNum + illustrationNum)</span></span>;</span><br><span class="line"><span class="comment">// 全部Sprite的排序函数，用于画出全部Sprite</span></span><br><span class="line"><span class="comment">// 注意传递vector的引用</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">sortAllSprites</span><span class="params">(vector&lt;<span class="type">int</span>&gt; &amp;Allsprites_Order, vector&lt;<span class="type">double</span>&gt; &amp;Allsprites_Distance, <span class="type">int</span> amount)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取时间</span></span><br><span class="line"><span class="function"><span class="type">unsigned</span> <span class="type">long</span> <span class="title">getTicks</span><span class="params">()</span></span>;</span><br><span class="line"><span class="comment">// 读取纹理，分别读取墙面地板天花板纹理、decoration纹理、illustration纹理</span></span><br><span class="line"><span class="comment">// 并且在其中调用修改alpha的函数，防止出现纯黑遮挡</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">LoadTexture</span><span class="params">()</span></span>;</span><br><span class="line"><span class="comment">// 修改纹理透明度，用于decoration和illustration纹理纯黑颜色修改为透明 (Alpha通道改为0)</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">SetTexture_Alpha</span><span class="params">(Texture *texture, <span class="type">int</span> start_index, <span class="type">int</span> end_index)</span></span>;</span><br><span class="line"><span class="comment">// 纹理墙壁绘制</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Wall_Casting</span><span class="params">(RenderWindow &amp;window)</span></span>;</span><br><span class="line"><span class="comment">// 纹理地板天花板绘制</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Floor_Ceiling_Casting</span><span class="params">(RenderWindow &amp;window)</span></span>;</span><br><span class="line"><span class="comment">// 移动函数，用于改变位置和朝向</span></span><br><span class="line"><span class="comment">// 已添加鼠标操作逻辑</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Move</span><span class="params">(RenderWindow &amp;window)</span></span>;</span><br><span class="line"><span class="comment">// 计算FOV大小，弧度制</span></span><br><span class="line"><span class="function"><span class="type">double</span> <span class="title">calculate_FOV</span><span class="params">()</span></span>;</span><br><span class="line"><span class="comment">// 画出Decoration Sprite</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Decoration_Casting</span><span class="params">(RenderWindow &amp;window)</span></span>;</span><br><span class="line"><span class="comment">// 画出illustration Sprite</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Illustration_Casting</span><span class="params">(RenderWindow &amp;window)</span></span>;</span><br><span class="line"><span class="comment">// 画出全部Sprite</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Allsprites_Casting</span><span class="params">(RenderWindow &amp;window)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/************************************************************/</span></span><br><span class="line"><span class="comment">/* 绘制小地图</span></span><br><span class="line"><span class="comment">/************************************************************/</span></span><br><span class="line"><span class="comment">// 小地图的宽度和高度</span></span><br><span class="line"><span class="type">const</span> <span class="type">int</span> minimapWidth = <span class="number">24</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">int</span> minimapHeight = <span class="number">24</span>;</span><br><span class="line"><span class="comment">// 小地图的大小（单位：像素）</span></span><br><span class="line"><span class="type">const</span> <span class="type">int</span> miniMapScale = <span class="number">15</span>;</span><br><span class="line"><span class="type">bool</span> ifdraw_Minimap = <span class="number">1</span>;</span><br><span class="line"><span class="comment">// 创建一个表示视野范围的三角扇形</span></span><br><span class="line"><span class="function">VertexArray <span class="title">FOV_Visualize</span><span class="params">(TriangleFan, screenWidth + <span class="number">1</span>)</span></span>;</span><br><span class="line"><span class="comment">// 记录视野范围每一处的位置</span></span><br><span class="line"><span class="comment">// 在墙壁绘制函数里修改值，在drawMiniMap函数里设置FOV位置</span></span><br><span class="line"><span class="function">vector&lt;Vector2f&gt; <span class="title">FOV_position</span><span class="params">(screenWidth + <span class="number">1</span>)</span></span>;</span><br><span class="line"><span class="comment">// 绘制小地图函数</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">drawMiniMap</span><span class="params">(RenderWindow &amp;window)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">RenderWindow <span class="title">window</span><span class="params">(sf::VideoMode(screenWidth, screenHeight), <span class="string">&quot;Raycasting-Final&quot;</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 加载纹理</span></span><br><span class="line">    <span class="built_in">LoadTexture</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 是否允许鼠标逻辑控制</span></span><br><span class="line">    <span class="keyword">if</span> (ifMouse)</span><br><span class="line">    &#123;</span><br><span class="line">        Mouse::<span class="built_in">setPosition</span>(<span class="built_in">Vector2i</span>(screenWidth * <span class="number">0.5f</span>, screenHeight * <span class="number">0.5f</span>), window);</span><br><span class="line">        window.<span class="built_in">setMouseCursorVisible</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 计算FOV视角</span></span><br><span class="line">    FOV = <span class="built_in">calculate_FOV</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (window.<span class="built_in">isOpen</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        sf::Event event;</span><br><span class="line">        <span class="keyword">while</span> (window.<span class="built_in">pollEvent</span>(event))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 考虑到鼠标操作，使用ESC退出</span></span><br><span class="line">            <span class="keyword">if</span> (event.type == sf::Event::Closed || sf::Keyboard::<span class="built_in">isKeyPressed</span>(sf::Keyboard::Escape))</span><br><span class="line">                window.<span class="built_in">close</span>();</span><br><span class="line">            <span class="comment">// sf::Keyboard::isKeyPressed函数会在每一帧都检测键盘的状态</span></span><br><span class="line">            <span class="comment">// sf::Event::KeyPressed事件只会在按键被按下的那一帧触发一次，即使你按住按键不放，它也不会在下一帧再次触发</span></span><br><span class="line">            <span class="comment">// 因此，使用sf::Event::KeyPressed事件可以确保ifdraw_Minimap的值只会被翻转一次</span></span><br><span class="line">            <span class="keyword">if</span> (event.type == sf::Event::KeyPressed)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 按Tab键、~键或M键开关小地图</span></span><br><span class="line">                <span class="keyword">if</span> (event.key.code == sf::Keyboard::Tab || event.key.code == sf::Keyboard::Tilde || event.key.code == sf::Keyboard::M)</span><br><span class="line">                &#123;</span><br><span class="line">                    ifdraw_Minimap = !ifdraw_Minimap;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        window.<span class="built_in">clear</span>();</span><br><span class="line">        <span class="built_in">Floor_Ceiling_Casting</span>(window);</span><br><span class="line">        <span class="built_in">Wall_Casting</span>(window);</span><br><span class="line">        <span class="comment">// Decoration_Casting(window);</span></span><br><span class="line">        <span class="comment">// Illustration_Casting(window);</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">Allsprites_Casting</span>(window);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">Move</span>(window);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ifdraw_Minimap)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">drawMiniMap</span>(window);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// cout &lt;&lt; &quot;posX: &quot; &lt;&lt; posX &lt;&lt; &quot; posY: &quot; &lt;&lt; posY &lt;&lt; endl;</span></span><br><span class="line"></span><br><span class="line">        window.<span class="built_in">display</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">unsigned</span> <span class="type">long</span> <span class="title">getTicks</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    sf::Time elapsed = Myclock.<span class="built_in">getElapsedTime</span>();</span><br><span class="line">    <span class="keyword">return</span> elapsed.<span class="built_in">asMilliseconds</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">LoadTexture</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 读取墙壁、地板天花板纹理</span></span><br><span class="line">    texture[<span class="number">0</span>].<span class="built_in">loadFromFile</span>(<span class="string">&quot;pics/eagle.png&quot;</span>);</span><br><span class="line">    texture[<span class="number">1</span>].<span class="built_in">loadFromFile</span>(<span class="string">&quot;pics/redbrick.png&quot;</span>);</span><br><span class="line">    texture[<span class="number">2</span>].<span class="built_in">loadFromFile</span>(<span class="string">&quot;pics/purplestone.png&quot;</span>);</span><br><span class="line">    texture[<span class="number">3</span>].<span class="built_in">loadFromFile</span>(<span class="string">&quot;pics/greystone.png&quot;</span>);</span><br><span class="line">    texture[<span class="number">4</span>].<span class="built_in">loadFromFile</span>(<span class="string">&quot;pics/bluestone.png&quot;</span>);</span><br><span class="line">    texture[<span class="number">5</span>].<span class="built_in">loadFromFile</span>(<span class="string">&quot;pics/mossy.png&quot;</span>);</span><br><span class="line">    texture[<span class="number">6</span>].<span class="built_in">loadFromFile</span>(<span class="string">&quot;pics/wood.png&quot;</span>);</span><br><span class="line">    texture[<span class="number">7</span>].<span class="built_in">loadFromFile</span>(<span class="string">&quot;pics/colorstone.png&quot;</span>);</span><br><span class="line">    <span class="comment">// 地板天花板渲染用的image</span></span><br><span class="line">    Ceiling_image = texture[<span class="number">6</span>].<span class="built_in">copyToImage</span>(); <span class="comment">// 天花板为木头</span></span><br><span class="line">    Floor_image = texture[<span class="number">3</span>].<span class="built_in">copyToImage</span>();   <span class="comment">// 地板为石头</span></span><br><span class="line">    <span class="comment">// 读取decoration纹理</span></span><br><span class="line">    decoration_texture[<span class="number">0</span>].<span class="built_in">loadFromFile</span>(<span class="string">&quot;pics/greenlight.png&quot;</span>);</span><br><span class="line">    decoration_texture[<span class="number">1</span>].<span class="built_in">loadFromFile</span>(<span class="string">&quot;pics/pillar.png&quot;</span>);</span><br><span class="line">    decoration_texture[<span class="number">2</span>].<span class="built_in">loadFromFile</span>(<span class="string">&quot;pics/barrel.png&quot;</span>);</span><br><span class="line">    <span class="comment">// 纯黑部分改透明</span></span><br><span class="line">    <span class="built_in">SetTexture_Alpha</span>(decoration_texture, <span class="number">0</span>, <span class="number">2</span>);</span><br><span class="line">    <span class="comment">// 读取illustration纹理</span></span><br><span class="line">    illustration_texture[<span class="number">0</span>].<span class="built_in">loadFromFile</span>(<span class="string">&quot;illustration/haruki.png&quot;</span>);</span><br><span class="line">    illustration_texture[<span class="number">1</span>].<span class="built_in">loadFromFile</span>(<span class="string">&quot;illustration/setsuna0.png&quot;</span>);</span><br><span class="line">    illustration_texture[<span class="number">2</span>].<span class="built_in">loadFromFile</span>(<span class="string">&quot;illustration/setsuna1.png&quot;</span>);</span><br><span class="line">    illustration_texture[<span class="number">3</span>].<span class="built_in">loadFromFile</span>(<span class="string">&quot;illustration/setsuna2.png&quot;</span>);</span><br><span class="line">    illustration_texture[<span class="number">4</span>].<span class="built_in">loadFromFile</span>(<span class="string">&quot;illustration/setsuna3.png&quot;</span>);</span><br><span class="line">    illustration_texture[<span class="number">5</span>].<span class="built_in">loadFromFile</span>(<span class="string">&quot;illustration/kazusa0.png&quot;</span>);</span><br><span class="line">    illustration_texture[<span class="number">6</span>].<span class="built_in">loadFromFile</span>(<span class="string">&quot;illustration/kazusa1.png&quot;</span>);</span><br><span class="line">    illustration_texture[<span class="number">7</span>].<span class="built_in">loadFromFile</span>(<span class="string">&quot;illustration/kazusa2.png&quot;</span>);</span><br><span class="line">    illustration_texture[<span class="number">8</span>].<span class="built_in">loadFromFile</span>(<span class="string">&quot;illustration/kazusa3.png&quot;</span>);</span><br><span class="line">    illustration_texture[<span class="number">9</span>].<span class="built_in">loadFromFile</span>(<span class="string">&quot;illustration/koharu.png&quot;</span>);</span><br><span class="line">    illustration_texture[<span class="number">10</span>].<span class="built_in">loadFromFile</span>(<span class="string">&quot;illustration/chiaki.png&quot;</span>);</span><br><span class="line">    illustration_texture[<span class="number">11</span>].<span class="built_in">loadFromFile</span>(<span class="string">&quot;illustration/mari.png&quot;</span>);</span><br><span class="line">    <span class="comment">// 纯黑部分改透明</span></span><br><span class="line">    <span class="built_in">SetTexture_Alpha</span>(illustration_texture, <span class="number">0</span>, <span class="number">11</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">SetTexture_Alpha</span><span class="params">(Texture *texture, <span class="type">int</span> start_index, <span class="type">int</span> end_index)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = start_index; i &lt;= end_index; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        Image tmp = texture[i].<span class="built_in">copyToImage</span>();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> y = <span class="number">0</span>; y &lt; tmp.<span class="built_in">getSize</span>().y; y++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> x = <span class="number">0</span>; x &lt; tmp.<span class="built_in">getSize</span>().x; x++)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (tmp.<span class="built_in">getPixel</span>(x, y) == Color::Black)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// 设置为完全透明</span></span><br><span class="line">                    tmp.<span class="built_in">setPixel</span>(x, y, sf::<span class="built_in">Color</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        texture[i].<span class="built_in">loadFromImage</span>(tmp); <span class="comment">// 用修改后的图像覆盖原数组的纹理</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Floor_Ceiling_Casting</span><span class="params">(RenderWindow &amp;window)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 创建一个新的Image</span></span><br><span class="line">    Image Floor_Ceiling_image;</span><br><span class="line">    Floor_Ceiling_image.<span class="built_in">create</span>(screenWidth, screenHeight);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// rayDir for leftmost ray (x = 0) and rightmost ray (x = w)</span></span><br><span class="line">    <span class="type">float</span> FOV_StartX = dirX - planeX;</span><br><span class="line">    <span class="type">float</span> FOV_StartY = dirY - planeY;</span><br><span class="line">    <span class="type">float</span> FOV_EndX = dirX + planeX;</span><br><span class="line">    <span class="type">float</span> FOV_EndY = dirY + planeY;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Vertical position of the camera.</span></span><br><span class="line">    <span class="type">float</span> posZ = <span class="number">0.5</span> * screenHeight;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// FLOOR AND CEILING CASTING</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> y = screenHeight / <span class="number">2</span>; y &lt; screenHeight; y++) <span class="comment">// 其实可以直接从screenHeight / 2开始遍历</span></span><br><span class="line">    <span class="comment">// for (int y = 0; y &lt; screenHeight; y++)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// Current y position compared to the center of the screen (the horizon)</span></span><br><span class="line">        <span class="type">int</span> row_y = y - screenHeight / <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Horizontal distance from the camera to the floor for the current row.</span></span><br><span class="line">        <span class="comment">// 0.5 is the z position exactly in the middle between floor and ceiling.</span></span><br><span class="line">        <span class="type">float</span> rowDistance = posZ / row_y;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// real world coordinates of the leftmost column. This will be updated as we step to the right.</span></span><br><span class="line">        <span class="type">float</span> floorX = posX + rowDistance * FOV_StartX;</span><br><span class="line">        <span class="type">float</span> floorY = posY + rowDistance * FOV_StartY;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// calculate the real world step vector we have to add for each x (parallel to camera plane)</span></span><br><span class="line">        <span class="comment">// adding step by step avoids multiplications with a weight in the inner loop</span></span><br><span class="line">        <span class="type">float</span> floorStepX = rowDistance * (FOV_EndX - FOV_StartX) / screenWidth;</span><br><span class="line">        <span class="type">float</span> floorStepY = rowDistance * (FOV_EndY - FOV_StartY) / screenWidth;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> x = <span class="number">0</span>; x &lt; screenWidth; ++x)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// the cell coord is simply got from the integer parts of floorX and floorY</span></span><br><span class="line">            <span class="type">int</span> cellX = (<span class="type">int</span>)(floorX);</span><br><span class="line">            <span class="type">int</span> cellY = (<span class="type">int</span>)(floorY);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// get the texture coordinate from the fractional part</span></span><br><span class="line">            <span class="type">int</span> tx = (<span class="type">int</span>)(texWidth * (floorX - cellX)) &amp; (texWidth - <span class="number">1</span>);</span><br><span class="line">            <span class="type">int</span> ty = (<span class="type">int</span>)(texHeight * (floorY - cellY)) &amp; (texHeight - <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">            floorX += floorStepX;</span><br><span class="line">            floorY += floorStepY;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 计算像素颜色，逐像素赋值</span></span><br><span class="line">            Color Floorcolor = Floor_image.<span class="built_in">getPixel</span>(tx, ty);</span><br><span class="line">            Color Ceilingcolor = Ceiling_image.<span class="built_in">getPixel</span>(tx, ty);</span><br><span class="line">            Floor_Ceiling_image.<span class="built_in">setPixel</span>(x, y, Floorcolor);</span><br><span class="line">            Floor_Ceiling_image.<span class="built_in">setPixel</span>(x, screenHeight - y - <span class="number">1</span>, Ceilingcolor);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 创建一个新的Texture</span></span><br><span class="line">    Texture Floor_Ceiling_texture;</span><br><span class="line">    Floor_Ceiling_texture.<span class="built_in">loadFromImage</span>(Floor_Ceiling_image);</span><br><span class="line">    <span class="comment">// 创建一个新的Sprite并设置其纹理</span></span><br><span class="line">    Sprite sprite;</span><br><span class="line">    sprite.<span class="built_in">setTexture</span>(Floor_Ceiling_texture);</span><br><span class="line">    <span class="comment">// 把这个Sprite画在屏幕上</span></span><br><span class="line">    window.<span class="built_in">draw</span>(sprite);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Wall_Casting</span><span class="params">(RenderWindow &amp;window)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> x = <span class="number">0</span>; x &lt; screenWidth; x++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// calculate ray position and direction</span></span><br><span class="line">        <span class="type">double</span> cameraX = <span class="number">2</span> * x / (<span class="type">double</span>)screenWidth - <span class="number">1</span>; <span class="comment">// x-coordinate in camera space</span></span><br><span class="line">        <span class="type">double</span> rayDirX = dirX + planeX * cameraX;</span><br><span class="line">        <span class="type">double</span> rayDirY = dirY + planeY * cameraX;</span><br><span class="line">        <span class="comment">// which box of the map we&#x27;re in</span></span><br><span class="line">        <span class="type">int</span> mapX = <span class="built_in">int</span>(posX);</span><br><span class="line">        <span class="type">int</span> mapY = <span class="built_in">int</span>(posY);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// length of ray from current position to next x or y-side</span></span><br><span class="line">        <span class="type">double</span> sideDistX;</span><br><span class="line">        <span class="type">double</span> sideDistY;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/************************************************************/</span></span><br><span class="line">        <span class="comment">/* 避免鱼眼效应相关代码</span></span><br><span class="line"><span class="comment">        /************************************************************/</span></span><br><span class="line">        <span class="comment">// 此段代码会避免鱼眼效应，而不是修正鱼眼效应</span></span><br><span class="line">        <span class="type">double</span> deltaDistX = (rayDirX == <span class="number">0</span>) ? <span class="number">1e30</span> : std::<span class="built_in">abs</span>(<span class="number">1</span> / rayDirX);</span><br><span class="line">        <span class="type">double</span> deltaDistY = (rayDirY == <span class="number">0</span>) ? <span class="number">1e30</span> : std::<span class="built_in">abs</span>(<span class="number">1</span> / rayDirY);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//// 此段代码会造成鱼眼效应</span></span><br><span class="line">        <span class="comment">// double rayDir_len = sqrt(rayDirX * rayDirX + rayDirY * rayDirY);</span></span><br><span class="line">        <span class="comment">// double deltaDistX = (rayDirX == 0) ? 1e30 : std::abs(rayDir_len / rayDirX);</span></span><br><span class="line">        <span class="comment">// double deltaDistY = (rayDirY == 0) ? 1e30 : std::abs(rayDir_len / rayDirY);</span></span><br><span class="line"></span><br><span class="line">        <span class="type">double</span> perpWallDist;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// what direction to step in x or y-direction (either +1 or -1)</span></span><br><span class="line">        <span class="type">int</span> stepX;</span><br><span class="line">        <span class="type">int</span> stepY;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> hit = <span class="number">0</span>; <span class="comment">// was there a wall hit?</span></span><br><span class="line">        <span class="type">int</span> side;    <span class="comment">// was a NS or a EW wall hit?</span></span><br><span class="line">        <span class="comment">// calculate step and initial sideDist</span></span><br><span class="line">        <span class="keyword">if</span> (rayDirX &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            stepX = <span class="number">-1</span>;</span><br><span class="line">            sideDistX = (posX - mapX) * deltaDistX;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            stepX = <span class="number">1</span>;</span><br><span class="line">            sideDistX = (mapX + <span class="number">1.0</span> - posX) * deltaDistX;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (rayDirY &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            stepY = <span class="number">-1</span>;</span><br><span class="line">            sideDistY = (posY - mapY) * deltaDistY;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            stepY = <span class="number">1</span>;</span><br><span class="line">            sideDistY = (mapY + <span class="number">1.0</span> - posY) * deltaDistY;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// perform DDA</span></span><br><span class="line">        <span class="keyword">while</span> (hit == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// jump to next map square, either in x-direction, or in y-direction</span></span><br><span class="line">            <span class="keyword">if</span> (sideDistX &lt; sideDistY)</span><br><span class="line">            &#123;</span><br><span class="line">                sideDistX += deltaDistX;</span><br><span class="line">                mapX += stepX;</span><br><span class="line">                side = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                sideDistY += deltaDistY;</span><br><span class="line">                mapY += stepY;</span><br><span class="line">                side = <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// Check if ray has hit a wall</span></span><br><span class="line">            <span class="keyword">if</span> (worldMap[mapX][mapY] &gt; <span class="number">0</span>)</span><br><span class="line">                hit = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 教程里这部分解释的比较清楚了</span></span><br><span class="line">        <span class="comment">// 也可以看我在博客里的证明过程，写的更清楚</span></span><br><span class="line">        <span class="keyword">if</span> (side == <span class="number">0</span>)</span><br><span class="line">            perpWallDist = (sideDistX - deltaDistX);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            perpWallDist = (sideDistY - deltaDistY);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*********************************************************************************/</span></span><br><span class="line">        <span class="comment">/*  此部分为添加FOV_Visualize用</span></span><br><span class="line"><span class="comment">        /*********************************************************************************/</span></span><br><span class="line">        <span class="comment">// 计算射线终点</span></span><br><span class="line">        <span class="type">double</span> rayEndX = posX + perpWallDist * rayDirX;</span><br><span class="line">        <span class="type">double</span> rayEndY = posY + perpWallDist * rayDirY;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 记录三角扇形顶点位置</span></span><br><span class="line">        FOV_position[x + <span class="number">1</span>] = <span class="built_in">Vector2f</span>(rayEndX * miniMapScale, (mapHeight - rayEndY) * miniMapScale);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*********************************************************************************/</span></span><br><span class="line">        <span class="comment">/* 添加ZBuffer</span></span><br><span class="line"><span class="comment">        /*********************************************************************************/</span></span><br><span class="line">        ZBuffer[x] = perpWallDist;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Calculate height of line to draw on screen</span></span><br><span class="line">        <span class="comment">// 可以任意修改墙的高度</span></span><br><span class="line">        <span class="type">int</span> lineHeight = (<span class="type">int</span>)(screenHeight / perpWallDist);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// calculate lowest and highest pixel to fill in current stripe</span></span><br><span class="line">        <span class="type">int</span> drawStart = -lineHeight / <span class="number">2</span> + screenHeight / <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">if</span> (drawStart &lt; <span class="number">0</span>)</span><br><span class="line">            drawStart = <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> drawEnd = lineHeight / <span class="number">2</span> + screenHeight / <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">if</span> (drawEnd &gt;= screenHeight)</span><br><span class="line">            drawEnd = screenHeight - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*********************************************************************************/</span></span><br><span class="line">        <span class="comment">/*  此部分替换了原raycasting画线部分</span></span><br><span class="line"><span class="comment">        /*  以下为纹理相关计算，是新内容</span></span><br><span class="line"><span class="comment">        /*  具体和原来的画线函数差不多，都是在具体位置上画出一条线</span></span><br><span class="line"><span class="comment">        /*  只不过这里画的是具体纹理上的一条线，利用了SFML中的sprite</span></span><br><span class="line"><span class="comment">        /*********************************************************************************/</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// texturing calculations</span></span><br><span class="line">        <span class="type">int</span> texNum = worldMap[mapX][mapY] - <span class="number">1</span>; <span class="comment">// 1 subtracted from it so that texture 0 can be used!</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// calculate value of wallX</span></span><br><span class="line">        <span class="type">double</span> wallX; <span class="comment">// where exactly the wall was hit</span></span><br><span class="line">        <span class="keyword">if</span> (side == <span class="number">0</span>)</span><br><span class="line">            wallX = posY + perpWallDist * rayDirY;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            wallX = posX + perpWallDist * rayDirX;</span><br><span class="line">        wallX -= <span class="built_in">floor</span>((wallX));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// x coordinate on the texture</span></span><br><span class="line">        <span class="type">int</span> texX = <span class="built_in">int</span>(wallX * <span class="built_in">double</span>(texWidth));</span><br><span class="line">        <span class="comment">// 防止镜像</span></span><br><span class="line">        <span class="keyword">if</span> (side == <span class="number">0</span> &amp;&amp; rayDirX &gt; <span class="number">0</span>)</span><br><span class="line">            texX = texWidth - texX - <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> (side == <span class="number">1</span> &amp;&amp; rayDirY &lt; <span class="number">0</span>)</span><br><span class="line">            texX = texWidth - texX - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 为了获取纹理具体某一个坐标的像素颜色</span></span><br><span class="line">        <span class="comment">// 创建一个新的sprite对象</span></span><br><span class="line">        sf::Sprite wall_sprite;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置sprite的纹理</span></span><br><span class="line">        wall_sprite.<span class="built_in">setTexture</span>(texture[texNum]);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置sprite的纹理矩形，定义了在纹理中的哪个部分应用到wall_sprite上</span></span><br><span class="line">        <span class="comment">// 宽度为1个像素，相当于原来的画线</span></span><br><span class="line">        wall_sprite.<span class="built_in">setTextureRect</span>(sf::<span class="built_in">IntRect</span>(texX, <span class="number">0</span>, <span class="number">1</span>, texHeight));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置sprite的位置，坐标指定了左上角的位置</span></span><br><span class="line">        <span class="comment">// wall_sprite.setPosition(x, drawStart);        //太几把恶心了，破案了：指定左上角的位置为drawStart</span></span><br><span class="line">        <span class="comment">//                                               //drawStart在特殊情况下会被赋值为0，即if (drawStart &lt; 0) drawStart = 0;</span></span><br><span class="line">        <span class="comment">//                                               //在此情况下绘制的起点就会改变为0，令人恶心</span></span><br><span class="line">        wall_sprite.<span class="built_in">setPosition</span>(x, <span class="built_in">round</span>(<span class="number">0.5f</span> * screenHeight - <span class="number">0.5f</span> * lineHeight));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置sprite的缩放因子</span></span><br><span class="line">        wall_sprite.<span class="built_in">setScale</span>(<span class="number">1</span>, lineHeight / (<span class="type">float</span>)texHeight);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 利用SFML中sprite的setColor功能，使y墙变暗</span></span><br><span class="line">        <span class="comment">// 这个函数实现的是“调制混合”</span></span><br><span class="line">        <span class="comment">// 举个例子：原来的R通道为200，与128混合为：200 * 128 / 255 = 100，实现了颜色除以2的效果</span></span><br><span class="line">        <span class="keyword">if</span> (side == <span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            wall_sprite.<span class="built_in">setColor</span>(<span class="built_in">Color</span>(<span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 绘制sprite</span></span><br><span class="line">        window.<span class="built_in">draw</span>(wall_sprite);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 移动函数，用于改变位置和朝向</span></span><br><span class="line"><span class="comment">// 已经实现鼠标左右转</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Move</span><span class="params">(RenderWindow &amp;window)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// timing for input and FPS counter</span></span><br><span class="line">    old_Time = new_Time;</span><br><span class="line">    new_Time = <span class="built_in">getTicks</span>();</span><br><span class="line">    <span class="type">double</span> frameTime = (new_Time - old_Time) / <span class="number">1000.0</span>; <span class="comment">// frameTime is the time this frame has taken, in seconds</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// speed modifiers</span></span><br><span class="line">    <span class="type">double</span> moveSpeed = frameTime * <span class="number">3.0</span>; <span class="comment">// the constant value is in squares/second</span></span><br><span class="line">    <span class="comment">// 这个旋转速度计算的是方向键左右逻辑，类似于坦克视角移动</span></span><br><span class="line">    <span class="type">double</span> rotSpeed = frameTime * <span class="number">2.0</span>; <span class="comment">// the constant value is in radians/second</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 这些是计算鼠标移动逻辑</span></span><br><span class="line">    <span class="comment">// 获取窗口的中心位置</span></span><br><span class="line">    <span class="function">Vector2i <span class="title">center</span><span class="params">(screenWidth * <span class="number">0.5f</span>, screenHeight * <span class="number">0.5f</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取鼠标当前位置</span></span><br><span class="line">    Vector2i position_now = Mouse::<span class="built_in">getPosition</span>(window);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 计算鼠标的旋转角度</span></span><br><span class="line">    <span class="comment">// 水平方向旋转角度</span></span><br><span class="line">    <span class="type">double</span> rotation_degree_horizontal = (center.x - position_now.x) * FOV / screenWidth;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ifMouse)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 更新方向</span></span><br><span class="line">        <span class="comment">// dir和plane一起更新</span></span><br><span class="line">        <span class="type">double</span> oldDirX = dirX;</span><br><span class="line">        dirX = dirX * <span class="built_in">cos</span>(rotation_degree_horizontal) - dirY * <span class="built_in">sin</span>(rotation_degree_horizontal);</span><br><span class="line">        dirY = oldDirX * <span class="built_in">sin</span>(rotation_degree_horizontal) + dirY * <span class="built_in">cos</span>(rotation_degree_horizontal);</span><br><span class="line">        <span class="type">double</span> oldPlaneX = planeX;</span><br><span class="line">        planeX = planeX * <span class="built_in">cos</span>(rotation_degree_horizontal) - planeY * <span class="built_in">sin</span>(rotation_degree_horizontal);</span><br><span class="line">        planeY = oldPlaneX * <span class="built_in">sin</span>(rotation_degree_horizontal) + planeY * <span class="built_in">cos</span>(rotation_degree_horizontal);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将鼠标位置重置到窗口中心</span></span><br><span class="line">        Mouse::<span class="built_in">setPosition</span>(center, window);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// move forward if no wall in front of you</span></span><br><span class="line">    <span class="keyword">if</span> (sf::Keyboard::<span class="built_in">isKeyPressed</span>(sf::Keyboard::Up) ||</span><br><span class="line">        sf::Keyboard::<span class="built_in">isKeyPressed</span>(sf::Keyboard::W))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (worldMap[<span class="built_in">int</span>(posX + dirX * moveSpeed)][<span class="built_in">int</span>(posY)] == <span class="literal">false</span>)</span><br><span class="line">            posX += dirX * moveSpeed;</span><br><span class="line">        <span class="keyword">if</span> (worldMap[<span class="built_in">int</span>(posX)][<span class="built_in">int</span>(posY + dirY * moveSpeed)] == <span class="literal">false</span>)</span><br><span class="line">            posY += dirY * moveSpeed;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// move backwards if no wall behind you</span></span><br><span class="line">    <span class="keyword">if</span> (sf::Keyboard::<span class="built_in">isKeyPressed</span>(sf::Keyboard::Down) ||</span><br><span class="line">        sf::Keyboard::<span class="built_in">isKeyPressed</span>(sf::Keyboard::S))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (worldMap[<span class="built_in">int</span>(posX - dirX * moveSpeed)][<span class="built_in">int</span>(posY)] == <span class="literal">false</span>)</span><br><span class="line">            posX -= dirX * moveSpeed;</span><br><span class="line">        <span class="keyword">if</span> (worldMap[<span class="built_in">int</span>(posX)][<span class="built_in">int</span>(posY - dirY * moveSpeed)] == <span class="literal">false</span>)</span><br><span class="line">            posY -= dirY * moveSpeed;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 向右走，原理还是跟前后走一样，只是方向用矩阵相乘重新算了</span></span><br><span class="line">    <span class="comment">// 向右走就是在(dirY, -dirX)这个方向走</span></span><br><span class="line">    <span class="keyword">if</span> (sf::Keyboard::<span class="built_in">isKeyPressed</span>(sf::Keyboard::D))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (worldMap[<span class="built_in">int</span>(posX + dirY * moveSpeed * <span class="number">0.75</span>)][<span class="built_in">int</span>(posY)] == <span class="literal">false</span>)</span><br><span class="line">            posX += dirY * moveSpeed * <span class="number">0.75</span>;</span><br><span class="line">        <span class="keyword">if</span> (worldMap[<span class="built_in">int</span>(posX)][<span class="built_in">int</span>(posY - dirX * moveSpeed * <span class="number">0.75</span>)] == <span class="literal">false</span>)</span><br><span class="line">            posY -= dirX * moveSpeed * <span class="number">0.75</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 向左走同理</span></span><br><span class="line">    <span class="comment">// 在(-dirY, dirX)方向</span></span><br><span class="line">    <span class="keyword">if</span> (sf::Keyboard::<span class="built_in">isKeyPressed</span>(sf::Keyboard::A))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (worldMap[<span class="built_in">int</span>(posX - dirY * moveSpeed * <span class="number">0.75</span>)][<span class="built_in">int</span>(posY)] == <span class="literal">false</span>)</span><br><span class="line">            posX -= dirY * moveSpeed * <span class="number">0.75</span>;</span><br><span class="line">        <span class="keyword">if</span> (worldMap[<span class="built_in">int</span>(posX)][<span class="built_in">int</span>(posY + dirX * moveSpeed * <span class="number">0.75</span>)] == <span class="literal">false</span>)</span><br><span class="line">            posY += dirX * moveSpeed * <span class="number">0.75</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// rotate to the right</span></span><br><span class="line">    <span class="keyword">if</span> (sf::Keyboard::<span class="built_in">isKeyPressed</span>(sf::Keyboard::Right))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// both camera direction and camera plane must be rotated</span></span><br><span class="line">        <span class="type">double</span> oldDirX = dirX;</span><br><span class="line">        dirX = dirX * <span class="built_in">cos</span>(-rotSpeed) - dirY * <span class="built_in">sin</span>(-rotSpeed);</span><br><span class="line">        dirY = oldDirX * <span class="built_in">sin</span>(-rotSpeed) + dirY * <span class="built_in">cos</span>(-rotSpeed);</span><br><span class="line">        <span class="type">double</span> oldPlaneX = planeX;</span><br><span class="line">        planeX = planeX * <span class="built_in">cos</span>(-rotSpeed) - planeY * <span class="built_in">sin</span>(-rotSpeed);</span><br><span class="line">        planeY = oldPlaneX * <span class="built_in">sin</span>(-rotSpeed) + planeY * <span class="built_in">cos</span>(-rotSpeed);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// rotate to the left</span></span><br><span class="line">    <span class="keyword">if</span> (sf::Keyboard::<span class="built_in">isKeyPressed</span>(sf::Keyboard::Left))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// both camera direction and camera plane must be rotated</span></span><br><span class="line">        <span class="type">double</span> oldDirX = dirX;</span><br><span class="line">        dirX = dirX * <span class="built_in">cos</span>(rotSpeed) - dirY * <span class="built_in">sin</span>(rotSpeed);</span><br><span class="line">        dirY = oldDirX * <span class="built_in">sin</span>(rotSpeed) + dirY * <span class="built_in">cos</span>(rotSpeed);</span><br><span class="line">        <span class="type">double</span> oldPlaneX = planeX;</span><br><span class="line">        planeX = planeX * <span class="built_in">cos</span>(rotSpeed) - planeY * <span class="built_in">sin</span>(rotSpeed);</span><br><span class="line">        planeY = oldPlaneX * <span class="built_in">sin</span>(rotSpeed) + planeY * <span class="built_in">cos</span>(rotSpeed);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">double</span> <span class="title">calculate_FOV</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">double</span> length_dir = <span class="built_in">sqrt</span>(dirX * dirX + dirY * dirY);</span><br><span class="line">    <span class="type">double</span> length_plane = <span class="built_in">sqrt</span>(planeX * planeX + planeY * planeY);</span><br><span class="line">    <span class="comment">// 弧度制</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">atan</span>(length_plane / length_dir) * <span class="number">2</span>;</span><br><span class="line">    <span class="comment">// 角度制</span></span><br><span class="line">    <span class="comment">//// return atan(length_plane / length_dir) * 2 * 180 / acos(-1);</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// sort algorithm</span></span><br><span class="line"><span class="comment">// sort the sprites based on distance</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">sortSprites</span><span class="params">(<span class="type">int</span> *order, <span class="type">double</span> *dist, <span class="type">int</span> amount)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    std::vector&lt;std::pair&lt;<span class="type">double</span>, <span class="type">int</span>&gt;&gt; <span class="built_in">sprites</span>(amount);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; amount; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        sprites[i].first = dist[i];</span><br><span class="line">        sprites[i].second = order[i];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 针对pair默认就用第一个变量按升序排列</span></span><br><span class="line">    std::<span class="built_in">sort</span>(sprites.<span class="built_in">begin</span>(), sprites.<span class="built_in">end</span>());</span><br><span class="line">    <span class="comment">// restore in reverse order to go from farthest to nearest</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; amount; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        dist[i] = sprites[amount - i - <span class="number">1</span>].first;</span><br><span class="line">        order[i] = sprites[amount - i - <span class="number">1</span>].second;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 画出Decoration Sprite</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Decoration_Casting</span><span class="params">(RenderWindow &amp;window)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; decorationNum; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        decoration_Order[i] = i;</span><br><span class="line">        decoration_Distance[i] = ((posX - decoration_lst[i].x) * (posX - decoration_lst[i].x) + (posY - decoration_lst[i].y) * (posY - decoration_lst[i].y)); <span class="comment">// sqrt not taken, unneeded</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 排序</span></span><br><span class="line">    <span class="comment">// 先画远的再画近的不会导致透明遮挡问题</span></span><br><span class="line">    <span class="comment">// 因为近的Sprite透明地方可以直接显示出远的Sprite</span></span><br><span class="line">    <span class="built_in">sortSprites</span>(decoration_Order, decoration_Distance, decorationNum);</span><br><span class="line">    <span class="comment">// after sorting the sprites, do the projection and draw them</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; decorationNum; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// translate sprite position to relative to camera</span></span><br><span class="line">        <span class="type">double</span> spriteX = decoration_lst[decoration_Order[i]].x - posX;</span><br><span class="line">        <span class="type">double</span> spriteY = decoration_lst[decoration_Order[i]].y - posY;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// transform sprite with the inverse camera matrix</span></span><br><span class="line">        <span class="comment">//  [ planeX   dirX ] -1                                       [ dirY      -dirX ]</span></span><br><span class="line">        <span class="comment">//  [               ]       =  1/(planeX*dirY-dirX*planeY) *   [                 ]</span></span><br><span class="line">        <span class="comment">//  [ planeY   dirY ]                                          [ -planeY  planeX ]</span></span><br><span class="line"></span><br><span class="line">        <span class="type">double</span> invDet = <span class="number">1.0</span> / (planeX * dirY - dirX * planeY); <span class="comment">// required for correct matrix multiplication</span></span><br><span class="line"></span><br><span class="line">        <span class="type">double</span> transformX = invDet * (dirY * spriteX - dirX * spriteY);</span><br><span class="line">        <span class="type">double</span> transformY = invDet * (-planeY * spriteX + planeX * spriteY); <span class="comment">// this is actually the depth inside the screen, that what Z is in 3D</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// sprite在屏幕上的x坐标</span></span><br><span class="line">        <span class="type">int</span> spriteScreenX = <span class="built_in">int</span>((screenWidth / <span class="number">2</span>) * (<span class="number">1</span> + transformX / transformY));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// calculate height of the sprite on screen</span></span><br><span class="line">        <span class="type">int</span> spriteHeight = <span class="built_in">abs</span>(<span class="built_in">int</span>(screenHeight / (transformY))); <span class="comment">// using &#x27;transformY&#x27; instead of the real distance prevents fisheye</span></span><br><span class="line">        <span class="comment">// calculate width of the sprite</span></span><br><span class="line">        <span class="type">int</span> spriteWidth = <span class="built_in">abs</span>(<span class="built_in">int</span>(screenHeight / (transformY)));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// calculate lowest and highest pixel to fill in current stripe</span></span><br><span class="line">        <span class="comment">// 计算y上的起点，不需要计算终点，因为竖线直接指定了Sprite的高度</span></span><br><span class="line">        <span class="type">int</span> drawStartY = -spriteHeight / <span class="number">2</span> + screenHeight / <span class="number">2</span>;</span><br><span class="line">        <span class="comment">// if (drawStartY &lt; 0) drawStartY = 0;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 计算x上的起点和终点</span></span><br><span class="line">        <span class="type">int</span> drawStartX = -spriteWidth / <span class="number">2</span> + spriteScreenX;</span><br><span class="line">        <span class="keyword">if</span> (drawStartX &lt; <span class="number">0</span>)</span><br><span class="line">            drawStartX = <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> drawEndX = spriteWidth / <span class="number">2</span> + spriteScreenX;</span><br><span class="line">        <span class="keyword">if</span> (drawEndX &gt;= screenWidth)</span><br><span class="line">            drawEndX = screenWidth - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// loop through every vertical stripe of the sprite on screen</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> stripe = drawStartX; stripe &lt; drawEndX; stripe++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="type">int</span> texX = <span class="built_in">int</span>(<span class="number">256</span> * (stripe - (-spriteWidth / <span class="number">2</span> + spriteScreenX)) * texWidth / spriteWidth) / <span class="number">256</span>;</span><br><span class="line">            <span class="comment">// the conditions in the if are:</span></span><br><span class="line">            <span class="comment">// 1) it&#x27;s in front of camera plane so you don&#x27;t see things behind you</span></span><br><span class="line">            <span class="comment">// 2) it&#x27;s on the screen (left)</span></span><br><span class="line">            <span class="comment">// 3) it&#x27;s on the screen (right)</span></span><br><span class="line">            <span class="comment">// 4) ZBuffer, with perpendicular distance</span></span><br><span class="line">            <span class="keyword">if</span> (transformY &gt; <span class="number">0</span> &amp;&amp; stripe &gt; <span class="number">0</span> &amp;&amp; stripe &lt; screenWidth &amp;&amp; transformY &lt; ZBuffer[stripe])</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// decoration一条线的Sprite</span></span><br><span class="line">                Sprite decoration_sprite;</span><br><span class="line">                <span class="comment">// 设置对应纹理</span></span><br><span class="line">                decoration_sprite.<span class="built_in">setTexture</span>(decoration_texture[decoration_lst[decoration_Order[i]].texture_index]);</span><br><span class="line">                <span class="comment">// 设置sprite的纹理矩形，定义了在纹理中的哪个部分应用到decoration_sprite上</span></span><br><span class="line">                <span class="comment">// 宽度为1个像素，相当于原来的画线</span></span><br><span class="line">                decoration_sprite.<span class="built_in">setTextureRect</span>(sf::<span class="built_in">IntRect</span>(texX, <span class="number">0</span>, <span class="number">1</span>, texHeight));</span><br><span class="line">                <span class="comment">// 设置sprite的位置，坐标指定了左上角的位置</span></span><br><span class="line">                decoration_sprite.<span class="built_in">setPosition</span>(stripe, drawStartY);</span><br><span class="line">                <span class="comment">// 设置sprite的缩放因子</span></span><br><span class="line">                decoration_sprite.<span class="built_in">setScale</span>(<span class="number">1</span>, spriteHeight / (<span class="type">float</span>)texHeight);</span><br><span class="line">                <span class="comment">// 绘制sprite</span></span><br><span class="line">                window.<span class="built_in">draw</span>(decoration_sprite);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 画出illustration Sprite</span></span><br><span class="line"><span class="comment">// 如果illustration与decoration分开画，会导致透明遮挡问题</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Illustration_Casting</span><span class="params">(RenderWindow &amp;window)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; illustrationNum; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        illustration_Order[i] = i;</span><br><span class="line">        illustration_Distance[i] = ((posX - illustration_lst[i].x) * (posX - illustration_lst[i].x) + (posY - illustration_lst[i].y) * (posY - illustration_lst[i].y)); <span class="comment">// sqrt not taken, unneeded</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 排序</span></span><br><span class="line">    <span class="comment">// 先画远的再画近的不会导致透明遮挡问题</span></span><br><span class="line">    <span class="comment">// 因为近的Sprite透明地方可以直接显示出远的Sprite</span></span><br><span class="line">    <span class="built_in">sortSprites</span>(illustration_Order, illustration_Distance, illustrationNum);</span><br><span class="line">    <span class="comment">// after sorting the sprites, do the projection and draw them</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; illustrationNum; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// translate sprite position to relative to camera</span></span><br><span class="line">        <span class="type">double</span> spriteX = illustration_lst[illustration_Order[i]].x - posX;</span><br><span class="line">        <span class="type">double</span> spriteY = illustration_lst[illustration_Order[i]].y - posY;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// transform sprite with the inverse camera matrix</span></span><br><span class="line">        <span class="comment">//  [ planeX   dirX ] -1                                       [ dirY      -dirX ]</span></span><br><span class="line">        <span class="comment">//  [               ]       =  1/(planeX*dirY-dirX*planeY) *   [                 ]</span></span><br><span class="line">        <span class="comment">//  [ planeY   dirY ]                                          [ -planeY  planeX ]</span></span><br><span class="line"></span><br><span class="line">        <span class="type">double</span> invDet = <span class="number">1.0</span> / (planeX * dirY - dirX * planeY); <span class="comment">// required for correct matrix multiplication</span></span><br><span class="line"></span><br><span class="line">        <span class="type">double</span> transformX = invDet * (dirY * spriteX - dirX * spriteY);</span><br><span class="line">        <span class="type">double</span> transformY = invDet * (-planeY * spriteX + planeX * spriteY); <span class="comment">// this is actually the depth inside the screen, that what Z is in 3D</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// sprite在屏幕上的x坐标</span></span><br><span class="line">        <span class="type">int</span> spriteScreenX = <span class="built_in">int</span>((screenWidth / <span class="number">2</span>) * (<span class="number">1</span> + transformX / transformY));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// calculate height of the sprite on screen</span></span><br><span class="line">        <span class="comment">// 注意illustration这里需要给高度乘一个illustrationHeight / illustrationWidth</span></span><br><span class="line">        <span class="comment">// 用于保持长宽比，不然不好看，北原春希都被压成正方形了</span></span><br><span class="line">        <span class="type">int</span> spriteHeight = <span class="built_in">abs</span>(<span class="built_in">int</span>(screenHeight / (transformY))) * illustrationHeight / illustrationWidth; <span class="comment">// using &#x27;transformY&#x27; instead of the real distance prevents fisheye</span></span><br><span class="line">        <span class="comment">// calculate width of the sprite</span></span><br><span class="line">        <span class="type">int</span> spriteWidth = <span class="built_in">abs</span>(<span class="built_in">int</span>(screenHeight / (transformY)));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// calculate lowest and highest pixel to fill in current stripe</span></span><br><span class="line">        <span class="comment">// 计算y上的起点，不需要计算终点，因为竖线直接指定了Sprite的高度</span></span><br><span class="line">        <span class="type">int</span> drawStartY = -spriteHeight / <span class="number">2</span> + screenHeight / <span class="number">2</span>;</span><br><span class="line">        <span class="comment">// if (drawStartY &lt; 0) drawStartY = 0;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 计算x上的起点和终点</span></span><br><span class="line">        <span class="type">int</span> drawStartX = -spriteWidth / <span class="number">2</span> + spriteScreenX;</span><br><span class="line">        <span class="keyword">if</span> (drawStartX &lt; <span class="number">0</span>)</span><br><span class="line">            drawStartX = <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> drawEndX = spriteWidth / <span class="number">2</span> + spriteScreenX;</span><br><span class="line">        <span class="keyword">if</span> (drawEndX &gt;= screenWidth)</span><br><span class="line">            drawEndX = screenWidth - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// loop through every vertical stripe of the sprite on screen</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> stripe = drawStartX; stripe &lt; drawEndX; stripe++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="type">int</span> texX = <span class="built_in">int</span>(<span class="number">256</span> * (stripe - (-spriteWidth / <span class="number">2</span> + spriteScreenX)) * illustrationWidth / spriteWidth) / <span class="number">256</span>;</span><br><span class="line">            <span class="comment">// the conditions in the if are:</span></span><br><span class="line">            <span class="comment">// 1) it&#x27;s in front of camera plane so you don&#x27;t see things behind you</span></span><br><span class="line">            <span class="comment">// 2) it&#x27;s on the screen (left)</span></span><br><span class="line">            <span class="comment">// 3) it&#x27;s on the screen (right)</span></span><br><span class="line">            <span class="comment">// 4) ZBuffer, with perpendicular distance</span></span><br><span class="line">            <span class="keyword">if</span> (transformY &gt; <span class="number">0</span> &amp;&amp; stripe &gt; <span class="number">0</span> &amp;&amp; stripe &lt; screenWidth &amp;&amp; transformY &lt; ZBuffer[stripe])</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// illustration一条线的Sprite</span></span><br><span class="line">                Sprite illustration_sprite;</span><br><span class="line">                <span class="comment">// 设置对应纹理</span></span><br><span class="line">                illustration_sprite.<span class="built_in">setTexture</span>(illustration_texture[illustration_lst[illustration_Order[i]].texture_index]);</span><br><span class="line">                <span class="comment">// 设置sprite的纹理矩形，定义了在纹理中的哪个部分应用到illustration_sprite上</span></span><br><span class="line">                <span class="comment">// 宽度为1个像素，相当于原来的画线</span></span><br><span class="line">                illustration_sprite.<span class="built_in">setTextureRect</span>(sf::<span class="built_in">IntRect</span>(texX, <span class="number">0</span>, <span class="number">1</span>, illustrationHeight));</span><br><span class="line">                <span class="comment">// 设置sprite的位置，坐标指定了左上角的位置</span></span><br><span class="line">                illustration_sprite.<span class="built_in">setPosition</span>(stripe, drawStartY);</span><br><span class="line">                <span class="comment">// 设置sprite的缩放因子</span></span><br><span class="line">                illustration_sprite.<span class="built_in">setScale</span>(<span class="number">1</span>, spriteHeight / (<span class="type">float</span>)illustrationHeight);</span><br><span class="line">                <span class="comment">// 绘制sprite</span></span><br><span class="line">                window.<span class="built_in">draw</span>(illustration_sprite);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">sortAllSprites</span><span class="params">(vector&lt;<span class="type">int</span>&gt; &amp;Allsprites_Order, vector&lt;<span class="type">double</span>&gt; &amp;Allsprites_Distance, <span class="type">int</span> amount)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    std::vector&lt;std::pair&lt;<span class="type">double</span>, <span class="type">int</span>&gt;&gt; <span class="built_in">sprites</span>(amount);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; amount; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        sprites[i].first = Allsprites_Distance[i];</span><br><span class="line">        sprites[i].second = Allsprites_Order[i];</span><br><span class="line">    &#125;</span><br><span class="line">    std::<span class="built_in">sort</span>(sprites.<span class="built_in">begin</span>(), sprites.<span class="built_in">end</span>());</span><br><span class="line">    <span class="comment">// restore in reverse order to go from farthest to nearest</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; amount; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        Allsprites_Distance[i] = sprites[amount - i - <span class="number">1</span>].first;</span><br><span class="line">        Allsprites_Order[i] = sprites[amount - i - <span class="number">1</span>].second;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 成功解决遮挡问题，原因：sortAllSprites排序没传递vector的引用，导致没有正常排序</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Allsprites_Casting</span><span class="params">(RenderWindow &amp;window)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; decorationNum + illustrationNum; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        Allsprites_Order[i] = i;</span><br><span class="line">        Allsprites_Distance[i] = ((posX - Allsprites_lst[i].x) * (posX - Allsprites_lst[i].x) + (posY - Allsprites_lst[i].y) * (posY - Allsprites_lst[i].y)); <span class="comment">// sqrt not taken, unneeded</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 排序</span></span><br><span class="line">    <span class="comment">// 先画远的再画近的不会导致透明遮挡问题</span></span><br><span class="line">    <span class="comment">// 因为近的Sprite透明地方可以直接显示出远的Sprite</span></span><br><span class="line">    <span class="built_in">sortAllSprites</span>(Allsprites_Order, Allsprites_Distance, decorationNum + illustrationNum);</span><br><span class="line">    <span class="comment">// after sorting the sprites, do the projection and draw them</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; decorationNum + illustrationNum; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// translate sprite position to relative to camera</span></span><br><span class="line">        <span class="type">double</span> spriteX = Allsprites_lst[Allsprites_Order[i]].x - posX;</span><br><span class="line">        <span class="type">double</span> spriteY = Allsprites_lst[Allsprites_Order[i]].y - posY;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// transform sprite with the inverse camera matrix</span></span><br><span class="line">        <span class="comment">//  [ planeX   dirX ] -1                                       [ dirY      -dirX ]</span></span><br><span class="line">        <span class="comment">//  [               ]       =  1/(planeX*dirY-dirX*planeY) *   [                 ]</span></span><br><span class="line">        <span class="comment">//  [ planeY   dirY ]                                          [ -planeY  planeX ]</span></span><br><span class="line"></span><br><span class="line">        <span class="type">double</span> invDet = <span class="number">1.0</span> / (planeX * dirY - dirX * planeY); <span class="comment">// required for correct matrix multiplication</span></span><br><span class="line"></span><br><span class="line">        <span class="type">double</span> transformX = invDet * (dirY * spriteX - dirX * spriteY);</span><br><span class="line">        <span class="type">double</span> transformY = invDet * (-planeY * spriteX + planeX * spriteY); <span class="comment">// this is actually the depth inside the screen, that what Z is in 3D</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// sprite在屏幕上的x坐标</span></span><br><span class="line">        <span class="type">int</span> spriteScreenX = <span class="built_in">int</span>((screenWidth / <span class="number">2</span>) * (<span class="number">1</span> + transformX / transformY));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// calculate height of the sprite on screen</span></span><br><span class="line">        <span class="type">int</span> spriteHeight = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">// decoration的height不用乘比例</span></span><br><span class="line">        <span class="keyword">if</span> (Allsprites_lst[Allsprites_Order[i]].type == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            spriteHeight = <span class="built_in">abs</span>(<span class="built_in">int</span>(screenHeight / (transformY))); <span class="comment">// using &#x27;transformY&#x27; instead of the real distance prevents fisheye</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// illustration的height需要乘比例</span></span><br><span class="line">        <span class="comment">// 用于保持长宽比，不然立绘被压成正方形</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (Allsprites_lst[Allsprites_Order[i]].type == <span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            spriteHeight = <span class="built_in">abs</span>(<span class="built_in">int</span>(screenHeight / (transformY))) * illustrationHeight / illustrationWidth; <span class="comment">// using &#x27;transformY&#x27; instead of the real distance prevents fisheye</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// calculate width of the sprite</span></span><br><span class="line">        <span class="type">int</span> spriteWidth = <span class="built_in">abs</span>(<span class="built_in">int</span>(screenHeight / (transformY)));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// calculate lowest and highest pixel to fill in current stripe</span></span><br><span class="line">        <span class="comment">// 计算y上的起点，不需要计算终点，因为竖线直接指定了Sprite的高度</span></span><br><span class="line">        <span class="type">int</span> drawStartY = -spriteHeight / <span class="number">2</span> + screenHeight / <span class="number">2</span>;</span><br><span class="line">        <span class="comment">// if (drawStartY &lt; 0) drawStartY = 0;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 计算x上的起点和终点</span></span><br><span class="line">        <span class="type">int</span> drawStartX = -spriteWidth / <span class="number">2</span> + spriteScreenX;</span><br><span class="line">        <span class="keyword">if</span> (drawStartX &lt; <span class="number">0</span>)</span><br><span class="line">            drawStartX = <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> drawEndX = spriteWidth / <span class="number">2</span> + spriteScreenX;</span><br><span class="line">        <span class="keyword">if</span> (drawEndX &gt;= screenWidth)</span><br><span class="line">            drawEndX = screenWidth - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// loop through every vertical stripe of the sprite on screen</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> stripe = drawStartX; stripe &lt; drawEndX; stripe++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// the conditions in the if are:</span></span><br><span class="line">            <span class="comment">// 1) it&#x27;s in front of camera plane so you don&#x27;t see things behind you</span></span><br><span class="line">            <span class="comment">// 2) it&#x27;s on the screen (left)</span></span><br><span class="line">            <span class="comment">// 3) it&#x27;s on the screen (right)</span></span><br><span class="line">            <span class="comment">// 4) ZBuffer, with perpendicular distance</span></span><br><span class="line">            <span class="keyword">if</span> (transformY &gt; <span class="number">0</span> &amp;&amp; stripe &gt; <span class="number">0</span> &amp;&amp; stripe &lt; screenWidth &amp;&amp; transformY &lt; ZBuffer[stripe])</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 画decoration</span></span><br><span class="line">                <span class="keyword">if</span> (Allsprites_lst[Allsprites_Order[i]].type == <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// 计算texX</span></span><br><span class="line">                    <span class="type">int</span> texX = <span class="built_in">int</span>(<span class="number">256</span> * (stripe - (-spriteWidth / <span class="number">2</span> + spriteScreenX)) * texWidth / spriteWidth) / <span class="number">256</span>;</span><br><span class="line">                    <span class="comment">// decoration一条线的Sprite</span></span><br><span class="line">                    Sprite decoration_sprite;</span><br><span class="line">                    <span class="comment">// 设置对应纹理</span></span><br><span class="line">                    decoration_sprite.<span class="built_in">setTexture</span>(decoration_texture[Allsprites_lst[Allsprites_Order[i]].texture_index]);</span><br><span class="line">                    <span class="comment">// 设置sprite的纹理矩形，定义了在纹理中的哪个部分应用到decoration_sprite上</span></span><br><span class="line">                    <span class="comment">// 宽度为1个像素，相当于原来的画线</span></span><br><span class="line">                    decoration_sprite.<span class="built_in">setTextureRect</span>(sf::<span class="built_in">IntRect</span>(texX, <span class="number">0</span>, <span class="number">1</span>, texHeight));</span><br><span class="line">                    <span class="comment">// 设置sprite的位置，坐标指定了左上角的位置</span></span><br><span class="line">                    decoration_sprite.<span class="built_in">setPosition</span>(stripe, drawStartY);</span><br><span class="line">                    <span class="comment">// 设置sprite的缩放因子</span></span><br><span class="line">                    decoration_sprite.<span class="built_in">setScale</span>(<span class="number">1</span>, spriteHeight / (<span class="type">float</span>)texHeight);</span><br><span class="line">                    <span class="comment">// 绘制sprite</span></span><br><span class="line">                    window.<span class="built_in">draw</span>(decoration_sprite);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 画illustration</span></span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (Allsprites_lst[Allsprites_Order[i]].type == <span class="number">1</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// 计算texX</span></span><br><span class="line">                    <span class="type">int</span> texX = <span class="built_in">int</span>(<span class="number">256</span> * (stripe - (-spriteWidth / <span class="number">2</span> + spriteScreenX)) * illustrationWidth / spriteWidth) / <span class="number">256</span>;</span><br><span class="line">                    <span class="comment">// illustration一条线的Sprite</span></span><br><span class="line">                    Sprite illustration_sprite;</span><br><span class="line">                    <span class="comment">// 设置对应纹理</span></span><br><span class="line">                    illustration_sprite.<span class="built_in">setTexture</span>(illustration_texture[Allsprites_lst[Allsprites_Order[i]].texture_index]);</span><br><span class="line">                    <span class="comment">// 设置sprite的纹理矩形，定义了在纹理中的哪个部分应用到illustration_sprite上</span></span><br><span class="line">                    <span class="comment">// 宽度为1个像素，相当于原来的画线</span></span><br><span class="line">                    illustration_sprite.<span class="built_in">setTextureRect</span>(sf::<span class="built_in">IntRect</span>(texX, <span class="number">0</span>, <span class="number">1</span>, illustrationHeight));</span><br><span class="line">                    <span class="comment">// 设置sprite的位置，坐标指定了左上角的位置</span></span><br><span class="line">                    illustration_sprite.<span class="built_in">setPosition</span>(stripe, drawStartY);</span><br><span class="line">                    <span class="comment">// 设置sprite的缩放因子</span></span><br><span class="line">                    illustration_sprite.<span class="built_in">setScale</span>(<span class="number">1</span>, spriteHeight / (<span class="type">float</span>)illustrationHeight);</span><br><span class="line">                    <span class="comment">// 绘制sprite</span></span><br><span class="line">                    window.<span class="built_in">draw</span>(illustration_sprite);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 要注意：SFML中的y轴是向下的，而用二维数组计算时y轴是向上的</span></span><br><span class="line"><span class="comment">// 需将游戏中的坐标系转换为小地图的坐标系，具体来说，就是将y坐标进行翻转</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">drawMiniMap</span><span class="params">(RenderWindow &amp;window)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 遍历地图的每一个格子</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> x = <span class="number">0</span>; x &lt; minimapWidth; x++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> y = <span class="number">0</span>; y &lt; minimapHeight; y++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 创建一个表示地图格子的矩形</span></span><br><span class="line">            <span class="function">RectangleShape <span class="title">rect</span><span class="params">(Vector2f(miniMapScale, miniMapScale))</span></span>;</span><br><span class="line">            rect.<span class="built_in">setPosition</span>(x * miniMapScale, (mapHeight - y - <span class="number">1</span>) * miniMapScale);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 根据地图数据设置矩形的颜色</span></span><br><span class="line">            <span class="keyword">if</span> (worldMap[x][y] &gt; <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                rect.<span class="built_in">setFillColor</span>(Color::White);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                rect.<span class="built_in">setFillColor</span>(Color::Black);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 在窗口上绘制矩形</span></span><br><span class="line">            window.<span class="built_in">draw</span>(rect);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建一个表示玩家位置的圆形</span></span><br><span class="line">    <span class="type">int</span> radius = <span class="number">4</span>;</span><br><span class="line">    <span class="function">CircleShape <span class="title">player_circle</span><span class="params">(radius)</span></span>;</span><br><span class="line">    player_circle.<span class="built_in">setFillColor</span>(Color::Red);</span><br><span class="line">    player_circle.<span class="built_in">setPosition</span>(posX * miniMapScale - player_circle.<span class="built_in">getRadius</span>(), (mapHeight - posY) * miniMapScale - player_circle.<span class="built_in">getRadius</span>());</span><br><span class="line">    <span class="comment">// 在窗口上绘制圆形</span></span><br><span class="line">    window.<span class="built_in">draw</span>(player_circle);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置三角扇形的原点为玩家的位置</span></span><br><span class="line">    <span class="comment">// FOV顶点具体计算在DDA算法里，保存在FOV_position数组中</span></span><br><span class="line">    FOV_Visualize[<span class="number">0</span>].position = <span class="built_in">Vector2f</span>(posX * miniMapScale, (mapHeight - posY) * miniMapScale);</span><br><span class="line">    FOV_Visualize[<span class="number">0</span>].color = Color::Transparent;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt;= screenWidth; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 设置FOV的位置</span></span><br><span class="line">        FOV_Visualize[i].position = FOV_position[i];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 在窗口上绘制三角扇形</span></span><br><span class="line">    window.<span class="built_in">draw</span>(FOV_Visualize);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h1 id="参考资料">参考资料</h1>
<p><a target="_blank" rel="noopener" href="https://lodev.org/cgtutor/raycasting.html">Raycasting
(lodev.org)</a></p>
<p><a target="_blank" rel="noopener" href="https://lodev.org/cgtutor/raycasting2.html">Raycasting II:
Floor and Ceiling (lodev.org)</a></p>
<p><a target="_blank" rel="noopener" href="https://lodev.org/cgtutor/raycasting3.html">Raycasting III:
Sprites (lodev.org)</a></p>
<p><a target="_blank" rel="noopener" href="https://winkyspeed.github.io/2023/11/09/学习记录/Raycasting学习记录/">Raycasting学习记录</a></p>
<p><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=OpIS1zoz6fU">I Used
RAYCASTING to Make a HORROR Game in C++</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/Kofybrek/New-Raycasting">New-Raycasting:
Horror game using Raycasting</a></p>
<p><a target="_blank" rel="noopener" href="https://www.bilibili.com/read/cv30532434/">《白色相簿2》中的PAK文件解包</a></p>
</article><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9B%BE%E5%BD%A2%E5%AD%A6/">计算机图形学</a><a class="post-meta__tags" href="/tags/Raycasting/">Raycasting</a><a class="post-meta__tags" href="/tags/%E4%BC%AA3D/">伪3D</a><a class="post-meta__tags" href="/tags/SFML/">SFML</a></div><div class="post_share"></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/06/09/%E9%97%AE%E9%A2%98%E8%AE%B0%E5%BD%95/VSCode-Pylance%E9%AB%98%E7%89%88%E6%9C%AC%E9%97%AE%E9%A2%98/" title="VSCode Pylance高版本问题"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">VSCode Pylance高版本问题</div></div></a></div><div class="next-post pull-right"><a href="/2024/05/14/%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/GAMES101%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/" title="GAMES101学习记录"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">GAMES101学习记录</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2023/11/09/%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/Raycasting%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/" title="Raycasting学习记录"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-11-09</div><div class="title">Raycasting学习记录</div></div></a></div><div><a href="/2024/01/07/%E5%A4%8D%E4%B9%A0%E6%95%B4%E7%90%86/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9B%BE%E5%BD%A2%E5%AD%A6%E5%A4%8D%E4%B9%A0%E6%95%B4%E7%90%86/" title="计算机图形学复习整理"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-01-07</div><div class="title">计算机图形学复习整理</div></div></a></div><div><a href="/2024/05/14/%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/GAMES101%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/" title="GAMES101学习记录"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-05-14</div><div class="title">GAMES101学习记录</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/WinkySpeed%20SP%20-%20Repaired.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">WinkySpeed</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">50</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">60</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/WinkySpeed"><i class="fab fa-github"></i><span>GitHub</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">欢迎来到我的博客</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#raycasting%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95_%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%89%A9%E5%B1%95"><span class="toc-number">1.</span> <span class="toc-text">Raycasting学习记录_进阶与扩展</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%BA%B9%E7%90%86%E5%9C%B0%E6%9D%BF%E5%A4%A9%E8%8A%B1%E6%9D%BF"><span class="toc-number">2.</span> <span class="toc-text">纹理地板天花板</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#visual-studio%E7%9A%84release%E6%A8%A1%E5%BC%8F"><span class="toc-number">2.1.</span> <span class="toc-text">visual
studio的Release模式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#sfml%E9%80%90%E5%83%8F%E7%B4%A0%E6%93%8D%E4%BD%9C"><span class="toc-number">2.2.</span> <span class="toc-text">SFML逐像素操作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B7%E4%BD%93%E9%80%BB%E8%BE%91"><span class="toc-number">2.3.</span> <span class="toc-text">具体逻辑</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%A1%E7%AE%97fov%E8%B5%B7%E7%82%B9%E7%BB%88%E7%82%B9"><span class="toc-number">2.3.1.</span> <span class="toc-text">计算FOV起点终点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%81%8D%E5%8E%86y%E5%B9%B6%E8%AE%A1%E7%AE%97rowdistance"><span class="toc-number">2.3.2.</span> <span class="toc-text">遍历y并计算rowDistance</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%A1%E7%AE%97%E9%81%8D%E5%8E%86%E5%8F%98%E9%87%8F"><span class="toc-number">2.3.3.</span> <span class="toc-text">计算遍历变量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%81%8D%E5%8E%86x"><span class="toc-number">2.3.4.</span> <span class="toc-text">遍历x</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%88%E6%9E%9C"><span class="toc-number">2.4.</span> <span class="toc-text">效果</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AF%B9%E5%BA%94%E4%BB%A3%E7%A0%81"><span class="toc-number">2.5.</span> <span class="toc-text">对应代码</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%BC%A0%E6%A0%87%E6%8E%A7%E5%88%B6%E8%A7%86%E8%A7%92%E6%97%8B%E8%BD%AC"><span class="toc-number">3.</span> <span class="toc-text">鼠标控制视角旋转</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE%E9%BC%A0%E6%A0%87%E6%8C%87%E9%92%88"><span class="toc-number">3.1.</span> <span class="toc-text">设置鼠标指针</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#fovfield-of-vision"><span class="toc-number">3.2.</span> <span class="toc-text">FOV（Field Of Vision）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B7%E4%BD%93%E9%80%BB%E8%BE%91-1"><span class="toc-number">3.3.</span> <span class="toc-text">具体逻辑</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AF%B9%E5%BA%94%E4%BB%A3%E7%A0%81-1"><span class="toc-number">3.4.</span> <span class="toc-text">对应代码</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%A2%9E%E5%8A%A0decoration-sprite"><span class="toc-number">4.</span> <span class="toc-text">增加Decoration Sprite</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BF%85%E8%A6%81%E5%8F%98%E9%87%8F"><span class="toc-number">4.1.</span> <span class="toc-text">必要变量</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AF%BB%E5%8F%96%E7%BA%B9%E7%90%86%E6%97%B6%E9%80%8F%E6%98%8E%E5%A4%84%E7%90%86"><span class="toc-number">4.2.</span> <span class="toc-text">读取纹理时透明处理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B7%E4%BD%93%E9%80%BB%E8%BE%91-2"><span class="toc-number">4.3.</span> <span class="toc-text">具体逻辑</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%92%E5%BA%8F"><span class="toc-number">4.3.1.</span> <span class="toc-text">排序</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E5%8F%98%E6%8D%A2"><span class="toc-number">4.3.2.</span> <span class="toc-text">基变换</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%A1%E7%AE%97decoration-sprite%E5%9C%A8%E5%B1%8F%E5%B9%95%E4%B8%8A%E7%9A%84%E8%8C%83%E5%9B%B4"><span class="toc-number">4.3.3.</span> <span class="toc-text">计算decoration
Sprite在屏幕上的范围</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%98%E5%88%B6"><span class="toc-number">4.3.4.</span> <span class="toc-text">绘制</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BA%90%E4%BB%A3%E7%A0%81"><span class="toc-number">4.4.</span> <span class="toc-text">源代码</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%A2%9E%E5%8A%A0illustration-sprite"><span class="toc-number">5.</span> <span class="toc-text">增加Illustration Sprite</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#wa2%E7%AB%8B%E7%BB%98%E8%A7%A3%E5%8C%85"><span class="toc-number">5.1.</span> <span class="toc-text">《WA2》立绘解包</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BF%85%E8%A6%81%E5%8F%98%E9%87%8F-1"><span class="toc-number">5.2.</span> <span class="toc-text">必要变量</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AF%BB%E5%8F%96%E7%BA%B9%E7%90%86%E9%80%8F%E6%98%8E%E5%A4%84%E7%90%86"><span class="toc-number">5.3.</span> <span class="toc-text">读取纹理透明处理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BA%90%E4%BB%A3%E7%A0%81-1"><span class="toc-number">5.4.</span> <span class="toc-text">源代码</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%A4%E7%A7%8Dsprite%E4%B8%80%E8%B5%B7%E7%BB%98%E5%88%B6%E5%87%BA%E7%8E%B0%E9%81%AE%E6%8C%A1%E9%97%AE%E9%A2%98"><span class="toc-number">6.</span> <span class="toc-text">两种Sprite一起绘制出现遮挡问题</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E9%98%90%E8%BF%B0"><span class="toc-number">6.1.</span> <span class="toc-text">问题阐述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-number">6.2.</span> <span class="toc-text">解决方案</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%9C%80%E7%BB%88%E6%BA%90%E4%BB%A3%E7%A0%81"><span class="toc-number">7.</span> <span class="toc-text">最终源代码</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="toc-number">8.</span> <span class="toc-text">参考资料</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/06/22/%E5%A4%8D%E4%B9%A0%E6%95%B4%E7%90%86/%E8%99%9A%E6%8B%9F%E7%8E%B0%E5%AE%9E%E5%A4%8D%E4%B9%A0%E6%95%B4%E7%90%86/" title="虚拟现实复习整理">虚拟现实复习整理</a><time datetime="2024-06-22T11:57:00.000Z" title="发表于 2024-06-22 19:57:00">2024-06-22</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/06/18/%E5%A4%8D%E4%B9%A0%E6%95%B4%E7%90%86/%E8%AE%A1%E7%AE%97%E6%9C%BA%E8%A7%86%E8%A7%89%E5%A4%8D%E4%B9%A0%E6%95%B4%E7%90%86/" title="计算机视觉复习整理">计算机视觉复习整理</a><time datetime="2024-06-18T11:15:00.000Z" title="发表于 2024-06-18 19:15:00">2024-06-18</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/06/09/%E9%97%AE%E9%A2%98%E8%AE%B0%E5%BD%95/VSCode-Pylance%E9%AB%98%E7%89%88%E6%9C%AC%E9%97%AE%E9%A2%98/" title="VSCode Pylance高版本问题">VSCode Pylance高版本问题</a><time datetime="2024-06-09T10:11:24.000Z" title="发表于 2024-06-09 18:11:24">2024-06-09</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/05/24/%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/Raycasting%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95-%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%89%A9%E5%B1%95/" title="Raycasting学习记录_进阶与扩展">Raycasting学习记录_进阶与扩展</a><time datetime="2024-05-24T07:00:00.000Z" title="发表于 2024-05-24 15:00:00">2024-05-24</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/05/14/%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/GAMES101%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/" title="GAMES101学习记录">GAMES101学习记录</a><time datetime="2024-05-14T07:22:42.000Z" title="发表于 2024-05-14 15:22:42">2024-05-14</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By WinkySpeed</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    tex: {
      inlineMath: [ ['$','$'], ["\\(","\\)"]],
      tags: 'ams'
    },
    chtml: {
      scale: 1.1
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, ''],
        insertScript: [200, () => {
          document.querySelectorAll('mjx-container').forEach(node => {
            if (node.hasAttribute('display')) {
              btf.wrap(node, 'div', { class: 'mathjax-overflow' })
            } else {
              btf.wrap(node, 'span', { class: 'mathjax-overflow' })
            }
          });
        }, '', false]
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://cdn.jsdelivr.net/npm/mathjax/es5/tex-mml-chtml.min.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typeset()
}</script></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><script src="/live2d-widget/autoload.js"></script></body></html>