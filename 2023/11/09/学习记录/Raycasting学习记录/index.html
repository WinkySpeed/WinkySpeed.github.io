<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"><title>Raycasting学习记录 | WinkySpeed's Blog</title><meta name="author" content="WinkySpeed"><meta name="copyright" content="WinkySpeed"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="前言 我是一个电子游戏爱好者，对市面上各种类型的电子游戏都稍有涉猎，其中最喜欢的应该就是射击游戏 凭借着对游戏的喜爱，我曾经追溯过游戏发展的历史，尤其是我最感兴趣的射击游戏：按照时间年表从现在到过去，《Splatoon》将游戏机制与手柄操作完美结合，定义了新的手柄射击方式；《Counter-Strike》这部里程碑式的作品将多人对抗竞技发扬光大；《Half-Life》让游戏不再局限于射击体验，">
<meta property="og:type" content="article">
<meta property="og:title" content="Raycasting学习记录">
<meta property="og:url" content="http://example.com/2023/11/09/%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/Raycasting%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/index.html">
<meta property="og:site_name" content="WinkySpeed&#39;s Blog">
<meta property="og:description" content="前言 我是一个电子游戏爱好者，对市面上各种类型的电子游戏都稍有涉猎，其中最喜欢的应该就是射击游戏 凭借着对游戏的喜爱，我曾经追溯过游戏发展的历史，尤其是我最感兴趣的射击游戏：按照时间年表从现在到过去，《Splatoon》将游戏机制与手柄操作完美结合，定义了新的手柄射击方式；《Counter-Strike》这部里程碑式的作品将多人对抗竞技发扬光大；《Half-Life》让游戏不再局限于射击体验，">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/img/WinkySpeed%20SP%20-%20Repaired.jpg">
<meta property="article:published_time" content="2023-11-09T01:47:32.000Z">
<meta property="article:modified_time" content="2024-05-31T07:27:53.527Z">
<meta property="article:author" content="WinkySpeed">
<meta property="article:tag" content="计算机图形学">
<meta property="article:tag" content="Raycasting">
<meta property="article:tag" content="伪3D">
<meta property="article:tag" content="SFML">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/img/WinkySpeed%20SP%20-%20Repaired.jpg"><link rel="shortcut icon" href="/img/WinkySpeed%20SP%20-%20Repaired.jpg"><link rel="canonical" href="http://example.com/2023/11/09/%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/Raycasting%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  }
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Raycasting学习记录',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-05-31 15:27:53'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = url => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      link.onload = () => resolve()
      link.onerror = () => reject()
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/WinkySpeed%20SP%20-%20Repaired.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">50</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">60</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><hr/></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/33703665_p0.jpg')"><nav id="nav"><span id="blog-info"><a href="/" title="WinkySpeed's Blog"><span class="site-name">WinkySpeed's Blog</span></a></span><div id="menus"><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Raycasting学习记录</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-11-09T01:47:32.000Z" title="发表于 2023-11-09 09:47:32">2023-11-09</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-05-31T07:27:53.527Z" title="更新于 2024-05-31 15:27:53">2024-05-31</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Raycasting学习记录"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="前言">前言</h1>
<p>我是一个电子游戏爱好者，对市面上各种类型的电子游戏都稍有涉猎，其中最喜欢的应该就是射击游戏</p>
<p>凭借着对游戏的喜爱，我曾经追溯过游戏发展的历史，尤其是我最感兴趣的射击游戏：按照时间年表从现在到过去，《Splatoon》将游戏机制与手柄操作完美结合，定义了新的手柄射击方式；《Counter-Strike》这部里程碑式的作品将多人对抗竞技发扬光大；《Half-Life》让游戏不再局限于射击体验，而在流程中更加着重于剧情与解谜成分；《GoldenEye
007》和《Halo》把射击游戏搬上了主机平台，优化了手柄的操作；《Quake》，世界上第一款实时3D渲染的射击游戏，第一款真正意义上的3D射击游戏；《Doom》和《Wolfenstein
3D》，利用伪3D的技术，超越了世代技术力的限制，让第一人称射击游戏提前出现了许多年</p>
<p>我其实在查资料的时候就很疑惑，毕竟我没有亲自经历过电子游戏发展早期的那个时代，既然机能不足，不能够支撑3D，那这个所谓的伪3D是个什么东西？</p>
<p>带着这个问题，我就进一步寻找答案，最终找到了叫做Raycasting的技术，这正是当年约翰卡马克在《德军总部3D》和《DOOM》中使用的算法</p>
<p>这是一篇Raycasting教程的博客，质量很高：<a target="_blank" rel="noopener" href="https://lodev.org/cgtutor/raycasting.html">Raycasting
(lodev.org)</a></p>
<p>更令我惊喜的是，这个算法并没有想象中那样复杂，在复现完以后，我能明确的说：只要有初中几何的知识，以及掌握最简单的二维矩阵乘法知识，就可以复现出这个算法</p>
<p><br></p>
<p>正好，在计算机图形学的实验课上有足够的时间学习和复现这个算法，毕竟“实验课想做啥就做啥”</p>
<p>于是，带着对射击游戏祖师爷《德军总部3D》的致敬和好奇，我复现了这个经典游戏的基本框架</p>
<p><br></p>
<p>此篇博客后续内容：<a target="_blank" rel="noopener" href="https://winkyspeed.github.io/2024/05/24/学习记录/Raycasting学习记录-进阶与扩展/">Raycasting学习记录_进阶与扩展</a>，增加地板天花板纹理、鼠标控制视角、decoration的Sprite绘制、《白色相簿2》立绘Sprite的绘制，都是在此博客的基础上添加的新内容</p>
<p>源代码和可执行程序已经部署到github上：<a target="_blank" rel="noopener" href="https://github.com/WinkySpeed/Raycasting">Raycasting</a></p>
<h1 id="raycasting">Raycasting</h1>
<h2 id="简介">简介</h2>
<blockquote>
<p>Raycasting is a rendering technique to create a 3D perspective in a
2D map. Back when computers were slower it wasn't possible to run real
3D engines in realtime, and raycasting was the first solution.
Raycasting can go very fast, because only a calculation has to be done
for every vertical line of the screen. The most well known game that
used this technique, is of course Wolfenstein 3D.</p>
</blockquote>
<p>利用Raycasting算法做的游戏是很有时代特色的，比如这样的：</p>
<img src="/2023/11/09/%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/Raycasting%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/Anarch_short_gameplay.gif" class title="Anarch_short_gameplay">
<p>一切可交互的物体，如敌人和物品，都用Sprite贴图来显示，交互逻辑也是很简单的“射爆”</p>
<p>可惜这次复现并没有涉及到Sprite，不过今后肯定会补上的</p>
<p><br></p>
<p>基本原理，一张动态图就能很好地解释：</p>
<img src="/2023/11/09/%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/Raycasting%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/Simple_raycasting_with_fisheye_correction.gif" class title="Simple_raycasting_with_fisheye_correction">
<p>用一个二维数组存储地图，0代表可以行走的地面，正数值可以代表不同的墙体，并且可以区分对应不同的纹理</p>
<p>从人物视角发出屏幕宽度像素个数的光线（比如大小是1440*900，就发射出1440道光线），每到光线发射出去后会检测墙面碰撞，如果碰到了墙面，就会记住对应的距离，然后根据<strong>近大远小</strong>的原理，在屏幕上画出对应高度的线，这个高度就代表墙的高度</p>
<p>比如一道光线碰到了墙，光线长度是5，我们就可以在屏幕对应位置画出<span class="math inline">\(\dfrac{屏幕高度}{5}\)</span>这么长的线，就代表墙高<span class="math inline">\(\dfrac{屏幕高度}{5}\)</span>；另一道光线碰到了墙，光线长度是10，我们就可以在屏幕对应位置画出<span class="math inline">\(\dfrac{屏幕高度}{10}\)</span>这么长的线，就代表墙高<span class="math inline">\(\dfrac{屏幕高度}{10}\)</span>。因此，在屏幕上显示的墙就很符合近大远小的特点：距离近的墙显示就大，距离远的墙显示就小</p>
<p>至于如何计算光线碰到墙的距离，就可以利用DDA算法，具体会在后面的“复现”解释</p>
<h2 id="最基本的复现">最基本的复现</h2>
<p>本次复现使用<a target="_blank" rel="noopener" href="https://www.sfml-dev.org/">SFML多媒体库</a>，原因是我之前用过，比较熟悉，还很简单</p>
<p>最基本的复现，指基础的Raycasting，不涉及纹理和小地图等</p>
<p>可在<a href="#Code_Raycasting">这里</a>查看源代码</p>
<p>下面是每个部分具体实现的讲解</p>
<h3 id="必要参数声明">必要参数声明</h3>
<p>此处定义屏幕大小，地图大小，地图</p>
<p>还有玩家位置，视野，面朝方向这些参数</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> screenWidth 1440</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> screenHeight 900</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> mapWidth 24</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> mapHeight 24</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> worldMap[mapWidth][mapWidth] =</span><br><span class="line">&#123;</span><br><span class="line">  &#123;<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>&#125;,</span><br><span class="line">  &#123;<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>&#125;,</span><br><span class="line">  &#123;<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>&#125;,</span><br><span class="line">  &#123;<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>&#125;,</span><br><span class="line">  &#123;<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">3</span>,<span class="number">0</span>,<span class="number">3</span>,<span class="number">0</span>,<span class="number">3</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>&#125;,</span><br><span class="line">  &#123;<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>&#125;,</span><br><span class="line">  &#123;<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">3</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">3</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>&#125;,</span><br><span class="line">  &#123;<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>&#125;,</span><br><span class="line">  &#123;<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">3</span>,<span class="number">0</span>,<span class="number">3</span>,<span class="number">0</span>,<span class="number">3</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>&#125;,</span><br><span class="line">  &#123;<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>&#125;,</span><br><span class="line">  &#123;<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>&#125;,</span><br><span class="line">  &#123;<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>&#125;,</span><br><span class="line">  &#123;<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>&#125;,</span><br><span class="line">  &#123;<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>&#125;,</span><br><span class="line">  &#123;<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>&#125;,</span><br><span class="line">  &#123;<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>&#125;,</span><br><span class="line">  &#123;<span class="number">1</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>&#125;,</span><br><span class="line">  &#123;<span class="number">1</span>,<span class="number">4</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>&#125;,</span><br><span class="line">  &#123;<span class="number">1</span>,<span class="number">4</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>&#125;,</span><br><span class="line">  &#123;<span class="number">1</span>,<span class="number">4</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>&#125;,</span><br><span class="line">  &#123;<span class="number">1</span>,<span class="number">4</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>&#125;,</span><br><span class="line">  &#123;<span class="number">1</span>,<span class="number">4</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>&#125;,</span><br><span class="line">  &#123;<span class="number">1</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>&#125;,</span><br><span class="line">  &#123;<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">double</span> posX = <span class="number">22</span>, posY = <span class="number">12</span>;  <span class="comment">//x and y start position</span></span><br><span class="line"><span class="type">double</span> dirX = <span class="number">-1</span>, dirY = <span class="number">0</span>; <span class="comment">//initial direction vector</span></span><br><span class="line"><span class="type">double</span> planeX = <span class="number">0</span>, planeY = <span class="number">0.66</span>; <span class="comment">//the 2d raycaster version of camera plane</span></span><br><span class="line"></span><br><span class="line"><span class="type">double</span> Mytime = <span class="number">0</span>; <span class="comment">//time of current frame</span></span><br><span class="line"><span class="type">double</span> oldTime = <span class="number">0</span>; <span class="comment">//time of previous frame</span></span><br><span class="line"></span><br><span class="line">Texture texture[<span class="number">8</span>];		<span class="comment">//纹理数组</span></span><br><span class="line">Clock Myclock;          <span class="comment">//用于计时</span></span><br></pre></td></tr></table></figure>
<p>参考<a target="_blank" rel="noopener" href="https://lodev.org/cgtutor/raycasting.html">原教程</a>，人物的视野范围可以用<span class="math inline">\(\overrightarrow{pos}\)</span>，<span class="math inline">\(\overrightarrow{dir}\)</span>和<span class="math inline">\(\overrightarrow{plane}\)</span>组合求得，如图所示，上面代码的对应6个变量就是设置这三个向量用的</p>
<img src="/2023/11/09/%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/Raycasting%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/raycastingcamera.gif" class title="raycastingcamera">
<p>关于计时：变量 <code>time</code> 和 <code>oldTime</code>
用于存储当前帧和前一帧的时间，这两者之间的时间差可以用来确定当按下某个键时应该移动多少（无论帧的计算需要多长时间，都能保持恒定的速度），即用于求移动速度和旋转速度</p>
<h3 id="main函数的结构"><code>main</code>函数的结构</h3>
<p>根据SFML库里介绍的，SFML最基础的<code>main</code>程序结构如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//定义窗口大小</span></span><br><span class="line">    <span class="function">sf::RenderWindow <span class="title">window</span><span class="params">(sf::VideoMode(<span class="number">200</span>, <span class="number">200</span>), <span class="string">&quot;SFML works!&quot;</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//while死循环，以帧为单位</span></span><br><span class="line">    <span class="keyword">while</span> (window.<span class="built_in">isOpen</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        sf::Event event;</span><br><span class="line">        <span class="keyword">while</span> (window.<span class="built_in">pollEvent</span>(event))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (event.type == sf::Event::Closed)</span><br><span class="line">                window.<span class="built_in">close</span>();		<span class="comment">//用于关闭窗口</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        window.<span class="built_in">clear</span>();		<span class="comment">//清空屏幕上所有图形</span></span><br><span class="line">        <span class="comment">//*****************************************************</span></span><br><span class="line">        <span class="comment">//	此处往屏幕上画图形，每一帧都会被清空重画</span></span><br><span class="line">        <span class="comment">//*****************************************************</span></span><br><span class="line">        window.<span class="built_in">display</span>();	<span class="comment">//显示在屏幕上画的图形</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>SFML每次都会重新画一帧，因此需要每一帧调用<code>window.clear();</code>函数</p>
<p>我们要做的，就是每一帧都在屏幕对应位置上画出对应的线</p>
<p>Raycasting的<code>main</code>函数如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">RenderWindow <span class="title">window</span><span class="params">(sf::VideoMode(screenWidth, screenHeight), <span class="string">&quot;Raycasting&quot;</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (window.<span class="built_in">isOpen</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        sf::Event event;</span><br><span class="line">        <span class="keyword">while</span> (window.<span class="built_in">pollEvent</span>(event))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (event.type == sf::Event::Closed)</span><br><span class="line">                window.<span class="built_in">close</span>();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        window.<span class="built_in">clear</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">DDA_algorithm</span>(window);</span><br><span class="line">        <span class="built_in">Move</span>(window);</span><br><span class="line">        </span><br><span class="line">        window.<span class="built_in">display</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在创建窗口后，就是经典的<code>main</code>函数死循环，每一帧判断是否关闭，然后清除所有图形，重新画新的，再显示到屏幕上</p>
<p>用于画图形的是<code>DDA_algorithm(window)</code></p>
<p><code>Move(window)</code>函数是控制角色移动的，会改变<span class="math inline">\(\overrightarrow{pos}\)</span>，<span class="math inline">\(\overrightarrow{dir}\)</span>和<span class="math inline">\(\overrightarrow{plane}\)</span>三个向量</p>
<p><br></p>
<p>紧接着介绍对应的两个函数</p>
<h3 id="dda_algorithm函数"><code>DDA_algorithm</code>函数</h3>
<p>函数的定义如下</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">DDA_algorithm</span><span class="params">(RenderWindow&amp; window)</span></span></span><br></pre></td></tr></table></figure>
<p>需要传递进<code>main</code>里面声明的<code>window</code>窗口</p>
<p>再看看原理图：</p>
<img src="/2023/11/09/%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/Raycasting%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/Simple_raycasting_with_fisheye_correction.gif" class title="Simple_raycasting_with_fisheye_correction">
<p>由于每一帧都需要从人物视角发出屏幕宽度像素个数的光线，每到光线发射出去后会检测墙面碰撞，再把对应的长度的墙画在屏幕上</p>
<p>所以这个函数就是一个<code>x</code>从<code>0</code>遍历到<code>screenWidth</code>的循环，每一个<code>x</code>都对应着一个屏幕像素的横坐标，这样我们就有了给竖直线定位用的横坐标，所以这个程序的大致结构如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">DDA_algorithm</span><span class="params">(RenderWindow&amp; window)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> x = <span class="number">0</span>; x &lt; screenWidth; x++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//角色视角发出对应x的一根线，确定这根线的方向，起点就在角色位置</span></span><br><span class="line">        <span class="comment">//执行DDA算法，用于判断线是否碰到了墙壁，并记录光线的长度</span></span><br><span class="line">        <span class="comment">//利用光线的长度计算墙的高度</span></span><br><span class="line">        <span class="comment">//根据地图，不同的墙选择不同的颜色</span></span><br><span class="line">        <span class="comment">//在屏幕对应位置画对应颜色的线</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>比如，窗口大小设置为1440*900，对应就是1440根光线执行注释里对应的5个操作，然后对应位置画竖直的线，就能达到伪3D的效果</p>
<p><br></p>
<p>下面将对应注释中的5个操作，介绍具体过程</p>
<h4 id="角色发出光线">角色发出光线</h4>
<p>需要定义光线的方向，过程如下图</p>
<img src="/2023/11/09/%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/Raycasting%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/image-20240106161148974.png" class title="image-20240106161148974">
<p>定义光线向量为<span class="math inline">\(\overrightarrow{rayDir}\)</span>，这个向量就可以通过<span class="math inline">\(\overrightarrow{dir}\)</span>和<span class="math inline">\(\overrightarrow{plane}\)</span>两个向量求得 <span class="math display">\[
\overrightarrow{rayDir}=\overrightarrow{dir}+对应倍数\cdot\overrightarrow{plane}
\]</span></p>
<p>这个倍数的范围应该是在<span class="math inline">\([-1,1]\)</span>上，这样就能全面覆盖所有视野范围</p>
<p>至于倍数的确定，就需要用到<code>x</code>了：把<code>x</code>这个变量映射到<span class="math inline">\([-1,1]\)</span>上，对应图上的图，映射得到的倍数命名为<code>cameraX</code>
<span class="math display">\[
cameraX=\dfrac{2}{screenWidth}\cdot x-1
\]</span> 所以对应的<span class="math inline">\(\overrightarrow{rayDir}\)</span>就能求出来，代码对应如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//calculate ray position and direction</span></span><br><span class="line"><span class="type">double</span> cameraX = <span class="number">2</span> * x / (<span class="type">double</span>)screenWidth - <span class="number">1</span>; <span class="comment">//x-coordinate in camera space</span></span><br><span class="line"><span class="type">double</span> rayDirX = dirX + planeX * cameraX;</span><br><span class="line"><span class="type">double</span> rayDirY = dirY + planeY * cameraX;</span><br></pre></td></tr></table></figure>
<h4 id="dda算法">DDA算法</h4>
<h5 id="必要的变量定义与计算">必要的变量定义与计算</h5>
<p>需要定义几个变量用于计算发出光线碰到墙后的长度</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//which box of the map we&#x27;re in</span></span><br><span class="line"><span class="type">int</span> mapX = <span class="built_in">int</span>(posX);</span><br><span class="line"><span class="type">int</span> mapY = <span class="built_in">int</span>(posY);</span><br><span class="line"></span><br><span class="line"><span class="comment">//length of ray from current position to next x or y-side</span></span><br><span class="line"><span class="type">double</span> sideDistX;	</span><br><span class="line"><span class="type">double</span> sideDistY;	</span><br><span class="line"></span><br><span class="line"><span class="type">double</span> deltaDistX = (rayDirX == <span class="number">0</span>) ? <span class="number">1e30</span> : std::<span class="built_in">abs</span>(<span class="number">1</span> / rayDirX);</span><br><span class="line"><span class="type">double</span> deltaDistY = (rayDirY == <span class="number">0</span>) ? <span class="number">1e30</span> : std::<span class="built_in">abs</span>(<span class="number">1</span> / rayDirY);</span><br><span class="line"></span><br><span class="line"><span class="type">double</span> perpWallDist;	<span class="comment">//光线长度</span></span><br></pre></td></tr></table></figure>
<p><code>mapX</code>和<code>mapY</code>是现在角色所在地图的位置</p>
<p><code>sideDistX</code>和<code>sideDistY</code>是光线从起始位置到第一个X边和第一个Y边需要行进的距离，可能文字无法精确描述，可以看看图里的定义</p>
<p><code>deltaDistX</code>是光线从一个X边到另一个X边需要行进的距离</p>
<p><code>deltaDistY</code>是光线从一个Y边到另一个Y边需要行进的距离</p>
<p>看图就会更容易理解：</p>
<img src="/2023/11/09/%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/Raycasting%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/image-20240106163522501.png" class title="image-20240106163522501">
<p>对于一个给定的方向<span class="math inline">\(\overrightarrow{rayDir}\)</span>，对应的<code>deltaDistX</code>和<code>deltaDistY</code>是固定的</p>
<p>设图上的角度为<span class="math inline">\(\theta\)</span></p>
<p>推导过程如下： <span class="math display">\[
\begin{align*}
\tan{\theta}=\frac{rayDirX}{rayDirY}&amp;=\frac{1}{\sqrt{deltaDistX^2-1}}\\\\
deltaDistX&amp;=\sqrt{\frac{rayDirX^2+rayDirY^2}{rayDirX^2}}\\\\
&amp;=\left|\frac{|rayDir|}{rayDirX}\right|\\\\\\
同理，deltaDistY&amp;=\left|\frac{|rayDir|}{rayDirY}\right|
\end{align*}
\]</span> 分子的<span class="math inline">\(|rayDir|\)</span>是模长的意思，而整个式子外面的符号是绝对值的意思</p>
<p>但因为DDA算法只与<code>deltaDistX</code>和<code>deltaDistY</code>的<strong>比例</strong>有关，所以可以把两个<code>deltaDist</code>化简为：
<span class="math display">\[
\begin{align*}
deltaDistX&amp;=\left|\frac{1}{rayDirX}\right|\\\\
deltaDistY&amp;=\left|\frac{1}{rayDirY}\right|
\end{align*}
\]</span> <br></p>
<p><strong>注</strong>：</p>
<ol type="1">
<li>如果不进行化简，就会导致<code>deltaDist</code>考虑到光线的实际长度，而<code>deltaDist</code>这个变量会用于<code>sideDist</code>的计算，进而用于求出画线长度变量<code>perpWallDist</code>的计算；说人话就是使用公式<span class="math inline">\(deltaDistX=\left|\dfrac{|rayDir|}{rayDirX}\right|\)</span>和<span class="math inline">\(deltaDistY=\left|\dfrac{|rayDir|}{rayDirY}\right|\)</span>计算，就会导致墙的高度考虑了光线起点与终点的欧氏距离，会产生“鱼眼效应”，详情见<a href="#Fisheye_effect">这里</a></li>
<li>化简之后，从计算方法上可以避免产生“鱼眼效应”，因为把<code>deltaDist</code>缩放了<code>|rayDir|</code>，在计算过程中可以使<code>perpWallDist</code>的值刚好等于<code>sideDistX - deltaDistX</code>或者<code>sideDistY - deltaDistY</code>，很神奇吧</li>
<li>还得注意，这种计算方法只是“<strong>避免</strong>”产生鱼眼效应，而不是“<strong>修正</strong>”鱼眼效应，这两个是完全不同的概念</li>
<li>具体证明“为什么能避免鱼眼效应”见<a href="#Fisheye_effect">这里</a></li>
<li>如果想看产生“鱼眼效应”的效果，见<a href="#Fisheye_effect_justdoit">这里</a>，<del>只要不嫌晕</del></li>
</ol>
<p><br></p>
<p>但是需要注意，如果方向垂直于坐标轴，比如：</p>
<img src="/2023/11/09/%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/Raycasting%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/image-20240106165056829.png" class title="image-20240106165056829">
<p>此时的<code>rayDirX = 0</code>，所以给<code>deltaDistX</code>赋值为无穷，比如<code>1e30</code>，Y方向同理</p>
<p>所以就有了对应的代码：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">double</span> deltaDistX = (rayDirX == <span class="number">0</span>) ? <span class="number">1e30</span> : std::<span class="built_in">abs</span>(<span class="number">1</span> / rayDirX);</span><br><span class="line"><span class="type">double</span> deltaDistY = (rayDirY == <span class="number">0</span>) ? <span class="number">1e30</span> : std::<span class="built_in">abs</span>(<span class="number">1</span> / rayDirY);</span><br></pre></td></tr></table></figure>
<p><br></p>
<p>再定义一系列新变量：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//what direction to step in x or y-direction (either +1 or -1)</span></span><br><span class="line"><span class="type">int</span> stepX;</span><br><span class="line"><span class="type">int</span> stepY;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> hit = <span class="number">0</span>; <span class="comment">//was there a wall hit?</span></span><br><span class="line"><span class="type">int</span> side; <span class="comment">//was a NS or a EW wall hit?</span></span><br></pre></td></tr></table></figure>
<p><code>stepX</code>，光线方向在X的正负方向，+1代表正方向，-1代表负方向（规定向右为正）</p>
<p><code>stepY</code>，光线方向在Y的正负方向，+1代表正方向，-1代表负方向（规定向上为正）</p>
<p><code>hit</code>，检测光线是否撞墙，用于结束循环</p>
<p><code>side</code>，当光线撞到X方向的墙时，赋值0；当光线撞到Y方向的墙时，赋值1</p>
<img src="/2023/11/09/%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/Raycasting%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/image-20240106165740763.png" class title="image-20240106165740763">
<p><br></p>
<p>计算<code>sideDist</code>，这个需要自己动手在纸上画一画，就是初中的相似三角形知识</p>
<img src="/2023/11/09/%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/Raycasting%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/image-20240106170110388.png" class title="image-20240106170110388">
<p>对应的代码如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">//calculate step and initial sideDist</span></span><br><span class="line"><span class="keyword">if</span> (rayDirX &lt; <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">    stepX = <span class="number">-1</span>;</span><br><span class="line">    sideDistX = (posX - mapX) * deltaDistX;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">    stepX = <span class="number">1</span>;</span><br><span class="line">    sideDistX = (mapX + <span class="number">1.0</span> - posX) * deltaDistX;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (rayDirY &lt; <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">    stepY = <span class="number">-1</span>;</span><br><span class="line">    sideDistY = (posY - mapY) * deltaDistY;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">    stepY = <span class="number">1</span>;</span><br><span class="line">    sideDistY = (mapY + <span class="number">1.0</span> - posY) * deltaDistY;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><br></p>
<h5 id="执行dda算法">执行DDA算法</h5>
<p>代码如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//perform DDA</span></span><br><span class="line"><span class="keyword">while</span> (hit == <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//jump to next map square, either in x-direction, or in y-direction</span></span><br><span class="line">    <span class="keyword">if</span> (sideDistX &lt; sideDistY)</span><br><span class="line">    &#123;</span><br><span class="line">        sideDistX += deltaDistX;</span><br><span class="line">        mapX += stepX;</span><br><span class="line">        side = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        sideDistY += deltaDistY;</span><br><span class="line">        mapY += stepY;</span><br><span class="line">        side = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//Check if ray has hit a wall</span></span><br><span class="line">    <span class="keyword">if</span> (worldMap[mapX][mapY] &gt; <span class="number">0</span>) hit = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这段代码还是挺简单的，可以在纸上画一画，就能理解过程了</p>
<p>可能等我有空了会做一个manim动画演示？<del>应该会做吧</del></p>
<img src="/2023/11/09/%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/Raycasting%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/image-20240106170821395.png" class title="image-20240106170821395">
<p>只需要注意，判断撞墙以后对应的长度会多加一个，于是需要减掉</p>
<h4 id="计算对应墙的高度">计算对应墙的高度</h4>
<p>当DDA结束以后，我们要计算光线的长度，这样才能求出对应墙的高度</p>
<p><a id="Fisheye_effect"></a></p>
<p>注意：我们不用角色到墙壁实际的欧氏距离（即碰到墙后光线的长度），而是用相机平面到墙壁的距离来计算长度</p>
<p>如果用实际欧氏距离，就会出现“鱼眼效应”，如图所示：</p>
<img src="/2023/11/09/%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/Raycasting%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/raycastdist.png" class title="raycastdist">
<p>在玩家角色P的左边，显示了一些从墙的击中点到玩家的红色光线，代表欧几里得距离</p>
<p>在玩家的右边，显示了一些从墙的击中点直接到相机平面的绿色光线，而不是到玩家，这些绿线的长度是我们将使用的垂直距离的例子，而不是直接的欧几里得距离</p>
<p>在示例图中，玩家正在直接看着墙，而在这种情况下，我们期望墙的底部和顶部在屏幕上形成一条完美的水平线，即面朝着墙，希望墙高度相等，如图所示：</p>
<img src="/2023/11/09/%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/Raycasting%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/image-20240106172230968.png" class title="image-20240106172230968">
<p>然而，红色的光线都有<strong>不同的长度</strong>，所以会为不同的垂直条纹计算出<strong>不同的墙高</strong>，从而产生圆润的效果</p>
<p>右边的绿色光线都有相同的长度，所以会给出正确的结果，当玩家旋转时仍然适用</p>
<p>用一个比较极端的例子来描述“用相机平面的距离代替欧拉距离”：</p>
<img src="/2023/11/09/%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/Raycasting%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/image-20240512175424051.png" class title="image-20240512175424051">
<p>这样就可以很好地理解了，只不过这个例子画的太极端了，完全没有考虑视野范围的情况</p>
<p>正常来说是应该计算出FOV里对应所有光线的终点，再拿相机平面到这些点的距离算出墙的高度</p>
<p><br></p>
<p>参考<a target="_blank" rel="noopener" href="https://lodev.org/cgtutor/raycasting.html">原教程</a>，里面给出了证明过程，证明了这样的计算就能避免鱼眼效应</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//教程里这部分解释的比较清楚了</span></span><br><span class="line"><span class="comment">//也可以看我在博客里的证明过程，写的更清楚</span></span><br><span class="line"><span class="keyword">if</span> (side == <span class="number">0</span>) perpWallDist = (sideDistX - deltaDistX);</span><br><span class="line"><span class="keyword">else</span>          perpWallDist = (sideDistY - deltaDistY);</span><br><span class="line"></span><br><span class="line"><span class="comment">//Calculate height of line to draw on screen</span></span><br><span class="line"><span class="comment">//可任意修改墙的高度</span></span><br><span class="line"><span class="type">int</span> lineHeight = (<span class="type">int</span>)(screenHeight / perpWallDist);</span><br></pre></td></tr></table></figure>
<p><br></p>
<p>详细的证明过程整理如下，以这个图为例：</p>
<img src="/2023/11/09/%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/Raycasting%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/raycastperpwalldist.png" class title="raycastperpwalldist">
<img src="/2023/11/09/%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/Raycasting%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/IMG_4436.JPG" class title="IMG_4436">
<img src="/2023/11/09/%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/Raycasting%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/IMG_4437.JPG" class title="IMG_4437">
<p><br></p>
<p><a id="Fisheye_effect_justdoit"></a></p>
<p>如果上文计算<code>deltaDistX</code>和<code>deltaDistY</code>的代码如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 鱼眼效应</span></span><br><span class="line"><span class="type">double</span> rayDir_len = <span class="built_in">sqrt</span>(rayDirX * rayDirX + rayDirY * rayDirY);</span><br><span class="line"><span class="type">double</span> deltaDistX = (rayDirX == <span class="number">0</span>) ? <span class="number">1e30</span> : std::<span class="built_in">abs</span>(rayDir_len / rayDirX);</span><br><span class="line"><span class="type">double</span> deltaDistY = (rayDirY == <span class="number">0</span>) ? <span class="number">1e30</span> : std::<span class="built_in">abs</span>(rayDir_len / rayDirY);</span><br></pre></td></tr></table></figure>
<p>就会产生“鱼眼效应”，如下图所示，<del>如果不嫌晕的话，其实挺有意思的</del></p>
<img src="/2023/11/09/%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/Raycasting%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/Raycasting_fisheye.gif" class title="Raycasting_fisheye">
<h4 id="不同墙选不同颜色">不同墙选不同颜色</h4>
<p>我们可以规定，如果光线撞到Y墙，就让颜色的RGB减半，视觉效果上就会更暗，这样会有更好的显示效果</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//choose wall color</span></span><br><span class="line">Color color;</span><br><span class="line"><span class="keyword">switch</span> (worldMap[mapX][mapY])</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1</span>:  color = Color::Red;    <span class="keyword">break</span>; <span class="comment">//red</span></span><br><span class="line">    <span class="keyword">case</span> <span class="number">2</span>:  color = Color::Green;  <span class="keyword">break</span>; <span class="comment">//green</span></span><br><span class="line">    <span class="keyword">case</span> <span class="number">3</span>:  color = Color::Blue;   <span class="keyword">break</span>; <span class="comment">//blue</span></span><br><span class="line">    <span class="keyword">case</span> <span class="number">4</span>:  color = Color::White;  <span class="keyword">break</span>; <span class="comment">//white</span></span><br><span class="line">    <span class="keyword">default</span>: color = Color::Yellow; <span class="keyword">break</span>; <span class="comment">//yellow</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//give x and y sides different brightness</span></span><br><span class="line"><span class="keyword">if</span> (side == <span class="number">1</span>)</span><br><span class="line">&#123;</span><br><span class="line">    color.r /= <span class="number">2</span>;</span><br><span class="line">    color.g /= <span class="number">2</span>;</span><br><span class="line">    color.b /= <span class="number">2</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="屏幕对应位置画线">屏幕对应位置画线</h4>
<p>先计算线对应的起点<code>drawStart</code>和终点<code>drawEnd</code>，再带入画线函数</p>
<p>计算过程如图：</p>
<img src="/2023/11/09/%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/Raycasting%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/image-20240106173943906.png" class title="image-20240106173943906">
<p>画线函数指定了屏幕对应的<code>x</code>坐标，线的起点和终点，还有对应的颜色</p>
<p>画线我单独写了一个函数：<code>verLine</code>，在DDA函数的最后直接调用就行</p>
<p>代码如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//calculate lowest and highest pixel to fill in current stripe</span></span><br><span class="line"><span class="type">int</span> drawStart = -lineHeight / <span class="number">2</span> + screenHeight / <span class="number">2</span>;</span><br><span class="line"><span class="keyword">if</span> (drawStart &lt; <span class="number">0</span>) drawStart = <span class="number">0</span>;</span><br><span class="line"><span class="type">int</span> drawEnd = lineHeight / <span class="number">2</span> + screenHeight / <span class="number">2</span>;</span><br><span class="line"><span class="keyword">if</span> (drawEnd &gt;= screenHeight) drawEnd = screenHeight - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//draw the pixels of the stripe as a vertical line</span></span><br><span class="line"><span class="built_in">verLine</span>(window, x, drawStart, drawEnd, color);</span><br></pre></td></tr></table></figure>
<p><br></p>
<p>画线函数定义如下</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//画线</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">verLine</span><span class="params">(sf::RenderWindow&amp; window, <span class="type">int</span> x, <span class="type">int</span> y1, <span class="type">int</span> y2, <span class="type">const</span> sf::Color&amp; color)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// Ensure y1 is less than y2</span></span><br><span class="line">    <span class="keyword">if</span> (y2 &lt; y1)</span><br><span class="line">    &#123;</span><br><span class="line">        std::<span class="built_in">swap</span>(y1, y2);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Create a sf::VertexArray for the line</span></span><br><span class="line">    <span class="function">sf::VertexArray <span class="title">line</span><span class="params">(sf::Lines, <span class="number">2</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Set the position and color of the line vertices</span></span><br><span class="line">    line[<span class="number">0</span>].position = sf::<span class="built_in">Vector2f</span>(x, y1);</span><br><span class="line">    line[<span class="number">0</span>].color = color;</span><br><span class="line">    line[<span class="number">1</span>].position = sf::<span class="built_in">Vector2f</span>(x, y2);</span><br><span class="line">    line[<span class="number">1</span>].color = color;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Draw the line</span></span><br><span class="line">    window.<span class="built_in">draw</span>(line);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>至此，DDA函数结束</p>
<h3 id="人物移动逻辑">人物移动逻辑</h3>
<p>对应了<code>main</code>函数中的<code>Move</code>函数</p>
<p>具体实现涉及到方向矩阵的乘法，说白了就是二维矩阵乘法</p>
<p><br></p>
<p>先计算帧之间的时间，用于计算速度</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//timing for input and FPS counter</span></span><br><span class="line">oldTime = Mytime;</span><br><span class="line">Mytime = <span class="built_in">getTicks</span>();</span><br><span class="line"><span class="type">double</span> frameTime = (Mytime - oldTime) / <span class="number">1000.0</span>; <span class="comment">//frameTime is the time this frame has taken, in seconds</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//speed modifiers</span></span><br><span class="line"><span class="type">double</span> moveSpeed = frameTime * <span class="number">5.0</span>; <span class="comment">//the constant value is in squares/second</span></span><br><span class="line"><span class="type">double</span> rotSpeed = frameTime * <span class="number">3.0</span>; <span class="comment">//the constant value is in radians/second</span></span><br></pre></td></tr></table></figure>
<p>其中<code>getTicks</code>函数定义如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">unsigned</span> <span class="type">long</span> <span class="title">getTicks</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    sf::Time elapsed = Myclock.<span class="built_in">getElapsedTime</span>();</span><br><span class="line">    <span class="keyword">return</span> elapsed.<span class="built_in">asMilliseconds</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><br></p>
<h4 id="前后走">前后走</h4>
<img src="/2023/11/09/%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/Raycasting%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/image-20240106175710655.png" class title="image-20240106175710655">
<p>很好理解，对应坐标加上速度乘方向</p>
<p>对应代码如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//move forward if no wall in front of you</span></span><br><span class="line"><span class="keyword">if</span> (sf::Keyboard::<span class="built_in">isKeyPressed</span>(sf::Keyboard::Up) || </span><br><span class="line">    sf::Keyboard::<span class="built_in">isKeyPressed</span>(sf::Keyboard::W))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (worldMap[<span class="built_in">int</span>(posX + dirX * moveSpeed)][<span class="built_in">int</span>(posY)] == <span class="literal">false</span>) posX += dirX * moveSpeed;</span><br><span class="line">    <span class="keyword">if</span> (worldMap[<span class="built_in">int</span>(posX)][<span class="built_in">int</span>(posY + dirY * moveSpeed)] == <span class="literal">false</span>) posY += dirY * moveSpeed;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//move backwards if no wall behind you</span></span><br><span class="line"><span class="keyword">if</span> (sf::Keyboard::<span class="built_in">isKeyPressed</span>(sf::Keyboard::Down) ||</span><br><span class="line">    sf::Keyboard::<span class="built_in">isKeyPressed</span>(sf::Keyboard::S))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (worldMap[<span class="built_in">int</span>(posX - dirX * moveSpeed)][<span class="built_in">int</span>(posY)] == <span class="literal">false</span>) posX -= dirX * moveSpeed;</span><br><span class="line">    <span class="keyword">if</span> (worldMap[<span class="built_in">int</span>(posX)][<span class="built_in">int</span>(posY - dirY * moveSpeed)] == <span class="literal">false</span>) posY -= dirY * moveSpeed;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="左右走">左右走</h4>
<img src="/2023/11/09/%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/Raycasting%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/image-20240106175852146.png" class title="image-20240106175852146">
<p>左右走也类似于前后走，只不过对应方向改变了</p>
<p>对应代码如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//向右走，原理还是跟前后走一样，只是方向用矩阵相乘重新算了</span></span><br><span class="line"><span class="comment">//向右走就是在(dirY, -dirX)这个方向走</span></span><br><span class="line"><span class="keyword">if</span> (sf::Keyboard::<span class="built_in">isKeyPressed</span>(sf::Keyboard::D))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (worldMap[<span class="built_in">int</span>(posX + dirY * moveSpeed * <span class="number">0.75</span>)][<span class="built_in">int</span>(posY)] == <span class="literal">false</span>) posX += dirY * moveSpeed * <span class="number">0.75</span>;</span><br><span class="line">    <span class="keyword">if</span> (worldMap[<span class="built_in">int</span>(posX)][<span class="built_in">int</span>(posY - dirX * moveSpeed * <span class="number">0.75</span>)] == <span class="literal">false</span>) posY -= dirX * moveSpeed * <span class="number">0.75</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//向左走同理</span></span><br><span class="line"><span class="comment">//在(-dirY, dirX)方向</span></span><br><span class="line"><span class="keyword">if</span> (sf::Keyboard::<span class="built_in">isKeyPressed</span>(sf::Keyboard::A))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (worldMap[<span class="built_in">int</span>(posX - dirY * moveSpeed * <span class="number">0.75</span>)][<span class="built_in">int</span>(posY)] == <span class="literal">false</span>) posX -= dirY * moveSpeed * <span class="number">0.75</span>;</span><br><span class="line">    <span class="keyword">if</span> (worldMap[<span class="built_in">int</span>(posX)][<span class="built_in">int</span>(posY + dirX * moveSpeed * <span class="number">0.75</span>)] == <span class="literal">false</span>) posY += dirX * moveSpeed * <span class="number">0.75</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="视角左右转">视角左右转</h4>
<p>注意：<span class="math inline">\(\overrightarrow{dir}\)</span>和<span class="math inline">\(\overrightarrow{plane}\)</span>两个向量同时都要旋转</p>
<img src="/2023/11/09/%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/Raycasting%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/image-20240106180208549.png" class title="image-20240106180208549">
<p>对应代码如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//rotate to the right</span></span><br><span class="line"><span class="keyword">if</span> (sf::Keyboard::<span class="built_in">isKeyPressed</span>(sf::Keyboard::Right))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//both camera direction and camera plane must be rotated</span></span><br><span class="line">    <span class="type">double</span> oldDirX = dirX;</span><br><span class="line">    dirX = dirX * <span class="built_in">cos</span>(-rotSpeed) - dirY * <span class="built_in">sin</span>(-rotSpeed);</span><br><span class="line">    dirY = oldDirX * <span class="built_in">sin</span>(-rotSpeed) + dirY * <span class="built_in">cos</span>(-rotSpeed);</span><br><span class="line">    <span class="type">double</span> oldPlaneX = planeX;</span><br><span class="line">    planeX = planeX * <span class="built_in">cos</span>(-rotSpeed) - planeY * <span class="built_in">sin</span>(-rotSpeed);</span><br><span class="line">    planeY = oldPlaneX * <span class="built_in">sin</span>(-rotSpeed) + planeY * <span class="built_in">cos</span>(-rotSpeed);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//rotate to the left</span></span><br><span class="line"><span class="keyword">if</span> (sf::Keyboard::<span class="built_in">isKeyPressed</span>(sf::Keyboard::Left))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//both camera direction and camera plane must be rotated</span></span><br><span class="line">    <span class="type">double</span> oldDirX = dirX;</span><br><span class="line">    dirX = dirX * <span class="built_in">cos</span>(rotSpeed) - dirY * <span class="built_in">sin</span>(rotSpeed);</span><br><span class="line">    dirY = oldDirX * <span class="built_in">sin</span>(rotSpeed) + dirY * <span class="built_in">cos</span>(rotSpeed);</span><br><span class="line">    <span class="type">double</span> oldPlaneX = planeX;</span><br><span class="line">    planeX = planeX * <span class="built_in">cos</span>(rotSpeed) - planeY * <span class="built_in">sin</span>(rotSpeed);</span><br><span class="line">    planeY = oldPlaneX * <span class="built_in">sin</span>(rotSpeed) + planeY * <span class="built_in">cos</span>(rotSpeed);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>至此，<code>Move</code>函数结束</p>
<h3 id="最后的效果">最后的效果</h3>
<img src="/2023/11/09/%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/Raycasting%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/image-20240106180421147.png" class title="image-20240106180421147">
<h3 id="源代码">源代码</h3>
<p><a id="Code_Raycasting"></a></p>
<p>无纹理，最基本Raycasting的实现，源代码如下</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;SFML/Graphics.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> sf;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> screenWidth 1440</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> screenHeight 900</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> mapWidth 24</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> mapHeight 24</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> worldMap[mapWidth][mapWidth] =</span><br><span class="line">&#123;</span><br><span class="line">  &#123;<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>&#125;,</span><br><span class="line">  &#123;<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>&#125;,</span><br><span class="line">  &#123;<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>&#125;,</span><br><span class="line">  &#123;<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>&#125;,</span><br><span class="line">  &#123;<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">3</span>,<span class="number">0</span>,<span class="number">3</span>,<span class="number">0</span>,<span class="number">3</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>&#125;,</span><br><span class="line">  &#123;<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>&#125;,</span><br><span class="line">  &#123;<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">3</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">3</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>&#125;,</span><br><span class="line">  &#123;<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>&#125;,</span><br><span class="line">  &#123;<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">3</span>,<span class="number">0</span>,<span class="number">3</span>,<span class="number">0</span>,<span class="number">3</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>&#125;,</span><br><span class="line">  &#123;<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>&#125;,</span><br><span class="line">  &#123;<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>&#125;,</span><br><span class="line">  &#123;<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>&#125;,</span><br><span class="line">  &#123;<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>&#125;,</span><br><span class="line">  &#123;<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>&#125;,</span><br><span class="line">  &#123;<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>&#125;,</span><br><span class="line">  &#123;<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>&#125;,</span><br><span class="line">  &#123;<span class="number">1</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>&#125;,</span><br><span class="line">  &#123;<span class="number">1</span>,<span class="number">4</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>&#125;,</span><br><span class="line">  &#123;<span class="number">1</span>,<span class="number">4</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>&#125;,</span><br><span class="line">  &#123;<span class="number">1</span>,<span class="number">4</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>&#125;,</span><br><span class="line">  &#123;<span class="number">1</span>,<span class="number">4</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>&#125;,</span><br><span class="line">  &#123;<span class="number">1</span>,<span class="number">4</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>&#125;,</span><br><span class="line">  &#123;<span class="number">1</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>&#125;,</span><br><span class="line">  &#123;<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">double</span> posX = <span class="number">22</span>, posY = <span class="number">12</span>;  <span class="comment">//x and y start position</span></span><br><span class="line"><span class="type">double</span> dirX = <span class="number">-1</span>, dirY = <span class="number">0</span>; <span class="comment">//initial direction vector</span></span><br><span class="line"><span class="type">double</span> planeX = <span class="number">0</span>, planeY = <span class="number">0.66</span>; <span class="comment">//the 2d raycaster version of camera plane</span></span><br><span class="line"></span><br><span class="line"><span class="type">double</span> Mytime = <span class="number">0</span>; <span class="comment">//time of current frame</span></span><br><span class="line"><span class="type">double</span> oldTime = <span class="number">0</span>; <span class="comment">//time of previous frame</span></span><br><span class="line"></span><br><span class="line">sf::Clock Myclock;    <span class="comment">//用于计时</span></span><br><span class="line"><span class="function"><span class="type">unsigned</span> <span class="type">long</span> <span class="title">getTicks</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    sf::Time elapsed = Myclock.<span class="built_in">getElapsedTime</span>();</span><br><span class="line">    <span class="keyword">return</span> elapsed.<span class="built_in">asMilliseconds</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//画线</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">verLine</span><span class="params">(sf::RenderWindow&amp; window, <span class="type">int</span> x, <span class="type">int</span> y1, <span class="type">int</span> y2, <span class="type">const</span> sf::Color&amp; color)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// Ensure y1 is less than y2</span></span><br><span class="line">    <span class="keyword">if</span> (y2 &lt; y1)</span><br><span class="line">    &#123;</span><br><span class="line">        std::<span class="built_in">swap</span>(y1, y2);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Create a sf::VertexArray for the line</span></span><br><span class="line">    <span class="function">sf::VertexArray <span class="title">line</span><span class="params">(sf::Lines, <span class="number">2</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Set the position and color of the line vertices</span></span><br><span class="line">    line[<span class="number">0</span>].position = sf::<span class="built_in">Vector2f</span>(x, y1);</span><br><span class="line">    line[<span class="number">0</span>].color = color;</span><br><span class="line">    line[<span class="number">1</span>].position = sf::<span class="built_in">Vector2f</span>(x, y2);</span><br><span class="line">    line[<span class="number">1</span>].color = color;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Draw the line</span></span><br><span class="line">    window.<span class="built_in">draw</span>(line);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DDA_algorithm</span><span class="params">(RenderWindow&amp; window)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> x = <span class="number">0</span>; x &lt; screenWidth; x++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//calculate ray position and direction</span></span><br><span class="line">        <span class="type">double</span> cameraX = <span class="number">2</span> * x / (<span class="type">double</span>)screenWidth - <span class="number">1</span>; <span class="comment">//x-coordinate in camera space</span></span><br><span class="line">        <span class="type">double</span> rayDirX = dirX + planeX * cameraX;</span><br><span class="line">        <span class="type">double</span> rayDirY = dirY + planeY * cameraX;</span><br><span class="line">        <span class="comment">//which box of the map we&#x27;re in</span></span><br><span class="line">        <span class="type">int</span> mapX = <span class="built_in">int</span>(posX);</span><br><span class="line">        <span class="type">int</span> mapY = <span class="built_in">int</span>(posY);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//length of ray from current position to next x or y-side</span></span><br><span class="line">        <span class="type">double</span> sideDistX;</span><br><span class="line">        <span class="type">double</span> sideDistY;</span><br><span class="line"></span><br><span class="line">        <span class="type">double</span> deltaDistX = (rayDirX == <span class="number">0</span>) ? <span class="number">1e30</span> : std::<span class="built_in">abs</span>(<span class="number">1</span> / rayDirX);</span><br><span class="line">        <span class="type">double</span> deltaDistY = (rayDirY == <span class="number">0</span>) ? <span class="number">1e30</span> : std::<span class="built_in">abs</span>(<span class="number">1</span> / rayDirY);</span><br><span class="line"></span><br><span class="line">        <span class="type">double</span> perpWallDist;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//what direction to step in x or y-direction (either +1 or -1)</span></span><br><span class="line">        <span class="type">int</span> stepX;</span><br><span class="line">        <span class="type">int</span> stepY;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> hit = <span class="number">0</span>; <span class="comment">//was there a wall hit?</span></span><br><span class="line">        <span class="type">int</span> side; <span class="comment">//was a NS or a EW wall hit?</span></span><br><span class="line">        <span class="comment">//calculate step and initial sideDist</span></span><br><span class="line">        <span class="keyword">if</span> (rayDirX &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            stepX = <span class="number">-1</span>;</span><br><span class="line">            sideDistX = (posX - mapX) * deltaDistX;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            stepX = <span class="number">1</span>;</span><br><span class="line">            sideDistX = (mapX + <span class="number">1.0</span> - posX) * deltaDistX;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (rayDirY &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            stepY = <span class="number">-1</span>;</span><br><span class="line">            sideDistY = (posY - mapY) * deltaDistY;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            stepY = <span class="number">1</span>;</span><br><span class="line">            sideDistY = (mapY + <span class="number">1.0</span> - posY) * deltaDistY;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//perform DDA</span></span><br><span class="line">        <span class="keyword">while</span> (hit == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//jump to next map square, either in x-direction, or in y-direction</span></span><br><span class="line">            <span class="keyword">if</span> (sideDistX &lt; sideDistY)</span><br><span class="line">            &#123;</span><br><span class="line">                sideDistX += deltaDistX;</span><br><span class="line">                mapX += stepX;</span><br><span class="line">                side = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                sideDistY += deltaDistY;</span><br><span class="line">                mapY += stepY;</span><br><span class="line">                side = <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//Check if ray has hit a wall</span></span><br><span class="line">            <span class="keyword">if</span> (worldMap[mapX][mapY] &gt; <span class="number">0</span>) hit = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//教程里这部分写的比较清楚，但可以看我博客的内容，更清楚</span></span><br><span class="line">        <span class="keyword">if</span> (side == <span class="number">0</span>) perpWallDist = (sideDistX - deltaDistX);</span><br><span class="line">        <span class="keyword">else</span>          perpWallDist = (sideDistY - deltaDistY);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Calculate height of line to draw on screen</span></span><br><span class="line">        <span class="comment">//修改墙的高度</span></span><br><span class="line">        <span class="type">int</span> lineHeight = (<span class="type">int</span>)(screenHeight / perpWallDist) * <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//calculate lowest and highest pixel to fill in current stripe</span></span><br><span class="line">        <span class="type">int</span> drawStart = -lineHeight / <span class="number">2</span> + screenHeight / <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">if</span> (drawStart &lt; <span class="number">0</span>) drawStart = <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> drawEnd = lineHeight / <span class="number">2</span> + screenHeight / <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">if</span> (drawEnd &gt;= screenHeight) drawEnd = screenHeight - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//choose wall color</span></span><br><span class="line">        Color color;</span><br><span class="line">        <span class="keyword">switch</span> (worldMap[mapX][mapY])</span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">1</span>:  color = Color::Red;    <span class="keyword">break</span>; <span class="comment">//red</span></span><br><span class="line">        <span class="keyword">case</span> <span class="number">2</span>:  color = Color::Green;  <span class="keyword">break</span>; <span class="comment">//green</span></span><br><span class="line">        <span class="keyword">case</span> <span class="number">3</span>:  color = Color::Blue;   <span class="keyword">break</span>; <span class="comment">//blue</span></span><br><span class="line">        <span class="keyword">case</span> <span class="number">4</span>:  color = Color::White;  <span class="keyword">break</span>; <span class="comment">//white</span></span><br><span class="line">        <span class="keyword">default</span>: color = Color::Yellow; <span class="keyword">break</span>; <span class="comment">//yellow</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//give x and y sides different brightness</span></span><br><span class="line">        <span class="keyword">if</span> (side == <span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            color.r /= <span class="number">2</span>;</span><br><span class="line">            color.g /= <span class="number">2</span>;</span><br><span class="line">            color.b /= <span class="number">2</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//draw the pixels of the stripe as a vertical line</span></span><br><span class="line">        <span class="built_in">verLine</span>(window, x, drawStart, drawEnd, color);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Move</span><span class="params">(RenderWindow&amp; window)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//timing for input and FPS counter</span></span><br><span class="line">    oldTime = Mytime;</span><br><span class="line">    Mytime = <span class="built_in">getTicks</span>();</span><br><span class="line">    <span class="type">double</span> frameTime = (Mytime - oldTime) / <span class="number">1000.0</span>; <span class="comment">//frameTime is the time this frame has taken, in seconds</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//speed modifiers</span></span><br><span class="line">    <span class="type">double</span> moveSpeed = frameTime * <span class="number">5.0</span>; <span class="comment">//the constant value is in squares/second</span></span><br><span class="line">    <span class="type">double</span> rotSpeed = frameTime * <span class="number">3.0</span>; <span class="comment">//the constant value is in radians/second</span></span><br><span class="line">    <span class="comment">//move forward if no wall in front of you</span></span><br><span class="line">    <span class="keyword">if</span> (sf::Keyboard::<span class="built_in">isKeyPressed</span>(sf::Keyboard::Up) || </span><br><span class="line">        sf::Keyboard::<span class="built_in">isKeyPressed</span>(sf::Keyboard::W))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (worldMap[<span class="built_in">int</span>(posX + dirX * moveSpeed)][<span class="built_in">int</span>(posY)] == <span class="literal">false</span>) posX += dirX * moveSpeed;</span><br><span class="line">        <span class="keyword">if</span> (worldMap[<span class="built_in">int</span>(posX)][<span class="built_in">int</span>(posY + dirY * moveSpeed)] == <span class="literal">false</span>) posY += dirY * moveSpeed;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//move backwards if no wall behind you</span></span><br><span class="line">    <span class="keyword">if</span> (sf::Keyboard::<span class="built_in">isKeyPressed</span>(sf::Keyboard::Down) ||</span><br><span class="line">        sf::Keyboard::<span class="built_in">isKeyPressed</span>(sf::Keyboard::S))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (worldMap[<span class="built_in">int</span>(posX - dirX * moveSpeed)][<span class="built_in">int</span>(posY)] == <span class="literal">false</span>) posX -= dirX * moveSpeed;</span><br><span class="line">        <span class="keyword">if</span> (worldMap[<span class="built_in">int</span>(posX)][<span class="built_in">int</span>(posY - dirY * moveSpeed)] == <span class="literal">false</span>) posY -= dirY * moveSpeed;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//向右走，原理还是跟前后走一样，只是方向用矩阵相乘重新算了</span></span><br><span class="line">    <span class="comment">//向右走就是在(dirY, -dirX)这个方向走</span></span><br><span class="line">    <span class="keyword">if</span> (sf::Keyboard::<span class="built_in">isKeyPressed</span>(sf::Keyboard::D))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (worldMap[<span class="built_in">int</span>(posX + dirY * moveSpeed * <span class="number">0.75</span>)][<span class="built_in">int</span>(posY)] == <span class="literal">false</span>) posX += dirY * moveSpeed * <span class="number">0.75</span>;</span><br><span class="line">        <span class="keyword">if</span> (worldMap[<span class="built_in">int</span>(posX)][<span class="built_in">int</span>(posY - dirX * moveSpeed * <span class="number">0.75</span>)] == <span class="literal">false</span>) posY -= dirX * moveSpeed * <span class="number">0.75</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//向左走同理</span></span><br><span class="line">    <span class="comment">//在(-dirY, dirX)方向</span></span><br><span class="line">    <span class="keyword">if</span> (sf::Keyboard::<span class="built_in">isKeyPressed</span>(sf::Keyboard::A))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (worldMap[<span class="built_in">int</span>(posX - dirY * moveSpeed * <span class="number">0.75</span>)][<span class="built_in">int</span>(posY)] == <span class="literal">false</span>) posX -= dirY * moveSpeed * <span class="number">0.75</span>;</span><br><span class="line">        <span class="keyword">if</span> (worldMap[<span class="built_in">int</span>(posX)][<span class="built_in">int</span>(posY + dirX * moveSpeed * <span class="number">0.75</span>)] == <span class="literal">false</span>) posY += dirX * moveSpeed * <span class="number">0.75</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//rotate to the right</span></span><br><span class="line">    <span class="keyword">if</span> (sf::Keyboard::<span class="built_in">isKeyPressed</span>(sf::Keyboard::Right))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//both camera direction and camera plane must be rotated</span></span><br><span class="line">        <span class="type">double</span> oldDirX = dirX;</span><br><span class="line">        dirX = dirX * <span class="built_in">cos</span>(-rotSpeed) - dirY * <span class="built_in">sin</span>(-rotSpeed);</span><br><span class="line">        dirY = oldDirX * <span class="built_in">sin</span>(-rotSpeed) + dirY * <span class="built_in">cos</span>(-rotSpeed);</span><br><span class="line">        <span class="type">double</span> oldPlaneX = planeX;</span><br><span class="line">        planeX = planeX * <span class="built_in">cos</span>(-rotSpeed) - planeY * <span class="built_in">sin</span>(-rotSpeed);</span><br><span class="line">        planeY = oldPlaneX * <span class="built_in">sin</span>(-rotSpeed) + planeY * <span class="built_in">cos</span>(-rotSpeed);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//rotate to the left</span></span><br><span class="line">    <span class="keyword">if</span> (sf::Keyboard::<span class="built_in">isKeyPressed</span>(sf::Keyboard::Left))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//both camera direction and camera plane must be rotated</span></span><br><span class="line">        <span class="type">double</span> oldDirX = dirX;</span><br><span class="line">        dirX = dirX * <span class="built_in">cos</span>(rotSpeed) - dirY * <span class="built_in">sin</span>(rotSpeed);</span><br><span class="line">        dirY = oldDirX * <span class="built_in">sin</span>(rotSpeed) + dirY * <span class="built_in">cos</span>(rotSpeed);</span><br><span class="line">        <span class="type">double</span> oldPlaneX = planeX;</span><br><span class="line">        planeX = planeX * <span class="built_in">cos</span>(rotSpeed) - planeY * <span class="built_in">sin</span>(rotSpeed);</span><br><span class="line">        planeY = oldPlaneX * <span class="built_in">sin</span>(rotSpeed) + planeY * <span class="built_in">cos</span>(rotSpeed);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">sf::RenderWindow <span class="title">window</span><span class="params">(sf::VideoMode(screenWidth, screenHeight), <span class="string">&quot;Raycasting&quot;</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (window.<span class="built_in">isOpen</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        sf::Event event;</span><br><span class="line">        <span class="keyword">while</span> (window.<span class="built_in">pollEvent</span>(event))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (event.type == sf::Event::Closed)</span><br><span class="line">                window.<span class="built_in">close</span>();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        window.<span class="built_in">clear</span>();</span><br><span class="line">        <span class="built_in">DDA_algorithm</span>(window);</span><br><span class="line">        <span class="built_in">Move</span>(window);</span><br><span class="line">        window.<span class="built_in">display</span>();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="加纹理版">加纹理版</h2>
<p>具体实现思路和最基础版本完全一样，只是略有不同</p>
<p>纹理部分会代替最基本实现中“颜色选择”部分</p>
<p>可在<a href="#Code_Raycasting_Texture">这里</a>查看源代码</p>
<p><br></p>
<p>变量声明处多了与纹理相关的定义，顺便换一张地图，重新定义角色起始位置：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> texWidth 64</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> texHeight 64</span></span><br><span class="line"></span><br><span class="line">Texture texture[<span class="number">8</span>];</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//修改新地图，修改角色位置</span></span><br><span class="line"><span class="type">int</span> worldMap[mapWidth][mapHeight] =</span><br><span class="line">&#123;</span><br><span class="line">  &#123;<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">7</span>,<span class="number">7</span>,<span class="number">7</span>,<span class="number">7</span>,<span class="number">7</span>,<span class="number">7</span>,<span class="number">7</span>,<span class="number">7</span>&#125;,</span><br><span class="line">  &#123;<span class="number">4</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">7</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">7</span>&#125;,</span><br><span class="line">  &#123;<span class="number">4</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">7</span>&#125;,</span><br><span class="line">  &#123;<span class="number">4</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">7</span>&#125;,</span><br><span class="line">  &#123;<span class="number">4</span>,<span class="number">0</span>,<span class="number">3</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">7</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">7</span>&#125;,</span><br><span class="line">  &#123;<span class="number">4</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">5</span>,<span class="number">5</span>,<span class="number">5</span>,<span class="number">5</span>,<span class="number">5</span>,<span class="number">5</span>,<span class="number">5</span>,<span class="number">5</span>,<span class="number">7</span>,<span class="number">7</span>,<span class="number">0</span>,<span class="number">7</span>,<span class="number">7</span>,<span class="number">7</span>,<span class="number">7</span>,<span class="number">7</span>&#125;,</span><br><span class="line">  &#123;<span class="number">4</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">7</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">7</span>,<span class="number">7</span>,<span class="number">7</span>,<span class="number">1</span>&#125;,</span><br><span class="line">  &#123;<span class="number">4</span>,<span class="number">0</span>,<span class="number">6</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">7</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">8</span>&#125;,</span><br><span class="line">  &#123;<span class="number">4</span>,<span class="number">0</span>,<span class="number">7</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">7</span>,<span class="number">7</span>,<span class="number">7</span>,<span class="number">1</span>&#125;,</span><br><span class="line">  &#123;<span class="number">4</span>,<span class="number">0</span>,<span class="number">8</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">7</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">8</span>&#125;,</span><br><span class="line">  &#123;<span class="number">4</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">7</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">7</span>,<span class="number">7</span>,<span class="number">7</span>,<span class="number">1</span>&#125;,</span><br><span class="line">  &#123;<span class="number">4</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">5</span>,<span class="number">5</span>,<span class="number">5</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">5</span>,<span class="number">5</span>,<span class="number">5</span>,<span class="number">7</span>,<span class="number">7</span>,<span class="number">7</span>,<span class="number">7</span>,<span class="number">7</span>,<span class="number">7</span>,<span class="number">7</span>,<span class="number">1</span>&#125;,</span><br><span class="line">  &#123;<span class="number">6</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">0</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">6</span>&#125;,</span><br><span class="line">  &#123;<span class="number">8</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">4</span>&#125;,</span><br><span class="line">  &#123;<span class="number">6</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">0</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">0</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">6</span>&#125;,</span><br><span class="line">  &#123;<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">6</span>,<span class="number">0</span>,<span class="number">6</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">3</span>,<span class="number">3</span>,<span class="number">3</span>&#125;,</span><br><span class="line">  &#123;<span class="number">4</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">6</span>,<span class="number">0</span>,<span class="number">6</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">2</span>&#125;,</span><br><span class="line">  &#123;<span class="number">4</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">6</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">2</span>&#125;,</span><br><span class="line">  &#123;<span class="number">4</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">6</span>,<span class="number">0</span>,<span class="number">6</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">2</span>&#125;,</span><br><span class="line">  &#123;<span class="number">4</span>,<span class="number">0</span>,<span class="number">6</span>,<span class="number">0</span>,<span class="number">6</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">6</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">2</span>&#125;,</span><br><span class="line">  &#123;<span class="number">4</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">6</span>,<span class="number">0</span>,<span class="number">6</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">2</span>&#125;,</span><br><span class="line">  &#123;<span class="number">4</span>,<span class="number">0</span>,<span class="number">6</span>,<span class="number">0</span>,<span class="number">6</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">6</span>,<span class="number">0</span>,<span class="number">6</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">2</span>&#125;,</span><br><span class="line">  &#123;<span class="number">4</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">6</span>,<span class="number">0</span>,<span class="number">6</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">2</span>&#125;,</span><br><span class="line">  &#123;<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">3</span>,<span class="number">3</span>,<span class="number">3</span>,<span class="number">3</span>&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">double</span> posX = <span class="number">22</span>, posY = <span class="number">11.5</span>;  <span class="comment">//x and y start position</span></span><br></pre></td></tr></table></figure>
<p><code>main</code>函数多了读取纹理的操作，把对应的纹理读取到<code>Texture texture[8]</code>这个纹理数组中：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">RenderWindow <span class="title">window</span><span class="params">(sf::VideoMode(screenWidth, screenHeight), <span class="string">&quot;Raycasting-texture&quot;</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">LoadTexture</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (window.<span class="built_in">isOpen</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        sf::Event event;</span><br><span class="line">        <span class="keyword">while</span> (window.<span class="built_in">pollEvent</span>(event))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (event.type == sf::Event::Closed)</span><br><span class="line">                window.<span class="built_in">close</span>();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        window.<span class="built_in">clear</span>();</span><br><span class="line">        <span class="built_in">DDA_algorithm</span>(window);</span><br><span class="line">        <span class="built_in">Move</span>(window);</span><br><span class="line">        window.<span class="built_in">display</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>LoadTexture</code>定义如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">LoadTexture</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    texture[<span class="number">0</span>].<span class="built_in">loadFromFile</span>(<span class="string">&quot;pics/eagle.png&quot;</span>);</span><br><span class="line">    texture[<span class="number">1</span>].<span class="built_in">loadFromFile</span>(<span class="string">&quot;pics/redbrick.png&quot;</span>);</span><br><span class="line">    texture[<span class="number">2</span>].<span class="built_in">loadFromFile</span>(<span class="string">&quot;pics/purplestone.png&quot;</span>);</span><br><span class="line">    texture[<span class="number">3</span>].<span class="built_in">loadFromFile</span>(<span class="string">&quot;pics/greystone.png&quot;</span>);</span><br><span class="line">    texture[<span class="number">4</span>].<span class="built_in">loadFromFile</span>(<span class="string">&quot;pics/bluestone.png&quot;</span>);</span><br><span class="line">    texture[<span class="number">5</span>].<span class="built_in">loadFromFile</span>(<span class="string">&quot;pics/mossy.png&quot;</span>);</span><br><span class="line">    texture[<span class="number">6</span>].<span class="built_in">loadFromFile</span>(<span class="string">&quot;pics/wood.png&quot;</span>);</span><br><span class="line">    texture[<span class="number">7</span>].<span class="built_in">loadFromFile</span>(<span class="string">&quot;pics/colorstone.png&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><br></p>
<p><a target="_blank" rel="noopener" href="https://lodev.org/cgtutor/raycasting.html">原教程</a>的纹理添加过程我也试过，但是非常卡，并且图像显示还有很大问题</p>
<p>于是这里只记录用SFML实现纹理的方法，具体参考为<a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=LUYxLjic0Bc">YouTube视频</a>以及对应的<a target="_blank" rel="noopener" href="https://github.com/Kofybrek/Raycasting">代码</a></p>
<p><del>原作者英文口语还是很奇怪的，代码也是研究了很久才看明白</del>，不过最后全变成我的东西了</p>
<p><br></p>
<p>纹理添加的代码具体更新内容，还是在DDA函数里修改：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">DDA_algorithm</span><span class="params">(RenderWindow&amp; window)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> x = <span class="number">0</span>; x &lt; screenWidth; x++)</span><br><span class="line">    &#123;</span><br><span class="line">		...</span><br><span class="line">		<span class="comment">//此处结束DDA算法，准备纹理相关变量的声明</span></span><br><span class="line">		<span class="comment">//设置纹理</span></span><br><span class="line">         <span class="comment">//画出纹理</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="计算纹理对应坐标texx">计算纹理对应坐标<code>texX</code></h3>
<p>此处紧接着DDA算法结束</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//texturing calculations</span></span><br><span class="line"><span class="type">int</span> texNum = worldMap[mapX][mapY] - <span class="number">1</span>; <span class="comment">//1 subtracted from it so that texture 0 can be used!</span></span><br></pre></td></tr></table></figure>
<p>变量<code>texNum</code>是当前地图方块的值减1，原因是存在纹理0，但地图砖块0没有纹理，因为它代表一个空的空间</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//calculate value of wallX</span></span><br><span class="line"><span class="type">double</span> wallX; <span class="comment">//where exactly the wall was hit</span></span><br><span class="line"><span class="keyword">if</span> (side == <span class="number">0</span>) wallX = posY + perpWallDist * rayDirY;</span><br><span class="line"><span class="keyword">else</span>           wallX = posX + perpWallDist * rayDirX;</span><br><span class="line">wallX -= <span class="built_in">floor</span>((wallX));	<span class="comment">//减去向下取整，即只保留小数部分</span></span><br></pre></td></tr></table></figure>
<p><code>wallX</code>表示墙被击中的确切位置，而不仅仅是墙的整数坐标</p>
<p>具体的计算方法，用到了相似三角形的内容，需要参考“<a href="#Fisheye_effect">避免鱼眼效应证明</a>”那一块的内容</p>
<p>具体来说，计算墙被光线击中具体位置与玩家坐标之间差值<code>Dist</code>的公式如下：
<span class="math display">\[
\begin{align*}
\frac{|\overrightarrow{\text{dir}}|=1}{\text{perpWallDist}}&amp;=\frac{\text{rayDirY}}{\text{yDist}}=\frac{\text{rayDirX}}{\text{xDist}}\\\\
\text{即：}\text{yDist}&amp;=\text{perpWallDist}\cdot \text{rayDirY}\\
\text{xDist}&amp;=\text{perpWallDist}\cdot \text{rayDirX}\\
\end{align*}
\]</span>
具体的差值<code>xDist</code>和<code>yDist</code>算出来以后，要根据方向选择是在玩家坐标的基础上加还是减，但是因为<code>rayDirX</code>和<code>rayDirY</code>本来就有正负号，因此刚好直接用，体现在代码里就是这段代码：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">double</span> wallX; <span class="comment">//where exactly the wall was hit</span></span><br><span class="line"><span class="keyword">if</span> (side == <span class="number">0</span>) wallX = posY + perpWallDist * rayDirY;</span><br><span class="line"><span class="keyword">else</span>           wallX = posX + perpWallDist * rayDirX;</span><br><span class="line">wallX -= <span class="built_in">floor</span>(wallX);	<span class="comment">//减去向下取整，即只保留小数部分</span></span><br></pre></td></tr></table></figure>
<p>这里用的<code>floor</code>函数，用于将一个数<strong>向下取整</strong>，即<code>floor()</code>函数会返回不大于输入参数的最大整数</p>
<blockquote>
<p>在C++中，将一个浮点数转换为整数（即<code>(int)wallX</code>）时，会直接舍去小数部分。例如，<code>(int)3.14</code>的结果是<code>3</code>，<code>(int)-3.14</code>的结果是<code>-3</code>。</p>
<p>而<code>floor()</code>函数则会返回不大于输入参数的最大整数。例如，<code>floor(3.14)</code>的结果是<code>3</code>，<code>floor(-3.14)</code>的结果是<code>-4</code>。</p>
<p>所以，如果<code>wallX</code>是正数，那么<code>wallX -= floor(wallX);</code>和<code>wallX -= (int)wallX;</code>的结果是一样的。但是，如果<code>wallX</code>是负数，那么这两种操作的结果就会不同。</p>
</blockquote>
<p><code>wallX -= floor((wallX))</code>会只保留小数部分，取值范围就在<span class="math inline">\([0,1)\)</span></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//x coordinate on the texture</span></span><br><span class="line"><span class="type">int</span> texX = <span class="built_in">int</span>(wallX * <span class="built_in">double</span>(texWidth));</span><br></pre></td></tr></table></figure>
<p><code>texX</code>是纹理的x坐标，根据<code>wallX</code>计算出来的，是光线撞到墙，墙的位置对应到纹理上的x坐标，即用<code>wallX</code>算出来的小数乘以<code>texWidth</code>，可以得到纹理上确切的<code>x</code>坐标</p>
<h3 id="镜像处理">镜像处理</h3>
<p>默认<code>texX</code>是纹理图像<strong>从左向右</strong>的<code>x</code>坐标</p>
<p>但是有两种情况计算出来的结果是从右向左的，会导致镜像翻转</p>
<img src="/2023/11/09/%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/Raycasting%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/image-20240527104146831.png" class title="image-20240527104146831">
<p>如果不进行镜像处理，就会出现这样的情况：</p>
<p>这两个面看过去，鹰的头向左偏</p>
<img src="/2023/11/09/%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/Raycasting%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/image-20240527103340657.png" class title="image-20240527103340657">
<p>从这两个面看过去，鹰的头向右偏</p>
<img src="/2023/11/09/%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/Raycasting%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/image-20240527103444561.png" class title="image-20240527103444561">
<p>而原图的鹰头就是偏向右的</p>
<img src="/2023/11/09/%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/Raycasting%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/eagle.png" class title="eagle">
<p>因此需要进行镜像处理</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 防止镜像</span></span><br><span class="line"><span class="keyword">if</span> (side == <span class="number">0</span> &amp;&amp; rayDirX &gt; <span class="number">0</span>) texX = texWidth - texX - <span class="number">1</span>;</span><br><span class="line"><span class="keyword">if</span> (side == <span class="number">1</span> &amp;&amp; rayDirY &lt; <span class="number">0</span>) texX = texWidth - texX - <span class="number">1</span>;</span><br></pre></td></tr></table></figure>
<h3 id="纹理的sprite">纹理的Sprite</h3>
<p>这部分的具体思路就与<a target="_blank" rel="noopener" href="https://lodev.org/cgtutor/raycasting.html">原教程</a>不一样了</p>
<p>我的思路还是与画线一样，即画出纹理对应的一条线，宽为1像素，长为对应线的长度，只是颜色是直接拿纹理的颜色</p>
<p>具体实现，就是创建长为<code>texHeight</code>，宽为1像素的Sprite，对其设置对应纹理</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//为了获取纹理具体某一个坐标的像素颜色</span></span><br><span class="line"><span class="comment">//创建一个新的sprite对象</span></span><br><span class="line">sf::Sprite wall_sprite;</span><br><span class="line"></span><br><span class="line"><span class="comment">//设置sprite的纹理</span></span><br><span class="line">wall_sprite.<span class="built_in">setTexture</span>(texture[texNum]);</span><br><span class="line"></span><br><span class="line"><span class="comment">//设置sprite的纹理矩形，定义了在纹理中的哪个部分应用到wall_sprite上</span></span><br><span class="line"><span class="comment">//宽度为1个像素，相当于原来的画线</span></span><br><span class="line">wall_sprite.<span class="built_in">setTextureRect</span>(sf::<span class="built_in">IntRect</span>(texX, <span class="number">0</span>, <span class="number">1</span>, texHeight));</span><br></pre></td></tr></table></figure>
<p><br></p>
<p>再指定左上角位置为<code>(x, round(0.5f * screenHeight - 0.5f * lineHeight)</code></p>
<p>至于Y起点指定的位置，为什么不是刚刚画线时的<code>drawStart</code>，我<a href="#Problem_Texture">在后面</a>会详细解释这个问题，还是挺有意思的一个小bug</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//设置sprite的位置，坐标指定了左上角的位置</span></span><br><span class="line">wall_sprite.<span class="built_in">setPosition</span>(x, <span class="built_in">round</span>(<span class="number">0.5f</span> * screenHeight - <span class="number">0.5f</span> * lineHeight));</span><br></pre></td></tr></table></figure>
<p><br></p>
<p>长度值是<code>texHeight</code>，而我们应该画线的长度是<code>lineHeight</code>，所以对这个Sprite进行缩放</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//设置sprite的缩放因子</span></span><br><span class="line">wall_sprite.<span class="built_in">setScale</span>(<span class="number">1</span>, lineHeight / (<span class="type">float</span>)texHeight);</span><br></pre></td></tr></table></figure>
<p><br></p>
<p>最后还是和之前一样的思路，Y墙上的颜色要变暗，就进行处理</p>
<p>SFML纹理颜色的处理需要用“调制混合”的概念</p>
<p>举个例子：原来的R通道为200，与128混合为：200 * 128 / 255 =
100，实现了颜色除以2的效果</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//利用SFML中sprite的setColor功能，使y墙变暗</span></span><br><span class="line"><span class="comment">//这个函数实现的是“调制混合”</span></span><br><span class="line"><span class="comment">//举个例子：原来的R通道为200，与128混合为：200 * 128 / 255 = 100，实现了颜色除以2的效果</span></span><br><span class="line"><span class="keyword">if</span> (side == <span class="number">1</span>)</span><br><span class="line">&#123;</span><br><span class="line">    wall_sprite.<span class="built_in">setColor</span>(<span class="built_in">Color</span>(<span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="绘制纹理sprite">绘制纹理Sprite</h3>
<p>这个就简单了，因为纹理Sprite我们已经设置位置和大小，直接画出来就行了</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 绘制sprite</span></span><br><span class="line">window.<span class="built_in">draw</span>(wall_sprite);</span><br></pre></td></tr></table></figure>
<h3 id="最后的效果-1">最后的效果</h3>
<img src="/2023/11/09/%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/Raycasting%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/image-20240106195943633.png" class title="image-20240106195943633">
<h3 id="源代码-1">源代码</h3>
<p><a id="Code_Raycasting_Texture"></a></p>
<p>带纹理Raycasting的实现，源代码如下</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;SFML/Graphics.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cmath&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> sf;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> screenWidth 1440</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> screenHeight 900</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> mapWidth 24</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> mapHeight 24</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> texWidth 64</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> texHeight 64</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> worldMap[mapWidth][mapHeight] =</span><br><span class="line">&#123;</span><br><span class="line">  &#123;<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">7</span>,<span class="number">7</span>,<span class="number">7</span>,<span class="number">7</span>,<span class="number">7</span>,<span class="number">7</span>,<span class="number">7</span>,<span class="number">7</span>&#125;,</span><br><span class="line">  &#123;<span class="number">4</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">7</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">7</span>&#125;,</span><br><span class="line">  &#123;<span class="number">4</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">7</span>&#125;,</span><br><span class="line">  &#123;<span class="number">4</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">7</span>&#125;,</span><br><span class="line">  &#123;<span class="number">4</span>,<span class="number">0</span>,<span class="number">3</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">7</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">7</span>&#125;,</span><br><span class="line">  &#123;<span class="number">4</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">5</span>,<span class="number">5</span>,<span class="number">5</span>,<span class="number">5</span>,<span class="number">5</span>,<span class="number">5</span>,<span class="number">5</span>,<span class="number">5</span>,<span class="number">7</span>,<span class="number">7</span>,<span class="number">0</span>,<span class="number">7</span>,<span class="number">7</span>,<span class="number">7</span>,<span class="number">7</span>,<span class="number">7</span>&#125;,</span><br><span class="line">  &#123;<span class="number">4</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">7</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">7</span>,<span class="number">7</span>,<span class="number">7</span>,<span class="number">1</span>&#125;,</span><br><span class="line">  &#123;<span class="number">4</span>,<span class="number">0</span>,<span class="number">6</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">7</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">8</span>&#125;,</span><br><span class="line">  &#123;<span class="number">4</span>,<span class="number">0</span>,<span class="number">7</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">7</span>,<span class="number">7</span>,<span class="number">7</span>,<span class="number">1</span>&#125;,</span><br><span class="line">  &#123;<span class="number">4</span>,<span class="number">0</span>,<span class="number">8</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">7</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">8</span>&#125;,</span><br><span class="line">  &#123;<span class="number">4</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">7</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">7</span>,<span class="number">7</span>,<span class="number">7</span>,<span class="number">1</span>&#125;,</span><br><span class="line">  &#123;<span class="number">4</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">5</span>,<span class="number">5</span>,<span class="number">5</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">5</span>,<span class="number">5</span>,<span class="number">5</span>,<span class="number">7</span>,<span class="number">7</span>,<span class="number">7</span>,<span class="number">7</span>,<span class="number">7</span>,<span class="number">7</span>,<span class="number">7</span>,<span class="number">1</span>&#125;,</span><br><span class="line">  &#123;<span class="number">6</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">0</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">6</span>&#125;,</span><br><span class="line">  &#123;<span class="number">8</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">4</span>&#125;,</span><br><span class="line">  &#123;<span class="number">6</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">0</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">0</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">6</span>&#125;,</span><br><span class="line">  &#123;<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">6</span>,<span class="number">0</span>,<span class="number">6</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">3</span>,<span class="number">3</span>,<span class="number">3</span>&#125;,</span><br><span class="line">  &#123;<span class="number">4</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">6</span>,<span class="number">0</span>,<span class="number">6</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">2</span>&#125;,</span><br><span class="line">  &#123;<span class="number">4</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">6</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">2</span>&#125;,</span><br><span class="line">  &#123;<span class="number">4</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">6</span>,<span class="number">0</span>,<span class="number">6</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">2</span>&#125;,</span><br><span class="line">  &#123;<span class="number">4</span>,<span class="number">0</span>,<span class="number">6</span>,<span class="number">0</span>,<span class="number">6</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">6</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">2</span>&#125;,</span><br><span class="line">  &#123;<span class="number">4</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">6</span>,<span class="number">0</span>,<span class="number">6</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">2</span>&#125;,</span><br><span class="line">  &#123;<span class="number">4</span>,<span class="number">0</span>,<span class="number">6</span>,<span class="number">0</span>,<span class="number">6</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">6</span>,<span class="number">0</span>,<span class="number">6</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">2</span>&#125;,</span><br><span class="line">  &#123;<span class="number">4</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">6</span>,<span class="number">0</span>,<span class="number">6</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">2</span>&#125;,</span><br><span class="line">  &#123;<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">3</span>,<span class="number">3</span>,<span class="number">3</span>,<span class="number">3</span>&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">double</span> posX = <span class="number">22</span>, posY = <span class="number">11.5</span>;  <span class="comment">//x and y start position</span></span><br><span class="line"><span class="type">double</span> dirX = <span class="number">-1</span>, dirY = <span class="number">0</span>; <span class="comment">//initial direction vector</span></span><br><span class="line"><span class="type">double</span> planeX = <span class="number">0</span>, planeY = <span class="number">0.66</span>; <span class="comment">//the 2d raycaster version of camera plane</span></span><br><span class="line"></span><br><span class="line"><span class="type">double</span> Mytime = <span class="number">0</span>; <span class="comment">//time of current frame</span></span><br><span class="line"><span class="type">double</span> oldTime = <span class="number">0</span>; <span class="comment">//time of previous frame</span></span><br><span class="line"></span><br><span class="line">Texture texture[<span class="number">8</span>];</span><br><span class="line">Clock Myclock;          <span class="comment">//用于计时</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//获取时间</span></span><br><span class="line"><span class="function"><span class="type">unsigned</span> <span class="type">long</span> <span class="title">getTicks</span><span class="params">()</span></span>;</span><br><span class="line"><span class="comment">//读取纹理</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">LoadTexture</span><span class="params">()</span></span>;</span><br><span class="line"><span class="comment">//DDA算法，用于计算墙的高度和画线</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DDA_algorithm</span><span class="params">(RenderWindow&amp; window)</span></span>;</span><br><span class="line"><span class="comment">//移动函数，用于改变位置和朝向</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Move</span><span class="params">(RenderWindow&amp; window)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">RenderWindow <span class="title">window</span><span class="params">(sf::VideoMode(screenWidth, screenHeight), <span class="string">&quot;Raycasting-texture&quot;</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">LoadTexture</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (window.<span class="built_in">isOpen</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        sf::Event event;</span><br><span class="line">        <span class="keyword">while</span> (window.<span class="built_in">pollEvent</span>(event))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (event.type == sf::Event::Closed)</span><br><span class="line">                window.<span class="built_in">close</span>();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        window.<span class="built_in">clear</span>();</span><br><span class="line">        <span class="built_in">DDA_algorithm</span>(window);</span><br><span class="line">        <span class="built_in">Move</span>(window);</span><br><span class="line">        window.<span class="built_in">display</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">unsigned</span> <span class="type">long</span> <span class="title">getTicks</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    sf::Time elapsed = Myclock.<span class="built_in">getElapsedTime</span>();</span><br><span class="line">    <span class="keyword">return</span> elapsed.<span class="built_in">asMilliseconds</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">LoadTexture</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    texture[<span class="number">0</span>].<span class="built_in">loadFromFile</span>(<span class="string">&quot;pics/eagle.png&quot;</span>);</span><br><span class="line">    texture[<span class="number">1</span>].<span class="built_in">loadFromFile</span>(<span class="string">&quot;pics/redbrick.png&quot;</span>);</span><br><span class="line">    texture[<span class="number">2</span>].<span class="built_in">loadFromFile</span>(<span class="string">&quot;pics/purplestone.png&quot;</span>);</span><br><span class="line">    texture[<span class="number">3</span>].<span class="built_in">loadFromFile</span>(<span class="string">&quot;pics/greystone.png&quot;</span>);</span><br><span class="line">    texture[<span class="number">4</span>].<span class="built_in">loadFromFile</span>(<span class="string">&quot;pics/bluestone.png&quot;</span>);</span><br><span class="line">    texture[<span class="number">5</span>].<span class="built_in">loadFromFile</span>(<span class="string">&quot;pics/mossy.png&quot;</span>);</span><br><span class="line">    texture[<span class="number">6</span>].<span class="built_in">loadFromFile</span>(<span class="string">&quot;pics/wood.png&quot;</span>);</span><br><span class="line">    texture[<span class="number">7</span>].<span class="built_in">loadFromFile</span>(<span class="string">&quot;pics/colorstone.png&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DDA_algorithm</span><span class="params">(RenderWindow&amp; window)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> x = <span class="number">0</span>; x &lt; screenWidth; x++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//calculate ray position and direction</span></span><br><span class="line">        <span class="type">double</span> cameraX = <span class="number">2</span> * x / (<span class="type">double</span>)screenWidth - <span class="number">1</span>; <span class="comment">//x-coordinate in camera space</span></span><br><span class="line">        <span class="type">double</span> rayDirX = dirX + planeX * cameraX;</span><br><span class="line">        <span class="type">double</span> rayDirY = dirY + planeY * cameraX;</span><br><span class="line">        <span class="comment">//which box of the map we&#x27;re in</span></span><br><span class="line">        <span class="type">int</span> mapX = <span class="built_in">int</span>(posX);</span><br><span class="line">        <span class="type">int</span> mapY = <span class="built_in">int</span>(posY);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//length of ray from current position to next x or y-side</span></span><br><span class="line">        <span class="type">double</span> sideDistX;</span><br><span class="line">        <span class="type">double</span> sideDistY;</span><br><span class="line"></span><br><span class="line">        <span class="type">double</span> deltaDistX = (rayDirX == <span class="number">0</span>) ? <span class="number">1e30</span> : std::<span class="built_in">abs</span>(<span class="number">1</span> / rayDirX);</span><br><span class="line">        <span class="type">double</span> deltaDistY = (rayDirY == <span class="number">0</span>) ? <span class="number">1e30</span> : std::<span class="built_in">abs</span>(<span class="number">1</span> / rayDirY);</span><br><span class="line"></span><br><span class="line">        <span class="type">double</span> perpWallDist;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//what direction to step in x or y-direction (either +1 or -1)</span></span><br><span class="line">        <span class="type">int</span> stepX;</span><br><span class="line">        <span class="type">int</span> stepY;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> hit = <span class="number">0</span>; <span class="comment">//was there a wall hit?</span></span><br><span class="line">        <span class="type">int</span> side; <span class="comment">//was a NS or a EW wall hit?</span></span><br><span class="line">        <span class="comment">//calculate step and initial sideDist</span></span><br><span class="line">        <span class="keyword">if</span> (rayDirX &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            stepX = <span class="number">-1</span>;</span><br><span class="line">            sideDistX = (posX - mapX) * deltaDistX;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            stepX = <span class="number">1</span>;</span><br><span class="line">            sideDistX = (mapX + <span class="number">1.0</span> - posX) * deltaDistX;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (rayDirY &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            stepY = <span class="number">-1</span>;</span><br><span class="line">            sideDistY = (posY - mapY) * deltaDistY;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            stepY = <span class="number">1</span>;</span><br><span class="line">            sideDistY = (mapY + <span class="number">1.0</span> - posY) * deltaDistY;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//perform DDA</span></span><br><span class="line">        <span class="keyword">while</span> (hit == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//jump to next map square, either in x-direction, or in y-direction</span></span><br><span class="line">            <span class="keyword">if</span> (sideDistX &lt; sideDistY)</span><br><span class="line">            &#123;</span><br><span class="line">                sideDistX += deltaDistX;</span><br><span class="line">                mapX += stepX;</span><br><span class="line">                side = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                sideDistY += deltaDistY;</span><br><span class="line">                mapY += stepY;</span><br><span class="line">                side = <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//Check if ray has hit a wall</span></span><br><span class="line">            <span class="keyword">if</span> (worldMap[mapX][mapY] &gt; <span class="number">0</span>) hit = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//教程里这部分解释的比较清楚了</span></span><br><span class="line">        <span class="comment">//也可以看我在博客里的证明过程，写的更清楚</span></span><br><span class="line">        <span class="keyword">if</span> (side == <span class="number">0</span>) perpWallDist = (sideDistX - deltaDistX);</span><br><span class="line">        <span class="keyword">else</span>          perpWallDist = (sideDistY - deltaDistY);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Calculate height of line to draw on screen</span></span><br><span class="line">        <span class="comment">//可以任意修改墙的高度</span></span><br><span class="line">        <span class="type">int</span> lineHeight = (<span class="type">int</span>)(screenHeight / perpWallDist);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//calculate lowest and highest pixel to fill in current stripe</span></span><br><span class="line">        <span class="type">int</span> drawStart = -lineHeight / <span class="number">2</span> + screenHeight / <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">if</span> (drawStart &lt; <span class="number">0</span>) drawStart = <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> drawEnd = lineHeight / <span class="number">2</span> + screenHeight / <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">if</span> (drawEnd &gt;= screenHeight) drawEnd = screenHeight - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">/*********************************************************************************/</span></span><br><span class="line">        <span class="comment">/*  此部分替换了原raycasting画线部分</span></span><br><span class="line"><span class="comment">        /*  以下为纹理相关计算，是新内容</span></span><br><span class="line"><span class="comment">        /*  具体和原来的画线函数差不多，都是在具体位置上画出一条线</span></span><br><span class="line"><span class="comment">        /*  只不过这里画的是具体纹理上的一条线，利用了SFML中的sprite</span></span><br><span class="line"><span class="comment">        /*********************************************************************************/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//texturing calculations</span></span><br><span class="line">        <span class="type">int</span> texNum = worldMap[mapX][mapY] - <span class="number">1</span>; <span class="comment">//1 subtracted from it so that texture 0 can be used!</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//calculate value of wallX</span></span><br><span class="line">        <span class="type">double</span> wallX; <span class="comment">//where exactly the wall was hit</span></span><br><span class="line">        <span class="keyword">if</span> (side == <span class="number">0</span>) wallX = posY + perpWallDist * rayDirY;</span><br><span class="line">        <span class="keyword">else</span>           wallX = posX + perpWallDist * rayDirX;</span><br><span class="line">        wallX -= <span class="built_in">floor</span>((wallX));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//x coordinate on the texture</span></span><br><span class="line">        <span class="type">int</span> texX = <span class="built_in">int</span>(wallX * <span class="built_in">double</span>(texWidth));</span><br><span class="line">        <span class="keyword">if</span> (side == <span class="number">0</span> &amp;&amp; rayDirX &gt; <span class="number">0</span>) texX = texWidth - texX - <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> (side == <span class="number">1</span> &amp;&amp; rayDirY &lt; <span class="number">0</span>) texX = texWidth - texX - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// How much to increase the texture coordinate per screen pixel</span></span><br><span class="line">        <span class="type">double</span> step = <span class="number">1.0</span> * texHeight / lineHeight;</span><br><span class="line">        <span class="comment">// Starting texture coordinate</span></span><br><span class="line">        <span class="type">double</span> texPos = (drawStart - screenHeight / <span class="number">2</span> + lineHeight / <span class="number">2</span>) * step;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//为了获取纹理具体某一个坐标的像素颜色</span></span><br><span class="line">        <span class="comment">//创建一个新的sprite对象</span></span><br><span class="line">        sf::Sprite wall_sprite;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//设置sprite的纹理</span></span><br><span class="line">        wall_sprite.<span class="built_in">setTexture</span>(texture[texNum]);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//设置sprite的纹理矩形，定义了在纹理中的哪个部分应用到wall_sprite上</span></span><br><span class="line">        <span class="comment">//宽度为1个像素，相当于原来的画线</span></span><br><span class="line">        wall_sprite.<span class="built_in">setTextureRect</span>(sf::<span class="built_in">IntRect</span>(texX, <span class="number">0</span>, <span class="number">1</span>, texHeight));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//设置sprite的位置，坐标指定了左上角的位置</span></span><br><span class="line">        <span class="comment">//wall_sprite.setPosition(x, drawStart);        //太几把恶心了，破案了：指定左上角的位置为drawStart</span></span><br><span class="line">        <span class="comment">//                                              //drawStart在特殊情况下会被赋值为0，即if (drawStart &lt; 0) drawStart = 0;</span></span><br><span class="line">        <span class="comment">//                                              //在此情况下绘制的起点就会改变为0，令人恶心</span></span><br><span class="line">        wall_sprite.<span class="built_in">setPosition</span>(x, <span class="built_in">round</span>(<span class="number">0.5f</span> * screenHeight - <span class="number">0.5f</span> * lineHeight));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//设置sprite的缩放因子</span></span><br><span class="line">        wall_sprite.<span class="built_in">setScale</span>(<span class="number">1</span>, lineHeight / (<span class="type">float</span>)texHeight);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//利用SFML中sprite的setColor功能，使y墙变暗</span></span><br><span class="line">        <span class="comment">//这个函数实现的是“调制混合”</span></span><br><span class="line">        <span class="comment">//举个例子：原来的R通道为200，与128混合为：200 * 128 / 255 = 100，实现了颜色除以2的效果</span></span><br><span class="line">        <span class="keyword">if</span> (side == <span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            wall_sprite.<span class="built_in">setColor</span>(<span class="built_in">Color</span>(<span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 绘制sprite</span></span><br><span class="line">        window.<span class="built_in">draw</span>(wall_sprite);</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Move</span><span class="params">(RenderWindow&amp; window)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//timing for input and FPS counter</span></span><br><span class="line">    oldTime = Mytime;</span><br><span class="line">    Mytime = <span class="built_in">getTicks</span>();</span><br><span class="line">    <span class="type">double</span> frameTime = (Mytime - oldTime) / <span class="number">1000.0</span>; <span class="comment">//frameTime is the time this frame has taken, in seconds</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//speed modifiers</span></span><br><span class="line">    <span class="type">double</span> moveSpeed = frameTime * <span class="number">3.0</span>; <span class="comment">//the constant value is in squares/second</span></span><br><span class="line">    <span class="type">double</span> rotSpeed = frameTime * <span class="number">2.0</span>; <span class="comment">//the constant value is in radians/second</span></span><br><span class="line">    <span class="comment">//move forward if no wall in front of you</span></span><br><span class="line">    <span class="keyword">if</span> (sf::Keyboard::<span class="built_in">isKeyPressed</span>(sf::Keyboard::Up) ||</span><br><span class="line">        sf::Keyboard::<span class="built_in">isKeyPressed</span>(sf::Keyboard::W))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (worldMap[<span class="built_in">int</span>(posX + dirX * moveSpeed)][<span class="built_in">int</span>(posY)] == <span class="literal">false</span>) posX += dirX * moveSpeed;</span><br><span class="line">        <span class="keyword">if</span> (worldMap[<span class="built_in">int</span>(posX)][<span class="built_in">int</span>(posY + dirY * moveSpeed)] == <span class="literal">false</span>) posY += dirY * moveSpeed;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//move backwards if no wall behind you</span></span><br><span class="line">    <span class="keyword">if</span> (sf::Keyboard::<span class="built_in">isKeyPressed</span>(sf::Keyboard::Down) ||</span><br><span class="line">        sf::Keyboard::<span class="built_in">isKeyPressed</span>(sf::Keyboard::S))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (worldMap[<span class="built_in">int</span>(posX - dirX * moveSpeed)][<span class="built_in">int</span>(posY)] == <span class="literal">false</span>) posX -= dirX * moveSpeed;</span><br><span class="line">        <span class="keyword">if</span> (worldMap[<span class="built_in">int</span>(posX)][<span class="built_in">int</span>(posY - dirY * moveSpeed)] == <span class="literal">false</span>) posY -= dirY * moveSpeed;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//向右走，原理还是跟前后走一样，只是方向用矩阵相乘重新算了</span></span><br><span class="line">    <span class="comment">//向右走就是在(dirY, -dirX)这个方向走</span></span><br><span class="line">    <span class="keyword">if</span> (sf::Keyboard::<span class="built_in">isKeyPressed</span>(sf::Keyboard::D))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (worldMap[<span class="built_in">int</span>(posX + dirY * moveSpeed * <span class="number">0.75</span>)][<span class="built_in">int</span>(posY)] == <span class="literal">false</span>) posX += dirY * moveSpeed * <span class="number">0.75</span>;</span><br><span class="line">        <span class="keyword">if</span> (worldMap[<span class="built_in">int</span>(posX)][<span class="built_in">int</span>(posY - dirX * moveSpeed * <span class="number">0.75</span>)] == <span class="literal">false</span>) posY -= dirX * moveSpeed * <span class="number">0.75</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//向左走同理</span></span><br><span class="line">    <span class="comment">//在(-dirY, dirX)方向</span></span><br><span class="line">    <span class="keyword">if</span> (sf::Keyboard::<span class="built_in">isKeyPressed</span>(sf::Keyboard::A))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (worldMap[<span class="built_in">int</span>(posX - dirY * moveSpeed * <span class="number">0.75</span>)][<span class="built_in">int</span>(posY)] == <span class="literal">false</span>) posX -= dirY * moveSpeed * <span class="number">0.75</span>;</span><br><span class="line">        <span class="keyword">if</span> (worldMap[<span class="built_in">int</span>(posX)][<span class="built_in">int</span>(posY + dirX * moveSpeed * <span class="number">0.75</span>)] == <span class="literal">false</span>) posY += dirX * moveSpeed * <span class="number">0.75</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//rotate to the right</span></span><br><span class="line">    <span class="keyword">if</span> (sf::Keyboard::<span class="built_in">isKeyPressed</span>(sf::Keyboard::Right))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//both camera direction and camera plane must be rotated</span></span><br><span class="line">        <span class="type">double</span> oldDirX = dirX;</span><br><span class="line">        dirX = dirX * <span class="built_in">cos</span>(-rotSpeed) - dirY * <span class="built_in">sin</span>(-rotSpeed);</span><br><span class="line">        dirY = oldDirX * <span class="built_in">sin</span>(-rotSpeed) + dirY * <span class="built_in">cos</span>(-rotSpeed);</span><br><span class="line">        <span class="type">double</span> oldPlaneX = planeX;</span><br><span class="line">        planeX = planeX * <span class="built_in">cos</span>(-rotSpeed) - planeY * <span class="built_in">sin</span>(-rotSpeed);</span><br><span class="line">        planeY = oldPlaneX * <span class="built_in">sin</span>(-rotSpeed) + planeY * <span class="built_in">cos</span>(-rotSpeed);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//rotate to the left</span></span><br><span class="line">    <span class="keyword">if</span> (sf::Keyboard::<span class="built_in">isKeyPressed</span>(sf::Keyboard::Left))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//both camera direction and camera plane must be rotated</span></span><br><span class="line">        <span class="type">double</span> oldDirX = dirX;</span><br><span class="line">        dirX = dirX * <span class="built_in">cos</span>(rotSpeed) - dirY * <span class="built_in">sin</span>(rotSpeed);</span><br><span class="line">        dirY = oldDirX * <span class="built_in">sin</span>(rotSpeed) + dirY * <span class="built_in">cos</span>(rotSpeed);</span><br><span class="line">        <span class="type">double</span> oldPlaneX = planeX;</span><br><span class="line">        planeX = planeX * <span class="built_in">cos</span>(rotSpeed) - planeY * <span class="built_in">sin</span>(rotSpeed);</span><br><span class="line">        planeY = oldPlaneX * <span class="built_in">sin</span>(rotSpeed) + planeY * <span class="built_in">cos</span>(rotSpeed);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="加点东西">加点东西</h2>
<p>本来是准备结束的，但是在实际演示的前一天，在我给同学展示的时候，有个同学就提出来了：这样看不出地图会迷路，是不是加个小地图会更好？</p>
<p>我一想，太对了，当天直接完成了小地图的部分</p>
<p>我再一想，既然小地图都做了，为什么不把角色视野范围做出了？</p>
<p>太对了，当天直接熬夜完成了视野范围的部分</p>
<p>本来想给地板和天花板都上个纹理的，但是因为实际做了之后帧数特别低，甚至无法跑到60帧，就搁置了，以后有时间再进行优化，最后就是只给地板和天花板弄了个纯色</p>
<h3 id="新的main函数">新的<code>main</code>函数</h3>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">RenderWindow <span class="title">window</span><span class="params">(sf::VideoMode(screenWidth, screenHeight), <span class="string">&quot;Raycasting-texture&quot;</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">LoadTexture</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (window.<span class="built_in">isOpen</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        sf::Event event;</span><br><span class="line">        <span class="keyword">while</span> (window.<span class="built_in">pollEvent</span>(event))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (event.type == sf::Event::Closed)</span><br><span class="line">                window.<span class="built_in">close</span>();</span><br><span class="line">            <span class="comment">//检测Tab键或~键是否被按下</span></span><br><span class="line">            <span class="comment">//sf::Keyboard::isKeyPressed函数会在每一帧都检测键盘的状态</span></span><br><span class="line">            <span class="comment">//sf::Event::KeyPressed事件只会在按键被按下的那一帧触发一次，即使你按住按键不放，它也不会在下一帧再次触发</span></span><br><span class="line">            <span class="comment">//因此，使用sf::Event::KeyPressed事件可以确保DrawminimapFlag的值只会被反转一次</span></span><br><span class="line">            <span class="keyword">if</span> (event.type == sf::Event::KeyPressed)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (event.key.code == sf::Keyboard::Tab || event.key.code == sf::Keyboard::Tilde)</span><br><span class="line">                &#123;</span><br><span class="line">                    DrawminimapFlag = !DrawminimapFlag;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (event.type == sf::Event::KeyPressed)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//按加号键增大小地图</span></span><br><span class="line">                <span class="keyword">if</span> (event.key.code == sf::Keyboard::Add)</span><br><span class="line">                &#123;</span><br><span class="line">                    miniMapScale++;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//按减号键缩小小地图</span></span><br><span class="line">                <span class="keyword">if</span> (event.key.code == sf::Keyboard::Subtract)</span><br><span class="line">                &#123;</span><br><span class="line">                    miniMapScale--;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        window.<span class="built_in">clear</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">DrawFloorCeiling</span>(window);</span><br><span class="line">        <span class="built_in">DDA_algorithm</span>(window);</span><br><span class="line">        <span class="built_in">Move</span>(window);        </span><br><span class="line">        <span class="keyword">if</span> (DrawminimapFlag)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">drawMiniMap</span>(window);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        window.<span class="built_in">display</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>加了对应画天花板地板的函数<code>DrawFloorCeiling</code>和画小地图的函数<code>drawMiniMap</code></p>
<p>其中，按<code>Tab</code>键可以开关小地图，实际上加一个标志位，每次按键检测设置flag即可，很容易</p>
<h3 id="加地板天花板">加地板天花板</h3>
<p>这个还是很容易的，只需要显示两个有色矩形，一个为天花板，一个为地板</p>
<p>在DDA画线之前画上天花板和地板就行了</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">DrawFloorCeiling</span><span class="params">(RenderWindow&amp; window)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">RectangleShape <span class="title">CeilingRect</span><span class="params">(Vector2f(screenWidth, screenHeight / <span class="number">2</span>))</span></span>;</span><br><span class="line">    CeilingRect.<span class="built_in">setFillColor</span>(<span class="built_in">Color</span>(<span class="number">156</span>,<span class="number">220</span>,<span class="number">235</span>));</span><br><span class="line"></span><br><span class="line">    <span class="function">RectangleShape <span class="title">FloorRect</span><span class="params">(Vector2f(screenWidth, screenHeight / <span class="number">2</span>))</span></span>;</span><br><span class="line">    FloorRect.<span class="built_in">setPosition</span>(<span class="number">0</span>, screenHeight / <span class="number">2</span>);</span><br><span class="line">    FloorRect.<span class="built_in">setFillColor</span>(<span class="built_in">Color</span>(<span class="number">68</span>,<span class="number">68</span>,<span class="number">68</span>));</span><br><span class="line"></span><br><span class="line">    window.<span class="built_in">draw</span>(CeilingRect);</span><br><span class="line">    window.<span class="built_in">draw</span>(FloorRect);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="加小地图和视野范围">加小地图和视野范围</h3>
<p>这个还是挺有趣的</p>
<p>先在全局变量添加小地图参数和FOV视野变量</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//创建一个表示视野范围的三角扇形</span></span><br><span class="line"><span class="comment">//还是程序设计的结构问题，应该给玩家安排个类，这个当做类的成员的</span></span><br><span class="line"><span class="comment">//而且中间参数还在DDA算法中计算，实际上不应该这样的</span></span><br><span class="line"><span class="function">VertexArray <span class="title">fov</span><span class="params">(sf::TriangleFan, screenWidth + <span class="number">1</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//小地图的宽度和高度</span></span><br><span class="line"><span class="type">const</span> <span class="type">int</span> minimapWidth = <span class="number">24</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">int</span> minimapHeight = <span class="number">24</span>;</span><br><span class="line"><span class="comment">//小地图的大小（单位：像素）</span></span><br><span class="line"><span class="type">int</span> miniMapScale = <span class="number">20</span>;</span><br><span class="line"><span class="type">bool</span> DrawminimapFlag = <span class="number">0</span>;</span><br></pre></td></tr></table></figure>
<p>如果把角色相关的东西都定义在一个类里，修改就不会很头疼了</p>
<p>但是因为这些代码是在原来基础上添加的，就不想重新构建了</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//要注意：SFML中的y轴是向下的，而用二维数组计算时y轴是向上的</span></span><br><span class="line"><span class="comment">//需将游戏中的坐标系转换为小地图的坐标系，具体来说，就是将y坐标进行翻转</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">drawMiniMap</span><span class="params">(sf::RenderWindow&amp; window)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 遍历地图的每一个格子</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> x = <span class="number">0</span>; x &lt; minimapWidth; ++x) </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> y = <span class="number">0</span>; y &lt; minimapHeight; ++y) </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 创建一个表示地图格子的矩形</span></span><br><span class="line">            <span class="function">sf::RectangleShape <span class="title">rect</span><span class="params">(sf::Vector2f(miniMapScale, miniMapScale))</span></span>;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//设置位置，注意翻转</span></span><br><span class="line">            rect.<span class="built_in">setPosition</span>(x * miniMapScale, (mapHeight - y - <span class="number">1</span>) * miniMapScale);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 根据地图数据设置矩形的颜色</span></span><br><span class="line">            <span class="keyword">if</span> (worldMap[x][y] &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                rect.<span class="built_in">setFillColor</span>(sf::Color::White);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                rect.<span class="built_in">setFillColor</span>(sf::Color::Black);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 在窗口上绘制矩形</span></span><br><span class="line">            window.<span class="built_in">draw</span>(rect);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建一个表示玩家位置的圆形</span></span><br><span class="line">    <span class="type">int</span> radius = <span class="number">4</span>;</span><br><span class="line">    <span class="function">sf::CircleShape <span class="title">player</span><span class="params">(radius)</span></span>;</span><br><span class="line">    player.<span class="built_in">setFillColor</span>(sf::Color::Red);</span><br><span class="line">    player.<span class="built_in">setPosition</span>(posX * miniMapScale - player.<span class="built_in">getRadius</span>(), (mapHeight - posY) * miniMapScale - player.<span class="built_in">getRadius</span>());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 在窗口上绘制圆形</span></span><br><span class="line">    window.<span class="built_in">draw</span>(player);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置三角扇形的原点为玩家的位置</span></span><br><span class="line">    <span class="comment">//FOV具体计算的参数在DDA算法里，我觉得这个结构很垃圾，应该在全局变量加个数组，在DDA算法中访问并修改这个参数</span></span><br><span class="line">    <span class="comment">//但是好像没啥时间给我改代码了，能跑就是胜利</span></span><br><span class="line">    fov[<span class="number">0</span>].position = sf::<span class="built_in">Vector2f</span>(posX * miniMapScale, (mapHeight - posY) * miniMapScale);</span><br><span class="line">    fov[<span class="number">0</span>].color = sf::Color::Transparent;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 在窗口上绘制三角扇形</span></span><br><span class="line">    window.<span class="built_in">draw</span>(fov);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对应扇形参数的设置我添加到DDA算法中了：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">DDA_algorithm</span><span class="params">(RenderWindow&amp; window)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> x = <span class="number">0</span>; x &lt; screenWidth; x++)</span><br><span class="line">    &#123;</span><br><span class="line">		...</span><br><span class="line">		<span class="comment">//此处结束了DDA算法</span></span><br><span class="line">         <span class="comment">/*********************************************************************************/</span></span><br><span class="line">        <span class="comment">/*  此部分为添加FOV用</span></span><br><span class="line"><span class="comment">        /*  计算射线的终点</span></span><br><span class="line"><span class="comment">        /*********************************************************************************/</span></span><br><span class="line">        <span class="type">double</span> rayEndX = posX + perpWallDist * rayDirX;</span><br><span class="line">        <span class="type">double</span> rayEndY = posY + perpWallDist * rayDirY;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置三角扇形的顶点</span></span><br><span class="line">        fov[x + <span class="number">1</span>].position = sf::<span class="built_in">Vector2f</span>(rayEndX * miniMapScale, (mapHeight - rayEndY) * miniMapScale);</span><br><span class="line">        fov[x + <span class="number">1</span>].color = sf::<span class="built_in">Color</span>(<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">150</span>);</span><br><span class="line">         ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><br></p>
<p>其他内容都没修改</p>
<h3 id="最后的效果-2">最后的效果</h3>
<img src="/2023/11/09/%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/Raycasting%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/image-20240106200513771.png" class title="image-20240106200513771">
<h3 id="源代码-2">源代码</h3>
<p><a id="Code_Raycasting_Texture_FloorCeiling_MapFOV"></a></p>
<p>带纹理，画天花板地板，画小地图FOV视野Raycasting的实现，源代码如下</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;SFML/Graphics.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cmath&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> sf;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> screenWidth 1440</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> screenHeight 900</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> mapWidth 24</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> mapHeight 24</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> texWidth 64</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> texHeight 64</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> worldMap[mapWidth][mapHeight] =</span><br><span class="line">&#123;</span><br><span class="line">  &#123;<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">7</span>,<span class="number">7</span>,<span class="number">7</span>,<span class="number">7</span>,<span class="number">7</span>,<span class="number">7</span>,<span class="number">7</span>,<span class="number">7</span>&#125;,</span><br><span class="line">  &#123;<span class="number">4</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">7</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">7</span>&#125;,</span><br><span class="line">  &#123;<span class="number">4</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">7</span>&#125;,</span><br><span class="line">  &#123;<span class="number">4</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">7</span>&#125;,</span><br><span class="line">  &#123;<span class="number">4</span>,<span class="number">0</span>,<span class="number">3</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">7</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">7</span>&#125;,</span><br><span class="line">  &#123;<span class="number">4</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">5</span>,<span class="number">5</span>,<span class="number">5</span>,<span class="number">5</span>,<span class="number">5</span>,<span class="number">5</span>,<span class="number">5</span>,<span class="number">5</span>,<span class="number">7</span>,<span class="number">7</span>,<span class="number">0</span>,<span class="number">7</span>,<span class="number">7</span>,<span class="number">7</span>,<span class="number">7</span>,<span class="number">7</span>&#125;,</span><br><span class="line">  &#123;<span class="number">4</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">7</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">7</span>,<span class="number">7</span>,<span class="number">7</span>,<span class="number">1</span>&#125;,</span><br><span class="line">  &#123;<span class="number">4</span>,<span class="number">0</span>,<span class="number">6</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">7</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">8</span>&#125;,</span><br><span class="line">  &#123;<span class="number">4</span>,<span class="number">0</span>,<span class="number">7</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">7</span>,<span class="number">7</span>,<span class="number">7</span>,<span class="number">1</span>&#125;,</span><br><span class="line">  &#123;<span class="number">4</span>,<span class="number">0</span>,<span class="number">8</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">7</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">8</span>&#125;,</span><br><span class="line">  &#123;<span class="number">4</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">7</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">7</span>,<span class="number">7</span>,<span class="number">7</span>,<span class="number">1</span>&#125;,</span><br><span class="line">  &#123;<span class="number">4</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">5</span>,<span class="number">5</span>,<span class="number">5</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">5</span>,<span class="number">5</span>,<span class="number">5</span>,<span class="number">7</span>,<span class="number">7</span>,<span class="number">7</span>,<span class="number">7</span>,<span class="number">7</span>,<span class="number">7</span>,<span class="number">7</span>,<span class="number">1</span>&#125;,</span><br><span class="line">  &#123;<span class="number">6</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">0</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">6</span>&#125;,</span><br><span class="line">  &#123;<span class="number">8</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">4</span>&#125;,</span><br><span class="line">  &#123;<span class="number">6</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">0</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">0</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">6</span>&#125;,</span><br><span class="line">  &#123;<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">6</span>,<span class="number">0</span>,<span class="number">6</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">3</span>,<span class="number">3</span>,<span class="number">3</span>&#125;,</span><br><span class="line">  &#123;<span class="number">4</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">6</span>,<span class="number">0</span>,<span class="number">6</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">2</span>&#125;,</span><br><span class="line">  &#123;<span class="number">4</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">6</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">2</span>&#125;,</span><br><span class="line">  &#123;<span class="number">4</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">6</span>,<span class="number">0</span>,<span class="number">6</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">2</span>&#125;,</span><br><span class="line">  &#123;<span class="number">4</span>,<span class="number">0</span>,<span class="number">6</span>,<span class="number">0</span>,<span class="number">6</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">6</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">2</span>&#125;,</span><br><span class="line">  &#123;<span class="number">4</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">0</span>,<span class="number">3</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">2</span>&#125;,</span><br><span class="line">  &#123;<span class="number">4</span>,<span class="number">0</span>,<span class="number">6</span>,<span class="number">0</span>,<span class="number">6</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">7</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">2</span>&#125;,</span><br><span class="line">  &#123;<span class="number">4</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">0</span>,<span class="number">6</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">2</span>&#125;,</span><br><span class="line">  &#123;<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">3</span>,<span class="number">3</span>,<span class="number">3</span>,<span class="number">3</span>&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//程序必要的参数</span></span><br><span class="line"><span class="type">double</span> posX = <span class="number">22</span>, posY = <span class="number">11.5</span>;  <span class="comment">//x and y start position</span></span><br><span class="line"><span class="type">double</span> dirX = <span class="number">-1</span>, dirY = <span class="number">0</span>; <span class="comment">//initial direction vector</span></span><br><span class="line"><span class="type">double</span> planeX = <span class="number">0</span>, planeY = <span class="number">0.66</span>; <span class="comment">//the 2d raycaster version of camera plane</span></span><br><span class="line"></span><br><span class="line"><span class="type">double</span> Mytime = <span class="number">0</span>; <span class="comment">//time of current frame</span></span><br><span class="line"><span class="type">double</span> oldTime = <span class="number">0</span>; <span class="comment">//time of previous frame</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//创建一个表示视野范围的三角扇形</span></span><br><span class="line"><span class="comment">//还是程序设计的结构问题，应该给玩家安排个类，这个当做类的成员的</span></span><br><span class="line"><span class="comment">//而且中间参数还在DDA算法中计算，实际上不应该这样的</span></span><br><span class="line"><span class="function">VertexArray <span class="title">fov</span><span class="params">(sf::TriangleFan, screenWidth + <span class="number">1</span>)</span></span>;</span><br><span class="line"><span class="comment">//墙面纹理数组</span></span><br><span class="line">Texture texture[<span class="number">8</span>];</span><br><span class="line"><span class="comment">//用于计时</span></span><br><span class="line">Clock Myclock;</span><br><span class="line"></span><br><span class="line"><span class="comment">//小地图的宽度和高度</span></span><br><span class="line"><span class="type">const</span> <span class="type">int</span> minimapWidth = <span class="number">24</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">int</span> minimapHeight = <span class="number">24</span>;</span><br><span class="line"><span class="comment">//小地图的大小（单位：像素）</span></span><br><span class="line"><span class="type">int</span> miniMapScale = <span class="number">20</span>;</span><br><span class="line"><span class="type">bool</span> DrawminimapFlag = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//获取时间</span></span><br><span class="line"><span class="function"><span class="type">unsigned</span> <span class="type">long</span> <span class="title">getTicks</span><span class="params">()</span></span>;</span><br><span class="line"><span class="comment">//读取纹理</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">LoadTexture</span><span class="params">()</span></span>;</span><br><span class="line"><span class="comment">//画天花板和地板</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DrawFloorCeiling</span><span class="params">(RenderWindow&amp; window)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">RectangleShape <span class="title">CeilingRect</span><span class="params">(Vector2f(screenWidth, screenHeight / <span class="number">2</span>))</span></span>;</span><br><span class="line">    CeilingRect.<span class="built_in">setFillColor</span>(<span class="built_in">Color</span>(<span class="number">156</span>,<span class="number">220</span>,<span class="number">235</span>));</span><br><span class="line"></span><br><span class="line">    <span class="function">RectangleShape <span class="title">FloorRect</span><span class="params">(Vector2f(screenWidth, screenHeight / <span class="number">2</span>))</span></span>;</span><br><span class="line">    FloorRect.<span class="built_in">setPosition</span>(<span class="number">0</span>, screenHeight / <span class="number">2</span>);</span><br><span class="line">    FloorRect.<span class="built_in">setFillColor</span>(<span class="built_in">Color</span>(<span class="number">68</span>,<span class="number">68</span>,<span class="number">68</span>));</span><br><span class="line"></span><br><span class="line">    window.<span class="built_in">draw</span>(CeilingRect);</span><br><span class="line">    window.<span class="built_in">draw</span>(FloorRect);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//整的新活：用SFML的VertexArray来可视化FOV</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">drawMiniMap</span><span class="params">(sf::RenderWindow&amp; window)</span></span>;</span><br><span class="line"><span class="comment">//DDA算法，用于计算墙的高度和画线</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DDA_algorithm</span><span class="params">(RenderWindow&amp; window)</span></span>;</span><br><span class="line"><span class="comment">//移动函数，用于改变位置和朝向</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Move</span><span class="params">(RenderWindow&amp; window)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">RenderWindow <span class="title">window</span><span class="params">(sf::VideoMode(screenWidth, screenHeight), <span class="string">&quot;Raycasting-texture&quot;</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">LoadTexture</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (window.<span class="built_in">isOpen</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        sf::Event event;</span><br><span class="line">        <span class="keyword">while</span> (window.<span class="built_in">pollEvent</span>(event))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (event.type == sf::Event::Closed)</span><br><span class="line">                window.<span class="built_in">close</span>();</span><br><span class="line">            <span class="comment">//检测Tab键或~键是否被按下</span></span><br><span class="line">            <span class="comment">//sf::Keyboard::isKeyPressed函数会在每一帧都检测键盘的状态</span></span><br><span class="line">            <span class="comment">//sf::Event::KeyPressed事件只会在按键被按下的那一帧触发一次，即使你按住按键不放，它也不会在下一帧再次触发</span></span><br><span class="line">            <span class="comment">//因此，使用sf::Event::KeyPressed事件可以确保DrawminimapFlag的值只会被反转一次</span></span><br><span class="line">            <span class="keyword">if</span> (event.type == sf::Event::KeyPressed)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (event.key.code == sf::Keyboard::Tab || event.key.code == sf::Keyboard::Tilde)</span><br><span class="line">                &#123;</span><br><span class="line">                    DrawminimapFlag = !DrawminimapFlag;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (event.type == sf::Event::KeyPressed)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//按加号键增大小地图</span></span><br><span class="line">                <span class="keyword">if</span> (event.key.code == sf::Keyboard::Add)</span><br><span class="line">                &#123;</span><br><span class="line">                    miniMapScale++;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//按减号键缩小小地图</span></span><br><span class="line">                <span class="keyword">if</span> (event.key.code == sf::Keyboard::Subtract)</span><br><span class="line">                &#123;</span><br><span class="line">                    miniMapScale--;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        window.<span class="built_in">clear</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">DrawFloorCeiling</span>(window);</span><br><span class="line">        <span class="built_in">DDA_algorithm</span>(window);</span><br><span class="line">        <span class="built_in">Move</span>(window);        </span><br><span class="line">        <span class="keyword">if</span> (DrawminimapFlag)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">drawMiniMap</span>(window);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        window.<span class="built_in">display</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">unsigned</span> <span class="type">long</span> <span class="title">getTicks</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    sf::Time elapsed = Myclock.<span class="built_in">getElapsedTime</span>();</span><br><span class="line">    <span class="keyword">return</span> elapsed.<span class="built_in">asMilliseconds</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">LoadTexture</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    texture[<span class="number">0</span>].<span class="built_in">loadFromFile</span>(<span class="string">&quot;pics/eagle.png&quot;</span>);</span><br><span class="line">    texture[<span class="number">1</span>].<span class="built_in">loadFromFile</span>(<span class="string">&quot;pics/redbrick.png&quot;</span>);</span><br><span class="line">    texture[<span class="number">2</span>].<span class="built_in">loadFromFile</span>(<span class="string">&quot;pics/purplestone.png&quot;</span>);</span><br><span class="line">    texture[<span class="number">3</span>].<span class="built_in">loadFromFile</span>(<span class="string">&quot;pics/greystone.png&quot;</span>);</span><br><span class="line">    texture[<span class="number">4</span>].<span class="built_in">loadFromFile</span>(<span class="string">&quot;pics/bluestone.png&quot;</span>);</span><br><span class="line">    texture[<span class="number">5</span>].<span class="built_in">loadFromFile</span>(<span class="string">&quot;pics/mossy.png&quot;</span>);</span><br><span class="line">    texture[<span class="number">6</span>].<span class="built_in">loadFromFile</span>(<span class="string">&quot;pics/wood.png&quot;</span>);</span><br><span class="line">    texture[<span class="number">7</span>].<span class="built_in">loadFromFile</span>(<span class="string">&quot;pics/colorstone.png&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//要注意：SFML中的y轴是向下的，而用二维数组计算时y轴是向上的</span></span><br><span class="line"><span class="comment">//需将游戏中的坐标系转换为小地图的坐标系，具体来说，就是将y坐标进行翻转</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">drawMiniMap</span><span class="params">(sf::RenderWindow&amp; window)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 遍历地图的每一个格子</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> x = <span class="number">0</span>; x &lt; minimapWidth; ++x) </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> y = <span class="number">0</span>; y &lt; minimapHeight; ++y) </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 创建一个表示地图格子的矩形</span></span><br><span class="line">            <span class="function">sf::RectangleShape <span class="title">rect</span><span class="params">(sf::Vector2f(miniMapScale, miniMapScale))</span></span>;</span><br><span class="line">            <span class="comment">//rect.setPosition(x * miniMapScale, y * miniMapScale);</span></span><br><span class="line">            rect.<span class="built_in">setPosition</span>(x * miniMapScale, (mapHeight - y - <span class="number">1</span>) * miniMapScale);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 根据地图数据设置矩形的颜色</span></span><br><span class="line">            <span class="keyword">if</span> (worldMap[x][y] &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                rect.<span class="built_in">setFillColor</span>(sf::Color::White);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                rect.<span class="built_in">setFillColor</span>(sf::Color::Black);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 在窗口上绘制矩形</span></span><br><span class="line">            window.<span class="built_in">draw</span>(rect);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建一个表示玩家位置的圆形</span></span><br><span class="line">    <span class="type">int</span> radius = <span class="number">4</span>;</span><br><span class="line">    <span class="function">sf::CircleShape <span class="title">player</span><span class="params">(radius)</span></span>;</span><br><span class="line">    player.<span class="built_in">setFillColor</span>(sf::Color::Red);</span><br><span class="line">    <span class="comment">//player.setPosition(posX * miniMapScale - player.getRadius(), posY * miniMapScale - player.getRadius());</span></span><br><span class="line">    player.<span class="built_in">setPosition</span>(posX * miniMapScale - player.<span class="built_in">getRadius</span>(), (mapHeight - posY) * miniMapScale - player.<span class="built_in">getRadius</span>());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 在窗口上绘制圆形</span></span><br><span class="line">    window.<span class="built_in">draw</span>(player);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置三角扇形的原点为玩家的位置</span></span><br><span class="line">    <span class="comment">//FOV具体计算的参数在DDA算法里，我觉得这个结构很垃圾，应该在全局变量加个数组，在DDA算法中访问并修改这个参数</span></span><br><span class="line">    <span class="comment">//但是好像没啥时间给我改代码了，能跑就是胜利</span></span><br><span class="line">    fov[<span class="number">0</span>].position = sf::<span class="built_in">Vector2f</span>(posX * miniMapScale, (mapHeight - posY) * miniMapScale);</span><br><span class="line">    fov[<span class="number">0</span>].color = sf::Color::Transparent;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 在窗口上绘制三角扇形</span></span><br><span class="line">    window.<span class="built_in">draw</span>(fov);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DDA_algorithm</span><span class="params">(RenderWindow&amp; window)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> x = <span class="number">0</span>; x &lt; screenWidth; x++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//calculate ray position and direction</span></span><br><span class="line">        <span class="type">double</span> cameraX = <span class="number">2</span> * x / (<span class="type">double</span>)screenWidth - <span class="number">1</span>; <span class="comment">//x-coordinate in camera space</span></span><br><span class="line">        <span class="type">double</span> rayDirX = dirX + planeX * cameraX;</span><br><span class="line">        <span class="type">double</span> rayDirY = dirY + planeY * cameraX;</span><br><span class="line">        <span class="comment">//which box of the map we&#x27;re in</span></span><br><span class="line">        <span class="type">int</span> mapX = <span class="built_in">int</span>(posX);</span><br><span class="line">        <span class="type">int</span> mapY = <span class="built_in">int</span>(posY);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//length of ray from current position to next x or y-side</span></span><br><span class="line">        <span class="type">double</span> sideDistX;</span><br><span class="line">        <span class="type">double</span> sideDistY;</span><br><span class="line"></span><br><span class="line">        <span class="type">double</span> deltaDistX = (rayDirX == <span class="number">0</span>) ? <span class="number">1e30</span> : std::<span class="built_in">abs</span>(<span class="number">1</span> / rayDirX);</span><br><span class="line">        <span class="type">double</span> deltaDistY = (rayDirY == <span class="number">0</span>) ? <span class="number">1e30</span> : std::<span class="built_in">abs</span>(<span class="number">1</span> / rayDirY);</span><br><span class="line"></span><br><span class="line">        <span class="type">double</span> perpWallDist;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//what direction to step in x or y-direction (either +1 or -1)</span></span><br><span class="line">        <span class="type">int</span> stepX;</span><br><span class="line">        <span class="type">int</span> stepY;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> hit = <span class="number">0</span>; <span class="comment">//was there a wall hit?</span></span><br><span class="line">        <span class="type">int</span> side; <span class="comment">//was a NS or a EW wall hit?</span></span><br><span class="line">        <span class="comment">//calculate step and initial sideDist</span></span><br><span class="line">        <span class="keyword">if</span> (rayDirX &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            stepX = <span class="number">-1</span>;</span><br><span class="line">            sideDistX = (posX - mapX) * deltaDistX;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            stepX = <span class="number">1</span>;</span><br><span class="line">            sideDistX = (mapX + <span class="number">1.0</span> - posX) * deltaDistX;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (rayDirY &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            stepY = <span class="number">-1</span>;</span><br><span class="line">            sideDistY = (posY - mapY) * deltaDistY;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            stepY = <span class="number">1</span>;</span><br><span class="line">            sideDistY = (mapY + <span class="number">1.0</span> - posY) * deltaDistY;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//perform DDA</span></span><br><span class="line">        <span class="keyword">while</span> (hit == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//jump to next map square, either in x-direction, or in y-direction</span></span><br><span class="line">            <span class="keyword">if</span> (sideDistX &lt; sideDistY)</span><br><span class="line">            &#123;</span><br><span class="line">                sideDistX += deltaDistX;</span><br><span class="line">                mapX += stepX;</span><br><span class="line">                side = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                sideDistY += deltaDistY;</span><br><span class="line">                mapY += stepY;</span><br><span class="line">                side = <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//Check if ray has hit a wall</span></span><br><span class="line">            <span class="keyword">if</span> (worldMap[mapX][mapY] &gt; <span class="number">0</span>) hit = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//教程里这部分解释的比较清楚了</span></span><br><span class="line">        <span class="comment">//也可以看我在博客里的证明过程，写的更清楚</span></span><br><span class="line">        <span class="keyword">if</span> (side == <span class="number">0</span>) perpWallDist = (sideDistX - deltaDistX);</span><br><span class="line">        <span class="keyword">else</span>          perpWallDist = (sideDistY - deltaDistY);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*********************************************************************************/</span></span><br><span class="line">        <span class="comment">/*  此部分为添加FOV用</span></span><br><span class="line"><span class="comment">        /*  计算射线的终点</span></span><br><span class="line"><span class="comment">        /*********************************************************************************/</span></span><br><span class="line">        <span class="type">double</span> rayEndX = posX + perpWallDist * rayDirX;</span><br><span class="line">        <span class="type">double</span> rayEndY = posY + perpWallDist * rayDirY;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置三角扇形的顶点</span></span><br><span class="line">        fov[x + <span class="number">1</span>].position = sf::<span class="built_in">Vector2f</span>(rayEndX * miniMapScale, (mapHeight - rayEndY) * miniMapScale);</span><br><span class="line">        fov[x + <span class="number">1</span>].color = sf::<span class="built_in">Color</span>(<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">150</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Calculate height of line to draw on screen</span></span><br><span class="line">        <span class="comment">//可以任意修改墙的高度</span></span><br><span class="line">        <span class="type">int</span> lineHeight = (<span class="type">int</span>)(screenHeight / perpWallDist);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//calculate lowest and highest pixel to fill in current stripe</span></span><br><span class="line">        <span class="type">int</span> drawStart = -lineHeight / <span class="number">2</span> + screenHeight / <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">if</span> (drawStart &lt; <span class="number">0</span>) drawStart = <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> drawEnd = lineHeight / <span class="number">2</span> + screenHeight / <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">if</span> (drawEnd &gt;= screenHeight) drawEnd = screenHeight - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">/*********************************************************************************/</span></span><br><span class="line">        <span class="comment">/*  此部分替换了原raycasting画线部分</span></span><br><span class="line"><span class="comment">        /*  以下为纹理相关计算，是新内容</span></span><br><span class="line"><span class="comment">        /*  具体和原来的画线函数差不多，都是在具体位置上画出一条线</span></span><br><span class="line"><span class="comment">        /*  只不过这里画的是具体纹理上的一条线，利用了SFML中的sprite</span></span><br><span class="line"><span class="comment">        /*********************************************************************************/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//texturing calculations</span></span><br><span class="line">        <span class="type">int</span> texNum = worldMap[mapX][mapY] - <span class="number">1</span>; <span class="comment">//1 subtracted from it so that texture 0 can be used!</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//calculate value of wallX</span></span><br><span class="line">        <span class="type">double</span> wallX; <span class="comment">//where exactly the wall was hit</span></span><br><span class="line">        <span class="keyword">if</span> (side == <span class="number">0</span>) wallX = posY + perpWallDist * rayDirY;</span><br><span class="line">        <span class="keyword">else</span>           wallX = posX + perpWallDist * rayDirX;</span><br><span class="line">        wallX -= <span class="built_in">floor</span>((wallX));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//x coordinate on the texture</span></span><br><span class="line">        <span class="type">int</span> texX = <span class="built_in">int</span>(wallX * <span class="built_in">double</span>(texWidth));</span><br><span class="line">        <span class="keyword">if</span> (side == <span class="number">0</span> &amp;&amp; rayDirX &gt; <span class="number">0</span>) texX = texWidth - texX - <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> (side == <span class="number">1</span> &amp;&amp; rayDirY &lt; <span class="number">0</span>) texX = texWidth - texX - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// How much to increase the texture coordinate per screen pixel</span></span><br><span class="line">        <span class="type">double</span> step = <span class="number">1.0</span> * texHeight / lineHeight;</span><br><span class="line">        <span class="comment">// Starting texture coordinate</span></span><br><span class="line">        <span class="type">double</span> texPos = (drawStart - screenHeight / <span class="number">2</span> + lineHeight / <span class="number">2</span>) * step;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//为了获取纹理具体某一个坐标的像素颜色</span></span><br><span class="line">        <span class="comment">//创建一个新的sprite对象</span></span><br><span class="line">        sf::Sprite wall_sprite;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//设置sprite的纹理</span></span><br><span class="line">        wall_sprite.<span class="built_in">setTexture</span>(texture[texNum]);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//设置sprite的纹理矩形，定义了在纹理中的哪个部分应用到wall_sprite上</span></span><br><span class="line">        <span class="comment">//宽度为1个像素，相当于原来的画线</span></span><br><span class="line">        wall_sprite.<span class="built_in">setTextureRect</span>(sf::<span class="built_in">IntRect</span>(texX, <span class="number">0</span>, <span class="number">1</span>, texHeight));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//设置sprite的位置，坐标指定了左上角的位置</span></span><br><span class="line">        <span class="comment">//wall_sprite.setPosition(x, drawStart);        //太几把恶心了，破案了：指定左上角的位置为drawStart</span></span><br><span class="line">        <span class="comment">//                                              //drawStart在特殊情况下会被赋值为0，即if (drawStart &lt; 0) drawStart = 0;</span></span><br><span class="line">        <span class="comment">//                                              //在此情况下绘制的起点就会改变为0，令人恶心</span></span><br><span class="line">        wall_sprite.<span class="built_in">setPosition</span>(x, <span class="built_in">round</span>(<span class="number">0.5f</span> * screenHeight - <span class="number">0.5f</span> * lineHeight));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//设置sprite的缩放因子</span></span><br><span class="line">        wall_sprite.<span class="built_in">setScale</span>(<span class="number">1</span>, lineHeight / (<span class="type">float</span>)texHeight);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//利用SFML中sprite的setColor功能，使y墙变暗</span></span><br><span class="line">        <span class="comment">//这个函数实现的是“调制混合”</span></span><br><span class="line">        <span class="comment">//举个例子：原来的R通道为200，与128混合为：200 * 128 / 255 = 100，实现了颜色除以2的效果</span></span><br><span class="line">        <span class="keyword">if</span> (side == <span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            wall_sprite.<span class="built_in">setColor</span>(<span class="built_in">Color</span>(<span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 绘制sprite</span></span><br><span class="line">        window.<span class="built_in">draw</span>(wall_sprite);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Move</span><span class="params">(RenderWindow&amp; window)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//timing for input and FPS counter</span></span><br><span class="line">    oldTime = Mytime;</span><br><span class="line">    Mytime = <span class="built_in">getTicks</span>();</span><br><span class="line">    <span class="type">double</span> frameTime = (Mytime - oldTime) / <span class="number">1000.0</span>; <span class="comment">//frameTime is the time this frame has taken, in seconds</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//speed modifiers</span></span><br><span class="line">    <span class="type">double</span> moveSpeed = frameTime * <span class="number">3.0</span>; <span class="comment">//the constant value is in squares/second</span></span><br><span class="line">    <span class="type">double</span> rotSpeed = frameTime * <span class="number">2.0</span>; <span class="comment">//the constant value is in radians/second</span></span><br><span class="line">    <span class="comment">//move forward if no wall in front of you</span></span><br><span class="line">    <span class="keyword">if</span> (sf::Keyboard::<span class="built_in">isKeyPressed</span>(sf::Keyboard::Up) ||</span><br><span class="line">        sf::Keyboard::<span class="built_in">isKeyPressed</span>(sf::Keyboard::W))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (worldMap[<span class="built_in">int</span>(posX + dirX * moveSpeed)][<span class="built_in">int</span>(posY)] == <span class="literal">false</span>) posX += dirX * moveSpeed;</span><br><span class="line">        <span class="keyword">if</span> (worldMap[<span class="built_in">int</span>(posX)][<span class="built_in">int</span>(posY + dirY * moveSpeed)] == <span class="literal">false</span>) posY += dirY * moveSpeed;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//move backwards if no wall behind you</span></span><br><span class="line">    <span class="keyword">if</span> (sf::Keyboard::<span class="built_in">isKeyPressed</span>(sf::Keyboard::Down) ||</span><br><span class="line">        sf::Keyboard::<span class="built_in">isKeyPressed</span>(sf::Keyboard::S))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (worldMap[<span class="built_in">int</span>(posX - dirX * moveSpeed)][<span class="built_in">int</span>(posY)] == <span class="literal">false</span>) posX -= dirX * moveSpeed;</span><br><span class="line">        <span class="keyword">if</span> (worldMap[<span class="built_in">int</span>(posX)][<span class="built_in">int</span>(posY - dirY * moveSpeed)] == <span class="literal">false</span>) posY -= dirY * moveSpeed;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//向右走，原理还是跟前后走一样，只是方向用矩阵相乘重新算了</span></span><br><span class="line">    <span class="comment">//向右走就是在(dirY, -dirX)这个方向走</span></span><br><span class="line">    <span class="keyword">if</span> (sf::Keyboard::<span class="built_in">isKeyPressed</span>(sf::Keyboard::D))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (worldMap[<span class="built_in">int</span>(posX + dirY * moveSpeed * <span class="number">0.75</span>)][<span class="built_in">int</span>(posY)] == <span class="literal">false</span>) posX += dirY * moveSpeed * <span class="number">0.75</span>;</span><br><span class="line">        <span class="keyword">if</span> (worldMap[<span class="built_in">int</span>(posX)][<span class="built_in">int</span>(posY - dirX * moveSpeed * <span class="number">0.75</span>)] == <span class="literal">false</span>) posY -= dirX * moveSpeed * <span class="number">0.75</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//向左走同理</span></span><br><span class="line">    <span class="comment">//在(-dirY, dirX)方向</span></span><br><span class="line">    <span class="keyword">if</span> (sf::Keyboard::<span class="built_in">isKeyPressed</span>(sf::Keyboard::A))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (worldMap[<span class="built_in">int</span>(posX - dirY * moveSpeed * <span class="number">0.75</span>)][<span class="built_in">int</span>(posY)] == <span class="literal">false</span>) posX -= dirY * moveSpeed * <span class="number">0.75</span>;</span><br><span class="line">        <span class="keyword">if</span> (worldMap[<span class="built_in">int</span>(posX)][<span class="built_in">int</span>(posY + dirX * moveSpeed * <span class="number">0.75</span>)] == <span class="literal">false</span>) posY += dirX * moveSpeed * <span class="number">0.75</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//rotate to the right</span></span><br><span class="line">    <span class="keyword">if</span> (sf::Keyboard::<span class="built_in">isKeyPressed</span>(sf::Keyboard::Right))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//both camera direction and camera plane must be rotated</span></span><br><span class="line">        <span class="type">double</span> oldDirX = dirX;</span><br><span class="line">        dirX = dirX * <span class="built_in">cos</span>(-rotSpeed) - dirY * <span class="built_in">sin</span>(-rotSpeed);</span><br><span class="line">        dirY = oldDirX * <span class="built_in">sin</span>(-rotSpeed) + dirY * <span class="built_in">cos</span>(-rotSpeed);</span><br><span class="line">        <span class="type">double</span> oldPlaneX = planeX;</span><br><span class="line">        planeX = planeX * <span class="built_in">cos</span>(-rotSpeed) - planeY * <span class="built_in">sin</span>(-rotSpeed);</span><br><span class="line">        planeY = oldPlaneX * <span class="built_in">sin</span>(-rotSpeed) + planeY * <span class="built_in">cos</span>(-rotSpeed);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//rotate to the left</span></span><br><span class="line">    <span class="keyword">if</span> (sf::Keyboard::<span class="built_in">isKeyPressed</span>(sf::Keyboard::Left))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//both camera direction and camera plane must be rotated</span></span><br><span class="line">        <span class="type">double</span> oldDirX = dirX;</span><br><span class="line">        dirX = dirX * <span class="built_in">cos</span>(rotSpeed) - dirY * <span class="built_in">sin</span>(rotSpeed);</span><br><span class="line">        dirY = oldDirX * <span class="built_in">sin</span>(rotSpeed) + dirY * <span class="built_in">cos</span>(rotSpeed);</span><br><span class="line">        <span class="type">double</span> oldPlaneX = planeX;</span><br><span class="line">        planeX = planeX * <span class="built_in">cos</span>(rotSpeed) - planeY * <span class="built_in">sin</span>(rotSpeed);</span><br><span class="line">        planeY = oldPlaneX * <span class="built_in">sin</span>(rotSpeed) + planeY * <span class="built_in">cos</span>(rotSpeed);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="展示的demonstration">展示的Demonstration</h2>
<h3 id="展示的逻辑">展示的逻辑</h3>
<p>就是用按键控制一系列显示，我感觉当时展示还挺成功的</p>
<p>唯一的遗憾是没有实时演示这个程序，而是录的视频，因为教室的电脑没装VisualStudio的运行环境</p>
<p>具体演示过程如下：</p>
<p>先只显示小地图，角色可以在小地图上自由行走，为了突出展示的主题“给<strong>二维</strong>数组一点小小的<strong>伪3D</strong>震撼”</p>
<p>再显示人物视野范围，按Shift开启</p>
<p>再缩小小地图，按&lt;键或减号键缩小</p>
<p>再显示伪3D效果，按回车开启</p>
<p>再显示地板天花板，按B开启</p>
<p>再显示纹理，按T开启</p>
<p><br></p>
<p>按照这个顺序演示，确实感觉太牛逼了，层层递进，一波一波的震撼，尤其是逐渐缩小小地图，按回车无缝衔接，显示Raycasting的结果，真正做到了给<strong>二维</strong>数组一点小小的<strong>伪3D</strong>震撼</p>
<p><br></p>
<h3 id="对应修改">对应修改</h3>
<p>添加对应的Flag标志：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//是否画伪3D效果                        回车键</span></span><br><span class="line"><span class="type">bool</span> DrawFlag = <span class="number">0</span>;</span><br><span class="line"><span class="comment">//是否画小地图，默认画而且很大           Tab键或~键</span></span><br><span class="line"><span class="type">bool</span> DrawminimapFlag = <span class="number">1</span>;</span><br><span class="line"><span class="comment">//是否画小地图上的FOV                   shift</span></span><br><span class="line"><span class="type">bool</span> DrawFOV = <span class="number">0</span>;</span><br><span class="line"><span class="comment">//是否加纹理                           T</span></span><br><span class="line"><span class="type">bool</span> TextureFlag = <span class="number">0</span>;</span><br><span class="line"><span class="comment">//是否画天花板地板                      B</span></span><br><span class="line"><span class="type">bool</span> DrawFloorCeilingFlag = <span class="number">0</span>;</span><br></pre></td></tr></table></figure>
<p><code>main</code>函数修改如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">RenderWindow <span class="title">window</span><span class="params">(sf::VideoMode(screenWidth, screenHeight), <span class="string">&quot;Raycasting-Demonstration&quot;</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="built_in">LoadTexture</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (window.<span class="built_in">isOpen</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        sf::Event event;</span><br><span class="line">        <span class="keyword">while</span> (window.<span class="built_in">pollEvent</span>(event))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (event.type == sf::Event::Closed)</span><br><span class="line">                window.<span class="built_in">close</span>();</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//sf::Keyboard::isKeyPressed函数会在每一帧都检测键盘的状态</span></span><br><span class="line">            <span class="comment">//sf::Event::KeyPressed事件只会在按键被按下的那一帧触发一次，即使你按住按键不放，它也不会在下一帧再次触发</span></span><br><span class="line">            <span class="comment">//因此，使用sf::Event::KeyPressed事件可以确保DrawminimapFlag的值只会被反转一次</span></span><br><span class="line">            <span class="keyword">if</span> (event.type == sf::Event::KeyPressed)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//按Tab键或~键开关小地图</span></span><br><span class="line">                <span class="keyword">if</span> (event.key.code == sf::Keyboard::Tab || event.key.code == sf::Keyboard::Tilde)</span><br><span class="line">                &#123;</span><br><span class="line">                    DrawminimapFlag = !DrawminimapFlag;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//按加号键或&gt;键增大小地图</span></span><br><span class="line">                <span class="keyword">if</span> (event.key.code == sf::Keyboard::Add || event.key.code == sf::Keyboard::Period)</span><br><span class="line">                &#123;</span><br><span class="line">                    miniMapScale++;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//按减号键或&lt;键缩小小地图</span></span><br><span class="line">                <span class="keyword">if</span> (event.key.code == sf::Keyboard::Subtract || event.key.code == sf::Keyboard::Comma)</span><br><span class="line">                &#123;</span><br><span class="line">                    miniMapScale--;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//按shift键画FOV</span></span><br><span class="line">                <span class="keyword">if</span> (event.key.code == sf::Keyboard::LShift)</span><br><span class="line">                &#123;</span><br><span class="line">                    DrawFOV = !DrawFOV;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//按T是否纹理</span></span><br><span class="line">                <span class="keyword">if</span> (event.key.code == sf::Keyboard::T)</span><br><span class="line">                &#123;</span><br><span class="line">                    TextureFlag = !TextureFlag;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//按B是否画天花板</span></span><br><span class="line">                <span class="keyword">if</span> (event.key.code == sf::Keyboard::B)</span><br><span class="line">                &#123;</span><br><span class="line">                    DrawFloorCeilingFlag = !DrawFloorCeilingFlag;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//按回车是否伪3D效果</span></span><br><span class="line">                <span class="keyword">if</span> (event.key.code == sf::Keyboard::Enter)</span><br><span class="line">                &#123;</span><br><span class="line">                    DrawFlag = <span class="number">1</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        window.<span class="built_in">clear</span>();</span><br><span class="line">        <span class="keyword">if</span> (DrawFloorCeilingFlag)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">DrawFloorCeiling</span>(window);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">DDA_algorithm</span>(window);</span><br><span class="line">        <span class="built_in">Move</span>(window);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (DrawminimapFlag)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">drawMiniMap</span>(window);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        window.<span class="built_in">display</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>这里实际上还涉及到SFML的一个小问题：按键检测</p>
<p>在移动逻辑中，我们用的逻辑是<code>sf::Keyboard::isKeyPressed(sf::Keyboard::W)</code></p>
<p>而在改变flag时，我们用的逻辑是<code>event</code>事件的<code>sf::Event::KeyPressed</code></p>
<p>具体为：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//sf::Keyboard::isKeyPressed函数会在每一帧都检测键盘的状态</span></span><br><span class="line"><span class="comment">//sf::Event::KeyPressed事件只会在按键被按下的那一帧触发一次，即使你按住按键不放，它也不会在下一帧再次触发</span></span><br><span class="line"><span class="comment">//因此，使用sf::Event::KeyPressed事件可以确保DrawminimapFlag的值只会被反转一次</span></span><br><span class="line"><span class="keyword">if</span> (event.type == sf::Event::KeyPressed)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//按Tab键或~键开关小地图</span></span><br><span class="line">    <span class="keyword">if</span> (event.key.code == sf::Keyboard::Tab || event.key.code == sf::Keyboard::Tilde)</span><br><span class="line">    &#123;</span><br><span class="line">        DrawminimapFlag = !DrawminimapFlag;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//按加号键或&gt;键增大小地图</span></span><br><span class="line">    <span class="keyword">if</span> (event.key.code == sf::Keyboard::Add || event.key.code == sf::Keyboard::Period)</span><br><span class="line">    &#123;</span><br><span class="line">        miniMapScale++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//按减号键或&lt;键缩小小地图</span></span><br><span class="line">    <span class="keyword">if</span> (event.key.code == sf::Keyboard::Subtract || event.key.code == sf::Keyboard::Comma)</span><br><span class="line">    &#123;</span><br><span class="line">        miniMapScale--;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//按shift键画FOV</span></span><br><span class="line">    <span class="keyword">if</span> (event.key.code == sf::Keyboard::LShift)</span><br><span class="line">    &#123;</span><br><span class="line">        DrawFOV = !DrawFOV;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//按T是否纹理</span></span><br><span class="line">    <span class="keyword">if</span> (event.key.code == sf::Keyboard::T)</span><br><span class="line">    &#123;</span><br><span class="line">        TextureFlag = !TextureFlag;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//按B是否画天花板</span></span><br><span class="line">    <span class="keyword">if</span> (event.key.code == sf::Keyboard::B)</span><br><span class="line">    &#123;</span><br><span class="line">        DrawFloorCeilingFlag = !DrawFloorCeilingFlag;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//按回车是否伪3D效果</span></span><br><span class="line">    <span class="keyword">if</span> (event.key.code == sf::Keyboard::Enter)</span><br><span class="line">    &#123;</span><br><span class="line">        DrawFlag = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>原因如下：</p>
<p><code>sf::Keyboard::isKeyPressed</code>函数会在每一帧都检测键盘的状态</p>
<p><code>sf::Event::KeyPressed</code>事件只会在按键被按下的那一帧触发一次，即使你按住按键不放，它也不会在下一帧再次触发</p>
<p>因此，使用<code>sf::Event::KeyPressed</code>事件可以确保<code>Flag</code>的值只会被反转一次</p>
<h3 id="源代码-3">源代码</h3>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;SFML/Graphics.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cmath&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> sf;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> screenWidth 1440</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> screenHeight 900</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> mapWidth 24</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> mapHeight 24</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> texWidth 64</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> texHeight 64</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> worldMap[mapWidth][mapWidth] =</span><br><span class="line">&#123;</span><br><span class="line">  &#123;<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>&#125;,</span><br><span class="line">  &#123;<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>&#125;,</span><br><span class="line">  &#123;<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>&#125;,</span><br><span class="line">  &#123;<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>&#125;,</span><br><span class="line">  &#123;<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">3</span>,<span class="number">0</span>,<span class="number">3</span>,<span class="number">0</span>,<span class="number">3</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>&#125;,</span><br><span class="line">  &#123;<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>&#125;,</span><br><span class="line">  &#123;<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">3</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">3</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>&#125;,</span><br><span class="line">  &#123;<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>&#125;,</span><br><span class="line">  &#123;<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">3</span>,<span class="number">0</span>,<span class="number">3</span>,<span class="number">0</span>,<span class="number">3</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>&#125;,</span><br><span class="line">  &#123;<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>&#125;,</span><br><span class="line">  &#123;<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>&#125;,</span><br><span class="line">  &#123;<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>&#125;,</span><br><span class="line">  &#123;<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>&#125;,</span><br><span class="line">  &#123;<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>&#125;,</span><br><span class="line">  &#123;<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>&#125;,</span><br><span class="line">  &#123;<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>&#125;,</span><br><span class="line">  &#123;<span class="number">1</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>&#125;,</span><br><span class="line">  &#123;<span class="number">1</span>,<span class="number">4</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>&#125;,</span><br><span class="line">  &#123;<span class="number">1</span>,<span class="number">4</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>&#125;,</span><br><span class="line">  &#123;<span class="number">1</span>,<span class="number">4</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>&#125;,</span><br><span class="line">  &#123;<span class="number">1</span>,<span class="number">4</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>&#125;,</span><br><span class="line">  &#123;<span class="number">1</span>,<span class="number">4</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>&#125;,</span><br><span class="line">  &#123;<span class="number">1</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>&#125;,</span><br><span class="line">  &#123;<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//程序必要的参数</span></span><br><span class="line"><span class="type">double</span> posX = <span class="number">22</span>, posY = <span class="number">12</span>;  <span class="comment">//x and y start position</span></span><br><span class="line"><span class="type">double</span> dirX = <span class="number">-1</span>, dirY = <span class="number">0</span>; <span class="comment">//initial direction vector</span></span><br><span class="line"><span class="type">double</span> planeX = <span class="number">0</span>, planeY = <span class="number">0.66</span>; <span class="comment">//the 2d raycaster version of camera plane</span></span><br><span class="line"></span><br><span class="line"><span class="type">double</span> Mytime = <span class="number">0</span>; <span class="comment">//time of current frame</span></span><br><span class="line"><span class="type">double</span> oldTime = <span class="number">0</span>; <span class="comment">//time of previous frame</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//创建一个表示视野范围的三角扇形</span></span><br><span class="line"><span class="comment">//还是程序设计的结构问题，应该给玩家安排个类，这个当做类的成员的</span></span><br><span class="line"><span class="comment">//而且中间参数还在DDA算法中计算，实际上不应该这样的</span></span><br><span class="line"><span class="function">VertexArray <span class="title">fov</span><span class="params">(sf::TriangleFan, screenWidth + <span class="number">1</span>)</span></span>;</span><br><span class="line"><span class="comment">//墙面纹理数组</span></span><br><span class="line">Texture texture[<span class="number">8</span>];</span><br><span class="line"><span class="comment">//用于计时</span></span><br><span class="line">Clock Myclock;</span><br><span class="line"></span><br><span class="line"><span class="comment">//小地图的宽度和高度</span></span><br><span class="line"><span class="type">const</span> <span class="type">int</span> minimapWidth = <span class="number">24</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">int</span> minimapHeight = <span class="number">24</span>;</span><br><span class="line"><span class="comment">//小地图的大小（单位：像素）             加减号或者&lt;&gt;键（,和.）操作放大缩小</span></span><br><span class="line"><span class="type">int</span> miniMapScale = <span class="number">36</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//是否画伪3D效果                        回车键</span></span><br><span class="line"><span class="type">bool</span> DrawFlag = <span class="number">0</span>;</span><br><span class="line"><span class="comment">//是否画小地图，默认画而且很大           Tab键或~键</span></span><br><span class="line"><span class="type">bool</span> DrawminimapFlag = <span class="number">1</span>;</span><br><span class="line"><span class="comment">//是否画小地图上的FOV                   shift</span></span><br><span class="line"><span class="type">bool</span> DrawFOV = <span class="number">0</span>;</span><br><span class="line"><span class="comment">//是否加纹理                           T</span></span><br><span class="line"><span class="type">bool</span> TextureFlag = <span class="number">0</span>;</span><br><span class="line"><span class="comment">//是否画天花板地板                      B</span></span><br><span class="line"><span class="type">bool</span> DrawFloorCeilingFlag = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//获取时间</span></span><br><span class="line"><span class="function"><span class="type">unsigned</span> <span class="type">long</span> <span class="title">getTicks</span><span class="params">()</span></span>;</span><br><span class="line"><span class="comment">//读取纹理</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">LoadTexture</span><span class="params">()</span></span>;</span><br><span class="line"><span class="comment">//画天花板和地板</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DrawFloorCeiling</span><span class="params">(RenderWindow&amp; window)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">RectangleShape <span class="title">CeilingRect</span><span class="params">(Vector2f(screenWidth, screenHeight / <span class="number">2</span>))</span></span>;</span><br><span class="line">    CeilingRect.<span class="built_in">setFillColor</span>(<span class="built_in">Color</span>(<span class="number">156</span>, <span class="number">220</span>, <span class="number">235</span>));</span><br><span class="line"></span><br><span class="line">    <span class="function">RectangleShape <span class="title">FloorRect</span><span class="params">(Vector2f(screenWidth, screenHeight / <span class="number">2</span>))</span></span>;</span><br><span class="line">    FloorRect.<span class="built_in">setPosition</span>(<span class="number">0</span>, screenHeight / <span class="number">2</span>);</span><br><span class="line">    FloorRect.<span class="built_in">setFillColor</span>(<span class="built_in">Color</span>(<span class="number">68</span>, <span class="number">68</span>, <span class="number">68</span>));</span><br><span class="line"></span><br><span class="line">    window.<span class="built_in">draw</span>(CeilingRect);</span><br><span class="line">    window.<span class="built_in">draw</span>(FloorRect);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//整的新活：用SFML的VertexArray来可视化FOV</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">drawMiniMap</span><span class="params">(sf::RenderWindow&amp; window)</span></span>;</span><br><span class="line"><span class="comment">//DDA算法，用于计算墙的高度和画线</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DDA_algorithm</span><span class="params">(RenderWindow&amp; window)</span></span>;</span><br><span class="line"><span class="comment">//移动函数，用于改变位置和朝向</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Move</span><span class="params">(RenderWindow&amp; window)</span></span>;</span><br><span class="line"><span class="comment">//画线</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">verLine</span><span class="params">(sf::RenderWindow&amp; window, <span class="type">int</span> x, <span class="type">int</span> y1, <span class="type">int</span> y2, <span class="type">const</span> sf::Color&amp; color)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// Ensure y1 is less than y2</span></span><br><span class="line">    <span class="keyword">if</span> (y2 &lt; y1)</span><br><span class="line">    &#123;</span><br><span class="line">        std::<span class="built_in">swap</span>(y1, y2);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Create a sf::VertexArray for the line</span></span><br><span class="line">    <span class="function">sf::VertexArray <span class="title">line</span><span class="params">(sf::Lines, <span class="number">2</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Set the position and color of the line vertices</span></span><br><span class="line">    line[<span class="number">0</span>].position = sf::<span class="built_in">Vector2f</span>(x, y1);</span><br><span class="line">    line[<span class="number">0</span>].color = color;</span><br><span class="line">    line[<span class="number">1</span>].position = sf::<span class="built_in">Vector2f</span>(x, y2);</span><br><span class="line">    line[<span class="number">1</span>].color = color;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Draw the line</span></span><br><span class="line">    window.<span class="built_in">draw</span>(line);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">RenderWindow <span class="title">window</span><span class="params">(sf::VideoMode(screenWidth, screenHeight), <span class="string">&quot;Raycasting-Demonstration&quot;</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="built_in">LoadTexture</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (window.<span class="built_in">isOpen</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        sf::Event event;</span><br><span class="line">        <span class="keyword">while</span> (window.<span class="built_in">pollEvent</span>(event))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (event.type == sf::Event::Closed)</span><br><span class="line">                window.<span class="built_in">close</span>();</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//sf::Keyboard::isKeyPressed函数会在每一帧都检测键盘的状态</span></span><br><span class="line">            <span class="comment">//sf::Event::KeyPressed事件只会在按键被按下的那一帧触发一次，即使你按住按键不放，它也不会在下一帧再次触发</span></span><br><span class="line">            <span class="comment">//因此，使用sf::Event::KeyPressed事件可以确保DrawminimapFlag的值只会被反转一次</span></span><br><span class="line">            <span class="keyword">if</span> (event.type == sf::Event::KeyPressed)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//按Tab键或~键开关小地图</span></span><br><span class="line">                <span class="keyword">if</span> (event.key.code == sf::Keyboard::Tab || event.key.code == sf::Keyboard::Tilde)</span><br><span class="line">                &#123;</span><br><span class="line">                    DrawminimapFlag = !DrawminimapFlag;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//按加号键或&gt;键增大小地图</span></span><br><span class="line">                <span class="keyword">if</span> (event.key.code == sf::Keyboard::Add || event.key.code == sf::Keyboard::Period)</span><br><span class="line">                &#123;</span><br><span class="line">                    miniMapScale++;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//按减号键或&lt;键缩小小地图</span></span><br><span class="line">                <span class="keyword">if</span> (event.key.code == sf::Keyboard::Subtract || event.key.code == sf::Keyboard::Comma)</span><br><span class="line">                &#123;</span><br><span class="line">                    miniMapScale--;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//按shift键画FOV</span></span><br><span class="line">                <span class="keyword">if</span> (event.key.code == sf::Keyboard::LShift)</span><br><span class="line">                &#123;</span><br><span class="line">                    DrawFOV = !DrawFOV;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//按T是否纹理</span></span><br><span class="line">                <span class="keyword">if</span> (event.key.code == sf::Keyboard::T)</span><br><span class="line">                &#123;</span><br><span class="line">                    TextureFlag = !TextureFlag;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//按B是否画天花板</span></span><br><span class="line">                <span class="keyword">if</span> (event.key.code == sf::Keyboard::B)</span><br><span class="line">                &#123;</span><br><span class="line">                    DrawFloorCeilingFlag = !DrawFloorCeilingFlag;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//按回车是否伪3D效果</span></span><br><span class="line">                <span class="keyword">if</span> (event.key.code == sf::Keyboard::Enter)</span><br><span class="line">                &#123;</span><br><span class="line">                    DrawFlag = <span class="number">1</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        window.<span class="built_in">clear</span>();</span><br><span class="line">        <span class="keyword">if</span> (DrawFloorCeilingFlag)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">DrawFloorCeiling</span>(window);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">DDA_algorithm</span>(window);</span><br><span class="line">        <span class="built_in">Move</span>(window);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (DrawminimapFlag)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">drawMiniMap</span>(window);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        window.<span class="built_in">display</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">unsigned</span> <span class="type">long</span> <span class="title">getTicks</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    sf::Time elapsed = Myclock.<span class="built_in">getElapsedTime</span>();</span><br><span class="line">    <span class="keyword">return</span> elapsed.<span class="built_in">asMilliseconds</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">LoadTexture</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//texture[0].loadFromFile(&quot;pics/eagle.png&quot;);</span></span><br><span class="line">    <span class="comment">//texture[1].loadFromFile(&quot;pics/redbrick.png&quot;);</span></span><br><span class="line">    <span class="comment">//texture[2].loadFromFile(&quot;pics/purplestone.png&quot;);</span></span><br><span class="line">    <span class="comment">//texture[3].loadFromFile(&quot;pics/greystone.png&quot;);</span></span><br><span class="line">    <span class="comment">//texture[4].loadFromFile(&quot;pics/bluestone.png&quot;);</span></span><br><span class="line">    <span class="comment">//texture[5].loadFromFile(&quot;pics/mossy.png&quot;);</span></span><br><span class="line">    <span class="comment">//texture[6].loadFromFile(&quot;pics/wood.png&quot;);</span></span><br><span class="line">    <span class="comment">//texture[7].loadFromFile(&quot;pics/colorstone.png&quot;);</span></span><br><span class="line">    texture[<span class="number">0</span>].<span class="built_in">loadFromFile</span>(<span class="string">&quot;pics/redbrick.png&quot;</span>);</span><br><span class="line">    texture[<span class="number">1</span>].<span class="built_in">loadFromFile</span>(<span class="string">&quot;pics/greystone.png&quot;</span>);</span><br><span class="line">    texture[<span class="number">2</span>].<span class="built_in">loadFromFile</span>(<span class="string">&quot;pics/bluestone.png&quot;</span>);</span><br><span class="line">    texture[<span class="number">3</span>].<span class="built_in">loadFromFile</span>(<span class="string">&quot;pics/colorstone.png&quot;</span>);</span><br><span class="line">    texture[<span class="number">4</span>].<span class="built_in">loadFromFile</span>(<span class="string">&quot;pics/purplestone.png&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//要注意：SFML中的y轴是向下的，而用二维数组计算时y轴是向上的</span></span><br><span class="line"><span class="comment">//需将游戏中的坐标系转换为小地图的坐标系，具体来说，就是将y坐标进行翻转</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">drawMiniMap</span><span class="params">(sf::RenderWindow&amp; window)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 遍历地图的每一个格子</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> x = <span class="number">0</span>; x &lt; minimapWidth; ++x)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> y = <span class="number">0</span>; y &lt; minimapHeight; ++y)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 创建一个表示地图格子的矩形</span></span><br><span class="line">            <span class="function">sf::RectangleShape <span class="title">rect</span><span class="params">(sf::Vector2f(miniMapScale, miniMapScale))</span></span>;</span><br><span class="line">            <span class="comment">//rect.setPosition(x * miniMapScale, y * miniMapScale);</span></span><br><span class="line">            rect.<span class="built_in">setPosition</span>(x * miniMapScale, (mapHeight - y - <span class="number">1</span>) * miniMapScale);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 根据地图数据设置矩形的颜色</span></span><br><span class="line">            <span class="keyword">if</span> (worldMap[x][y] &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                rect.<span class="built_in">setFillColor</span>(sf::Color::White);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                rect.<span class="built_in">setFillColor</span>(sf::Color::Black);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 在窗口上绘制矩形</span></span><br><span class="line">            window.<span class="built_in">draw</span>(rect);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建一个表示玩家位置的圆形</span></span><br><span class="line">    <span class="type">int</span> radius = <span class="number">4</span>;</span><br><span class="line">    <span class="function">sf::CircleShape <span class="title">player</span><span class="params">(radius)</span></span>;</span><br><span class="line">    player.<span class="built_in">setFillColor</span>(sf::Color::Red);</span><br><span class="line">    <span class="comment">//player.setPosition(posX * miniMapScale - player.getRadius(), posY * miniMapScale - player.getRadius());</span></span><br><span class="line">    player.<span class="built_in">setPosition</span>(posX * miniMapScale - player.<span class="built_in">getRadius</span>(), (mapHeight - posY) * miniMapScale - player.<span class="built_in">getRadius</span>());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 在窗口上绘制圆形</span></span><br><span class="line">    window.<span class="built_in">draw</span>(player);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置三角扇形的原点为玩家的位置</span></span><br><span class="line">    <span class="comment">//FOV具体计算的参数在DDA算法里，我觉得这个结构很垃圾，应该在全局变量加个数组，在DDA算法中访问并修改这个参数</span></span><br><span class="line">    <span class="comment">//但是好像没啥时间给我改代码了，能跑就是胜利</span></span><br><span class="line">    fov[<span class="number">0</span>].position = sf::<span class="built_in">Vector2f</span>(posX * miniMapScale, (mapHeight - posY) * miniMapScale);</span><br><span class="line">    fov[<span class="number">0</span>].color = sf::Color::Transparent;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 在窗口上绘制三角扇形</span></span><br><span class="line">    <span class="keyword">if</span> (DrawFOV == <span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        window.<span class="built_in">draw</span>(fov);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DDA_algorithm</span><span class="params">(RenderWindow&amp; window)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> x = <span class="number">0</span>; x &lt; screenWidth; x++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//calculate ray position and direction</span></span><br><span class="line">        <span class="type">double</span> cameraX = <span class="number">2</span> * x / (<span class="type">double</span>)screenWidth - <span class="number">1</span>; <span class="comment">//x-coordinate in camera space</span></span><br><span class="line">        <span class="type">double</span> rayDirX = dirX + planeX * cameraX;</span><br><span class="line">        <span class="type">double</span> rayDirY = dirY + planeY * cameraX;</span><br><span class="line">        <span class="comment">//which box of the map we&#x27;re in</span></span><br><span class="line">        <span class="type">int</span> mapX = <span class="built_in">int</span>(posX);</span><br><span class="line">        <span class="type">int</span> mapY = <span class="built_in">int</span>(posY);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//length of ray from current position to next x or y-side</span></span><br><span class="line">        <span class="type">double</span> sideDistX;</span><br><span class="line">        <span class="type">double</span> sideDistY;</span><br><span class="line"></span><br><span class="line">        <span class="type">double</span> deltaDistX = (rayDirX == <span class="number">0</span>) ? <span class="number">1e30</span> : std::<span class="built_in">abs</span>(<span class="number">1</span> / rayDirX);</span><br><span class="line">        <span class="type">double</span> deltaDistY = (rayDirY == <span class="number">0</span>) ? <span class="number">1e30</span> : std::<span class="built_in">abs</span>(<span class="number">1</span> / rayDirY);</span><br><span class="line"></span><br><span class="line">        <span class="type">double</span> perpWallDist;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//what direction to step in x or y-direction (either +1 or -1)</span></span><br><span class="line">        <span class="type">int</span> stepX;</span><br><span class="line">        <span class="type">int</span> stepY;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> hit = <span class="number">0</span>; <span class="comment">//was there a wall hit?</span></span><br><span class="line">        <span class="type">int</span> side; <span class="comment">//was a NS or a EW wall hit?</span></span><br><span class="line">        <span class="comment">//calculate step and initial sideDist</span></span><br><span class="line">        <span class="keyword">if</span> (rayDirX &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            stepX = <span class="number">-1</span>;</span><br><span class="line">            sideDistX = (posX - mapX) * deltaDistX;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            stepX = <span class="number">1</span>;</span><br><span class="line">            sideDistX = (mapX + <span class="number">1.0</span> - posX) * deltaDistX;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (rayDirY &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            stepY = <span class="number">-1</span>;</span><br><span class="line">            sideDistY = (posY - mapY) * deltaDistY;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            stepY = <span class="number">1</span>;</span><br><span class="line">            sideDistY = (mapY + <span class="number">1.0</span> - posY) * deltaDistY;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//perform DDA</span></span><br><span class="line">        <span class="keyword">while</span> (hit == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//jump to next map square, either in x-direction, or in y-direction</span></span><br><span class="line">            <span class="keyword">if</span> (sideDistX &lt; sideDistY)</span><br><span class="line">            &#123;</span><br><span class="line">                sideDistX += deltaDistX;</span><br><span class="line">                mapX += stepX;</span><br><span class="line">                side = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                sideDistY += deltaDistY;</span><br><span class="line">                mapY += stepY;</span><br><span class="line">                side = <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//Check if ray has hit a wall</span></span><br><span class="line">            <span class="keyword">if</span> (worldMap[mapX][mapY] &gt; <span class="number">0</span>) hit = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//教程里这部分解释的比较清楚了</span></span><br><span class="line">        <span class="comment">//也可以看我在博客里的证明过程，写的更清楚</span></span><br><span class="line">        <span class="keyword">if</span> (side == <span class="number">0</span>) perpWallDist = (sideDistX - deltaDistX);</span><br><span class="line">        <span class="keyword">else</span>          perpWallDist = (sideDistY - deltaDistY);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*********************************************************************************/</span></span><br><span class="line">        <span class="comment">/*  此部分为添加FOV用</span></span><br><span class="line"><span class="comment">        /*  计算射线的终点</span></span><br><span class="line"><span class="comment">        /*********************************************************************************/</span></span><br><span class="line">        <span class="type">double</span> rayEndX = posX + perpWallDist * rayDirX;</span><br><span class="line">        <span class="type">double</span> rayEndY = posY + perpWallDist * rayDirY;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置三角扇形的顶点</span></span><br><span class="line">        fov[x + <span class="number">1</span>].position = sf::<span class="built_in">Vector2f</span>(rayEndX * miniMapScale, (mapHeight - rayEndY) * miniMapScale);</span><br><span class="line">        fov[x + <span class="number">1</span>].color = sf::<span class="built_in">Color</span>(<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">150</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Calculate height of line to draw on screen</span></span><br><span class="line">        <span class="comment">//可以任意修改墙的高度</span></span><br><span class="line">        <span class="type">int</span> lineHeight = (<span class="type">int</span>)(screenHeight / perpWallDist) * <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//calculate lowest and highest pixel to fill in current stripe</span></span><br><span class="line">        <span class="type">int</span> drawStart = -lineHeight / <span class="number">2</span> + screenHeight / <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">if</span> (drawStart &lt; <span class="number">0</span>) drawStart = <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> drawEnd = lineHeight / <span class="number">2</span> + screenHeight / <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">if</span> (drawEnd &gt;= screenHeight) drawEnd = screenHeight - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*无纹理时*/</span></span><br><span class="line">        <span class="keyword">if</span> (TextureFlag == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//choose wall color</span></span><br><span class="line">            Color color;</span><br><span class="line">            <span class="keyword">switch</span> (worldMap[mapX][mapY])</span><br><span class="line">            &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">1</span>:  color = Color::Red;    <span class="keyword">break</span>; <span class="comment">//red</span></span><br><span class="line">            <span class="keyword">case</span> <span class="number">2</span>:  color = Color::Green;  <span class="keyword">break</span>; <span class="comment">//green</span></span><br><span class="line">            <span class="keyword">case</span> <span class="number">3</span>:  color = Color::Blue;   <span class="keyword">break</span>; <span class="comment">//blue</span></span><br><span class="line">            <span class="keyword">case</span> <span class="number">4</span>:  color = Color::White;  <span class="keyword">break</span>; <span class="comment">//white</span></span><br><span class="line">            <span class="keyword">default</span>: color = Color::Yellow; <span class="keyword">break</span>; <span class="comment">//yellow</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//give x and y sides different brightness</span></span><br><span class="line">            <span class="keyword">if</span> (side == <span class="number">1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                color.r /= <span class="number">2</span>;</span><br><span class="line">                color.g /= <span class="number">2</span>;</span><br><span class="line">                color.b /= <span class="number">2</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//draw the pixels of the stripe as a vertical line</span></span><br><span class="line">            <span class="keyword">if</span> (DrawFlag == <span class="number">1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">verLine</span>(window, x, drawStart, drawEnd, color);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*********************************************************************************/</span></span><br><span class="line">        <span class="comment">/*  此部分替换了原raycasting画线部分</span></span><br><span class="line"><span class="comment">        /*  以下为纹理相关计算，是新内容</span></span><br><span class="line"><span class="comment">        /*  具体和原来的画线函数差不多，都是在具体位置上画出一条线</span></span><br><span class="line"><span class="comment">        /*  只不过这里画的是具体纹理上的一条线，利用了SFML中的sprite</span></span><br><span class="line"><span class="comment">        /*********************************************************************************/</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (TextureFlag == <span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//texturing calculations</span></span><br><span class="line">            <span class="type">int</span> texNum = worldMap[mapX][mapY] - <span class="number">1</span>; <span class="comment">//1 subtracted from it so that texture 0 can be used!</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">//calculate value of wallX</span></span><br><span class="line">            <span class="type">double</span> wallX; <span class="comment">//where exactly the wall was hit</span></span><br><span class="line">            <span class="keyword">if</span> (side == <span class="number">0</span>) wallX = posY + perpWallDist * rayDirY;</span><br><span class="line">            <span class="keyword">else</span>           wallX = posX + perpWallDist * rayDirX;</span><br><span class="line">            wallX -= <span class="built_in">floor</span>((wallX));</span><br><span class="line"></span><br><span class="line">            <span class="comment">//x coordinate on the texture</span></span><br><span class="line">            <span class="type">int</span> texX = <span class="built_in">int</span>(wallX * <span class="built_in">double</span>(texWidth));</span><br><span class="line">            <span class="keyword">if</span> (side == <span class="number">0</span> &amp;&amp; rayDirX &gt; <span class="number">0</span>) texX = texWidth - texX - <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">if</span> (side == <span class="number">1</span> &amp;&amp; rayDirY &lt; <span class="number">0</span>) texX = texWidth - texX - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// How much to increase the texture coordinate per screen pixel</span></span><br><span class="line">            <span class="type">double</span> step = <span class="number">1.0</span> * texHeight / lineHeight;</span><br><span class="line">            <span class="comment">// Starting texture coordinate</span></span><br><span class="line">            <span class="type">double</span> texPos = (drawStart - screenHeight / <span class="number">2</span> + lineHeight / <span class="number">2</span>) * step;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//为了获取纹理具体某一个坐标的像素颜色</span></span><br><span class="line">            <span class="comment">//创建一个新的sprite对象</span></span><br><span class="line">            sf::Sprite wall_sprite;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//设置sprite的纹理</span></span><br><span class="line">            wall_sprite.<span class="built_in">setTexture</span>(texture[texNum]);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//设置sprite的纹理矩形，定义了在纹理中的哪个部分应用到wall_sprite上</span></span><br><span class="line">            <span class="comment">//宽度为1个像素，相当于原来的画线</span></span><br><span class="line">            wall_sprite.<span class="built_in">setTextureRect</span>(sf::<span class="built_in">IntRect</span>(texX, <span class="number">0</span>, <span class="number">1</span>, texHeight));</span><br><span class="line">            <span class="comment">//wall_sprite.setTextureRect(sf::IntRect(texX, 0, 1, lineHeight));</span></span><br><span class="line">            <span class="comment">//wall_sprite.setTextureRect(sf::IntRect(static_cast&lt;unsigned short&gt;(round(texX)), 0, 1, lineHeight));</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">//设置sprite的位置，坐标指定了左上角的位置</span></span><br><span class="line">            <span class="comment">//wall_sprite.setPosition(x, drawStart);        //太几把恶心了，破案了：指定左上角的位置为drawStart</span></span><br><span class="line">            <span class="comment">//                                              //drawStart在特殊情况下会被赋值为0，即if (drawStart &lt; 0) drawStart = 0;</span></span><br><span class="line">            <span class="comment">//                                              //在此情况下绘制的起点就会改变为0，令人恶心</span></span><br><span class="line">            wall_sprite.<span class="built_in">setPosition</span>(x, <span class="built_in">round</span>(<span class="number">0.5f</span> * screenHeight - <span class="number">0.5f</span> * lineHeight));</span><br><span class="line"></span><br><span class="line">            <span class="comment">//设置sprite的缩放因子</span></span><br><span class="line">            wall_sprite.<span class="built_in">setScale</span>(<span class="number">1</span>, lineHeight / (<span class="type">float</span>)texHeight);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="comment">//利用SFML中sprite的setColor功能，使y墙变暗</span></span><br><span class="line">            <span class="comment">//这个函数实现的是“调制混合”</span></span><br><span class="line">            <span class="comment">//举个例子：原来的R通道为200，与128混合为：200 * 128 / 255 = 100，实现了颜色除以2的效果</span></span><br><span class="line">            <span class="keyword">if</span> (side == <span class="number">1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                wall_sprite.<span class="built_in">setColor</span>(<span class="built_in">Color</span>(<span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 绘制sprite</span></span><br><span class="line">            <span class="keyword">if</span> (DrawFlag == <span class="number">1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                window.<span class="built_in">draw</span>(wall_sprite);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Move</span><span class="params">(RenderWindow&amp; window)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//timing for input and FPS counter</span></span><br><span class="line">    oldTime = Mytime;</span><br><span class="line">    Mytime = <span class="built_in">getTicks</span>();</span><br><span class="line">    <span class="type">double</span> frameTime = (Mytime - oldTime) / <span class="number">1000.0</span>; <span class="comment">//frameTime is the time this frame has taken, in seconds</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//speed modifiers</span></span><br><span class="line">    <span class="type">double</span> moveSpeed = frameTime * <span class="number">3.0</span>; <span class="comment">//the constant value is in squares/second</span></span><br><span class="line">    <span class="type">double</span> rotSpeed = frameTime * <span class="number">2.0</span>; <span class="comment">//the constant value is in radians/second</span></span><br><span class="line">    <span class="comment">//move forward if no wall in front of you</span></span><br><span class="line">    <span class="keyword">if</span> (sf::Keyboard::<span class="built_in">isKeyPressed</span>(sf::Keyboard::Up) ||</span><br><span class="line">        sf::Keyboard::<span class="built_in">isKeyPressed</span>(sf::Keyboard::W))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (worldMap[<span class="built_in">int</span>(posX + dirX * moveSpeed)][<span class="built_in">int</span>(posY)] == <span class="literal">false</span>) posX += dirX * moveSpeed;</span><br><span class="line">        <span class="keyword">if</span> (worldMap[<span class="built_in">int</span>(posX)][<span class="built_in">int</span>(posY + dirY * moveSpeed)] == <span class="literal">false</span>) posY += dirY * moveSpeed;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//move backwards if no wall behind you</span></span><br><span class="line">    <span class="keyword">if</span> (sf::Keyboard::<span class="built_in">isKeyPressed</span>(sf::Keyboard::Down) ||</span><br><span class="line">        sf::Keyboard::<span class="built_in">isKeyPressed</span>(sf::Keyboard::S))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (worldMap[<span class="built_in">int</span>(posX - dirX * moveSpeed)][<span class="built_in">int</span>(posY)] == <span class="literal">false</span>) posX -= dirX * moveSpeed;</span><br><span class="line">        <span class="keyword">if</span> (worldMap[<span class="built_in">int</span>(posX)][<span class="built_in">int</span>(posY - dirY * moveSpeed)] == <span class="literal">false</span>) posY -= dirY * moveSpeed;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//向右走，原理还是跟前后走一样，只是方向用矩阵相乘重新算了</span></span><br><span class="line">    <span class="comment">//向右走就是在(dirY, -dirX)这个方向走</span></span><br><span class="line">    <span class="keyword">if</span> (sf::Keyboard::<span class="built_in">isKeyPressed</span>(sf::Keyboard::D))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (worldMap[<span class="built_in">int</span>(posX + dirY * moveSpeed * <span class="number">0.75</span>)][<span class="built_in">int</span>(posY)] == <span class="literal">false</span>) posX += dirY * moveSpeed * <span class="number">0.75</span>;</span><br><span class="line">        <span class="keyword">if</span> (worldMap[<span class="built_in">int</span>(posX)][<span class="built_in">int</span>(posY - dirX * moveSpeed * <span class="number">0.75</span>)] == <span class="literal">false</span>) posY -= dirX * moveSpeed * <span class="number">0.75</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//向左走同理</span></span><br><span class="line">    <span class="comment">//在(-dirY, dirX)方向</span></span><br><span class="line">    <span class="keyword">if</span> (sf::Keyboard::<span class="built_in">isKeyPressed</span>(sf::Keyboard::A))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (worldMap[<span class="built_in">int</span>(posX - dirY * moveSpeed * <span class="number">0.75</span>)][<span class="built_in">int</span>(posY)] == <span class="literal">false</span>) posX -= dirY * moveSpeed * <span class="number">0.75</span>;</span><br><span class="line">        <span class="keyword">if</span> (worldMap[<span class="built_in">int</span>(posX)][<span class="built_in">int</span>(posY + dirX * moveSpeed * <span class="number">0.75</span>)] == <span class="literal">false</span>) posY += dirX * moveSpeed * <span class="number">0.75</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//rotate to the right</span></span><br><span class="line">    <span class="keyword">if</span> (sf::Keyboard::<span class="built_in">isKeyPressed</span>(sf::Keyboard::Right))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//both camera direction and camera plane must be rotated</span></span><br><span class="line">        <span class="type">double</span> oldDirX = dirX;</span><br><span class="line">        dirX = dirX * <span class="built_in">cos</span>(-rotSpeed) - dirY * <span class="built_in">sin</span>(-rotSpeed);</span><br><span class="line">        dirY = oldDirX * <span class="built_in">sin</span>(-rotSpeed) + dirY * <span class="built_in">cos</span>(-rotSpeed);</span><br><span class="line">        <span class="type">double</span> oldPlaneX = planeX;</span><br><span class="line">        planeX = planeX * <span class="built_in">cos</span>(-rotSpeed) - planeY * <span class="built_in">sin</span>(-rotSpeed);</span><br><span class="line">        planeY = oldPlaneX * <span class="built_in">sin</span>(-rotSpeed) + planeY * <span class="built_in">cos</span>(-rotSpeed);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//rotate to the left</span></span><br><span class="line">    <span class="keyword">if</span> (sf::Keyboard::<span class="built_in">isKeyPressed</span>(sf::Keyboard::Left))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//both camera direction and camera plane must be rotated</span></span><br><span class="line">        <span class="type">double</span> oldDirX = dirX;</span><br><span class="line">        dirX = dirX * <span class="built_in">cos</span>(rotSpeed) - dirY * <span class="built_in">sin</span>(rotSpeed);</span><br><span class="line">        dirY = oldDirX * <span class="built_in">sin</span>(rotSpeed) + dirY * <span class="built_in">cos</span>(rotSpeed);</span><br><span class="line">        <span class="type">double</span> oldPlaneX = planeX;</span><br><span class="line">        planeX = planeX * <span class="built_in">cos</span>(rotSpeed) - planeY * <span class="built_in">sin</span>(rotSpeed);</span><br><span class="line">        planeY = oldPlaneX * <span class="built_in">sin</span>(rotSpeed) + planeY * <span class="built_in">cos</span>(rotSpeed);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="遇到的问题">遇到的问题</h1>
<h2 id="纹理问题">纹理问题</h2>
<p><a id="Problem_Texture"></a></p>
<p>我在编码过程中碰到了如图所示的问题</p>
<img src="/2023/11/09/%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/Raycasting%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/raycasting_bug.gif" class title="raycasting_bug">
<p>开什么玩笑？要吐了！</p>
<p>那么这是怎么会是呢？</p>
<p>为什么会出现“墙往两侧倒”的这种情况？</p>
<p>为什么刚刚纯色版本没出现这个问题？</p>
<p>其实很简单，因为<strong>纯色版本也有这样的问题</strong>，只是纯色没有纹理，看不出来这样的效果</p>
<p>最主要的问题就出在“设置线的起点”这条语句上</p>
<p>先看看纯色的这里是怎么做的：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> drawStart = -lineHeight / <span class="number">2</span> + screenHeight / <span class="number">2</span>;</span><br><span class="line"><span class="keyword">if</span> (drawStart &lt; <span class="number">0</span>) drawStart = <span class="number">0</span>;</span><br><span class="line">...</span><br><span class="line"><span class="comment">//draw the pixels of the stripe as a vertical line</span></span><br><span class="line"><span class="built_in">verLine</span>(window, x, drawStart, drawEnd, color);</span><br></pre></td></tr></table></figure>
<p>我们在设置起点的时候，明确指定了：如果起点小于0，就把<code>drawStart</code>强行赋值为0</p>
<p>再来看看纹理设置位置：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//设置sprite的位置，坐标指定了左上角的位置</span></span><br><span class="line">wall_sprite.<span class="built_in">setPosition</span>(x, drawStart); </span><br></pre></td></tr></table></figure>
<p>这就导致了问题：当这个墙超过视野范围，计算的起点必须是负数，但是强行赋值为0，就会导致纹理的起点变成0</p>
<p><br></p>
<p>在<a target="_blank" rel="noopener" href="https://lodev.org/cgtutor/raycasting.html">原教程</a>中，把起点强行设置为0，可能是因为原教程里用的图形库不支持负数坐标，并且显示逻辑也跟我在SFML中用的不一样</p>
<p>但是在SFML中是支持坐标超出屏幕范围的，也就是支持坐标指定为负数，那就不用担心了</p>
<p>我们就把设置位置这条的Y坐标起始位置修改为<code>drawStart</code>的计算过程：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//设置sprite的位置，坐标指定了左上角的位置</span></span><br><span class="line">wall_sprite.<span class="built_in">setPosition</span>(x, <span class="built_in">round</span>(<span class="number">0.5f</span> * screenHeight - <span class="number">0.5f</span> * lineHeight)); </span><br></pre></td></tr></table></figure>
<p>这样就解决问题了</p>
<p>经过这个bug，深刻认识到参考只能是参考，和实际一定会有差别，代码不能直接复制粘贴啊，笑拉了</p>
<p><br></p>
<p><br></p>
<p><br></p>
<hr>
<h1 id="参考资料">参考资料</h1>
<p><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/First-person_shooter">First-person
shooter - Wikipedia</a></p>
<p><a target="_blank" rel="noopener" href="https://lodev.org/cgtutor/raycasting.html">Raycasting
(lodev.org)</a></p>
<p><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/德軍總部3D">德军总部3D -
维基百科</a></p>
<p><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Ray_casting">Ray casting -
Wikipedia</a></p>
<p><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=LUYxLjic0Bc&amp;t">Making my
First RAYCASTING Game in C++</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/Kofybrek/Raycasting">Kofybrek/Raycasting:
Tried to write a ray casting game with no experience</a></p>
<p><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=OpIS1zoz6fU">I Used
RAYCASTING to Make a HORROR Game in C++</a></p>
</article><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9B%BE%E5%BD%A2%E5%AD%A6/">计算机图形学</a><a class="post-meta__tags" href="/tags/Raycasting/">Raycasting</a><a class="post-meta__tags" href="/tags/%E4%BC%AA3D/">伪3D</a><a class="post-meta__tags" href="/tags/SFML/">SFML</a></div><div class="post_share"></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2023/12/06/%E5%A4%8D%E4%B9%A0%E6%95%B4%E7%90%86/OOAD%E5%A4%8D%E4%B9%A0%E6%95%B4%E7%90%86/" title="OOAD复习整理"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">OOAD复习整理</div></div></a></div><div class="next-post pull-right"><a href="/2023/10/28/%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/%E5%A4%A7%E4%B8%89%E4%B8%93%E4%B8%9A%E8%AF%BE%E4%B8%8A%E6%9C%BA%E5%AE%9E%E9%AA%8C%E7%A2%B0%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98%E5%90%88%E9%9B%86/" title="大三专业课上机实验碰到的问题合集"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">大三专业课上机实验碰到的问题合集</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2024/05/24/%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/Raycasting%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95-%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%89%A9%E5%B1%95/" title="Raycasting学习记录_进阶与扩展"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-05-24</div><div class="title">Raycasting学习记录_进阶与扩展</div></div></a></div><div><a href="/2024/01/07/%E5%A4%8D%E4%B9%A0%E6%95%B4%E7%90%86/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9B%BE%E5%BD%A2%E5%AD%A6%E5%A4%8D%E4%B9%A0%E6%95%B4%E7%90%86/" title="计算机图形学复习整理"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-01-07</div><div class="title">计算机图形学复习整理</div></div></a></div><div><a href="/2024/05/14/%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/GAMES101%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/" title="GAMES101学习记录"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-05-14</div><div class="title">GAMES101学习记录</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/WinkySpeed%20SP%20-%20Repaired.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">WinkySpeed</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">50</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">60</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/WinkySpeed"><i class="fab fa-github"></i><span>GitHub</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">欢迎来到我的博客</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#raycasting"><span class="toc-number">2.</span> <span class="toc-text">Raycasting</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B"><span class="toc-number">2.1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%80%E5%9F%BA%E6%9C%AC%E7%9A%84%E5%A4%8D%E7%8E%B0"><span class="toc-number">2.2.</span> <span class="toc-text">最基本的复现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BF%85%E8%A6%81%E5%8F%82%E6%95%B0%E5%A3%B0%E6%98%8E"><span class="toc-number">2.2.1.</span> <span class="toc-text">必要参数声明</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#main%E5%87%BD%E6%95%B0%E7%9A%84%E7%BB%93%E6%9E%84"><span class="toc-number">2.2.2.</span> <span class="toc-text">main函数的结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#dda_algorithm%E5%87%BD%E6%95%B0"><span class="toc-number">2.2.3.</span> <span class="toc-text">DDA_algorithm函数</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A7%92%E8%89%B2%E5%8F%91%E5%87%BA%E5%85%89%E7%BA%BF"><span class="toc-number">2.2.3.1.</span> <span class="toc-text">角色发出光线</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#dda%E7%AE%97%E6%B3%95"><span class="toc-number">2.2.3.2.</span> <span class="toc-text">DDA算法</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%BF%85%E8%A6%81%E7%9A%84%E5%8F%98%E9%87%8F%E5%AE%9A%E4%B9%89%E4%B8%8E%E8%AE%A1%E7%AE%97"><span class="toc-number">2.2.3.2.1.</span> <span class="toc-text">必要的变量定义与计算</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%89%A7%E8%A1%8Cdda%E7%AE%97%E6%B3%95"><span class="toc-number">2.2.3.2.2.</span> <span class="toc-text">执行DDA算法</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AE%A1%E7%AE%97%E5%AF%B9%E5%BA%94%E5%A2%99%E7%9A%84%E9%AB%98%E5%BA%A6"><span class="toc-number">2.2.3.3.</span> <span class="toc-text">计算对应墙的高度</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%8D%E5%90%8C%E5%A2%99%E9%80%89%E4%B8%8D%E5%90%8C%E9%A2%9C%E8%89%B2"><span class="toc-number">2.2.3.4.</span> <span class="toc-text">不同墙选不同颜色</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B1%8F%E5%B9%95%E5%AF%B9%E5%BA%94%E4%BD%8D%E7%BD%AE%E7%94%BB%E7%BA%BF"><span class="toc-number">2.2.3.5.</span> <span class="toc-text">屏幕对应位置画线</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%BA%E7%89%A9%E7%A7%BB%E5%8A%A8%E9%80%BB%E8%BE%91"><span class="toc-number">2.2.4.</span> <span class="toc-text">人物移动逻辑</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%89%8D%E5%90%8E%E8%B5%B0"><span class="toc-number">2.2.4.1.</span> <span class="toc-text">前后走</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B7%A6%E5%8F%B3%E8%B5%B0"><span class="toc-number">2.2.4.2.</span> <span class="toc-text">左右走</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A7%86%E8%A7%92%E5%B7%A6%E5%8F%B3%E8%BD%AC"><span class="toc-number">2.2.4.3.</span> <span class="toc-text">视角左右转</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%80%E5%90%8E%E7%9A%84%E6%95%88%E6%9E%9C"><span class="toc-number">2.2.5.</span> <span class="toc-text">最后的效果</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BA%90%E4%BB%A3%E7%A0%81"><span class="toc-number">2.2.6.</span> <span class="toc-text">源代码</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%A0%E7%BA%B9%E7%90%86%E7%89%88"><span class="toc-number">2.3.</span> <span class="toc-text">加纹理版</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%A1%E7%AE%97%E7%BA%B9%E7%90%86%E5%AF%B9%E5%BA%94%E5%9D%90%E6%A0%87texx"><span class="toc-number">2.3.1.</span> <span class="toc-text">计算纹理对应坐标texX</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%95%9C%E5%83%8F%E5%A4%84%E7%90%86"><span class="toc-number">2.3.2.</span> <span class="toc-text">镜像处理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BA%B9%E7%90%86%E7%9A%84sprite"><span class="toc-number">2.3.3.</span> <span class="toc-text">纹理的Sprite</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%98%E5%88%B6%E7%BA%B9%E7%90%86sprite"><span class="toc-number">2.3.4.</span> <span class="toc-text">绘制纹理Sprite</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%80%E5%90%8E%E7%9A%84%E6%95%88%E6%9E%9C-1"><span class="toc-number">2.3.5.</span> <span class="toc-text">最后的效果</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BA%90%E4%BB%A3%E7%A0%81-1"><span class="toc-number">2.3.6.</span> <span class="toc-text">源代码</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%A0%E7%82%B9%E4%B8%9C%E8%A5%BF"><span class="toc-number">2.4.</span> <span class="toc-text">加点东西</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B0%E7%9A%84main%E5%87%BD%E6%95%B0"><span class="toc-number">2.4.1.</span> <span class="toc-text">新的main函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%A0%E5%9C%B0%E6%9D%BF%E5%A4%A9%E8%8A%B1%E6%9D%BF"><span class="toc-number">2.4.2.</span> <span class="toc-text">加地板天花板</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%A0%E5%B0%8F%E5%9C%B0%E5%9B%BE%E5%92%8C%E8%A7%86%E9%87%8E%E8%8C%83%E5%9B%B4"><span class="toc-number">2.4.3.</span> <span class="toc-text">加小地图和视野范围</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%80%E5%90%8E%E7%9A%84%E6%95%88%E6%9E%9C-2"><span class="toc-number">2.4.4.</span> <span class="toc-text">最后的效果</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BA%90%E4%BB%A3%E7%A0%81-2"><span class="toc-number">2.4.5.</span> <span class="toc-text">源代码</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B1%95%E7%A4%BA%E7%9A%84demonstration"><span class="toc-number">2.5.</span> <span class="toc-text">展示的Demonstration</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B1%95%E7%A4%BA%E7%9A%84%E9%80%BB%E8%BE%91"><span class="toc-number">2.5.1.</span> <span class="toc-text">展示的逻辑</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%B9%E5%BA%94%E4%BF%AE%E6%94%B9"><span class="toc-number">2.5.2.</span> <span class="toc-text">对应修改</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BA%90%E4%BB%A3%E7%A0%81-3"><span class="toc-number">2.5.3.</span> <span class="toc-text">源代码</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number">3.</span> <span class="toc-text">遇到的问题</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BA%B9%E7%90%86%E9%97%AE%E9%A2%98"><span class="toc-number">3.1.</span> <span class="toc-text">纹理问题</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="toc-number">4.</span> <span class="toc-text">参考资料</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/06/22/%E5%A4%8D%E4%B9%A0%E6%95%B4%E7%90%86/%E8%99%9A%E6%8B%9F%E7%8E%B0%E5%AE%9E%E5%A4%8D%E4%B9%A0%E6%95%B4%E7%90%86/" title="虚拟现实复习整理">虚拟现实复习整理</a><time datetime="2024-06-22T11:57:00.000Z" title="发表于 2024-06-22 19:57:00">2024-06-22</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/06/18/%E5%A4%8D%E4%B9%A0%E6%95%B4%E7%90%86/%E8%AE%A1%E7%AE%97%E6%9C%BA%E8%A7%86%E8%A7%89%E5%A4%8D%E4%B9%A0%E6%95%B4%E7%90%86/" title="计算机视觉复习整理">计算机视觉复习整理</a><time datetime="2024-06-18T11:15:00.000Z" title="发表于 2024-06-18 19:15:00">2024-06-18</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/06/09/%E9%97%AE%E9%A2%98%E8%AE%B0%E5%BD%95/VSCode-Pylance%E9%AB%98%E7%89%88%E6%9C%AC%E9%97%AE%E9%A2%98/" title="VSCode Pylance高版本问题">VSCode Pylance高版本问题</a><time datetime="2024-06-09T10:11:24.000Z" title="发表于 2024-06-09 18:11:24">2024-06-09</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/05/24/%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/Raycasting%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95-%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%89%A9%E5%B1%95/" title="Raycasting学习记录_进阶与扩展">Raycasting学习记录_进阶与扩展</a><time datetime="2024-05-24T07:00:00.000Z" title="发表于 2024-05-24 15:00:00">2024-05-24</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/05/14/%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/GAMES101%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/" title="GAMES101学习记录">GAMES101学习记录</a><time datetime="2024-05-14T07:22:42.000Z" title="发表于 2024-05-14 15:22:42">2024-05-14</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By WinkySpeed</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    tex: {
      inlineMath: [ ['$','$'], ["\\(","\\)"]],
      tags: 'ams'
    },
    chtml: {
      scale: 1.1
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, ''],
        insertScript: [200, () => {
          document.querySelectorAll('mjx-container').forEach(node => {
            if (node.hasAttribute('display')) {
              btf.wrap(node, 'div', { class: 'mathjax-overflow' })
            } else {
              btf.wrap(node, 'span', { class: 'mathjax-overflow' })
            }
          });
        }, '', false]
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://cdn.jsdelivr.net/npm/mathjax/es5/tex-mml-chtml.min.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typeset()
}</script></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><script src="/live2d-widget/autoload.js"></script></body></html>